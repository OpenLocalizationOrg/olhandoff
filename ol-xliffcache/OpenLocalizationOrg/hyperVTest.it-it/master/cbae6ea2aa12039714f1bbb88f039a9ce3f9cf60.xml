{
  "nodes": [
    {
      "pos": [
        27,
        82
      ],
      "content": "Extend HDInsight with Virtual Network | Microsoft Azure"
    },
    {
      "pos": [
        103,
        220
      ],
      "content": "Learn how to use Azure Virtual Network to connect HDInsight to other cloud resources, or resources in your datacenter"
    },
    {
      "pos": [
        519,
        579
      ],
      "content": "Extend HDInsight capabilities by using Azure Virtual Network"
    },
    {
      "pos": [
        581,
        771
      ],
      "content": "Azure Virtual Network allows you to extend your Hadoop solutions to incorporate on-premises resources such as SQL Server, or to create secure private networks between resources in the cloud."
    },
    {
      "pos": [
        775,
        921
      ],
      "content": "<ph id=\"ph2\">[AZURE.NOTE]</ph><ph id=\"ph3\"/> HDInsight does not support affinity-based Azure virtual networks. When using HDInsight, you must use location-based virtual networks.",
      "nodes": [
        {
          "content": "<ph id=\"ph2\">[AZURE.NOTE]</ph><ph id=\"ph3\"/> HDInsight does not support affinity-based Azure virtual networks.",
          "pos": [
            0,
            110
          ]
        },
        {
          "content": "When using HDInsight, you must use location-based virtual networks.",
          "pos": [
            111,
            178
          ]
        }
      ]
    },
    {
      "pos": [
        924,
        926
      ],
      "content": "##"
    },
    {
      "pos": [
        945,
        975
      ],
      "content": "What is Azure Virtual Network?"
    },
    {
      "pos": [
        977,
        1205
      ],
      "content": "<bpt id=\"p1\">[</bpt>Azure Virtual Network<ept id=\"p1\">](https://azure.microsoft.com/documentation/services/virtual-network/)</ept><ph id=\"ph4\"/> allows you to create a secure, persistent network containing the resources you need for your solution. A virtual network allows you to:",
      "nodes": [
        {
          "content": "<bpt id=\"p1\">[</bpt>Azure Virtual Network<ept id=\"p1\">](https://azure.microsoft.com/documentation/services/virtual-network/)</ept><ph id=\"ph4\"/> allows you to create a secure, persistent network containing the resources you need for your solution.",
          "pos": [
            0,
            247
          ]
        },
        {
          "content": "A virtual network allows you to:",
          "pos": [
            248,
            280
          ]
        }
      ]
    },
    {
      "pos": [
        1209,
        1276
      ],
      "content": "Connect cloud resources together in a private network (cloud-only)."
    },
    {
      "pos": [
        1282,
        1382
      ],
      "content": "<ph id=\"ph5\">![</ph>diagram of cloud-only configuration<ph id=\"ph6\">](media/hdinsight-extend-hadoop-virtual-network/cloud-only.png)</ph>"
    },
    {
      "pos": [
        1388,
        1486
      ],
      "content": "Using Virtual Network to link Azure services with Azure HDInsight enables the following scenarios:"
    },
    {
      "pos": [
        1494,
        1600
      ],
      "content": "<bpt id=\"p2\">**</bpt>Invoking HDInsight services or jobs<ept id=\"p2\">**</ept><ph id=\"ph7\"/> from Azure websites or services running in Azure virtual machines."
    },
    {
      "pos": [
        1608,
        1755
      ],
      "content": "<bpt id=\"p3\">**</bpt>Directly transferring data<ept id=\"p3\">**</ept><ph id=\"ph8\"/> between HDInsight and Azure SQL Database, SQL Server, or another data storage solution running on a virtual machine."
    },
    {
      "pos": [
        1763,
        2069
      ],
      "content": "<bpt id=\"p4\">**</bpt>Combining multiple HDInsight servers<ept id=\"p4\">**</ept><ph id=\"ph9\"/> into a single solution. An example is using an HDInsight Storm server to consume incoming data, and then storing the processed data to an HDInsight HBase server. The raw data might also be stored to an HDInsight Hadoop server for future analysis by using MapReduce.",
      "nodes": [
        {
          "content": "<bpt id=\"p4\">**</bpt>Combining multiple HDInsight servers<ept id=\"p4\">**</ept><ph id=\"ph9\"/> into a single solution.",
          "pos": [
            0,
            116
          ]
        },
        {
          "content": "An example is using an HDInsight Storm server to consume incoming data, and then storing the processed data to an HDInsight HBase server.",
          "pos": [
            117,
            254
          ]
        },
        {
          "content": "The raw data might also be stored to an HDInsight Hadoop server for future analysis by using MapReduce.",
          "pos": [
            255,
            358
          ]
        }
      ]
    },
    {
      "pos": [
        2073,
        2208
      ],
      "content": "Connect your cloud resources to your local datacenter network (site-to-site or point-to-site) by using a virtual private network (VPN)."
    },
    {
      "pos": [
        2214,
        2397
      ],
      "content": "Site-to-site configuration allows you to connect multiple resources from your datacenter to the Azure virtual network by using a hardware VPN or the Routing and Remote Access service."
    },
    {
      "pos": [
        2403,
        2507
      ],
      "content": "<ph id=\"ph10\">![</ph>diagram of site-to-site configuration<ph id=\"ph11\">](media/hdinsight-extend-hadoop-virtual-network/site-to-site.png)</ph>"
    },
    {
      "pos": [
        2513,
        2634
      ],
      "content": "Point-to-site configuration allows you to connect a specific resource to the Azure virtual network by using software VPN."
    },
    {
      "pos": [
        2640,
        2746
      ],
      "content": "<ph id=\"ph12\">![</ph>diagram of point-to-site configuration<ph id=\"ph13\">](media/hdinsight-extend-hadoop-virtual-network/point-to-site.png)</ph>"
    },
    {
      "pos": [
        2752,
        2992
      ],
      "content": "Using Virtual Network to link the cloud and your datacenter enables similar scenarios to the cloud-only configuration. But instead of being limited to working with resources in the cloud, you can also work with resources in your datacenter.",
      "nodes": [
        {
          "content": "Using Virtual Network to link the cloud and your datacenter enables similar scenarios to the cloud-only configuration.",
          "pos": [
            0,
            118
          ]
        },
        {
          "content": "But instead of being limited to working with resources in the cloud, you can also work with resources in your datacenter.",
          "pos": [
            119,
            240
          ]
        }
      ]
    },
    {
      "pos": [
        3000,
        3201
      ],
      "content": "<bpt id=\"p5\">**</bpt>Directly transferring data<ept id=\"p5\">**</ept><ph id=\"ph14\"/> between HDInsight and your datacenter. An example is using Sqoop to transfer data to or from SQL Server or reading data generated by a line-of-business (LOB) application.",
      "nodes": [
        {
          "content": "<bpt id=\"p5\">**</bpt>Directly transferring data<ept id=\"p5\">**</ept><ph id=\"ph14\"/> between HDInsight and your datacenter.",
          "pos": [
            0,
            122
          ]
        },
        {
          "content": "An example is using Sqoop to transfer data to or from SQL Server or reading data generated by a line-of-business (LOB) application.",
          "pos": [
            123,
            254
          ]
        }
      ]
    },
    {
      "pos": [
        3209,
        3369
      ],
      "content": "<bpt id=\"p6\">**</bpt>Invoking HDInsight services or jobs<ept id=\"p6\">**</ept><ph id=\"ph15\"/> from an LOB application. An example is using HBase Java APIs to store and retrieve data from an HDInsight HBase cluster.",
      "nodes": [
        {
          "content": "<bpt id=\"p6\">**</bpt>Invoking HDInsight services or jobs<ept id=\"p6\">**</ept><ph id=\"ph15\"/> from an LOB application.",
          "pos": [
            0,
            117
          ]
        },
        {
          "content": "An example is using HBase Java APIs to store and retrieve data from an HDInsight HBase cluster.",
          "pos": [
            118,
            213
          ]
        }
      ]
    },
    {
      "pos": [
        3371,
        3539
      ],
      "content": "For more information on Virtual Network features, benefits, and capabilities, see the <bpt id=\"p7\">[</bpt>Azure Virtual Network overview<ept id=\"p7\">](../virtual-network/virtual-networks-overview.md)</ept>."
    },
    {
      "pos": [
        3543,
        3773
      ],
      "content": "<ph id=\"ph16\">[AZURE.NOTE]</ph><ph id=\"ph17\"/> You must create the Azure Virtual Network before provisioning an HDInsight cluster. For more information, see <bpt id=\"p8\">[</bpt>Virtual Network configuration tasks<ept id=\"p8\">](https://azure.microsoft.com/documentation/services/virtual-network/)</ept>.",
      "nodes": [
        {
          "content": "<ph id=\"ph16\">[AZURE.NOTE]</ph><ph id=\"ph17\"/> You must create the Azure Virtual Network before provisioning an HDInsight cluster.",
          "pos": [
            0,
            130
          ]
        },
        {
          "content": "For more information, see <bpt id=\"p8\">[</bpt>Virtual Network configuration tasks<ept id=\"p8\">](https://azure.microsoft.com/documentation/services/virtual-network/)</ept>.",
          "pos": [
            131,
            302
          ]
        }
      ]
    },
    {
      "pos": [
        3778,
        3806
      ],
      "content": "Virtual Network requirements"
    },
    {
      "pos": [
        3810,
        3965
      ],
      "content": "<ph id=\"ph18\">[AZURE.IMPORTANT]</ph><ph id=\"ph19\"/> Creating an HDInsight cluster on a Virtual Network requires specific Virtual Network configurations, which are described in this section."
    },
    {
      "pos": [
        3970,
        4001
      ],
      "content": "Location-based Virtual networks"
    },
    {
      "pos": [
        4003,
        4140
      ],
      "content": "Azure HDInsight supports only location-based virtual networks, and does not currently work with virtual networks based on affinity group."
    },
    {
      "pos": [
        4146,
        4153
      ],
      "content": "Subnets"
    },
    {
      "pos": [
        4155,
        4239
      ],
      "content": "It is highly recommended that you create a single subnet for each HDInsight cluster."
    },
    {
      "pos": [
        4245,
        4274
      ],
      "content": "Classic or v2 Virtual Network"
    },
    {
      "pos": [
        4276,
        4520
      ],
      "content": "Windows-based clusters require a v1 (Classic) Virtual Network, while Linux-based clusters require a v2 (Azure Resource Manager,) Virtual Network. If you do not have the correct type of network, it will not be usable when you create the cluster.",
      "nodes": [
        {
          "content": "Windows-based clusters require a v1 (Classic) Virtual Network, while Linux-based clusters require a v2 (Azure Resource Manager,) Virtual Network.",
          "pos": [
            0,
            145
          ]
        },
        {
          "content": "If you do not have the correct type of network, it will not be usable when you create the cluster.",
          "pos": [
            146,
            244
          ]
        }
      ]
    },
    {
      "pos": [
        4522,
        5066
      ],
      "content": "If you have resources on a Virtual Network that is not usable by the cluster you plan on creating, you can create a new Virtual Network that is usable by the cluster, and connect it to the incompatible Virtual Network. You can then create the cluster in the network version that it requires, and it will be able to access resources in the other network since the two are joined. For more information on connecting classic and new Virtual Networks, see <bpt id=\"p9\">[</bpt>Connecting classic VNets to new VNets<ept id=\"p9\">](../virtual-network/virtual-networks-arm-asm-s2s.md)</ept>.",
      "nodes": [
        {
          "content": "If you have resources on a Virtual Network that is not usable by the cluster you plan on creating, you can create a new Virtual Network that is usable by the cluster, and connect it to the incompatible Virtual Network.",
          "pos": [
            0,
            218
          ]
        },
        {
          "content": "You can then create the cluster in the network version that it requires, and it will be able to access resources in the other network since the two are joined.",
          "pos": [
            219,
            378
          ]
        },
        {
          "content": "For more information on connecting classic and new Virtual Networks, see <bpt id=\"p9\">[</bpt>Connecting classic VNets to new VNets<ept id=\"p9\">](../virtual-network/virtual-networks-arm-asm-s2s.md)</ept>.",
          "pos": [
            379,
            582
          ]
        }
      ]
    },
    {
      "pos": [
        5071,
        5095
      ],
      "content": "Secured Virtual Networks"
    },
    {
      "pos": [
        5097,
        5567
      ],
      "content": "HDInsight is not supported on Azure Virtual Networks that explicitly restrict access to/from the Internet. For example, using Network Security Groups or ExpressRoute to block Internet traffic to resources in the Virtual Network. The HDInsight service is a managed service, and requires Internet access during provisioning and while running so that Azure can monitor the health of the cluster, initiate failover of cluster resources, and other automated management tasks.",
      "nodes": [
        {
          "content": "HDInsight is not supported on Azure Virtual Networks that explicitly restrict access to/from the Internet.",
          "pos": [
            0,
            106
          ]
        },
        {
          "content": "For example, using Network Security Groups or ExpressRoute to block Internet traffic to resources in the Virtual Network.",
          "pos": [
            107,
            228
          ]
        },
        {
          "content": "The HDInsight service is a managed service, and requires Internet access during provisioning and while running so that Azure can monitor the health of the cluster, initiate failover of cluster resources, and other automated management tasks.",
          "pos": [
            229,
            470
          ]
        }
      ]
    },
    {
      "pos": [
        5569,
        5681
      ],
      "content": "If you want to use HDInsight on a Virtual Network that blocks Internet traffic, you can use the following steps:"
    },
    {
      "pos": [
        5686,
        5995
      ],
      "content": "Create a new subnet within the Virtual Network. By default, the new subnet will be able to communicate with the Internet. This allows HDInsight to be installed on this subnet. Since the new subnet is in the same virtual network as the secured subnet(s), it can also communicate with resources installed there.",
      "nodes": [
        {
          "content": "Create a new subnet within the Virtual Network.",
          "pos": [
            0,
            47
          ]
        },
        {
          "content": "By default, the new subnet will be able to communicate with the Internet.",
          "pos": [
            48,
            121
          ]
        },
        {
          "content": "This allows HDInsight to be installed on this subnet.",
          "pos": [
            122,
            175
          ]
        },
        {
          "content": "Since the new subnet is in the same virtual network as the secured subnet(s), it can also communicate with resources installed there.",
          "pos": [
            176,
            309
          ]
        }
      ]
    },
    {
      "pos": [
        6000,
        6129
      ],
      "content": "Create the HDInsight cluster. When configuring the Virtual Network settings for the cluster, select the subnet created in step 1.",
      "nodes": [
        {
          "content": "Create the HDInsight cluster.",
          "pos": [
            0,
            29
          ]
        },
        {
          "content": "When configuring the Virtual Network settings for the cluster, select the subnet created in step 1.",
          "pos": [
            30,
            129
          ]
        }
      ]
    },
    {
      "pos": [
        6133,
        6374
      ],
      "content": "<ph id=\"ph20\">[AZURE.NOTE]</ph><ph id=\"ph21\"/> The above steps assume that you have not restricted communications to IP addresses <bpt id=\"p10\">_</bpt>within the Virtual Network IP address range<ept id=\"p10\">_</ept>. If you have, you may need to modify these restrictions to allow communication with the new subnet.",
      "nodes": [
        {
          "content": "<ph id=\"ph20\">[AZURE.NOTE]</ph><ph id=\"ph21\"/> The above steps assume that you have not restricted communications to IP addresses <bpt id=\"p10\">_</bpt>within the Virtual Network IP address range<ept id=\"p10\">_</ept>.",
          "pos": [
            0,
            216
          ]
        },
        {
          "content": "If you have, you may need to modify these restrictions to allow communication with the new subnet.",
          "pos": [
            217,
            315
          ]
        }
      ]
    },
    {
      "pos": [
        6376,
        6559
      ],
      "content": "If you are unsure whether you have applied restrictions to the subnet that you want to install HDInsight into, or want to remove restrictions from the subnet, use the following steps:"
    },
    {
      "pos": [
        6564,
        6614
      ],
      "content": "Open the <bpt id=\"p11\">[</bpt>Azure portal<ept id=\"p11\">](https://portal.azure.com)</ept>."
    },
    {
      "pos": [
        6619,
        6649
      ],
      "content": "Selecting the Virtual Network."
    },
    {
      "pos": [
        6654,
        6676
      ],
      "content": "Select <bpt id=\"p12\">__</bpt>Properties<ept id=\"p12\">__</ept>."
    },
    {
      "pos": [
        6681,
        6899
      ],
      "content": "Select <bpt id=\"p13\">__</bpt>Subnets<ept id=\"p13\">__</ept>, and then select the specific subnet. On the blade for this subnet, the <bpt id=\"p14\">__</bpt>Network security group<ept id=\"p14\">__</ept><ph id=\"ph22\"/> and <bpt id=\"p15\">__</bpt>Route table<ept id=\"p15\">__</ept><ph id=\"ph23\"/> entries will be set to a value of <bpt id=\"p16\">__</bpt>None<ept id=\"p16\">__</ept><ph id=\"ph24\"/> if no restrictions have been applied.",
      "nodes": [
        {
          "content": "Select <bpt id=\"p13\">__</bpt>Subnets<ept id=\"p13\">__</ept>, and then select the specific subnet.",
          "pos": [
            0,
            96
          ]
        },
        {
          "content": "On the blade for this subnet, the <bpt id=\"p14\">__</bpt>Network security group<ept id=\"p14\">__</ept><ph id=\"ph22\"/> and <bpt id=\"p15\">__</bpt>Route table<ept id=\"p15\">__</ept><ph id=\"ph23\"/> entries will be set to a value of <bpt id=\"p16\">__</bpt>None<ept id=\"p16\">__</ept><ph id=\"ph24\"/> if no restrictions have been applied.",
          "pos": [
            97,
            423
          ]
        }
      ]
    },
    {
      "pos": [
        6905,
        7137
      ],
      "content": "If restrictions have been applied, you can remove the restriction by selecting the <bpt id=\"p17\">__</bpt>Network security group<ept id=\"p17\">__</ept><ph id=\"ph25\"/> or <bpt id=\"p18\">__</bpt>Route table<ept id=\"p18\">__</ept><ph id=\"ph26\"/> entry, and then selecting <bpt id=\"p19\">__</bpt>None<ept id=\"p19\">__</ept>. Finally, select <bpt id=\"p20\">__</bpt>Save<ept id=\"p20\">__</ept><ph id=\"ph27\"/> from the Subnet blade to save the changes.",
      "nodes": [
        {
          "content": "If restrictions have been applied, you can remove the restriction by selecting the <bpt id=\"p17\">__</bpt>Network security group<ept id=\"p17\">__</ept><ph id=\"ph25\"/> or <bpt id=\"p18\">__</bpt>Route table<ept id=\"p18\">__</ept><ph id=\"ph26\"/> entry, and then selecting <bpt id=\"p19\">__</bpt>None<ept id=\"p19\">__</ept>.",
          "pos": [
            0,
            314
          ]
        },
        {
          "content": "Finally, select <bpt id=\"p20\">__</bpt>Save<ept id=\"p20\">__</ept><ph id=\"ph27\"/> from the Subnet blade to save the changes.",
          "pos": [
            315,
            437
          ]
        }
      ]
    },
    {
      "pos": [
        7147,
        7275
      ],
      "content": "<ph id=\"ph28\">![</ph>Image of the subnet blade and Network Security Group selection<ph id=\"ph29\">](./media/hdinsight-extend-hadoop-virtual-network/subnetnsg.png)</ph>"
    },
    {
      "pos": [
        7277,
        7575
      ],
      "content": "For more information on Network Security Groups, see <bpt id=\"p21\">[</bpt>Network Security Groups overview<ept id=\"p21\">](../virtual-network/virtual-networks-nsg.md)</ept>. For information on controlling routing in an Azure Virtual Network, see <bpt id=\"p22\">[</bpt>User Defined Routes and IP forwarding<ept id=\"p22\">](../virtual-network/virtual-networks-udr-overview.md)</ept>.",
      "nodes": [
        {
          "content": "For more information on Network Security Groups, see <bpt id=\"p21\">[</bpt>Network Security Groups overview<ept id=\"p21\">](../virtual-network/virtual-networks-nsg.md)</ept>.",
          "pos": [
            0,
            172
          ]
        },
        {
          "content": "For information on controlling routing in an Azure Virtual Network, see <bpt id=\"p22\">[</bpt>User Defined Routes and IP forwarding<ept id=\"p22\">](../virtual-network/virtual-networks-udr-overview.md)</ept>.",
          "pos": [
            173,
            378
          ]
        }
      ]
    },
    {
      "pos": [
        7577,
        7579
      ],
      "content": "##"
    },
    {
      "pos": [
        7597,
        7618
      ],
      "content": "Tasks and information"
    },
    {
      "pos": [
        7620,
        7743
      ],
      "content": "This section contains information on common tasks and information you may need when using HDInsight with a virtual network."
    },
    {
      "pos": [
        7748,
        7766
      ],
      "content": "Determine the FQDN"
    },
    {
      "pos": [
        7768,
        8091
      ],
      "content": "The HDInsight cluster will be assigned a specific fully qualified domain name (FQDN) for the Virtual Network interface. This is the address that you should use when connecting to the cluster from other resources on the virtual network. To determine the FQDN, use the following to URL to query the Ambari management service:",
      "nodes": [
        {
          "content": "The HDInsight cluster will be assigned a specific fully qualified domain name (FQDN) for the Virtual Network interface.",
          "pos": [
            0,
            119
          ]
        },
        {
          "content": "This is the address that you should use when connecting to the cluster from other resources on the virtual network.",
          "pos": [
            120,
            235
          ]
        },
        {
          "content": "To determine the FQDN, use the following to URL to query the Ambari management service:",
          "pos": [
            236,
            323
          ]
        }
      ]
    },
    {
      "pos": [
        8247,
        8414
      ],
      "content": "<ph id=\"ph30\">[AZURE.NOTE]</ph><ph id=\"ph31\"/> For more information on using Ambari with HDInsight, see <bpt id=\"p23\">[</bpt>Monitor Hadoop clusters in HDInsight using the Ambari API<ept id=\"p23\">](hdinsight-monitor-use-ambari-api.md)</ept>."
    },
    {
      "pos": [
        8416,
        8536
      ],
      "content": "You must specify the cluster name and a service and component running on the cluster, such as the YARN resource manager."
    },
    {
      "pos": [
        8540,
        8793
      ],
      "content": "<ph id=\"ph32\">[AZURE.NOTE]</ph><ph id=\"ph33\"/> The data returned is a JavaScript Object Notation (JSON) document that contains a lot of information about the component. To extract just the FQDN, you should use a JSON parser to retrieve the <ph id=\"ph34\">`host_components[0].HostRoles.host_name`</ph><ph id=\"ph35\"/> value.",
      "nodes": [
        {
          "content": "<ph id=\"ph32\">[AZURE.NOTE]</ph><ph id=\"ph33\"/> The data returned is a JavaScript Object Notation (JSON) document that contains a lot of information about the component.",
          "pos": [
            0,
            168
          ]
        },
        {
          "content": "To extract just the FQDN, you should use a JSON parser to retrieve the <ph id=\"ph34\">`host_components[0].HostRoles.host_name`</ph><ph id=\"ph35\"/> value.",
          "pos": [
            169,
            321
          ]
        }
      ]
    },
    {
      "pos": [
        8795,
        8953
      ],
      "content": "For example, to return the FQDN from an HDInsight Hadoop cluster, you can use one of the following methods to retrieve the data for the YARN resource manager:"
    },
    {
      "pos": [
        8957,
        9011
      ],
      "content": "<bpt id=\"p24\">[</bpt>Azure PowerShell<ept id=\"p24\">](../powershell-install-configure.md)</ept>"
    },
    {
      "pos": [
        9722,
        9790
      ],
      "content": "<bpt id=\"p25\">[</bpt>cURL<ept id=\"p25\">](http://curl.haxx.se/)</ept><ph id=\"ph36\"/> and <bpt id=\"p26\">[</bpt>jq<ept id=\"p26\">](http://stedolan.github.io/jq/)</ept>"
    },
    {
      "pos": [
        10020,
        10039
      ],
      "content": "Connecting to HBase"
    },
    {
      "pos": [
        10041,
        10202
      ],
      "content": "To connect to HBase remotely by using the Java API, you must determine the ZooKeeper quorum addresses for the HBase cluster and specify this in your application."
    },
    {
      "pos": [
        10204,
        10313
      ],
      "content": "To get the ZooKeeper quorum address, use one of the following methods to query the Ambari management service:"
    },
    {
      "pos": [
        10317,
        10371
      ],
      "content": "<bpt id=\"p27\">[</bpt>Azure PowerShell<ept id=\"p27\">](../powershell-install-configure.md)</ept>"
    },
    {
      "pos": [
        11110,
        11178
      ],
      "content": "<bpt id=\"p28\">[</bpt>cURL<ept id=\"p28\">](http://curl.haxx.se/)</ept><ph id=\"ph37\"/> and <bpt id=\"p29\">[</bpt>jq<ept id=\"p29\">](http://stedolan.github.io/jq/)</ept>"
    },
    {
      "pos": [
        11441,
        11608
      ],
      "content": "<ph id=\"ph38\">[AZURE.NOTE]</ph><ph id=\"ph39\"/> For more information on using Ambari with HDInsight, see <bpt id=\"p30\">[</bpt>Monitor Hadoop clusters in HDInsight using the Ambari API<ept id=\"p30\">](hdinsight-monitor-use-ambari-api.md)</ept>."
    },
    {
      "pos": [
        11610,
        11682
      ],
      "content": "Once you have the quorum information, use it in your client application."
    },
    {
      "pos": [
        11684,
        11859
      ],
      "content": "For example, for a Java application that uses the HBase API, you would add an <bpt id=\"p31\">**</bpt>hbase-site.xml<ept id=\"p31\">**</ept><ph id=\"ph40\"/> file to the project and specify the quorum information in the file as follows:"
    },
    {
      "pos": [
        12247,
        12274
      ],
      "content": "Verify network connectivity"
    },
    {
      "pos": [
        12276,
        12425
      ],
      "content": "Some services, such as SQL Server, can limit incoming network connections. This will prevent HDInsight from successfully working with these services.",
      "nodes": [
        {
          "content": "Some services, such as SQL Server, can limit incoming network connections.",
          "pos": [
            0,
            74
          ]
        },
        {
          "content": "This will prevent HDInsight from successfully working with these services.",
          "pos": [
            75,
            149
          ]
        }
      ]
    },
    {
      "pos": [
        12427,
        12792
      ],
      "content": "If you encounter problems accessing a service from HDInsight, consult the documentation for the service to ensure that you have enabled network access. You can also verify network access by creating an Azure virtual machine on the same virtual network, and use client utilities to verify that the virtual machine can connect to the service over the virtual network.",
      "nodes": [
        {
          "content": "If you encounter problems accessing a service from HDInsight, consult the documentation for the service to ensure that you have enabled network access.",
          "pos": [
            0,
            151
          ]
        },
        {
          "content": "You can also verify network access by creating an Azure virtual machine on the same virtual network, and use client utilities to verify that the virtual machine can connect to the service over the virtual network.",
          "pos": [
            152,
            365
          ]
        }
      ]
    },
    {
      "pos": [
        12794,
        12796
      ],
      "content": "##"
    },
    {
      "pos": [
        12818,
        12828
      ],
      "content": "Next steps"
    },
    {
      "pos": [
        12830,
        12913
      ],
      "content": "The following examples demonstrate how to use HDInsight with Azure Virtual Network:"
    },
    {
      "pos": [
        12917,
        13152
      ],
      "content": "<bpt id=\"p32\">[</bpt>Analyze sensor data with Storm and HBase in HDInsight<ept id=\"p32\">](hdinsight-storm-sensor-data-analysis.md)</ept><ph id=\"ph41\"/> - Demonstrates how to configure a Storm and HBase cluster in a virtual network, as well as how to remotely write data to HBase from Storm."
    },
    {
      "pos": [
        13156,
        13352
      ],
      "content": "<bpt id=\"p33\">[</bpt>Provision Hadoop clusters in HDInsight<ept id=\"p33\">](hdinsight-hadoop-provision-linux-clusters.md)</ept><ph id=\"ph42\"/> - Provides information on provisioning Hadoop clusters, including information on using Azure Virtual Network."
    },
    {
      "pos": [
        13356,
        13521
      ],
      "content": "<bpt id=\"p34\">[</bpt>Use Sqoop with Hadoop in HDInsight<ept id=\"p34\">](hdinsight-use-sqoop-mac-linux.md)</ept><ph id=\"ph43\"/> - Provides information on using Sqoop to transfer data with SQL Server over a virtual network."
    },
    {
      "pos": [
        13523,
        13657
      ],
      "content": "To learn more about Azure virtual networks, see the <bpt id=\"p35\">[</bpt>Azure Virtual Network overview<ept id=\"p35\">](../virtual-network/virtual-networks-overview.md)</ept>."
    }
  ],
  "content": "<properties\n    pageTitle=\"Extend HDInsight with Virtual Network | Microsoft Azure\"  \n    description=\"Learn how to use Azure Virtual Network to connect HDInsight to other cloud resources, or resources in your datacenter\"\n    services=\"hdinsight\"\n    documentationCenter=\"\"\n    authors=\"Blackmist\"\n    manager=\"paulettm\"\n    editor=\"cgronlun\"/>\n\n<tags\n   ms.service=\"hdinsight\"\n   ms.devlang=\"na\"\n   ms.topic=\"article\"\n   ms.tgt_pltfrm=\"na\"\n   ms.workload=\"big-data\"\n   ms.date=\"01/29/2016\"\n   ms.author=\"larryfr\"/>\n\n\n#Extend HDInsight capabilities by using Azure Virtual Network\n\nAzure Virtual Network allows you to extend your Hadoop solutions to incorporate on-premises resources such as SQL Server, or to create secure private networks between resources in the cloud.\n\n> [AZURE.NOTE] HDInsight does not support affinity-based Azure virtual networks. When using HDInsight, you must use location-based virtual networks.\n\n\n##<a id=\"whatis\"></a>What is Azure Virtual Network?\n\n[Azure Virtual Network](https://azure.microsoft.com/documentation/services/virtual-network/) allows you to create a secure, persistent network containing the resources you need for your solution. A virtual network allows you to:\n\n* Connect cloud resources together in a private network (cloud-only).\n\n    ![diagram of cloud-only configuration](media/hdinsight-extend-hadoop-virtual-network/cloud-only.png)\n\n    Using Virtual Network to link Azure services with Azure HDInsight enables the following scenarios:\n\n    * **Invoking HDInsight services or jobs** from Azure websites or services running in Azure virtual machines.\n\n    * **Directly transferring data** between HDInsight and Azure SQL Database, SQL Server, or another data storage solution running on a virtual machine.\n\n    * **Combining multiple HDInsight servers** into a single solution. An example is using an HDInsight Storm server to consume incoming data, and then storing the processed data to an HDInsight HBase server. The raw data might also be stored to an HDInsight Hadoop server for future analysis by using MapReduce.\n\n* Connect your cloud resources to your local datacenter network (site-to-site or point-to-site) by using a virtual private network (VPN).\n\n    Site-to-site configuration allows you to connect multiple resources from your datacenter to the Azure virtual network by using a hardware VPN or the Routing and Remote Access service.\n\n    ![diagram of site-to-site configuration](media/hdinsight-extend-hadoop-virtual-network/site-to-site.png)\n\n    Point-to-site configuration allows you to connect a specific resource to the Azure virtual network by using software VPN.\n\n    ![diagram of point-to-site configuration](media/hdinsight-extend-hadoop-virtual-network/point-to-site.png)\n\n    Using Virtual Network to link the cloud and your datacenter enables similar scenarios to the cloud-only configuration. But instead of being limited to working with resources in the cloud, you can also work with resources in your datacenter.\n\n    * **Directly transferring data** between HDInsight and your datacenter. An example is using Sqoop to transfer data to or from SQL Server or reading data generated by a line-of-business (LOB) application.\n\n    * **Invoking HDInsight services or jobs** from an LOB application. An example is using HBase Java APIs to store and retrieve data from an HDInsight HBase cluster.\n\nFor more information on Virtual Network features, benefits, and capabilities, see the [Azure Virtual Network overview](../virtual-network/virtual-networks-overview.md).\n\n> [AZURE.NOTE] You must create the Azure Virtual Network before provisioning an HDInsight cluster. For more information, see [Virtual Network configuration tasks](https://azure.microsoft.com/documentation/services/virtual-network/).\n\n## Virtual Network requirements\n\n> [AZURE.IMPORTANT] Creating an HDInsight cluster on a Virtual Network requires specific Virtual Network configurations, which are described in this section.\n\n###Location-based Virtual networks\n\nAzure HDInsight supports only location-based virtual networks, and does not currently work with virtual networks based on affinity group. \n\n###Subnets\n\nIt is highly recommended that you create a single subnet for each HDInsight cluster. \n\n###Classic or v2 Virtual Network\n\nWindows-based clusters require a v1 (Classic) Virtual Network, while Linux-based clusters require a v2 (Azure Resource Manager,) Virtual Network. If you do not have the correct type of network, it will not be usable when you create the cluster.\n\nIf you have resources on a Virtual Network that is not usable by the cluster you plan on creating, you can create a new Virtual Network that is usable by the cluster, and connect it to the incompatible Virtual Network. You can then create the cluster in the network version that it requires, and it will be able to access resources in the other network since the two are joined. For more information on connecting classic and new Virtual Networks, see [Connecting classic VNets to new VNets](../virtual-network/virtual-networks-arm-asm-s2s.md).\n\n###Secured Virtual Networks\n\nHDInsight is not supported on Azure Virtual Networks that explicitly restrict access to/from the Internet. For example, using Network Security Groups or ExpressRoute to block Internet traffic to resources in the Virtual Network. The HDInsight service is a managed service, and requires Internet access during provisioning and while running so that Azure can monitor the health of the cluster, initiate failover of cluster resources, and other automated management tasks.\n\nIf you want to use HDInsight on a Virtual Network that blocks Internet traffic, you can use the following steps:\n\n1. Create a new subnet within the Virtual Network. By default, the new subnet will be able to communicate with the Internet. This allows HDInsight to be installed on this subnet. Since the new subnet is in the same virtual network as the secured subnet(s), it can also communicate with resources installed there.\n\n2. Create the HDInsight cluster. When configuring the Virtual Network settings for the cluster, select the subnet created in step 1.\n\n> [AZURE.NOTE] The above steps assume that you have not restricted communications to IP addresses _within the Virtual Network IP address range_. If you have, you may need to modify these restrictions to allow communication with the new subnet.\n\nIf you are unsure whether you have applied restrictions to the subnet that you want to install HDInsight into, or want to remove restrictions from the subnet, use the following steps:\n\n1. Open the [Azure portal](https://portal.azure.com).\n\n2. Selecting the Virtual Network.\n\n3. Select __Properties__.\n\n4. Select __Subnets__, and then select the specific subnet. On the blade for this subnet, the __Network security group__ and __Route table__ entries will be set to a value of __None__ if no restrictions have been applied.\n\n    If restrictions have been applied, you can remove the restriction by selecting the __Network security group__ or __Route table__ entry, and then selecting __None__. Finally, select __Save__ from the Subnet blade to save the changes.\n    \n    ![Image of the subnet blade and Network Security Group selection](./media/hdinsight-extend-hadoop-virtual-network/subnetnsg.png)\n\nFor more information on Network Security Groups, see [Network Security Groups overview](../virtual-network/virtual-networks-nsg.md). For information on controlling routing in an Azure Virtual Network, see [User Defined Routes and IP forwarding](../virtual-network/virtual-networks-udr-overview.md).\n\n##<a id=\"tasks\"></a>Tasks and information\n\nThis section contains information on common tasks and information you may need when using HDInsight with a virtual network.\n\n###Determine the FQDN\n\nThe HDInsight cluster will be assigned a specific fully qualified domain name (FQDN) for the Virtual Network interface. This is the address that you should use when connecting to the cluster from other resources on the virtual network. To determine the FQDN, use the following to URL to query the Ambari management service:\n\n    https://<clustername>.azurehdinsight.net/ambari/api/v1/clusters/<clustername>.azurehdinsight.net/services/<servicename>/components/<componentname>\n\n> [AZURE.NOTE] For more information on using Ambari with HDInsight, see [Monitor Hadoop clusters in HDInsight using the Ambari API](hdinsight-monitor-use-ambari-api.md).\n\nYou must specify the cluster name and a service and component running on the cluster, such as the YARN resource manager.\n\n> [AZURE.NOTE] The data returned is a JavaScript Object Notation (JSON) document that contains a lot of information about the component. To extract just the FQDN, you should use a JSON parser to retrieve the `host_components[0].HostRoles.host_name` value.\n\nFor example, to return the FQDN from an HDInsight Hadoop cluster, you can use one of the following methods to retrieve the data for the YARN resource manager:\n\n* [Azure PowerShell](../powershell-install-configure.md)\n\n        $ClusterDnsName = <clustername>\n        $Username = <cluster admin username>\n        $Password = <cluster admin password>\n        $DnsSuffix = \".azurehdinsight.net\"\n        $ClusterFQDN = $ClusterDnsName + $DnsSuffix\n\n        $webclient = new-object System.Net.WebClient\n        $webclient.Credentials = new-object System.Net.NetworkCredential($Username, $Password)\n\n        $Url = \"https://\" + $ClusterFQDN + \"/ambari/api/v1/clusters/\" + $ClusterFQDN + \"/services/yarn/     components/resourcemanager\"\n        $Response = $webclient.DownloadString($Url)\n        $JsonObject = $Response | ConvertFrom-Json\n        $FQDN = $JsonObject.host_components[0].HostRoles.host_name\n        Write-host $FQDN\n\n* [cURL](http://curl.haxx.se/) and [jq](http://stedolan.github.io/jq/)\n\n        curl -G -u <username>:<password> https://<clustername>.azurehdinsight.net/ambari/api/v1/clusters/<clustername>.azurehdinsight.net/services/yarn/components/resourcemanager | jq .host_components[0].HostRoles.host_name\n\n###Connecting to HBase\n\nTo connect to HBase remotely by using the Java API, you must determine the ZooKeeper quorum addresses for the HBase cluster and specify this in your application.\n\nTo get the ZooKeeper quorum address, use one of the following methods to query the Ambari management service:\n\n* [Azure PowerShell](../powershell-install-configure.md)\n\n        $ClusterDnsName = <clustername>\n        $Username = <cluster admin username>\n        $Password = <cluster admin password>\n        $DnsSuffix = \".azurehdinsight.net\"\n        $ClusterFQDN = $ClusterDnsName + $DnsSuffix\n\n        $webclient = new-object System.Net.WebClient\n        $webclient.Credentials = new-object System.Net.NetworkCredential($Username, $Password)\n\n        $Url = \"https://\" + $ClusterFQDN + \"/ambari/api/v1/clusters/\" + $ClusterFQDN + \"/configurations?type=hbase-site&tag=default&fields=items/properties/hbase.zookeeper.quorum\"\n        $Response = $webclient.DownloadString($Url)\n        $JsonObject = $Response | ConvertFrom-Json\n        Write-host $JsonObject.items[0].properties.'hbase.zookeeper.quorum'\n\n* [cURL](http://curl.haxx.se/) and [jq](http://stedolan.github.io/jq/)\n\n        curl -G -u <username>:<password> \"https://<clustername>.azurehdinsight.net/ambari/api/v1/clusters/<clustername>.azurehdinsight.net/configurations?type=hbase-site&tag=default&fields=items/properties/hbase.zookeeper.quorum\" | jq .items[0].properties[]\n\n> [AZURE.NOTE] For more information on using Ambari with HDInsight, see [Monitor Hadoop clusters in HDInsight using the Ambari API](hdinsight-monitor-use-ambari-api.md).\n\nOnce you have the quorum information, use it in your client application.\n\nFor example, for a Java application that uses the HBase API, you would add an **hbase-site.xml** file to the project and specify the quorum information in the file as follows:\n\n```\n<configuration>\n  <property>\n    <name>hbase.cluster.distributed</name>\n    <value>true</value>\n  </property>\n  <property>\n    <name>hbase.zookeeper.quorum</name>\n    <value>zookeeper0.address,zookeeper1.address,zookeeper2.address</value>\n  </property>\n  <property>\n    <name>hbase.zookeeper.property.clientPort</name>\n    <value>2181</value>\n  </property>\n</configuration>\n```\n\n###Verify network connectivity\n\nSome services, such as SQL Server, can limit incoming network connections. This will prevent HDInsight from successfully working with these services.\n\nIf you encounter problems accessing a service from HDInsight, consult the documentation for the service to ensure that you have enabled network access. You can also verify network access by creating an Azure virtual machine on the same virtual network, and use client utilities to verify that the virtual machine can connect to the service over the virtual network.\n\n##<a id=\"nextsteps\"></a>Next steps\n\nThe following examples demonstrate how to use HDInsight with Azure Virtual Network:\n\n* [Analyze sensor data with Storm and HBase in HDInsight](hdinsight-storm-sensor-data-analysis.md) - Demonstrates how to configure a Storm and HBase cluster in a virtual network, as well as how to remotely write data to HBase from Storm.\n\n* [Provision Hadoop clusters in HDInsight](hdinsight-hadoop-provision-linux-clusters.md) - Provides information on provisioning Hadoop clusters, including information on using Azure Virtual Network.\n\n* [Use Sqoop with Hadoop in HDInsight](hdinsight-use-sqoop-mac-linux.md) - Provides information on using Sqoop to transfer data with SQL Server over a virtual network.\n\nTo learn more about Azure virtual networks, see the [Azure Virtual Network overview](../virtual-network/virtual-networks-overview.md).\n"
}