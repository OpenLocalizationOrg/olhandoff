{"nodes":[{"content":"Azure Backup - Deploy and manage back up for DPM using PowerShell | Microsoft Azure","pos":[27,110]},{"content":"Learn how to deploy and manage Azure Backup for Data Protection Manager (DPM) using PowerShell","pos":[129,223]},{"content":"Deploy and manage backup to Azure for Data Protection Manager (DPM) servers using PowerShell","pos":[552,644]},{"content":"This article shows you how to use PowerShell to setup Azure Backup on a DPM server, and to manage backup and recovery.","pos":[646,764]},{"content":"Setting up the PowerShell environment","pos":[769,806]},{"content":"Before you can use PowerShell to manage backups from Data Protection Manager to Azure, you will need to have the right environment in PowerShell.","pos":[914,1059]},{"content":"At the start of the PowerShell session, ensure that you run the following command to import the right modules and allow you to correctly reference the DPM cmdlets:","pos":[1060,1223]},{"content":"Setup and Registration","pos":[1623,1645]},{"content":"To begin:","pos":[1646,1655]},{"pos":[1660,1778],"content":"<bpt id=\"p1\">[</bpt>Download latest PowerShell<ept id=\"p1\">](https://github.com/Azure/azure-powershell/releases)</ept> (minimum version required is : 1.0.0)"},{"pos":[1782,1907],"content":"Enable the Azure Backup commandlets by switching to <bpt id=\"p1\">*</bpt>AzureResourceManager<ept id=\"p1\">*</ept> mode by using the <bpt id=\"p2\">**</bpt>Switch-AzureMode<ept id=\"p2\">**</ept> commandlet:"},{"content":"The following setup and registration tasks can be automated with PowerShell:","pos":[1964,2040]},{"content":"Create a backup vault","pos":[2044,2065]},{"content":"Installing the Azure Backup agent","pos":[2068,2101]},{"content":"Registering with the Azure Backup service","pos":[2104,2145]},{"content":"Networking settings","pos":[2148,2167]},{"content":"Encryption settings","pos":[2170,2189]},{"content":"Create a backup vault","pos":[2195,2216]},{"content":"For customers using Azure Backup for the first time, you need to register the Azure Backup provider to be used with your subscription.","pos":[2236,2370]},{"content":"This can be done by running the following command: Register-AzureProvider -ProviderNamespace \"Microsoft.Backup\"","pos":[2371,2482]},{"content":"You can create a new backup vault using the <bpt id=\"p1\">**</bpt>New-AzureRMBackupVault<ept id=\"p1\">**</ept> commandlet.","pos":[2484,2566]},{"content":"The backup vault is an ARM resource, so you need to place it within a Resource Group.","pos":[2567,2652]},{"content":"In an elevated Azure PowerShell console, run the following commands:","pos":[2653,2721]},{"pos":[2922,3038],"content":"You can get a list of all the backup vaults in a given subscription using the <bpt id=\"p1\">**</bpt>Get-AzureRMBackupVault<ept id=\"p1\">**</ept> commandlet."},{"content":"Installing the Azure Backup agent on a DPM Server","pos":[3045,3094]},{"content":"Before you install the Azure Backup agent, you need to have the installer downloaded and present on the Windows Server.","pos":[3095,3214]},{"content":"You can get the latest version of the installer from the <bpt id=\"p1\">[</bpt>Microsoft Download Center<ept id=\"p1\">](http://aka.ms/azurebackup_agent)</ept> or from the backup vault's Dashboard page.","pos":[3215,3375]},{"content":"Save the installer to an easily accessible location like *C:\\Downloads\\*.","pos":[3376,3449]},{"pos":[3451,3555],"content":"To install the agent, run the following command in an elevated PowerShell console <bpt id=\"p1\">**</bpt>on the DPM server<ept id=\"p1\">**</ept>:"},{"content":"This installs the agent with all the default options.","pos":[3600,3653]},{"content":"The installation takes a few minutes in the background.","pos":[3654,3709]},{"content":"If you do not specify the <bpt id=\"p1\">*</bpt>/nu<ept id=\"p1\">*</ept> option the <bpt id=\"p2\">**</bpt>Windows Update<ept id=\"p2\">**</ept> window will open at the end of the installation to check for any updates.","pos":[3710,3845]},{"content":"The agent will show in the list of installed programs.","pos":[3847,3901]},{"content":"To see the list of installed programs, go to <bpt id=\"p1\">**</bpt>Control Panel<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>Programs<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Programs and Features<ept id=\"p3\">**</ept>","pos":[3902,4007]},{"content":"Agent installed","pos":[4012,4027]},{"content":"Installation options","pos":[4094,4114]},{"content":"To see all the options available via the command-line, use the following command:","pos":[4115,4196]},{"content":"The available options include:","pos":[4241,4271]},{"content":"Option","pos":[4275,4281]},{"content":"Details","pos":[4284,4291]},{"content":"Default","pos":[4294,4301]},{"content":"/q","pos":[4331,4333]},{"content":"Quiet installation","pos":[4336,4354]},{"content":"/p:\"location\"","pos":[4363,4376]},{"content":"Path to the installation folder for the Azure Backup agent.","pos":[4379,4438]},{"content":"C:\\Program Files\\Microsoft Azure Recovery Services Agent","pos":[4441,4497]},{"content":"/s:\"location\"","pos":[4502,4515]},{"content":"Path to the cache folder for the Azure Backup agent.","pos":[4518,4570]},{"content":"C:\\Program Files\\Microsoft Azure Recovery Services Agent\\Scratch","pos":[4573,4637]},{"content":"/m","pos":[4642,4644]},{"content":"Opt-in to Microsoft Update","pos":[4647,4673]},{"content":"/nu","pos":[4682,4685]},{"content":"Do not Check for updates after installation is complete","pos":[4688,4743]},{"content":"/d","pos":[4752,4754]},{"content":"Uninstalls Microsoft Azure Recovery Services Agent","pos":[4757,4807]},{"content":"/ph","pos":[4816,4819]},{"content":"Proxy Host Address","pos":[4822,4840]},{"content":"/po","pos":[4849,4852]},{"content":"Proxy Host Port Number","pos":[4855,4877]},{"content":"/pu","pos":[4886,4889]},{"content":"Proxy Host UserName","pos":[4892,4911]},{"content":"/pw","pos":[4920,4923]},{"content":"Proxy Password","pos":[4926,4940]},{"content":"Registering with the Azure Backup service","pos":[4952,4993]},{"content":"Before you can register with the Azure Backup service, you need to ensure that the <bpt id=\"p1\">[</bpt>prerequisites<ept id=\"p1\">](backup-azure-dpm-introduction.md)</ept> are met.","pos":[4994,5135]},{"content":"You must:","pos":[5136,5145]},{"content":"Have a valid Azure subscription","pos":[5149,5180]},{"content":"Have a backup vault","pos":[5183,5202]},{"pos":[5204,5384],"content":"To download the vault credentials, run the <bpt id=\"p1\">**</bpt>Get-AzureBackupVaultCredentials<ept id=\"p1\">**</ept> commandlet in an Azure PowerShell console and store it in a convenient location like *C:\\Downloads\\*."},{"pos":[5644,5785],"content":"Registering the machine with the vault is done using the <bpt id=\"p1\">[</bpt>Start-DPMCloudRegistration<ept id=\"p1\">](https://technet.microsoft.com/library/jj612787)</ept> cmdlet:"},{"content":"This will register the DPM Server named “TestingServer” with Microsoft Azure Vault using the specified vault credentials.","pos":[5938,6059]},{"content":"Do not use relative paths to specify the vault credentials file.","pos":[6081,6145]},{"content":"You must provide an absolute path as an input to the cmdlet.","pos":[6146,6206]},{"content":"Initial configuration settings","pos":[6212,6242]},{"content":"Once the DPM Server is registered with the Azure Backup vault, it will start with default subscription settings.","pos":[6243,6355]},{"content":"These subscription settings include Networking, Encryption and the Staging area.","pos":[6356,6436]},{"content":"To begin changing the subscription settings you need to first get a handle on the existing (default) settings using the <bpt id=\"p1\">[</bpt>Get-DPMCloudSubscriptionSetting<ept id=\"p1\">](https://technet.microsoft.com/library/jj612793)</ept> cmdlet:","pos":[6437,6646]},{"content":"All modifications are made to this local PowerShell object <ph id=\"ph1\">```$setting```</ph>  and then the full object is committed to DPM and Azure Backup to save them using the <bpt id=\"p1\">[</bpt>Set-DPMCloudSubscriptionSetting<ept id=\"p1\">](https://technet.microsoft.com/library/jj612791)</ept> cmdlet.","pos":[6731,6980]},{"content":"You need to use the <ph id=\"ph1\">```–Commit```</ph> flag to ensure that the changes are persisted.","pos":[6981,7061]},{"content":"The settings will not be applied and used by Azure Backup unless committed.","pos":[7062,7137]},{"content":"Networking","pos":[7261,7271]},{"content":"If the connectivity of the DPM machine to the Azure Backup service on the internet is through a proxy server, then the proxy server settings should be provided for backups to succeed.","pos":[7272,7455]},{"content":"This is done by using the <ph id=\"ph1\">```-ProxyServer```</ph>, <ph id=\"ph2\">```-ProxyPort```</ph>, <ph id=\"ph3\">```-ProxyUsername```</ph> and the <ph id=\"ph4\">```ProxyPassword```</ph> parameters with the <bpt id=\"p1\">[</bpt>Set-DPMCloudSubscriptionSetting<ept id=\"p1\">](https://technet.microsoft.com/library/jj612791)</ept> cmdlet.","pos":[7456,7678]},{"content":"In this example, there is no proxy server so we are explicitly clearing any proxy-related information.","pos":[7679,7781]},{"content":"Bandwidth usage can also be controlled with options of <ph id=\"ph1\">```-WorkHourBandwidth```</ph> and <ph id=\"ph2\">```-NonWorkHourBandwidth```</ph> for a given set of days of the week.","pos":[7902,8050]},{"content":"In this example we are not setting any throttling.","pos":[8051,8101]},{"content":"Configuring the staging Area","pos":[8229,8257]},{"content":"The Azure Backup agent running on the DPM server needs temporary storage for data restored from the cloud (local staging area).","pos":[8258,8385]},{"content":"Configure the staging area using the <bpt id=\"p1\">[</bpt>Set-DPMCloudSubscriptionSetting<ept id=\"p1\">](https://technet.microsoft.com/library/jj612791)</ept> cmdlet and the <ph id=\"ph1\">```-StagingAreaPath```</ph> parameter.","pos":[8386,8553]},{"content":"In the example above, the staging area will be set to <bpt id=\"p1\">*</bpt>C:\\StagingArea<ept id=\"p1\">*</ept> in the PowerShell object <ph id=\"ph1\">```$setting```</ph>.","pos":[8699,8810]},{"content":"Ensure that the specified folder already exists, or else the final commit of the subscription settings will fail.","pos":[8811,8924]},{"content":"Encryption settings","pos":[8931,8950]},{"content":"The backup data sent to Azure Backup is encrypted to protect the confidentiality of the data.","pos":[8951,9044]},{"content":"The encryption passphrase is the \"password\" to decrypt the data at the time of restore.","pos":[9045,9132]},{"content":"It is important to keep this information safe and secure once it is set.","pos":[9133,9205]},{"content":"In the example below, the first command converts the string <ph id=\"ph1\">```passphrase123456789```</ph> to a secure string and assigns the secure string to the variable named <ph id=\"ph2\">```$Passphrase```</ph>.","pos":[9207,9382]},{"content":"the second command sets the secure string in <ph id=\"ph1\">```$Passphrase```</ph> as the password for encrypting backups.","pos":[9383,9485]},{"content":"Keep the passphrase information safe and secure once it is set.","pos":[9747,9810]},{"content":"You will not be able to restore data from Azure without this passphrase.","pos":[9811,9883]},{"content":"At this point, you should have made all the required changes to the <ph id=\"ph1\">```$setting```</ph> object.","pos":[9885,9975]},{"content":"Remember to commit the changes.","pos":[9976,10007]},{"content":"Protect data to Azure Backup","pos":[10130,10158]},{"content":"In this section, you will add a production server to DPM and then protect the data to local DPM storage and then to Azure Backup.","pos":[10159,10288]},{"content":"In the examples we will demonstrate how to back up files and folders.","pos":[10289,10358]},{"content":"The logic can easily be extended to backup any DPM-supported data source.","pos":[10359,10432]},{"content":"All your DPM backups are governed by a Protection Group (PG) with four parts:","pos":[10433,10510]},{"content":"<bpt id=\"p1\">**</bpt>Group members<ept id=\"p1\">**</ept> is a list of all the protectable objects (also known as <bpt id=\"p2\">*</bpt>Datasources<ept id=\"p2\">*</ept> in DPM) that you want to protect in the same protection group.","pos":[10515,10665]},{"content":"For example, you may want to protect production VMs in one protection group and SQL Server databases in another protection group as they may have different backup requirements.","pos":[10666,10842]},{"content":"Before you can back up any datasource on a production server you need to make sure the DPM Agent is installed on the server and is managed by DPM.","pos":[10843,10989]},{"content":"Follow the steps for <bpt id=\"p1\">[</bpt>installing the DPM Agent<ept id=\"p1\">](https://technet.microsoft.com/library/bb870935.aspx)</ept> and linking it to the appropriate DPM Server.","pos":[10990,11136]},{"content":"<bpt id=\"p1\">**</bpt>Data protection method<ept id=\"p1\">**</ept> specifies the target backup locations - tape, disk, and cloud.","pos":[11140,11229]},{"content":"In our example we will protect data to the local disk and to the cloud.","pos":[11230,11301]},{"pos":[11305,11467],"content":"A <bpt id=\"p1\">**</bpt>backup schedule<ept id=\"p1\">**</ept> that specifies when backups need to be taken and how often the data should be synchronized between the DPM Server and the production server."},{"pos":[11471,11559],"content":"A <bpt id=\"p1\">**</bpt>retention schedule<ept id=\"p1\">**</ept> that specifies how long to retain the recovery points in Azure."},{"content":"Creating a protection group","pos":[11565,11592]},{"pos":[11593,11724],"content":"Start by creating a new Protection Group using the <bpt id=\"p1\">[</bpt>New-DPMProtectionGroup<ept id=\"p1\">](https://technet.microsoft.com/library/hh881722)</ept> cmdlet."},{"content":"The above cmdlet will create a Protection Group named <bpt id=\"p1\">*</bpt>ProtectGroup01<ept id=\"p1\">*</ept>.","pos":[11828,11899]},{"content":"An existing protection group can also be modified later to add backup to the Azure cloud.","pos":[11900,11989]},{"content":"However, to make any changes to the Protection Group - new or existing - we need to get a handle on a <bpt id=\"p1\">*</bpt>modifiable<ept id=\"p1\">*</ept> object using the <bpt id=\"p2\">[</bpt>Get-DPMModifiableProtectionGroup<ept id=\"p2\">](https://technet.microsoft.com/library/hh881713)</ept> cmdlet.","pos":[11990,12212]},{"content":"Adding group members to the Protection Group","pos":[12276,12320]},{"content":"Each DPM Agent knows the list of datasources on the server that it is installed on.","pos":[12321,12404]},{"content":"To add a datasource to the Protection Group, the DPM Agent needs to first send a list of the datasources back to the DPM server.","pos":[12405,12533]},{"content":"One or more datasources are then selected and added to the Protection Group.","pos":[12534,12610]},{"content":"The PowerShell steps needed to get achieve this are:","pos":[12611,12663]},{"content":"Fetch a list of all servers managed by DPM through the DPM Agent.","pos":[12668,12733]},{"content":"Choose a specific server.","pos":[12737,12762]},{"content":"Fetch a list of all datasources on the server.","pos":[12766,12812]},{"content":"Choose one or more datasources and add them to the Protection Group","pos":[12816,12883]},{"content":"The list of servers on which the DPM Agent is installed and is being managed by the DPM Server is acquired with the <bpt id=\"p1\">[</bpt>Get-DPMProductionServer<ept id=\"p1\">](https://technet.microsoft.com/library/hh881600)</ept> cmdlet.","pos":[12885,13082]},{"content":"In this example we will filter and only configure PS with name <bpt id=\"p1\">*</bpt>productionserver01<ept id=\"p1\">*</ept> for backup.","pos":[13083,13178]},{"content":"Now fetch the list of datasources on <ph id=\"ph1\">```$server```</ph> using the <bpt id=\"p1\">[</bpt>Get-DPMDatasource<ept id=\"p1\">](https://technet.microsoft.com/library/hh881605)</ept> cmdlet.","pos":[13315,13451]},{"content":"In this example we are filtering for the volume <bpt id=\"p1\">*</bpt>D:\\* which we want to configure for backup. This datasource is then added to the Protection Group using the <bpt id=\"p2\">[</bpt>Add-DPMChildDatasource<ept id=\"p2\">](https://technet.microsoft.com/library/hh881732)</ept> cmdlet. Remember to use the <ept id=\"p1\">*</ept>modifable* protection group object <ph id=\"ph1\">```$MPG```</ph> to make the additions.","pos":[13452,13779]},{"content":"Repeat this step as many times as required, until you have added all the chosen datasources to the protection group.","pos":[13965,14081]},{"content":"You can also start with just one datasource, and complete the workflow for creating the Protection Group, and at a later point add more datasources to the Protection Group.","pos":[14082,14254]},{"content":"Selecting the data protection method","pos":[14260,14296]},{"content":"Once the datasources have been added to the Protection Group, the next step is to specify the protection method using the <bpt id=\"p1\">[</bpt>Set-DPMProtectionType<ept id=\"p1\">](https://technet.microsoft.com/library/hh881725)</ept> cmdlet.","pos":[14297,14498]},{"content":"In this example, the Protection Group will be setup for local disk and cloud backup.","pos":[14499,14583]},{"content":"You also need to specify the datasource that you want to protect to cloud using the <bpt id=\"p1\">[</bpt>Add-DPMChildDatasource<ept id=\"p1\">](https://technet.microsoft.com/library/hh881732.aspx)</ept> cmdlet with -Online flag.","pos":[14584,14771]},{"content":"Setting the retention range","pos":[14953,14980]},{"content":"Set the retention for the backup points using the <bpt id=\"p1\">[</bpt>Set-DPMPolicyObjective<ept id=\"p1\">](https://technet.microsoft.com/library/hh881762)</ept> cmdlet.","pos":[14981,15111]},{"content":"While it might seem odd to set the retention before the backup schedule has been defined, using the <ph id=\"ph1\">```Set-DPMPolicyObjective```</ph> cmdlet automatically sets a default backup schedule that can then be modified.","pos":[15112,15319]},{"content":"It is always possible to set the backup schedule first and the retention policy after.","pos":[15320,15406]},{"content":"In the example below, the cmdlet sets the retention parameters for disk backups.","pos":[15408,15488]},{"content":"This will retain backups for 10 days, and sync data every 6 hours between the production server and the DPM server.","pos":[15489,15604]},{"content":"The <ph id=\"ph1\">```SynchronizationFrequencyMinutes```</ph> doesn't define how often a backup point is created, but how often data is copied to the DPM server; this prevents backups from becoming too large.","pos":[15605,15793]},{"content":"For backups going to Azure (DPM refers to these as Online backups) the retention ranges can be configured for <bpt id=\"p1\">[</bpt>long term retention using a Grandfather-Father-Son scheme (GFS)<ept id=\"p1\">](backup-azure-backup-cloud-as-tape.md)</ept>.","pos":[15919,16133]},{"content":"That is, you can define a combined retention policy involving daily, weekly, monthly and yearly retention policies.","pos":[16134,16249]},{"content":"In this example, we create an array representing the complex retention scheme that we want, and then configure the retention range using the <bpt id=\"p1\">[</bpt>Set-DPMPolicyObjective<ept id=\"p1\">](https://technet.microsoft.com/library/hh881762)</ept> cmdlet.","pos":[16250,16471]},{"content":"Set the backup schedule","pos":[17180,17203]},{"content":"DPM sets a default backup schedule automatically if you specify the protection objective using the <ph id=\"ph1\">```Set-DPMPolicyObjective```</ph> cmdlet.","pos":[17204,17339]},{"content":"To change the default schedules, use the <bpt id=\"p1\">[</bpt>Get-DPMPolicySchedule<ept id=\"p1\">](https://technet.microsoft.com/library/hh881749)</ept> cmdlet followed by the <bpt id=\"p2\">[</bpt>Set-DPMPolicySchedule<ept id=\"p2\">](https://technet.microsoft.com/library/hh881723)</ept> cmdlet.","pos":[17340,17555]},{"pos":[18190,18357],"content":"In the example above, <ph id=\"ph1\">```$onlineSch```</ph> is an array with four elements that contains the existing online protection schedule for the Protection Group in the GFS scheme:"},{"pos":[18382,18413],"content":"will contain the daily schedule"},{"pos":[18437,18469],"content":"will contain the weekly schedule"},{"pos":[18493,18526],"content":"will contain the monthly schedule"},{"pos":[18550,18582],"content":"will contain the yearly schedule"},{"pos":[18584,18654],"content":"So if you need to modify the weekly schedule, you need to refer to the"},{"content":"Initial backup","pos":[18681,18695]},{"content":"When backing up a datasource for the first time, DPM needs to create an initial replica which will create a copy of the datasource to be protected on DPM replica volume.","pos":[18696,18865]},{"content":"This activity can either be scheduled for a specific time, or can be triggered manually, using the <bpt id=\"p1\">[</bpt>Set-DPMReplicaCreationMethod<ept id=\"p1\">](https://technet.microsoft.com/library/hh881715)</ept> cmdlet with the parameter","pos":[18866,19069]},{"content":"Changing the size of DPM Replica &amp; recovery point volume","pos":[19159,19215]},{"content":"You can also change the size of DPM Replica volume as well as Shadow Copy volume using <bpt id=\"p1\">[</bpt>Set-DPMDatasourceDiskAllocation<ept id=\"p1\">](https://technet.microsoft.com/library/hh881618.aspx)</ept> cmdlet as in the below example:","pos":[19216,19421]},{"content":"Get-DatasourceDiskAllocation -Datasource $DS","pos":[19422,19466]},{"content":"Set-DatasourceDiskAllocation -Datasource $DS -ProtectionGroup $MPG -manual -ReplicaArea (2gb) -ShadowCopyArea (2gb)","pos":[19467,19582]},{"content":"Committing the changes to the Protection Group","pos":[19588,19634]},{"content":"Finally, the changes need to be committed before DPM can take the backup per the new Protection Group configuration.","pos":[19635,19751]},{"content":"This is done using the <bpt id=\"p1\">[</bpt>Set-DPMProtectionGroup<ept id=\"p1\">](https://technet.microsoft.com/library/hh881758)</ept> cmdlet.","pos":[19752,19855]},{"content":"View the backup points","pos":[19921,19943]},{"content":"You can use the <bpt id=\"p1\">[</bpt>Get-DPMRecoveryPoint<ept id=\"p1\">](https://technet.microsoft.com/library/hh881746)</ept> cmdlet to get a list of all recovery points for a datasource.","pos":[19944,20092]},{"content":"In this example, we will:","pos":[20093,20118]},{"pos":[20121,20189],"content":"fetch all the PGs on the DPM server which will be stored in an array"},{"pos":[20202,20242],"content":"get the datasources corresponding to the"},{"content":"get all the recovery points for a datasource.","pos":[20258,20303]},{"content":"Restore data protected on Azure","pos":[20515,20546]},{"content":"Restoring data is a combination of a <ph id=\"ph1\">```RecoverableItem```</ph> object and a <ph id=\"ph2\">```RecoveryOption```</ph> object.","pos":[20547,20647]},{"content":"In the previous section, we got a list of the backup points for a datasource.","pos":[20648,20725]},{"content":"In the example below, we demonstrate how to restore a Hyper-V virtual machine from Azure Backup by combining backup points with the target for recovery.","pos":[20727,20879]},{"content":"This includes:","pos":[20880,20894]},{"pos":[20898,21015],"content":"Creating a recovery option using the  <bpt id=\"p1\">[</bpt>New-DPMRecoveryOption<ept id=\"p1\">](https://technet.microsoft.com/library/hh881592)</ept> cmdlet."},{"pos":[21018,21098],"content":"Fetching the array of backup points using the <ph id=\"ph1\">```Get-DPMRecoveryPoint```</ph> cmdlet."},{"content":"Choosing a backup point to restore from.","pos":[21101,21141]},{"content":"The commands can easily be extended for any datasource type.","pos":[21643,21703]},{"content":"Next steps","pos":[21708,21718]},{"pos":[21722,21836],"content":"For more information about Azure Backup for DPM see <bpt id=\"p1\">[</bpt>Introduction to DPM Backup<ept id=\"p1\">](backup-azure-dpm-introduction.md)</ept>"}],"content":"<properties\n    pageTitle=\"Azure Backup - Deploy and manage back up for DPM using PowerShell | Microsoft Azure\"\n    description=\"Learn how to deploy and manage Azure Backup for Data Protection Manager (DPM) using PowerShell\"\n    services=\"backup\"\n    documentationCenter=\"\"\n    authors=\"AnuragMehrotra\"\n    manager=\"jwhit\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"backup\"\n    ms.workload=\"storage-backup-recovery\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"01/28/2016\"\n    ms.author=\"jimpark; aashishr; anuragm\"/>\n\n\n# Deploy and manage backup to Azure for Data Protection Manager (DPM) servers using PowerShell\n\nThis article shows you how to use PowerShell to setup Azure Backup on a DPM server, and to manage backup and recovery.\n\n## Setting up the PowerShell environment\n\n[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-include.md)]\n\nBefore you can use PowerShell to manage backups from Data Protection Manager to Azure, you will need to have the right environment in PowerShell. At the start of the PowerShell session, ensure that you run the following command to import the right modules and allow you to correctly reference the DPM cmdlets:\n\n```\nPS C:> & \"C:\\Program Files\\Microsoft System Center 2012 R2\\DPM\\DPM\\bin\\DpmCliInitScript.ps1\"\n\nWelcome to the DPM Management Shell!\n\nFull list of cmdlets: Get-Command\nOnly DPM cmdlets: Get-DPMCommand\nGet general help: help\nGet help for a cmdlet: help <cmdlet-name> or <cmdlet-name> -?\nGet definition of a cmdlet: Get-Command <cmdlet-name> -Syntax\nSample DPM scripts: Get-DPMSampleScript\n```\n\n## Setup and Registration\nTo begin:\n\n1. [Download latest PowerShell](https://github.com/Azure/azure-powershell/releases) (minimum version required is : 1.0.0)\n2. Enable the Azure Backup commandlets by switching to *AzureResourceManager* mode by using the **Switch-AzureMode** commandlet:\n\n```\nPS C:\\> Switch-AzureMode AzureResourceManager\n```\n\nThe following setup and registration tasks can be automated with PowerShell:\n\n- Create a backup vault\n- Installing the Azure Backup agent\n- Registering with the Azure Backup service\n- Networking settings\n- Encryption settings\n\n### Create a backup vault\n\n> [AZURE.WARNING] For customers using Azure Backup for the first time, you need to register the Azure Backup provider to be used with your subscription. This can be done by running the following command: Register-AzureProvider -ProviderNamespace \"Microsoft.Backup\"\n\nYou can create a new backup vault using the **New-AzureRMBackupVault** commandlet. The backup vault is an ARM resource, so you need to place it within a Resource Group. In an elevated Azure PowerShell console, run the following commands:\n\n```\nPS C:\\> New-AzureResourceGroup –Name “test-rg” -Region “West US”\nPS C:\\> $backupvault = New-AzureRMBackupVault –ResourceGroupName “test-rg” –Name “test-vault” –Region “West US” –Storage GRS\n```\n\nYou can get a list of all the backup vaults in a given subscription using the **Get-AzureRMBackupVault** commandlet.\n\n\n### Installing the Azure Backup agent on a DPM Server\nBefore you install the Azure Backup agent, you need to have the installer downloaded and present on the Windows Server. You can get the latest version of the installer from the [Microsoft Download Center](http://aka.ms/azurebackup_agent) or from the backup vault's Dashboard page. Save the installer to an easily accessible location like *C:\\Downloads\\*.\n\nTo install the agent, run the following command in an elevated PowerShell console **on the DPM server**:\n\n```\nPS C:\\> MARSAgentInstaller.exe /q\n```\n\nThis installs the agent with all the default options. The installation takes a few minutes in the background. If you do not specify the */nu* option the **Windows Update** window will open at the end of the installation to check for any updates.\n\nThe agent will show in the list of installed programs. To see the list of installed programs, go to **Control Panel** > **Programs** > **Programs and Features**.\n\n![Agent installed](./media/backup-dpm-automation/installed-agent-listing.png)\n\n#### Installation options\nTo see all the options available via the command-line, use the following command:\n\n```\nPS C:\\> MARSAgentInstaller.exe /?\n```\n\nThe available options include:\n\n| Option | Details | Default |\n| ---- | ----- | ----- |\n| /q | Quiet installation | - |\n| /p:\"location\" | Path to the installation folder for the Azure Backup agent. | C:\\Program Files\\Microsoft Azure Recovery Services Agent |\n| /s:\"location\" | Path to the cache folder for the Azure Backup agent. | C:\\Program Files\\Microsoft Azure Recovery Services Agent\\Scratch |\n| /m | Opt-in to Microsoft Update | - |\n| /nu | Do not Check for updates after installation is complete | - |\n| /d | Uninstalls Microsoft Azure Recovery Services Agent | - |\n| /ph | Proxy Host Address | - |\n| /po | Proxy Host Port Number | - |\n| /pu | Proxy Host UserName | - |\n| /pw | Proxy Password | - |\n\n### Registering with the Azure Backup service\nBefore you can register with the Azure Backup service, you need to ensure that the [prerequisites](backup-azure-dpm-introduction.md) are met. You must:\n\n- Have a valid Azure subscription\n- Have a backup vault\n\nTo download the vault credentials, run the **Get-AzureBackupVaultCredentials** commandlet in an Azure PowerShell console and store it in a convenient location like *C:\\Downloads\\*.\n\n```\nPS C:\\> $credspath = \"C:\\\"\nPS C:\\> $credsfilename = Get-AzureRMBackupVaultCredentials -Vault $backupvault -TargetLocation $credspath\nPS C:\\> $credsfilename\nf5303a0b-fae4-4cdb-b44d-0e4c032dde26_backuprg_backuprn_2015-08-11--06-22-35.VaultCredentials\n```\n\nRegistering the machine with the vault is done using the [Start-DPMCloudRegistration](https://technet.microsoft.com/library/jj612787) cmdlet:\n\n```\nPS C:\\> $cred = $credspath + $credsfilename\nPS C:\\> Start-DPMCloudRegistration -DPMServerName \"TestingServer\" -VaultCredentialsFilePath $cred\n```\n\nThis will register the DPM Server named “TestingServer” with Microsoft Azure Vault using the specified vault credentials.\n\n> [AZURE.IMPORTANT] Do not use relative paths to specify the vault credentials file. You must provide an absolute path as an input to the cmdlet.\n\n### Initial configuration settings\nOnce the DPM Server is registered with the Azure Backup vault, it will start with default subscription settings. These subscription settings include Networking, Encryption and the Staging area. To begin changing the subscription settings you need to first get a handle on the existing (default) settings using the [Get-DPMCloudSubscriptionSetting](https://technet.microsoft.com/library/jj612793) cmdlet:\n\n```\n$setting = Get-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\"\n```\n\nAll modifications are made to this local PowerShell object ```$setting```  and then the full object is committed to DPM and Azure Backup to save them using the [Set-DPMCloudSubscriptionSetting](https://technet.microsoft.com/library/jj612791) cmdlet. You need to use the ```–Commit``` flag to ensure that the changes are persisted. The settings will not be applied and used by Azure Backup unless committed.\n\n```\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -Commit\n```\n\n### Networking\nIf the connectivity of the DPM machine to the Azure Backup service on the internet is through a proxy server, then the proxy server settings should be provided for backups to succeed. This is done by using the ```-ProxyServer```, ```-ProxyPort```, ```-ProxyUsername``` and the ```ProxyPassword``` parameters with the [Set-DPMCloudSubscriptionSetting](https://technet.microsoft.com/library/jj612791) cmdlet. In this example, there is no proxy server so we are explicitly clearing any proxy-related information.\n\n```\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -NoProxy\n```\n\nBandwidth usage can also be controlled with options of ```-WorkHourBandwidth``` and ```-NonWorkHourBandwidth``` for a given set of days of the week. In this example we are not setting any throttling.\n\n```\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -NoThrottle\n```\n\n### Configuring the staging Area\nThe Azure Backup agent running on the DPM server needs temporary storage for data restored from the cloud (local staging area). Configure the staging area using the [Set-DPMCloudSubscriptionSetting](https://technet.microsoft.com/library/jj612791) cmdlet and the ```-StagingAreaPath``` parameter.\n\n```\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -StagingAreaPath \"C:\\StagingArea\"\n```\n\nIn the example above, the staging area will be set to *C:\\StagingArea* in the PowerShell object ```$setting```. Ensure that the specified folder already exists, or else the final commit of the subscription settings will fail.\n\n\n### Encryption settings\nThe backup data sent to Azure Backup is encrypted to protect the confidentiality of the data. The encryption passphrase is the \"password\" to decrypt the data at the time of restore. It is important to keep this information safe and secure once it is set.\n\nIn the example below, the first command converts the string ```passphrase123456789``` to a secure string and assigns the secure string to the variable named ```$Passphrase```. the second command sets the secure string in ```$Passphrase``` as the password for encrypting backups.\n\n```\nPS C:\\> $Passphrase = ConvertTo-SecureString -string \"passphrase123456789\" -AsPlainText -Force\n\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -EncryptionPassphrase $Passphrase\n```\n\n> [AZURE.IMPORTANT] Keep the passphrase information safe and secure once it is set. You will not be able to restore data from Azure without this passphrase.\n\nAt this point, you should have made all the required changes to the ```$setting``` object. Remember to commit the changes.\n\n```\nPS C:\\> Set-DPMCloudSubscriptionSetting -DPMServerName \"TestingServer\" -SubscriptionSetting $setting -Commit\n```\n\n## Protect data to Azure Backup\nIn this section, you will add a production server to DPM and then protect the data to local DPM storage and then to Azure Backup. In the examples we will demonstrate how to back up files and folders. The logic can easily be extended to backup any DPM-supported data source. All your DPM backups are governed by a Protection Group (PG) with four parts:\n\n1. **Group members** is a list of all the protectable objects (also known as *Datasources* in DPM) that you want to protect in the same protection group. For example, you may want to protect production VMs in one protection group and SQL Server databases in another protection group as they may have different backup requirements. Before you can back up any datasource on a production server you need to make sure the DPM Agent is installed on the server and is managed by DPM. Follow the steps for [installing the DPM Agent](https://technet.microsoft.com/library/bb870935.aspx) and linking it to the appropriate DPM Server.\n2. **Data protection method** specifies the target backup locations - tape, disk, and cloud. In our example we will protect data to the local disk and to the cloud.\n3. A **backup schedule** that specifies when backups need to be taken and how often the data should be synchronized between the DPM Server and the production server.\n4. A **retention schedule** that specifies how long to retain the recovery points in Azure.\n\n### Creating a protection group\nStart by creating a new Protection Group using the [New-DPMProtectionGroup](https://technet.microsoft.com/library/hh881722) cmdlet.\n\n```\nPS C:\\> $PG = New-DPMProtectionGroup -DPMServerName \" TestingServer \" -Name \"ProtectGroup01\"\n```\n\nThe above cmdlet will create a Protection Group named *ProtectGroup01*. An existing protection group can also be modified later to add backup to the Azure cloud. However, to make any changes to the Protection Group - new or existing - we need to get a handle on a *modifiable* object using the [Get-DPMModifiableProtectionGroup](https://technet.microsoft.com/library/hh881713) cmdlet.\n\n```\nPS C:\\> $MPG = Get-ModifiableProtectionGroup $PG\n```\n\n### Adding group members to the Protection Group\nEach DPM Agent knows the list of datasources on the server that it is installed on. To add a datasource to the Protection Group, the DPM Agent needs to first send a list of the datasources back to the DPM server. One or more datasources are then selected and added to the Protection Group. The PowerShell steps needed to get achieve this are:\n\n1. Fetch a list of all servers managed by DPM through the DPM Agent.\n2. Choose a specific server.\n3. Fetch a list of all datasources on the server.\n4. Choose one or more datasources and add them to the Protection Group\n\nThe list of servers on which the DPM Agent is installed and is being managed by the DPM Server is acquired with the [Get-DPMProductionServer](https://technet.microsoft.com/library/hh881600) cmdlet. In this example we will filter and only configure PS with name *productionserver01* for backup.\n\n```\nPS C:\\> $server = Get-ProductionServer -DPMServerName \"TestingServer\" | where {($_.servername) –contains “productionserver01”\n```\n\nNow fetch the list of datasources on ```$server``` using the [Get-DPMDatasource](https://technet.microsoft.com/library/hh881605) cmdlet. In this example we are filtering for the volume *D:\\* which we want to configure for backup. This datasource is then added to the Protection Group using the [Add-DPMChildDatasource](https://technet.microsoft.com/library/hh881732) cmdlet. Remember to use the *modifable* protection group object ```$MPG``` to make the additions.\n\n```\nPS C:\\> $DS = Get-Datasource -ProductionServer $server -Inquire | where { $_.Name -contains “D:\\” }\n\nPS C:\\> Add-DPMChildDatasource -ProtectionGroup $MPG -ChildDatasource $DS\n```\n\nRepeat this step as many times as required, until you have added all the chosen datasources to the protection group. You can also start with just one datasource, and complete the workflow for creating the Protection Group, and at a later point add more datasources to the Protection Group.\n\n### Selecting the data protection method\nOnce the datasources have been added to the Protection Group, the next step is to specify the protection method using the [Set-DPMProtectionType](https://technet.microsoft.com/library/hh881725) cmdlet. In this example, the Protection Group will be setup for local disk and cloud backup. You also need to specify the datasource that you want to protect to cloud using the [Add-DPMChildDatasource](https://technet.microsoft.com/library/hh881732.aspx) cmdlet with -Online flag.\n\n```\nPS C:\\> Set-DPMProtectionType -ProtectionGroup $MPG -ShortTerm Disk –LongTerm Online\nPS C:\\> Add-DPMChildDatasource -ProtectionGroup $MPG -ChildDatasource $DS –Online\n```\n\n### Setting the retention range\nSet the retention for the backup points using the [Set-DPMPolicyObjective](https://technet.microsoft.com/library/hh881762) cmdlet. While it might seem odd to set the retention before the backup schedule has been defined, using the ```Set-DPMPolicyObjective``` cmdlet automatically sets a default backup schedule that can then be modified. It is always possible to set the backup schedule first and the retention policy after.\n\nIn the example below, the cmdlet sets the retention parameters for disk backups. This will retain backups for 10 days, and sync data every 6 hours between the production server and the DPM server. The ```SynchronizationFrequencyMinutes``` doesn't define how often a backup point is created, but how often data is copied to the DPM server; this prevents backups from becoming too large.\n\n```\nPS C:\\> Set-DPMPolicyObjective –ProtectionGroup $MPG -RetentionRangeInDays 10 -SynchronizationFrequencyMinutes 360\n```\n\nFor backups going to Azure (DPM refers to these as Online backups) the retention ranges can be configured for [long term retention using a Grandfather-Father-Son scheme (GFS)](backup-azure-backup-cloud-as-tape.md). That is, you can define a combined retention policy involving daily, weekly, monthly and yearly retention policies. In this example, we create an array representing the complex retention scheme that we want, and then configure the retention range using the [Set-DPMPolicyObjective](https://technet.microsoft.com/library/hh881762) cmdlet.\n\n```\nPS C:\\> $RRlist = @()\nPS C:\\> $RRList += (New-Object -TypeName Microsoft.Internal.EnterpriseStorage.Dls.UI.ObjectModel.OMCommon.RetentionRange -ArgumentList 180, Days)\nPS C:\\> $RRList += (New-Object -TypeName Microsoft.Internal.EnterpriseStorage.Dls.UI.ObjectModel.OMCommon.RetentionRange -ArgumentList 104, Weeks)\nPS C:\\> $RRList += (New-Object -TypeName Microsoft.Internal.EnterpriseStorage.Dls.UI.ObjectModel.OMCommon.RetentionRange -ArgumentList 60, Month)\nPS C:\\> $RRList += (New-Object -TypeName Microsoft.Internal.EnterpriseStorage.Dls.UI.ObjectModel.OMCommon.RetentionRange -ArgumentList 10, Years)\nPS C:\\> Set-DPMPolicyObjective –ProtectionGroup $MPG -OnlineRetentionRangeList $RRlist\n```\n\n### Set the backup schedule\nDPM sets a default backup schedule automatically if you specify the protection objective using the ```Set-DPMPolicyObjective``` cmdlet. To change the default schedules, use the [Get-DPMPolicySchedule](https://technet.microsoft.com/library/hh881749) cmdlet followed by the [Set-DPMPolicySchedule](https://technet.microsoft.com/library/hh881723) cmdlet.\n\n```\nPS C:\\> $onlineSch = Get-DPMPolicySchedule -ProtectionGroup $mpg -LongTerm Online\nPS C:\\> Set-DPMPolicySchedule -ProtectionGroup $MPG -Schedule $onlineSch[0] -TimesOfDay 02:00\nPS C:\\> Set-DPMPolicySchedule -ProtectionGroup $MPG -Schedule $onlineSch[1] -TimesOfDay 02:00 -DaysOfWeek Sa,Su –Interval 1\nPS C:\\> Set-DPMPolicySchedule -ProtectionGroup $MPG -Schedule $onlineSch[2] -TimesOfDay 02:00 -RelativeIntervals First,Third –DaysOfWeek Sa\nPS C:\\> Set-DPMPolicySchedule -ProtectionGroup $MPG -Schedule $onlineSch[3] -TimesOfDay 02:00 -DaysOfMonth 2,5,8,9 -Months Jan,Jul\nPS C:\\> Set-DPMProtectionGroup -ProtectionGroup $MPG\n```\n\nIn the example above, ```$onlineSch``` is an array with four elements that contains the existing online protection schedule for the Protection Group in the GFS scheme:\n\n1. ```$onlineSch[0]``` will contain the daily schedule\n2. ```$onlineSch[1]``` will contain the weekly schedule\n3. ```$onlineSch[2]``` will contain the monthly schedule\n4. ```$onlineSch[3]``` will contain the yearly schedule\n\nSo if you need to modify the weekly schedule, you need to refer to the ```$onlineSch[1]```.\n\n### Initial backup\nWhen backing up a datasource for the first time, DPM needs to create an initial replica which will create a copy of the datasource to be protected on DPM replica volume. This activity can either be scheduled for a specific time, or can be triggered manually, using the [Set-DPMReplicaCreationMethod](https://technet.microsoft.com/library/hh881715) cmdlet with the parameter ```-NOW```.\n\n```\nPS C:\\> Set-DPMReplicaCreationMethod -ProtectionGroup $MPG -NOW\n```\n### Changing the size of DPM Replica & recovery point volume\nYou can also change the size of DPM Replica volume as well as Shadow Copy volume using [Set-DPMDatasourceDiskAllocation](https://technet.microsoft.com/library/hh881618.aspx) cmdlet as in the below example:\nGet-DatasourceDiskAllocation -Datasource $DS\nSet-DatasourceDiskAllocation -Datasource $DS -ProtectionGroup $MPG -manual -ReplicaArea (2gb) -ShadowCopyArea (2gb)\n\n### Committing the changes to the Protection Group\nFinally, the changes need to be committed before DPM can take the backup per the new Protection Group configuration. This is done using the [Set-DPMProtectionGroup](https://technet.microsoft.com/library/hh881758) cmdlet.\n\n```\nPS C:\\> Set-DPMProtectionGroup -ProtectionGroup $MPG\n```\n## View the backup points\nYou can use the [Get-DPMRecoveryPoint](https://technet.microsoft.com/library/hh881746) cmdlet to get a list of all recovery points for a datasource. In this example, we will:\n- fetch all the PGs on the DPM server which will be stored in an array ```$PG```\n- get the datasources corresponding to the ```$PG[0]```\n- get all the recovery points for a datasource.\n\n```\nPS C:\\> $PG = Get-DPMProtectionGroup –DPMServerName \"TestingServer\"\nPS C:\\> $DS = Get-DPMDatasource -ProtectionGroup $PG[0]\nPS C:\\> $RecoveryPoints = Get-DPMRecoverypoint -Datasource $DS[0] -Online\n```\n\n## Restore data protected on Azure\nRestoring data is a combination of a ```RecoverableItem``` object and a ```RecoveryOption``` object. In the previous section, we got a list of the backup points for a datasource.\n\nIn the example below, we demonstrate how to restore a Hyper-V virtual machine from Azure Backup by combining backup points with the target for recovery. This includes:\n\n- Creating a recovery option using the  [New-DPMRecoveryOption](https://technet.microsoft.com/library/hh881592) cmdlet.\n- Fetching the array of backup points using the ```Get-DPMRecoveryPoint``` cmdlet.\n- Choosing a backup point to restore from.\n\n```\nPS C:\\> $RecoveryOption = New-DPMRecoveryOption -HyperVDatasource -TargetServer \"HVDCenter02\" -RecoveryLocation AlternateHyperVServer -RecoveryType Recover -TargetLocation “C:\\VMRecovery”\n\nPS C:\\> $PG = Get-DPMProtectionGroup –DPMServerName \"TestingServer\"\nPS C:\\> $DS = Get-DPMDatasource -ProtectionGroup $PG[0]\nPS C:\\> $RecoveryPoints = Get-DPMRecoverypoint -Datasource $DS[0] -Online\n\nPS C:\\> Restore-DPMRecoverableItem -RecoverableItem $RecoveryPoints[0] -RecoveryOption $RecoveryOption\n```\n\nThe commands can easily be extended for any datasource type.\n\n## Next steps\n\n- For more information about Azure Backup for DPM see [Introduction to DPM Backup](backup-azure-dpm-introduction.md)\n"}