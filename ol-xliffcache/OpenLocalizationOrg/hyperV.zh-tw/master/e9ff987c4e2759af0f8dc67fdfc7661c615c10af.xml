{
  "nodes": [
    {
      "content": "App Model v2.0 OpenID Connect Protocol | Microsoft Azure",
      "pos": [
        28,
        84
      ]
    },
    {
      "content": "Building web applications using Azure AD's implementation of the OpenID Connect authentication protocol.",
      "pos": [
        103,
        207
      ]
    },
    {
      "content": "App model v2.0 preview: Protocols - OpenID Connect",
      "pos": [
        522,
        572
      ]
    },
    {
      "content": "OpenID Connect is an authentication protocol built on top of OAuth 2.0 that can be used to securely sign users into web applications.",
      "pos": [
        573,
        706
      ]
    },
    {
      "content": "Using the app model v2.0's implementation of OpenID Connect, you can add sign in and API access to your web based applications.",
      "pos": [
        708,
        835
      ]
    },
    {
      "content": "This guide will show you how to do so in a language-independent manner, describing how to send and receive HTTP messages without using any of our open-source libraries.",
      "pos": [
        837,
        1005
      ]
    },
    {
      "content": "This information applies to the v2.0 app model public preview.",
      "pos": [
        1026,
        1088
      ]
    },
    {
      "content": "For instructions on how to integrate with the generally available Azure AD service, please refer to the <bpt id=\"p1\">[</bpt>Azure Active Directory Developer Guide<ept id=\"p1\">](active-directory-developers-guide.md)</ept>.",
      "pos": [
        1090,
        1273
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>OpenID Connect<ept id=\"p1\">](http://openid.net/specs/openid-connect-core-1_0.html)</ept> extends the OAuth 2.0 <bpt id=\"p2\">*</bpt>authorization<ept id=\"p2\">*</ept> protocol for use as an <bpt id=\"p3\">*</bpt>authentication<ept id=\"p3\">*</ept> protocol, which allows you to perform single sign-on using OAuth.",
      "pos": [
        1275,
        1489
      ]
    },
    {
      "content": "It introduces the concept of an <ph id=\"ph1\">`id_token`</ph>, which is a security token that allows the client to verify the identity of the user and obtain basic profile information about the user.",
      "pos": [
        1491,
        1671
      ]
    },
    {
      "content": "Because it extends OAuth 2.0, it also enables apps to securely acquire <bpt id=\"p1\">**</bpt>access_tokens<ept id=\"p1\">**</ept> which can be used to access resources that are secured by an <bpt id=\"p2\">[</bpt>authorization server<ept id=\"p2\">](active-directory-v2-protocols.md#the-basics)</ept>.",
      "pos": [
        1673,
        1891
      ]
    },
    {
      "content": "OpenID Connect is our recommendation if you are building a <bpt id=\"p1\">[</bpt>web application<ept id=\"p1\">](active-directory-v2-flows.md#web-apps)</ept> that is hosted on a server and accessed via a browser.",
      "pos": [
        1893,
        2063
      ]
    },
    {
      "content": "Send the Sign-In Request",
      "pos": [
        2068,
        2092
      ]
    },
    {
      "content": "When your web app needs to authenticate the user, it can direct the user to the <ph id=\"ph1\">`/authorize`</ph> endpoint.",
      "pos": [
        2093,
        2195
      ]
    },
    {
      "content": "This request is similar to the first leg of the <bpt id=\"p1\">[</bpt>OAuth 2.0 Authorization Code Flow<ept id=\"p1\">](active-directory-v2-protocols-oauth-code.md)</ept>, with a few important distinctions:",
      "pos": [
        2197,
        2361
      ]
    },
    {
      "pos": [
        2365,
        2434
      ],
      "content": "The request must include the scope <ph id=\"ph1\">`openid`</ph> in the <ph id=\"ph2\">`scope`</ph> parameter."
    },
    {
      "pos": [
        2437,
        2490
      ],
      "content": "The <ph id=\"ph1\">`response_type`</ph> parameter must include <ph id=\"ph2\">`id_token`</ph>"
    },
    {
      "pos": [
        2493,
        2539
      ],
      "content": "The request must include the <ph id=\"ph1\">`nonce`</ph> parameter"
    },
    {
      "content": "Parameter",
      "pos": [
        3239,
        3248
      ]
    },
    {
      "content": "Description",
      "pos": [
        3253,
        3264
      ]
    },
    {
      "content": "client_id",
      "pos": [
        3349,
        3358
      ]
    },
    {
      "content": "required",
      "pos": [
        3361,
        3369
      ]
    },
    {
      "pos": [
        3372,
        3497
      ],
      "content": "The Application Id that the registration portal (<bpt id=\"p1\">[</bpt>apps.dev.microsoft.com<ept id=\"p1\">](https://apps.dev.microsoft.com)</ept>) assigned your app."
    },
    {
      "content": "response_type",
      "pos": [
        3502,
        3515
      ]
    },
    {
      "content": "required",
      "pos": [
        3518,
        3526
      ]
    },
    {
      "content": "Must include <ph id=\"ph1\">`id_token`</ph> for OpenID Connect sign-in.",
      "pos": [
        3529,
        3580
      ]
    },
    {
      "content": "It may also include other response_types, such as <ph id=\"ph1\">`code`</ph>.",
      "pos": [
        3582,
        3639
      ]
    },
    {
      "content": "redirect_uri",
      "pos": [
        3644,
        3656
      ]
    },
    {
      "content": "required",
      "pos": [
        3659,
        3667
      ]
    },
    {
      "content": "The redirect_uri of your app, where authentication responses can be sent and received by your app.",
      "pos": [
        3670,
        3768
      ]
    },
    {
      "content": "It must exactly match one of the redirect_uris you registered in the portal, except it must be url encoded.",
      "pos": [
        3770,
        3877
      ]
    },
    {
      "content": "scope",
      "pos": [
        3882,
        3887
      ]
    },
    {
      "content": "required",
      "pos": [
        3890,
        3898
      ]
    },
    {
      "content": "A space-separated list of scopes.",
      "pos": [
        3901,
        3934
      ]
    },
    {
      "content": "For OpenID Connect, it must include the scope <ph id=\"ph1\">`openid`</ph>, which translates to the \"Sign in &amp; Read Your Profile\" permission in the consent UI.",
      "pos": [
        3936,
        4075
      ]
    },
    {
      "content": "You may also include other scopes in this request for requesting consent.",
      "pos": [
        4077,
        4150
      ]
    },
    {
      "content": "nonce",
      "pos": [
        4156,
        4161
      ]
    },
    {
      "content": "required",
      "pos": [
        4164,
        4172
      ]
    },
    {
      "content": "A value included in the request, generated by the app, that will be included in the resulting id_token as a claim.",
      "pos": [
        4175,
        4289
      ]
    },
    {
      "content": "The app can then verify this value to mitigate token replay attacks.",
      "pos": [
        4291,
        4359
      ]
    },
    {
      "content": "The value is typically a randomized, unique string that can be used to identify the origin of the request.",
      "pos": [
        4361,
        4467
      ]
    },
    {
      "content": "response_mode",
      "pos": [
        4473,
        4486
      ]
    },
    {
      "content": "recommended",
      "pos": [
        4489,
        4500
      ]
    },
    {
      "content": "Specifies the method that should be used to send the resulting authorization_code back to your app.",
      "pos": [
        4503,
        4602
      ]
    },
    {
      "content": "Can be one of 'query', 'form_post', or 'fragment'.",
      "pos": [
        4604,
        4654
      ]
    },
    {
      "content": "state",
      "pos": [
        4659,
        4664
      ]
    },
    {
      "content": "recommended",
      "pos": [
        4667,
        4678
      ]
    },
    {
      "content": "A value included in the request that will also be returned in the token response.",
      "pos": [
        4681,
        4762
      ]
    },
    {
      "content": "It can be a string of any content that you wish.",
      "pos": [
        4764,
        4812
      ]
    },
    {
      "content": "A randomly generated unique value is typically used for preventing cross-site request forgery attacks.",
      "pos": [
        4814,
        4916
      ]
    },
    {
      "content": "The state is also used to encode information about the user's state in the app before the authentication request occurred, such as the page or view they were on.",
      "pos": [
        4918,
        5079
      ]
    },
    {
      "content": "prompt",
      "pos": [
        5084,
        5090
      ]
    },
    {
      "content": "optional",
      "pos": [
        5093,
        5101
      ]
    },
    {
      "content": "Indicates the type of user interaction that is required.",
      "pos": [
        5104,
        5160
      ]
    },
    {
      "content": "The only valid values at this time are 'login', 'none', and 'consent'.",
      "pos": [
        5162,
        5232
      ]
    },
    {
      "content": "<ph id=\"ph1\">`prompt=login`</ph> will force the user to enter their credentials on that request, negating single-sign on.",
      "pos": [
        5234,
        5337
      ]
    },
    {
      "content": "<ph id=\"ph1\">`prompt=none`</ph> is the opposite - it will ensure that the user is not presented with any interactive prompt whatsoever.",
      "pos": [
        5339,
        5456
      ]
    },
    {
      "content": "If the request cannot be completed silently via single-sign on, the v2.0 endpoint will return an error.",
      "pos": [
        5458,
        5561
      ]
    },
    {
      "content": "<ph id=\"ph1\">`prompt=consent`</ph> will trigger the OAuth consent dialog after the user signs in, asking the user to grant permissions to the app.",
      "pos": [
        5563,
        5691
      ]
    },
    {
      "content": "login_hint",
      "pos": [
        5696,
        5706
      ]
    },
    {
      "content": "optional",
      "pos": [
        5709,
        5717
      ]
    },
    {
      "content": "Can be used to pre-fill the username/email address field of the sign in page for the user.",
      "pos": [
        5720,
        5810
      ]
    },
    {
      "content": "At this point, the user will be asked to enter their credentials and complete the authentication.",
      "pos": [
        5814,
        5911
      ]
    },
    {
      "content": "The v2.0 endpoint will also ensure that the user has consented to the permissions indicated in the <ph id=\"ph1\">`scope`</ph> query parameter.",
      "pos": [
        5913,
        6036
      ]
    },
    {
      "content": "If the user has not consented to any of those permissions, it will ask the user to consent to the required permissions.",
      "pos": [
        6038,
        6157
      ]
    },
    {
      "content": "Details of <bpt id=\"p1\">[</bpt>permissions, consent, and multi-tenant apps are provided here<ept id=\"p1\">](active-directory-v2-scopes.md)</ept>.",
      "pos": [
        6159,
        6265
      ]
    },
    {
      "pos": [
        6267,
        6461
      ],
      "content": "Once the user authenticates and grants consent, the v2.0 endpoint will return a response to your app at the indicated <ph id=\"ph1\">`redirect_uri`</ph>, using the method specified in the <ph id=\"ph2\">`response_mode`</ph> parameter."
    },
    {
      "pos": [
        6463,
        6524
      ],
      "content": "A successful response using <ph id=\"ph1\">`response_mode=query`</ph> looks like:"
    },
    {
      "content": "Parameter",
      "pos": [
        6907,
        6916
      ]
    },
    {
      "content": "Description",
      "pos": [
        6919,
        6930
      ]
    },
    {
      "content": "id_token",
      "pos": [
        6997,
        7005
      ]
    },
    {
      "content": "The id_token that the  app requested.",
      "pos": [
        7008,
        7045
      ]
    },
    {
      "content": "You can use the id_token to verify the user's identity and begin a session with the user.",
      "pos": [
        7046,
        7135
      ]
    },
    {
      "content": "More details on id_tokens and their contents is included in the <bpt id=\"p1\">[</bpt>v2.0 endpoint token reference<ept id=\"p1\">](active-directory-v2-tokens.md)</ept>.",
      "pos": [
        7137,
        7264
      ]
    },
    {
      "content": "session_state",
      "pos": [
        7270,
        7283
      ]
    },
    {
      "content": "A unique value that identifies the current user session.",
      "pos": [
        7286,
        7342
      ]
    },
    {
      "content": "This value is a GUID, but should be treated as an opaque value that is passed without examination.",
      "pos": [
        7343,
        7441
      ]
    },
    {
      "content": "state",
      "pos": [
        7446,
        7451
      ]
    },
    {
      "content": "If a state parameter is included in the request, the same value should appear in the response.",
      "pos": [
        7454,
        7548
      ]
    },
    {
      "content": "The  app should verify that the state values in the request and response are identical.",
      "pos": [
        7549,
        7636
      ]
    },
    {
      "content": "id_token_expires_in",
      "pos": [
        7641,
        7660
      ]
    },
    {
      "content": "How long the id token is valid (in seconds).",
      "pos": [
        7663,
        7707
      ]
    },
    {
      "pos": [
        7712,
        7808
      ],
      "content": "Error responses may also be sent to the <ph id=\"ph1\">`redirect_uri`</ph> so the app can handle them appropriately:"
    },
    {
      "content": "Parameter",
      "pos": [
        7927,
        7936
      ]
    },
    {
      "content": "Description",
      "pos": [
        7939,
        7950
      ]
    },
    {
      "content": "error",
      "pos": [
        8017,
        8022
      ]
    },
    {
      "content": "An error code string that can be used to classify types of errors that occur, and can be used to react to errors.",
      "pos": [
        8025,
        8138
      ]
    },
    {
      "content": "error_description",
      "pos": [
        8143,
        8160
      ]
    },
    {
      "content": "A specific error message that can help a developer identify the root cause of an authentication error.",
      "pos": [
        8163,
        8265
      ]
    },
    {
      "content": "Validate the id_token",
      "pos": [
        8273,
        8294
      ]
    },
    {
      "content": "Just receiving an id_token is not sufficient to authenticate the user; you must validate the id_token's signature and verify the claims in the token per your  app's requirements.",
      "pos": [
        8295,
        8473
      ]
    },
    {
      "content": "The v2.0 endpoint uses <bpt id=\"p1\">[</bpt>JSON Web Tokens (JWTs)<ept id=\"p1\">](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html)</ept> and public key cryptography to sign tokens and verify that they are valid.",
      "pos": [
        8475,
        8664
      ]
    },
    {
      "content": "The v2.0 app model has an OpenID Connect metadata endpoint, which allows an app to fetch information about the v2.0 app model at runtime.",
      "pos": [
        8666,
        8803
      ]
    },
    {
      "content": "This information includes endpoints, token contents, and token signing keys.",
      "pos": [
        8805,
        8881
      ]
    },
    {
      "content": "The metadata endpoint contains a JSON document located at:",
      "pos": [
        8883,
        8941
      ]
    },
    {
      "pos": [
        9025,
        9140
      ],
      "content": "One of the properties of this configuration document is the <ph id=\"ph1\">`jwks_uri`</ph>, whose value for the v2.0 app model will be:"
    },
    {
      "pos": [
        9142,
        9205
      ],
      "content": "<ph id=\"ph1\">`https://login.microsoftonline.com/common/discovery/v2.0/keys`</ph>."
    },
    {
      "content": "You can use the RSA256 public keys located at this endpoint to validate the signature of the id_token.",
      "pos": [
        9207,
        9309
      ]
    },
    {
      "content": "There are multiple keys listed at this endpoint at any given point in time, each identified by a <ph id=\"ph1\">`kid`</ph>.",
      "pos": [
        9311,
        9414
      ]
    },
    {
      "content": "The header of the id_token also contains a <ph id=\"ph1\">`kid`</ph> claim, which indicates which of these keys was used to sign the id_token.",
      "pos": [
        9416,
        9538
      ]
    },
    {
      "pos": [
        9542,
        9819
      ],
      "content": "See the <bpt id=\"p1\">[</bpt>v2.0 app model token reference<ept id=\"p1\">](active-directory-v2-tokens.md)</ept> for more information, including <bpt id=\"p2\">[</bpt>Validating Tokens<ept id=\"p2\">](active-directory-v2-tokens.md#validating-tokens)</ept> and <bpt id=\"p3\">[</bpt>Important Information About Signing Key Rollover<ept id=\"p3\">](active-directory-v2-tokens.md#validating-tokens)</ept>."
    },
    {
      "content": "Once you've validated the signature of the id_token, there are a few claims you will need to verify:",
      "pos": [
        9866,
        9966
      ]
    },
    {
      "content": "You should validate the <ph id=\"ph1\">`nonce`</ph> claim to prevent token replay attacks.",
      "pos": [
        9970,
        10040
      ]
    },
    {
      "content": "Its value should be what you specified in the sign-in request.",
      "pos": [
        10042,
        10104
      ]
    },
    {
      "content": "You should validate the <ph id=\"ph1\">`aud`</ph> claim to ensure the id_token was issued for your app.",
      "pos": [
        10107,
        10190
      ]
    },
    {
      "content": "Its value should be the <ph id=\"ph1\">`client_id`</ph> of your app.",
      "pos": [
        10192,
        10240
      ]
    },
    {
      "pos": [
        10243,
        10329
      ],
      "content": "You should validate the <ph id=\"ph1\">`iat`</ph> and <ph id=\"ph2\">`exp`</ph> claims to ensure the id_token has not expired."
    },
    {
      "content": "You may also wish to validate additional claims depending on your scenario.",
      "pos": [
        10331,
        10406
      ]
    },
    {
      "content": "Some common validations include:",
      "pos": [
        10408,
        10440
      ]
    },
    {
      "content": "Ensuring the user/organization has signed up for the  app.",
      "pos": [
        10444,
        10502
      ]
    },
    {
      "content": "Ensuring the user has proper authorization/privileges",
      "pos": [
        10505,
        10558
      ]
    },
    {
      "content": "Ensuring a certain strength of authentication has occurred, such as multi-factor authentication.",
      "pos": [
        10561,
        10657
      ]
    },
    {
      "pos": [
        10659,
        10782
      ],
      "content": "For more information on the claims in an id_token, see the <bpt id=\"p1\">[</bpt>v2.0 app model token reference<ept id=\"p1\">](active-directory-v2-tokens.md)</ept>."
    },
    {
      "content": "Once you have completely validated the id_token, you can begin a session with the user and use the claims in the id_token to obtain information about the user in your app.",
      "pos": [
        10784,
        10955
      ]
    },
    {
      "content": "This information can be used for display, records, authorizations, etc.",
      "pos": [
        10957,
        11028
      ]
    },
    {
      "content": "Send a Sign Out Request",
      "pos": [
        11033,
        11056
      ]
    },
    {
      "content": "The OpenIdConnect <ph id=\"ph1\">`end_session_endpoint`</ph> is not currently supported by the v2.0 app model preview.",
      "pos": [
        11058,
        11156
      ]
    },
    {
      "content": "This means your app cannot send a request to the v2.0 endpoint to end a user's session and clear cookies set by the v2.0 endpoint.",
      "pos": [
        11157,
        11287
      ]
    },
    {
      "content": "To sign a user out, your app can simply end its own session with the user, and leave the user's session with the v2.0 endpoint in-tact.",
      "pos": [
        11288,
        11423
      ]
    },
    {
      "content": "The next time the user tries to sign in, they will see a \"choose account\" page, with their actively signed-in accounts listed.",
      "pos": [
        11425,
        11551
      ]
    },
    {
      "content": "On that page, the user can choose to sign out of any account, ending the session with the v2.0 endpoint.",
      "pos": [
        11552,
        11656
      ]
    },
    {
      "content": "Sign In Summary Diagram",
      "pos": [
        12630,
        12653
      ]
    },
    {
      "content": "The most basic sign-in flow contains the following steps:",
      "pos": [
        12654,
        12711
      ]
    },
    {
      "content": "OpenId Connect Swimlanes",
      "pos": [
        12715,
        12739
      ]
    },
    {
      "content": "Get Access Tokens",
      "pos": [
        12814,
        12831
      ]
    },
    {
      "content": "Many web apps need to not only sign the user in, but also access a web service on behalf of that user using OAuth.",
      "pos": [
        12832,
        12946
      ]
    },
    {
      "content": "This scenario combines OpenID Connect for user authentication while simultaneously acquiring an authorization_code that can be used to get access_tokens using the OAuth Authorization Code Flow.",
      "pos": [
        12948,
        13141
      ]
    },
    {
      "content": "To acquire access tokens, you'll need to slightly modify the sign in request from above:",
      "pos": [
        13143,
        13231
      ]
    },
    {
      "pos": [
        14097,
        14377
      ],
      "content": "By including permission scopes in the request and using <ph id=\"ph1\">`response_type=code+id_token`</ph>, the v2.0 endpoint will ensure that the user has consented to the permissions indicated in the <ph id=\"ph2\">`scope`</ph> query parameter, and return your app an authorization code to exchange for an access token."
    },
    {
      "pos": [
        14379,
        14440
      ],
      "content": "A successful response using <ph id=\"ph1\">`response_mode=query`</ph> looks like:"
    },
    {
      "content": "Parameter",
      "pos": [
        14924,
        14933
      ]
    },
    {
      "content": "Description",
      "pos": [
        14936,
        14947
      ]
    },
    {
      "content": "id_token",
      "pos": [
        15014,
        15022
      ]
    },
    {
      "content": "The id_token that the  app requested.",
      "pos": [
        15025,
        15062
      ]
    },
    {
      "content": "You can use the id_token to verify the user's identity and begin a session with the user.",
      "pos": [
        15063,
        15152
      ]
    },
    {
      "content": "More details on id_tokens and their contents is included in the <bpt id=\"p1\">[</bpt>v2.0 app model token reference<ept id=\"p1\">](active-directory-v2-tokens.md)</ept>.",
      "pos": [
        15154,
        15282
      ]
    },
    {
      "content": "code",
      "pos": [
        15288,
        15292
      ]
    },
    {
      "content": "The authorization_code that the  app requested.",
      "pos": [
        15295,
        15342
      ]
    },
    {
      "content": "The  app can use the authorization code to request an access token for the target resource.",
      "pos": [
        15343,
        15434
      ]
    },
    {
      "content": "Authorization_codes are very short lived, typically they expire after about 10 minutes.",
      "pos": [
        15436,
        15523
      ]
    },
    {
      "content": "session_state",
      "pos": [
        15528,
        15541
      ]
    },
    {
      "content": "A unique value that identifies the current user session.",
      "pos": [
        15544,
        15600
      ]
    },
    {
      "content": "This value is a GUID, but should be treated as an opaque value that is passed without examination.",
      "pos": [
        15601,
        15699
      ]
    },
    {
      "content": "state",
      "pos": [
        15704,
        15709
      ]
    },
    {
      "content": "If a state parameter is included in the request, the same value should appear in the response.",
      "pos": [
        15712,
        15806
      ]
    },
    {
      "content": "The  app should verify that the state values in the request and response are identical.",
      "pos": [
        15807,
        15894
      ]
    },
    {
      "content": "id_token_expires_in",
      "pos": [
        15899,
        15918
      ]
    },
    {
      "content": "How long the id token is valid (in seconds).",
      "pos": [
        15921,
        15965
      ]
    },
    {
      "pos": [
        15969,
        16065
      ],
      "content": "Error responses may also be sent to the <ph id=\"ph1\">`redirect_uri`</ph> so the app can handle them appropriately:"
    },
    {
      "content": "Parameter",
      "pos": [
        16184,
        16193
      ]
    },
    {
      "content": "Description",
      "pos": [
        16196,
        16207
      ]
    },
    {
      "content": "error",
      "pos": [
        16274,
        16279
      ]
    },
    {
      "content": "An error code string that can be used to classify types of errors that occur, and can be used to react to errors.",
      "pos": [
        16282,
        16395
      ]
    },
    {
      "content": "error_description",
      "pos": [
        16400,
        16417
      ]
    },
    {
      "content": "A specific error message that can help a developer identify the root cause of an authentication error.",
      "pos": [
        16420,
        16522
      ]
    },
    {
      "content": "Once you've gotten an authorization <ph id=\"ph1\">`code`</ph> and an <ph id=\"ph2\">`id_token`</ph>, you can sign the user in and get access tokens on their behalf.",
      "pos": [
        16527,
        16652
      ]
    },
    {
      "content": "To sign the user in, you must validate the <ph id=\"ph1\">`id_token`</ph> exactly as described <bpt id=\"p1\">[</bpt>above<ept id=\"p1\">](#validating-the-id-token)</ept>.",
      "pos": [
        16654,
        16763
      ]
    },
    {
      "content": "To get access tokens, you can follow the steps described in our <bpt id=\"p1\">[</bpt>OAuth protocol documentation<ept id=\"p1\">](active-directory-v2-protocols-oidc.md#request-an-access-token)</ept>.",
      "pos": [
        16765,
        16923
      ]
    },
    {
      "content": "Token Acquisition Summary Diagram",
      "pos": [
        16928,
        16961
      ]
    },
    {
      "content": "For reference, the full OpenID Connect sign-in and token acquisition flow looks something like this:",
      "pos": [
        16963,
        17063
      ]
    },
    {
      "content": "OpenId Connect Swimlanes",
      "pos": [
        17067,
        17091
      ]
    }
  ],
  "content": "\n<properties\n    pageTitle=\"App Model v2.0 OpenID Connect Protocol | Microsoft Azure\"\n    description=\"Building web applications using Azure AD's implementation of the OpenID Connect authentication protocol.\"\n    services=\"active-directory\"\n    documentationCenter=\"\"\n    authors=\"dstrockis\"\n    manager=\"msmbaldwin\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"active-directory\"\n    ms.workload=\"identity\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"12/09/2015\"\n    ms.author=\"dastrock\"/>\n\n# App model v2.0 preview: Protocols - OpenID Connect\nOpenID Connect is an authentication protocol built on top of OAuth 2.0 that can be used to securely sign users into web applications.  Using the app model v2.0's implementation of OpenID Connect, you can add sign in and API access to your web based applications.  This guide will show you how to do so in a language-independent manner, describing how to send and receive HTTP messages without using any of our open-source libraries.\n\n> [AZURE.NOTE]\n    This information applies to the v2.0 app model public preview.  For instructions on how to integrate with the generally available Azure AD service, please refer to the [Azure Active Directory Developer Guide](active-directory-developers-guide.md).\n\n[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) extends the OAuth 2.0 *authorization* protocol for use as an *authentication* protocol, which allows you to perform single sign-on using OAuth.  It introduces the concept of an `id_token`, which is a security token that allows the client to verify the identity of the user and obtain basic profile information about the user.  Because it extends OAuth 2.0, it also enables apps to securely acquire **access_tokens** which can be used to access resources that are secured by an [authorization server](active-directory-v2-protocols.md#the-basics).  OpenID Connect is our recommendation if you are building a [web application](active-directory-v2-flows.md#web-apps) that is hosted on a server and accessed via a browser.\n\n## Send the Sign-In Request\nWhen your web app needs to authenticate the user, it can direct the user to the `/authorize` endpoint.  This request is similar to the first leg of the [OAuth 2.0 Authorization Code Flow](active-directory-v2-protocols-oauth-code.md), with a few important distinctions:\n\n- The request must include the scope `openid` in the `scope` parameter.\n- The `response_type` parameter must include `id_token`\n- The request must include the `nonce` parameter\n\n```\n// Line breaks for legibility only\n\nGET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?\nclient_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id\n&response_type=id_token\n&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded\n&response_mode=query                                  // 'query', 'form_post', or 'fragment'\n&scope=openid                                        // Translates to the 'Read your profile' permission\n&state=12345                                         // Any value, provided by your app\n&nonce=678910                                        // Any value, provided by your app\n```\n\n| Parameter | | Description |\n| ----------------------- | ------------------------------- | --------------- |\n| client_id | required | The Application Id that the registration portal ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) assigned your app. |\n| response_type | required | Must include `id_token` for OpenID Connect sign-in.  It may also include other response_types, such as `code`. |\n| redirect_uri | required | The redirect_uri of your app, where authentication responses can be sent and received by your app.  It must exactly match one of the redirect_uris you registered in the portal, except it must be url encoded. |\n| scope | required | A space-separated list of scopes.  For OpenID Connect, it must include the scope `openid`, which translates to the \"Sign in & Read Your Profile\" permission in the consent UI.  You may also include other scopes in this request for requesting consent.  |\n| nonce | required | A value included in the request, generated by the app, that will be included in the resulting id_token as a claim.  The app can then verify this value to mitigate token replay attacks.  The value is typically a randomized, unique string that can be used to identify the origin of the request.  |\n| response_mode | recommended | Specifies the method that should be used to send the resulting authorization_code back to your app.  Can be one of 'query', 'form_post', or 'fragment'.  \n| state | recommended | A value included in the request that will also be returned in the token response.  It can be a string of any content that you wish.  A randomly generated unique value is typically used for preventing cross-site request forgery attacks.  The state is also used to encode information about the user's state in the app before the authentication request occurred, such as the page or view they were on. |\n| prompt | optional | Indicates the type of user interaction that is required.  The only valid values at this time are 'login', 'none', and 'consent'.  `prompt=login` will force the user to enter their credentials on that request, negating single-sign on.  `prompt=none` is the opposite - it will ensure that the user is not presented with any interactive prompt whatsoever.  If the request cannot be completed silently via single-sign on, the v2.0 endpoint will return an error.  `prompt=consent` will trigger the OAuth consent dialog after the user signs in, asking the user to grant permissions to the app. |\n| login_hint | optional | Can be used to pre-fill the username/email address field of the sign in page for the user. |\n\nAt this point, the user will be asked to enter their credentials and complete the authentication.  The v2.0 endpoint will also ensure that the user has consented to the permissions indicated in the `scope` query parameter.  If the user has not consented to any of those permissions, it will ask the user to consent to the required permissions.  Details of [permissions, consent, and multi-tenant apps are provided here](active-directory-v2-scopes.md).\n\nOnce the user authenticates and grants consent, the v2.0 endpoint will return a response to your app at the indicated `redirect_uri`, using the method specified in the `response_mode` parameter.\n\nA successful response using `response_mode=query` looks like:\n\n```\nGET https://localhost/myapp/?\nid_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated\n&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint\n&state=12345                                                    // the value provided in the request\n&id_token_expires_in=3600\n\n```\n\n| Parameter | Description |\n| ----------------------- | ------------------------------- |\n| id_token | The id_token that the  app requested. You can use the id_token to verify the user's identity and begin a session with the user.  More details on id_tokens and their contents is included in the [v2.0 endpoint token reference](active-directory-v2-tokens.md).  |\n| session_state | A unique value that identifies the current user session. This value is a GUID, but should be treated as an opaque value that is passed without examination. |\n| state | If a state parameter is included in the request, the same value should appear in the response. The  app should verify that the state values in the request and response are identical. |\n| id_token_expires_in | How long the id token is valid (in seconds). |\n\n\nError responses may also be sent to the `redirect_uri` so the app can handle them appropriately:\n\n```\nGET https://localhost/myapp/?\nerror=access_denied\n&error_description=the+user+canceled+the+authentication\n```\n\n| Parameter | Description |\n| ----------------------- | ------------------------------- |\n| error | An error code string that can be used to classify types of errors that occur, and can be used to react to errors. |\n| error_description | A specific error message that can help a developer identify the root cause of an authentication error.  |\n\n## Validate the id_token\nJust receiving an id_token is not sufficient to authenticate the user; you must validate the id_token's signature and verify the claims in the token per your  app's requirements.  The v2.0 endpoint uses [JSON Web Tokens (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) and public key cryptography to sign tokens and verify that they are valid.\n\nThe v2.0 app model has an OpenID Connect metadata endpoint, which allows an app to fetch information about the v2.0 app model at runtime.  This information includes endpoints, token contents, and token signing keys.  The metadata endpoint contains a JSON document located at:\n\n`https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`\n\nOne of the properties of this configuration document is the `jwks_uri`, whose value for the v2.0 app model will be:\n\n`https://login.microsoftonline.com/common/discovery/v2.0/keys`.\n\nYou can use the RSA256 public keys located at this endpoint to validate the signature of the id_token.  There are multiple keys listed at this endpoint at any given point in time, each identified by a `kid`.  The header of the id_token also contains a `kid` claim, which indicates which of these keys was used to sign the id_token.  \n\nSee the [v2.0 app model token reference](active-directory-v2-tokens.md) for more information, including [Validating Tokens](active-directory-v2-tokens.md#validating-tokens) and [Important Information About Signing Key Rollover](active-directory-v2-tokens.md#validating-tokens).\n<!--TODO: Improve the information on this-->\n\nOnce you've validated the signature of the id_token, there are a few claims you will need to verify:\n\n- You should validate the `nonce` claim to prevent token replay attacks.  Its value should be what you specified in the sign-in request.\n- You should validate the `aud` claim to ensure the id_token was issued for your app.  Its value should be the `client_id` of your app.\n- You should validate the `iat` and `exp` claims to ensure the id_token has not expired.\n\nYou may also wish to validate additional claims depending on your scenario.  Some common validations include:\n\n- Ensuring the user/organization has signed up for the  app.\n- Ensuring the user has proper authorization/privileges\n- Ensuring a certain strength of authentication has occurred, such as multi-factor authentication.\n\nFor more information on the claims in an id_token, see the [v2.0 app model token reference](active-directory-v2-tokens.md).\n\nOnce you have completely validated the id_token, you can begin a session with the user and use the claims in the id_token to obtain information about the user in your app.  This information can be used for display, records, authorizations, etc.\n\n## Send a Sign Out Request\n\nThe OpenIdConnect `end_session_endpoint` is not currently supported by the v2.0 app model preview. This means your app cannot send a request to the v2.0 endpoint to end a user's session and clear cookies set by the v2.0 endpoint.\nTo sign a user out, your app can simply end its own session with the user, and leave the user's session with the v2.0 endpoint in-tact.  The next time the user tries to sign in, they will see a \"choose account\" page, with their actively signed-in accounts listed.\nOn that page, the user can choose to sign out of any account, ending the session with the v2.0 endpoint.\n\n<!--\n\nWhen you wish to sign the user out of the  app, it is not sufficient to clear your app's cookies or otherwise end the session with the user.  You must also redirect the user to the v2.0 endpoint for sign out.  If you fail to do so, the user will be able to re-authenticate to your app without entering their credentials again, because they will have a valid single sign-on session with the v2.0 endpoint.\n\nYou can simply redirect the user to the `end_session_endpoint` listed in the OpenID Connect metadata document:\n\n```\nGET https://login.microsoftonline.com/common/oauth2/v2.0/logout?\npost_logout_redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F\n```\n\n| Parameter | | Description |\n| ----------------------- | ------------------------------- | ------------ |\n| post_logout_redirect_uri | recommended | The URL which the user should be redirected to after successful logout.  If not included, the user will be shown a generic message by the v2.0 endpoint.  |\n\n-->\n\n## Sign In Summary Diagram\nThe most basic sign-in flow contains the following steps:\n\n![OpenId Connect Swimlanes](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)\n\n## Get Access Tokens\nMany web apps need to not only sign the user in, but also access a web service on behalf of that user using OAuth.  This scenario combines OpenID Connect for user authentication while simultaneously acquiring an authorization_code that can be used to get access_tokens using the OAuth Authorization Code Flow.  To acquire access tokens, you'll need to slightly modify the sign in request from above:\n\n\n```\n// Line breaks for legibility only\n\nGET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?\nclient_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id\n&response_type=id_token+code\n&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded\n&response_mode=query                                  // 'query', 'form_post', or 'fragment'\n&scope=openid%20                                      // Include both 'openid' and scopes your app needs  \noffline_access%20                                        \nhttps%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20\nhttps%3A%2F%2Fgraph.windows.net%2Fdirectory.write\n&state=12345                                         // Any value, provided by your app\n&nonce=678910                                        // Any value, provided by your app\n```\n\nBy including permission scopes in the request and using `response_type=code+id_token`, the v2.0 endpoint will ensure that the user has consented to the permissions indicated in the `scope` query parameter, and return your app an authorization code to exchange for an access token.\n\nA successful response using `response_mode=query` looks like:\n\n```\nGET https://localhost/myapp/?\nid_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated\n&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...  // the authorization_code, truncated\n&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint\n&state=12345                                                    // the value provided in the request\n&id_token_expires_in=3599\n\n```\n\n| Parameter | Description |\n| ----------------------- | ------------------------------- |\n| id_token | The id_token that the  app requested. You can use the id_token to verify the user's identity and begin a session with the user.  More details on id_tokens and their contents is included in the [v2.0 app model token reference](active-directory-v2-tokens.md).  |\n| code | The authorization_code that the  app requested. The  app can use the authorization code to request an access token for the target resource.  Authorization_codes are very short lived, typically they expire after about 10 minutes. |\n| session_state | A unique value that identifies the current user session. This value is a GUID, but should be treated as an opaque value that is passed without examination. |\n| state | If a state parameter is included in the request, the same value should appear in the response. The  app should verify that the state values in the request and response are identical. |\n| id_token_expires_in | How long the id token is valid (in seconds). |\n\nError responses may also be sent to the `redirect_uri` so the app can handle them appropriately:\n\n```\nGET https://localhost/myapp/?\nerror=access_denied\n&error_description=the+user+canceled+the+authentication\n```\n\n| Parameter | Description |\n| ----------------------- | ------------------------------- |\n| error | An error code string that can be used to classify types of errors that occur, and can be used to react to errors. |\n| error_description | A specific error message that can help a developer identify the root cause of an authentication error.  |\n\nOnce you've gotten an authorization `code` and an `id_token`, you can sign the user in and get access tokens on their behalf.  To sign the user in, you must validate the `id_token` exactly as described [above](#validating-the-id-token).  To get access tokens, you can follow the steps described in our [OAuth protocol documentation](active-directory-v2-protocols-oidc.md#request-an-access-token).\n\n## Token Acquisition Summary Diagram\n\nFor reference, the full OpenID Connect sign-in and token acquisition flow looks something like this:\n\n![OpenId Connect Swimlanes](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)\n\n"
}