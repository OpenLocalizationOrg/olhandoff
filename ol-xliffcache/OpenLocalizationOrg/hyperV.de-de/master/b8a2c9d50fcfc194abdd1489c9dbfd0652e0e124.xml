{
  "nodes": [
    {
      "content": "Connect to Azure Storage in your Xamarin.Forms app",
      "pos": [
        27,
        77
      ]
    },
    {
      "content": "Add images to the todo list Xamarin.Forms mobile app by connecting to Azure blob storage",
      "pos": [
        96,
        184
      ]
    },
    {
      "content": "Connect to Azure Storage in your Xamarin.Forms app",
      "pos": [
        522,
        572
      ]
    },
    {
      "content": "Overview",
      "pos": [
        577,
        585
      ]
    },
    {
      "content": "The Azure Mobile Apps client and server SDK support offline sync of structured data with CRUD operations against the /tables endpoint.",
      "pos": [
        587,
        721
      ]
    },
    {
      "content": "Generally this data is stored in a database or similar store, and generally these data stores cannot store large binary data efficiently.",
      "pos": [
        722,
        859
      ]
    },
    {
      "content": "Also, some applications have related data that is stored elsewhere (e.g., blob storage, files shares), and it is useful to be able to create associations between records in the /tables endpoint and other data.",
      "pos": [
        860,
        1069
      ]
    },
    {
      "content": "This topic shows you how to add support for images to the Mobile Apps todo list quickstart.",
      "pos": [
        1071,
        1162
      ]
    },
    {
      "content": "You must first complete the tutorial <bpt id=\"p1\">[</bpt><ept id=\"p1\">Create a Xamarin.Forms app]</ept>.",
      "pos": [
        1163,
        1229
      ]
    },
    {
      "content": "In this tutorial, you will create a storage account and add a connection string to your Mobile App backend.",
      "pos": [
        1231,
        1338
      ]
    },
    {
      "content": "You will then add a new inheriting from the new Mobile Apps type <ph id=\"ph1\">`StorageController&lt;T&gt;`</ph> to your server project.",
      "pos": [
        1339,
        1450
      ]
    },
    {
      "pos": [
        1453,
        1657
      ],
      "content": "<ph id=\"ph1\">[AZURE.TIP]</ph> This tutorial has a <bpt id=\"p1\">[</bpt>companion sample<ept id=\"p1\">](https://azure.microsoft.com/documentation/samples/app-service-mobile-dotnet-todo-list-files/)</ept> available, which can be deployed to your own Azure account."
    },
    {
      "content": "Prerequisites",
      "pos": [
        1663,
        1676
      ]
    },
    {
      "content": "To complete this tutorial, you need the following:",
      "pos": [
        1678,
        1728
      ]
    },
    {
      "content": "An active Azure account.",
      "pos": [
        1732,
        1756
      ]
    },
    {
      "content": "If you don't have an account, you can sign up for an Azure trial and get up to 10 free mobile apps that you can keep using even after your trial ends.",
      "pos": [
        1757,
        1907
      ]
    },
    {
      "content": "For details, see <bpt id=\"p1\">[</bpt>Azure Free Trial<ept id=\"p1\">](https://azure.microsoft.com/pricing/free-trial/)</ept>.",
      "pos": [
        1908,
        1993
      ]
    },
    {
      "pos": [
        1997,
        2037
      ],
      "content": "<bpt id=\"p1\">[</bpt><ept id=\"p1\">Visual Studio Community 2013]</ept> or later."
    },
    {
      "pos": [
        2041,
        2182
      ],
      "content": "A Mac with <bpt id=\"p1\">[</bpt>Xcode<ept id=\"p1\">](https://go.microsoft.com/fwLink/?LinkID=266532)</ept> v7.0 or later and <bpt id=\"p2\">[</bpt>Xamarin Studio<ept id=\"p2\">](http://xamarin.com/download)</ept> installed."
    },
    {
      "content": "Completion of the tutorial <bpt id=\"p1\">[</bpt><ept id=\"p1\">Create a Xamarin.Forms app]</ept>.",
      "pos": [
        2186,
        2242
      ]
    },
    {
      "content": "This article uses the completed app from that tutorial.",
      "pos": [
        2243,
        2298
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> If you want to get started with Azure App Service before you sign up for an Azure account, go to <bpt id=\"p1\">[</bpt>Try App Service<ept id=\"p1\">](https://tryappservice.azure.com/?appServiceName=mobile)</ept>.",
      "pos": [
        2301,
        2485
      ]
    },
    {
      "content": "There, you can immediately create a short-lived starter mobile app in App Service—no credit card required, and no commitments.",
      "pos": [
        2486,
        2612
      ]
    },
    {
      "content": "Create a storage account",
      "pos": [
        2617,
        2641
      ]
    },
    {
      "pos": [
        2646,
        2731
      ],
      "content": "Create a storage account by following the tutorial <bpt id=\"p1\">[</bpt><ept id=\"p1\">Create an Azure Storage Account]</ept>."
    },
    {
      "content": "In the Azure Portal, navigate to your newly created storage account and click the <bpt id=\"p1\">**</bpt>Keys<ept id=\"p1\">**</ept> icon.",
      "pos": [
        2737,
        2833
      ]
    },
    {
      "content": "Copy the <bpt id=\"p1\">**</bpt>Primary Connection String<ept id=\"p1\">**</ept>.",
      "pos": [
        2834,
        2873
      ]
    },
    {
      "content": "Navigate to your mobile app backend.",
      "pos": [
        2878,
        2914
      ]
    },
    {
      "content": "Under <bpt id=\"p1\">**</bpt>All Settings<ept id=\"p1\">**</ept> -&gt; <bpt id=\"p2\">**</bpt>Application Settings<ept id=\"p2\">**</ept> -&gt; <bpt id=\"p3\">**</bpt>Connection Strings<ept id=\"p3\">**</ept>, create a new key named <ph id=\"ph1\">`MS_AzureStorageAccountConnectionString`</ph> and use the value copied from your storage account.",
      "pos": [
        2915,
        3108
      ]
    },
    {
      "content": "Use <bpt id=\"p1\">**</bpt>Custom<ept id=\"p1\">**</ept> as the key type.",
      "pos": [
        3109,
        3140
      ]
    },
    {
      "content": "Add a storage controller to your server project",
      "pos": [
        3145,
        3192
      ]
    },
    {
      "content": "In Visual Studio, open your .NET server project.",
      "pos": [
        3197,
        3245
      ]
    },
    {
      "content": "Add the NuGet package <bpt id=\"p1\">[</bpt><ept id=\"p1\">Microsoft.Azure.Mobile.Server.Files]</ept>.",
      "pos": [
        3246,
        3306
      ]
    },
    {
      "content": "Be sure to select <bpt id=\"p1\">**</bpt>Include prerelease<ept id=\"p1\">**</ept>.",
      "pos": [
        3307,
        3348
      ]
    },
    {
      "content": "In Visual Studio, open your .NET server project.",
      "pos": [
        3353,
        3401
      ]
    },
    {
      "content": "Right-click the <bpt id=\"p1\">**</bpt>Controllers<ept id=\"p1\">**</ept> folder and select <bpt id=\"p2\">**</bpt>Add<ept id=\"p2\">**</ept> -&gt; <bpt id=\"p3\">**</bpt>Controller<ept id=\"p3\">**</ept> -&gt; <bpt id=\"p4\">**</bpt>Web API 2 Controller - Empty<ept id=\"p4\">**</ept>.",
      "pos": [
        3402,
        3514
      ]
    },
    {
      "content": "Name the controller <ph id=\"ph1\">`TodoItemStorageController`</ph>.",
      "pos": [
        3515,
        3563
      ]
    },
    {
      "content": "Add the following using statements:",
      "pos": [
        3568,
        3603
      ]
    },
    {
      "pos": [
        3723,
        3768
      ],
      "content": "Change the base class to <ph id=\"ph1\">`StorageController`</ph>:"
    },
    {
      "content": "Add the following methods to the class:",
      "pos": [
        3855,
        3894
      ]
    },
    {
      "content": "Update the Web API configuration to set up attribute routing.",
      "pos": [
        4785,
        4846
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Startup.MobileApp.cs<ept id=\"p1\">**</ept>, add the following line to the <ph id=\"ph1\">`ConfigureMobileApp()`</ph> method, after the definition of the <ph id=\"ph2\">`config`</ph> variable:",
      "pos": [
        4847,
        4983
      ]
    },
    {
      "content": "Publish your server project to your mobile app backend.",
      "pos": [
        5030,
        5085
      ]
    },
    {
      "content": "Routes registered by the storage controller",
      "pos": [
        5090,
        5133
      ]
    },
    {
      "pos": [
        5135,
        5225
      ],
      "content": "The new <ph id=\"ph1\">`TodoItemStorageController`</ph> exposes two sub-resources under the record it manages:"
    },
    {
      "content": "StorageToken",
      "pos": [
        5229,
        5241
      ]
    },
    {
      "content": "HTTP POST : Creates a storage token",
      "pos": [
        5249,
        5284
      ]
    },
    {
      "content": "MobileServiceFiles",
      "pos": [
        5348,
        5366
      ]
    },
    {
      "content": "HTTP GET: Retrieves a list of files associated with the record",
      "pos": [
        5374,
        5436
      ]
    },
    {
      "content": "HTTP DELETE: Deletes the file specified in the file resource identifier",
      "pos": [
        5500,
        5571
      ]
    },
    {
      "content": "Client and server communication",
      "pos": [
        5641,
        5672
      ]
    },
    {
      "content": "Note that <ph id=\"ph1\">`TodoItemStorageController`</ph> does <bpt id=\"p1\">*</bpt>not<ept id=\"p1\">*</ept> have a route for uploading or downloading a blob.",
      "pos": [
        5674,
        5772
      ]
    },
    {
      "content": "That is because a mobile client interacts with blob storage <bpt id=\"p1\">*</bpt>directly<ept id=\"p1\">*</ept> in order to perform these operations, after first getting a SAS token (Shared Access Signature) to securely access a particular blob or container.",
      "pos": [
        5773,
        5990
      ]
    },
    {
      "content": "This is an important architectural design, as otherwise access to storage would be limited by the scability and availability of the mobile backend.",
      "pos": [
        5991,
        6138
      ]
    },
    {
      "content": "Instead, by connecting directly to Azure Storage, the mobile client can take advantage of its features such as auto-partitioning and geo-distribution.",
      "pos": [
        6139,
        6289
      ]
    },
    {
      "content": "A shared access signature provides delegated access to resources in your storage account.",
      "pos": [
        6291,
        6380
      ]
    },
    {
      "content": "This means that you can grant a client limited permissions to objects in your storage account for a specified period of time and with a specified set of permissions, without having to share your account access keys.",
      "pos": [
        6381,
        6596
      ]
    },
    {
      "content": "To learn more, see <bpt id=\"p1\">[</bpt><ept id=\"p1\">Understanding Shared Access Signatures]</ept>.",
      "pos": [
        6597,
        6657
      ]
    },
    {
      "content": "The diagram below shows the client and server interactions.",
      "pos": [
        6659,
        6718
      ]
    },
    {
      "content": "Before uploading a file, the client requests a SAS token from the service.",
      "pos": [
        6719,
        6793
      ]
    },
    {
      "content": "The service uses the storage connection string to generate a new SAS, which it then returns to the client.",
      "pos": [
        6794,
        6900
      ]
    },
    {
      "content": "The SAS is time-limited and restricts permissions to just a particular file or container.",
      "pos": [
        6901,
        6990
      ]
    },
    {
      "content": "The mobile client then uses this SAS and the Azure Storage client SDK to upload the file to blob storage.",
      "pos": [
        6991,
        7096
      ]
    },
    {
      "content": "Requesting a SAS token",
      "pos": [
        7100,
        7122
      ]
    },
    {
      "content": "Update your client app to add image support",
      "pos": [
        7209,
        7252
      ]
    },
    {
      "content": "Open the Xamarin.Forms quickstart project in either Visual Studio or Xamarin Studio.",
      "pos": [
        7254,
        7338
      ]
    },
    {
      "pos": [
        7342,
        7465
      ],
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> This tutorial only contains instructions for the Android, iOS, and Windows Store platforms, not Windows Phone."
    },
    {
      "content": "Add NuGet packages",
      "pos": [
        7470,
        7488
      ]
    },
    {
      "content": "Right-click the solution and select <bpt id=\"p1\">**</bpt>Manage NuGet packages for solution<ept id=\"p1\">**</ept>.",
      "pos": [
        7490,
        7565
      ]
    },
    {
      "content": "Add the following NuGet packages to <bpt id=\"p1\">**</bpt>all<ept id=\"p1\">**</ept> projects in the solution.",
      "pos": [
        7566,
        7635
      ]
    },
    {
      "content": "Be sure to check <bpt id=\"p1\">**</bpt>Include prerelease<ept id=\"p1\">**</ept>.",
      "pos": [
        7636,
        7676
      ]
    },
    {
      "content": "Microsoft.Azure.Mobile.Client.Files",
      "pos": [
        7683,
        7718
      ]
    },
    {
      "content": "Microsoft.Azure.Mobile.Client.SQLiteStore",
      "pos": [
        7726,
        7767
      ]
    },
    {
      "content": "PCLStorage",
      "pos": [
        7775,
        7785
      ]
    },
    {
      "pos": [
        7788,
        7907
      ],
      "content": "For convenience, this sample uses the <bpt id=\"p1\">[</bpt><ept id=\"p1\">PCLStorage]</ept> library, but it is not required by the Azure Mobile Apps client SDK."
    },
    {
      "content": "Add IPlatform interface",
      "pos": [
        7970,
        7993
      ]
    },
    {
      "content": "Create a new interface <ph id=\"ph1\">`IPlatform`</ph> in the main portable library project.",
      "pos": [
        7995,
        8067
      ]
    },
    {
      "content": "This follows the <bpt id=\"p1\">[</bpt><ept id=\"p1\">Xamarin.Forms DependencyService]</ept> pattern to load the right platform-specific class at runtime.",
      "pos": [
        8068,
        8180
      ]
    },
    {
      "content": "You will later add platform specific implementations in each of the client projects.",
      "pos": [
        8181,
        8265
      ]
    },
    {
      "content": "Add the following using statements:",
      "pos": [
        8270,
        8305
      ]
    },
    {
      "content": "Replace the implementation with the following:",
      "pos": [
        8496,
        8542
      ]
    },
    {
      "content": "Add FileHelper class",
      "pos": [
        8930,
        8950
      ]
    },
    {
      "content": "Create a new class <ph id=\"ph1\">`FileHelper`</ph> in the main portable library project.",
      "pos": [
        8955,
        9024
      ]
    },
    {
      "content": "Add the following using statements:",
      "pos": [
        9025,
        9060
      ]
    },
    {
      "content": "Add the class definition:",
      "pos": [
        9184,
        9209
      ]
    },
    {
      "content": "Add a file sync handler",
      "pos": [
        11413,
        11436
      ]
    },
    {
      "content": "Create a new class <ph id=\"ph1\">`TodoItemFileSyncHandler`</ph> in the main portable library project.",
      "pos": [
        11438,
        11520
      ]
    },
    {
      "content": "This class contains callbacks from the Azure SDK to notify your code when a file is added or removed.",
      "pos": [
        11521,
        11622
      ]
    },
    {
      "pos": [
        11624,
        11840
      ],
      "content": "The Azure Mobile Client SDK does not store actually store any file data: the client SDK invokes your implementation of <ph id=\"ph1\">`IFileSyncHandler`</ph> which in turn determines whether and how files are stored on the local device."
    },
    {
      "content": "Add the following using statements:",
      "pos": [
        11845,
        11880
      ]
    },
    {
      "content": "Replace the class definition with the following:",
      "pos": [
        12144,
        12192
      ]
    },
    {
      "content": "Update TodoItemManager",
      "pos": [
        13240,
        13262
      ]
    },
    {
      "pos": [
        13267,
        13344
      ],
      "content": "In <bpt id=\"p1\">**</bpt>TodoItemManager.cs<ept id=\"p1\">**</ept>, uncomment the line <ph id=\"ph1\">`#define OFFLINE_SYNC_ENABLED`</ph>."
    },
    {
      "pos": [
        13349,
        13411
      ],
      "content": "In <bpt id=\"p1\">**</bpt>TodoItemManager.cs<ept id=\"p1\">**</ept>, add the following using statements:"
    },
    {
      "pos": [
        13656,
        13749
      ],
      "content": "In the constructor of <ph id=\"ph1\">`TodoItemManager`</ph>, add the following after the call to <ph id=\"ph2\">`DefineTable()`</ph>:"
    },
    {
      "content": "In the constructor, replace the call to <ph id=\"ph1\">`InitializeAsync`</ph> with the following.",
      "pos": [
        13876,
        13953
      ]
    },
    {
      "content": "This will ensure that there are callbacks when records are modified in the local store.",
      "pos": [
        13954,
        14041
      ]
    },
    {
      "content": "The file sync feature uses these callbacks to trigger your file sync handler.",
      "pos": [
        14042,
        14119
      ]
    },
    {
      "pos": [
        14234,
        14302
      ],
      "content": "In <ph id=\"ph1\">`SyncAsync()`</ph>, add the following after the call to <ph id=\"ph2\">`PushAsync()`</ph>:"
    },
    {
      "pos": [
        14361,
        14408
      ],
      "content": "Add the following methods to <ph id=\"ph1\">`TodoItemManager`</ph>:"
    },
    {
      "content": "Add a details view",
      "pos": [
        15468,
        15486
      ]
    },
    {
      "content": "In this section, you will add a new details view for a todo item.",
      "pos": [
        15488,
        15553
      ]
    },
    {
      "content": "The view is created when the user selects a todo item and it allows new images to be added to an item.",
      "pos": [
        15554,
        15656
      ]
    },
    {
      "pos": [
        15661,
        15761
      ],
      "content": "Add a new class <bpt id=\"p1\">**</bpt>TodoItemImage<ept id=\"p1\">**</ept> to the portable library project with the following implementation:"
    },
    {
      "content": "Edit <bpt id=\"p1\">**</bpt>App.cs<ept id=\"p1\">**</ept>.",
      "pos": [
        16996,
        17012
      ]
    },
    {
      "content": "Replace the initialization of <ph id=\"ph1\">`MainPage`</ph> with the following:",
      "pos": [
        17013,
        17073
      ]
    },
    {
      "pos": [
        17138,
        17180
      ],
      "content": "In <bpt id=\"p1\">**</bpt>App.cs<ept id=\"p1\">**</ept>, add the following property:"
    },
    {
      "content": "Right-click the portable library project and select <bpt id=\"p1\">**</bpt>Add<ept id=\"p1\">**</ept> -&gt; <bpt id=\"p2\">**</bpt>New Item<ept id=\"p2\">**</ept> -&gt; <bpt id=\"p3\">**</bpt>Cross-platform<ept id=\"p3\">**</ept> -&gt; <bpt id=\"p4\">**</bpt>Forms Xaml Page<ept id=\"p4\">**</ept>.",
      "pos": [
        17239,
        17360
      ]
    },
    {
      "content": "Name the view <ph id=\"ph1\">`TodoItemDetailsView`</ph>.",
      "pos": [
        17361,
        17397
      ]
    },
    {
      "pos": [
        17402,
        17495
      ],
      "content": "Open <bpt id=\"p1\">**</bpt>TodoItemDetailsView.xaml<ept id=\"p1\">**</ept> and replace the body of the ContentPage with the following:"
    },
    {
      "pos": [
        18288,
        18364
      ],
      "content": "Edit <bpt id=\"p1\">**</bpt>TodoItemDetailsView.xaml.cs<ept id=\"p1\">**</ept> and add the following using statements:"
    },
    {
      "pos": [
        18475,
        18546
      ],
      "content": "Replace the implementation of <ph id=\"ph1\">`TodoItemDetailsView`</ph> with the following:"
    },
    {
      "content": "Update the main view",
      "pos": [
        20165,
        20185
      ]
    },
    {
      "content": "Update the main view to open the details view when a todo item is selected.",
      "pos": [
        20188,
        20263
      ]
    },
    {
      "pos": [
        20265,
        20352
      ],
      "content": "In <bpt id=\"p1\">**</bpt>TodoList.xaml.cs<ept id=\"p1\">**</ept>, replace the implementation of <ph id=\"ph1\">`OnSelected`</ph> with the following:"
    },
    {
      "content": "Update the Android project",
      "pos": [
        20747,
        20773
      ]
    },
    {
      "content": "Add platform-specific code to the Android project, including code for downloading a file and using the camera to capture a new image.",
      "pos": [
        20775,
        20908
      ]
    },
    {
      "pos": [
        20911,
        21089
      ],
      "content": "This code uses the Xamarin.Forms <bpt id=\"p1\">[</bpt>DependencyService<ept id=\"p1\">](https://developer.xamarin.com/guides/xamarin-forms/dependency-service/)</ept> to load the right platform-specific class at runtime."
    },
    {
      "pos": [
        21094,
        21154
      ],
      "content": "Add the component <bpt id=\"p1\">**</bpt>Xamarin.Mobile<ept id=\"p1\">**</ept> to the Android project."
    },
    {
      "content": "Add a new class <ph id=\"ph1\">`DroidPlatform`</ph> with the following implementation.",
      "pos": [
        21159,
        21225
      ]
    },
    {
      "content": "Replace \"YourNamespace\" with the main namespace of your project.",
      "pos": [
        21226,
        21290
      ]
    },
    {
      "content": "Edit <bpt id=\"p1\">**</bpt>MainActivity.cs<ept id=\"p1\">**</ept>.",
      "pos": [
        23696,
        23721
      ]
    },
    {
      "content": "In <ph id=\"ph1\">`OnCreate`</ph>, add the following before the call to <ph id=\"ph2\">`LoadApplication()`</ph>:",
      "pos": [
        23722,
        23794
      ]
    },
    {
      "content": "Update the iOS project",
      "pos": [
        23830,
        23852
      ]
    },
    {
      "content": "Add platform-specific code to the iOS project.",
      "pos": [
        23854,
        23900
      ]
    },
    {
      "pos": [
        23905,
        23961
      ],
      "content": "Add the component <bpt id=\"p1\">**</bpt>Xamarin.Mobile<ept id=\"p1\">**</ept> to the iOS project."
    },
    {
      "content": "Add a new class <ph id=\"ph1\">`TouchPlatform`</ph> with the following implementation.",
      "pos": [
        23966,
        24032
      ]
    },
    {
      "content": "Replace \"YourNamespace\" with the main namespace of your project.",
      "pos": [
        24033,
        24097
      ]
    },
    {
      "pos": [
        26309,
        26394
      ],
      "content": "Edit <bpt id=\"p1\">**</bpt>AppDelegate.cs<ept id=\"p1\">**</ept> and uncomment the call to <ph id=\"ph1\">`SQLitePCL.CurrentPlatform.Init()`</ph>."
    },
    {
      "content": "Update the Windows project",
      "pos": [
        26399,
        26425
      ]
    },
    {
      "content": "Install the Visual Studio extension <bpt id=\"p1\">[</bpt>SQLite for Windows 8.1<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=716919)</ept>.",
      "pos": [
        26430,
        26538
      ]
    },
    {
      "content": "For more information, see the tutorial <bpt id=\"p1\">[</bpt>Enable offline sync for your Windows app<ept id=\"p1\">](app-service-mobile-windows-store-dotnet-get-started-offline-data.md)</ept>.",
      "pos": [
        26540,
        26691
      ]
    },
    {
      "pos": [
        26697,
        26763
      ],
      "content": "Edit <bpt id=\"p1\">**</bpt>Package.appxmanifest<ept id=\"p1\">**</ept> and check the <bpt id=\"p2\">**</bpt>Webcam<ept id=\"p2\">**</ept> capability."
    },
    {
      "content": "Add a new class <ph id=\"ph1\">`WindowsStorePlatform`</ph> with the following implementation.",
      "pos": [
        26768,
        26841
      ]
    },
    {
      "content": "Replace \"YourNamespace\" with the main namespace of your project.",
      "pos": [
        26842,
        26906
      ]
    },
    {
      "content": "Summary",
      "pos": [
        29410,
        29417
      ]
    },
    {
      "content": "This article described how to use the new file support in the Azure Mobile client and server SDK to work with Azure Storage.",
      "pos": [
        29419,
        29543
      ]
    },
    {
      "content": "Create a storage account and add the connection string to your mobile app backend.",
      "pos": [
        29548,
        29630
      ]
    },
    {
      "content": "Only the backend has the key to Azure Storage: the mobile client requests a SAS token (Shared Access Signature) whenever it needs to access Azure Storage.",
      "pos": [
        29631,
        29785
      ]
    },
    {
      "content": "To learn more about SAS tokens in Azure Storage, see <bpt id=\"p1\">[</bpt><ept id=\"p1\">Understanding Shared Access Signatures]</ept>.",
      "pos": [
        29786,
        29880
      ]
    },
    {
      "content": "Create a controller that subclasses <ph id=\"ph1\">`StorageController`</ph> in order to handle the SAS token requests and to get the files that are associated with a record.",
      "pos": [
        29884,
        30037
      ]
    },
    {
      "content": "By default, files are associated with a record by using the record ID as part of the container name; the behavior can be customized by specifying an implementation of <ph id=\"ph1\">`IContainerNameResolver`</ph>.",
      "pos": [
        30038,
        30230
      ]
    },
    {
      "content": "The SAS token policy can also be customized.",
      "pos": [
        30231,
        30275
      ]
    },
    {
      "content": "The Azure Mobile Client SDK does not store actually store any file data.",
      "pos": [
        30279,
        30351
      ]
    },
    {
      "content": "Rather, the client SDK invokes your <ph id=\"ph1\">`IFileSyncHandler`</ph>, which then decides how (and if) files are stored on the local device.",
      "pos": [
        30352,
        30477
      ]
    },
    {
      "content": "The sync handler is registered as follows:",
      "pos": [
        30478,
        30520
      ]
    },
    {
      "content": "A <ph id=\"ph1\">`MobileServiceFile`</ph> can be used either in online or offline mode, by using a <ph id=\"ph2\">`IMobileServiceTable`</ph> or <ph id=\"ph3\">`IMobileServiceSyncTable`</ph>, respectively.",
      "pos": [
        31269,
        31413
      ]
    },
    {
      "content": "In the offline scenario, the upload will occur when the app calls <ph id=\"ph1\">`PushFileChangesAsync`</ph>.",
      "pos": [
        31414,
        31503
      ]
    },
    {
      "content": "This causes the offline operation queue to be processed; for each file operation, the Azure Mobile client SDK will invoke the <ph id=\"ph1\">`GetDataSource`</ph> method on the <ph id=\"ph2\">`IFileSyncHandler`</ph> instance to retrieve the file contents for the upload.",
      "pos": [
        31504,
        31733
      ]
    },
    {
      "content": "In order to retrieve an item's files, call the ``GetFilesAsync<ph id=\"ph1\">` method on the  `</ph>IMobileServiceTable",
      "pos": [
        31737,
        31836
      ]
    },
    {
      "content": "<ph id=\"ph1\">` or IMobileServiceSyncTable&lt;T&gt;`</ph> instance.",
      "pos": [
        31839,
        31881
      ]
    },
    {
      "content": "This method returns a list of files associated with the data item provided.",
      "pos": [
        31882,
        31957
      ]
    },
    {
      "content": "(Note: this is a <bpt id=\"p1\">*</bpt>local<ept id=\"p1\">*</ept> operation and will return the files based on the state of the object when it was last synchronized.",
      "pos": [
        31958,
        32082
      ]
    },
    {
      "content": "To get an updated list of files from the server, you should initiate a sync operation first.)",
      "pos": [
        32083,
        32176
      ]
    },
    {
      "content": "The file sync feature uses record change notifications on the local store in order to retrieve the records that the client received as part of a push or pull operation.",
      "pos": [
        32265,
        32433
      ]
    },
    {
      "content": "This is achieved by turning on local and server notifications for the sync context using the <ph id=\"ph1\">`StoreTrackingOptions`</ph> parameter.",
      "pos": [
        32434,
        32560
      ]
    },
    {
      "content": "It is possible to add or remove files from a record by modifying blob storage directly, since the association is achieved through a naming convention.",
      "pos": [
        32993,
        33143
      ]
    },
    {
      "content": "However, in this case you should always <bpt id=\"p1\">**</bpt>update the record timestamp when the associated blobs are modified<ept id=\"p1\">**</ept>.",
      "pos": [
        33144,
        33255
      ]
    },
    {
      "content": "The Azure Mobile client SDK always updates a record when adding or removing a file.",
      "pos": [
        33256,
        33339
      ]
    },
    {
      "content": "The reason for this requirement is that some mobile clients will already have the record in local storage.",
      "pos": [
        33346,
        33452
      ]
    },
    {
      "content": "When these clients perform an incremental pull, this record will not be returned and the client will not query for the new associated files.",
      "pos": [
        33453,
        33593
      ]
    },
    {
      "content": "To avoid this problem, it is recommended that you update the record timestamp when performing any blob storage change that does not use the Azure Mobile client SDK.",
      "pos": [
        33594,
        33758
      ]
    },
    {
      "content": "The client project uses the <bpt id=\"p1\">[</bpt><ept id=\"p1\">Xamarin.Forms DependencyService]</ept> pattern to load the right platform-specific class at runtime.",
      "pos": [
        33762,
        33885
      ]
    },
    {
      "content": "In this sample, we defined an interface <ph id=\"ph1\">`IPlatform`</ph> with implementations in each of the platform-specific projects.",
      "pos": [
        33886,
        34001
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Connect to Azure Storage in your Xamarin.Forms app\"\n    description=\"Add images to the todo list Xamarin.Forms mobile app by connecting to Azure blob storage\"\n    documentationCenter=\"xamarin\"\n    authors=\"lindydonna\"\n    manager=\"dwrede\"\n    editor=\"\"\n    services=\"app-service\\mobile\"/>\n\n<tags\n    ms.service=\"app-service-mobile\"\n    ms.workload=\"mobile\"\n    ms.tgt_pltfrm=\"mobile-xamarin-ios\"\n    ms.devlang=\"dotnet\"\n    ms.topic=\"article\"\n    ms.date=\"02/03/2016\"\n    ms.author=\"donnam\"/>\n\n#Connect to Azure Storage in your Xamarin.Forms app\n\n## Overview\n\nThe Azure Mobile Apps client and server SDK support offline sync of structured data with CRUD operations against the /tables endpoint. Generally this data is stored in a database or similar store, and generally these data stores cannot store large binary data efficiently. Also, some applications have related data that is stored elsewhere (e.g., blob storage, files shares), and it is useful to be able to create associations between records in the /tables endpoint and other data.\n\nThis topic shows you how to add support for images to the Mobile Apps todo list quickstart. You must first complete the tutorial [Create a Xamarin.Forms app].\n\nIn this tutorial, you will create a storage account and add a connection string to your Mobile App backend. You will then add a new inheriting from the new Mobile Apps type `StorageController<T>` to your server project.\n\n>[AZURE.TIP] This tutorial has a [companion sample](https://azure.microsoft.com/documentation/samples/app-service-mobile-dotnet-todo-list-files/) available, which can be deployed to your own Azure account. \n\n## Prerequisites\n\nTo complete this tutorial, you need the following:\n\n* An active Azure account. If you don't have an account, you can sign up for an Azure trial and get up to 10 free mobile apps that you can keep using even after your trial ends. For details, see [Azure Free Trial](https://azure.microsoft.com/pricing/free-trial/).\n\n* [Visual Studio Community 2013] or later.\n\n* A Mac with [Xcode](https://go.microsoft.com/fwLink/?LinkID=266532) v7.0 or later and [Xamarin Studio](http://xamarin.com/download) installed.\n\n* Completion of the tutorial [Create a Xamarin.Forms app]. This article uses the completed app from that tutorial.\n\n>[AZURE.NOTE] If you want to get started with Azure App Service before you sign up for an Azure account, go to [Try App Service](https://tryappservice.azure.com/?appServiceName=mobile). There, you can immediately create a short-lived starter mobile app in App Service—no credit card required, and no commitments.\n\n## Create a storage account\n\n1. Create a storage account by following the tutorial [Create an Azure Storage Account]. \n\n2. In the Azure Portal, navigate to your newly created storage account and click the **Keys** icon. Copy the **Primary Connection String**.\n\n3. Navigate to your mobile app backend. Under **All Settings** -> **Application Settings** -> **Connection Strings**, create a new key named `MS_AzureStorageAccountConnectionString` and use the value copied from your storage account. Use **Custom** as the key type.\n\n## Add a storage controller to your server project\n\n1. In Visual Studio, open your .NET server project. Add the NuGet package [Microsoft.Azure.Mobile.Server.Files]. Be sure to select **Include prerelease**.\n\n2. In Visual Studio, open your .NET server project. Right-click the **Controllers** folder and select **Add** -> **Controller** -> **Web API 2 Controller - Empty**. Name the controller `TodoItemStorageController`.\n\n3. Add the following using statements:\n\n        using Microsoft.Azure.Mobile.Server.Files;\n        using Microsoft.Azure.Mobile.Server.Files.Controllers;\n\n4. Change the base class to `StorageController`:\n    \n        public class TodoItemStorageController : StorageController<TodoItem>\n\n5. Add the following methods to the class:\n\n        [HttpPost]\n        [Route(\"tables/TodoItem/{id}/StorageToken\")]\n        public async Task<HttpResponseMessage> PostStorageTokenRequest(string id, StorageTokenRequest value)\n        {\n            StorageToken token = await GetStorageTokenAsync(id, value);\n\n            return Request.CreateResponse(token);\n        }\n\n        // Get the files associated with this record\n        [HttpGet]\n        [Route(\"tables/TodoItem/{id}/MobileServiceFiles\")]\n        public async Task<HttpResponseMessage> GetFiles(string id)\n        {\n            IEnumerable<MobileServiceFile> files = await GetRecordFilesAsync(id);\n\n            return Request.CreateResponse(files);\n        }\n\n        [HttpDelete]\n        [Route(\"tables/TodoItem/{id}/MobileServiceFiles/{name}\")]\n        public Task Delete(string id, string name)\n        {\n            return base.DeleteFileAsync(id, name);\n        }\n\n6. Update the Web API configuration to set up attribute routing. In **Startup.MobileApp.cs**, add the following line to the `ConfigureMobileApp()` method, after the definition of the `config` variable:\n\n        config.MapHttpAttributeRoutes();\n\n7. Publish your server project to your mobile app backend.\n\n###Routes registered by the storage controller\n\nThe new `TodoItemStorageController` exposes two sub-resources under the record it manages:\n\n- StorageToken\n\n    + HTTP POST : Creates a storage token\n    \n        `/tables/TodoItem/{id}/MobileServiceFiles`\n    \n- MobileServiceFiles\n\n    + HTTP GET: Retrieves a list of files associated with the record\n    \n        `/tables/TodoItem/{id}/MobileServiceFiles`\n\n    + HTTP DELETE: Deletes the file specified in the file resource identifier\n    \n        `/tables/TodoItem/{id}/MobileServiceFiles/{fileid}`\n\n###Client and server communication\n\nNote that `TodoItemStorageController` does *not* have a route for uploading or downloading a blob. That is because a mobile client interacts with blob storage *directly* in order to perform these operations, after first getting a SAS token (Shared Access Signature) to securely access a particular blob or container. This is an important architectural design, as otherwise access to storage would be limited by the scability and availability of the mobile backend. Instead, by connecting directly to Azure Storage, the mobile client can take advantage of its features such as auto-partitioning and geo-distribution.\n\nA shared access signature provides delegated access to resources in your storage account. This means that you can grant a client limited permissions to objects in your storage account for a specified period of time and with a specified set of permissions, without having to share your account access keys. To learn more, see [Understanding Shared Access Signatures].\n\nThe diagram below shows the client and server interactions. Before uploading a file, the client requests a SAS token from the service. The service uses the storage connection string to generate a new SAS, which it then returns to the client. The SAS is time-limited and restricts permissions to just a particular file or container. The mobile client then uses this SAS and the Azure Storage client SDK to upload the file to blob storage.\n\n![Requesting a SAS token](./media/app-service-mobile-xamarin-forms-blob-storage/storage-token-diagram.png)\n\n## Update your client app to add image support\n\nOpen the Xamarin.Forms quickstart project in either Visual Studio or Xamarin Studio. \n\n>[AZURE.NOTE] This tutorial only contains instructions for the Android, iOS, and Windows Store platforms, not Windows Phone.\n\n###Add NuGet packages\n\nRight-click the solution and select **Manage NuGet packages for solution**. Add the following NuGet packages to **all** projects in the solution. Be sure to check **Include prerelease**.\n\n  - [Microsoft.Azure.Mobile.Client.Files]\n\n  - [Microsoft.Azure.Mobile.Client.SQLiteStore]\n\n  - [PCLStorage]\n\nFor convenience, this sample uses the [PCLStorage] library, but it is not required by the Azure Mobile Apps client SDK.\n\n[PCLStorage]: https://www.nuget.org/packages/PCLStorage/\n\n###Add IPlatform interface\n\nCreate a new interface `IPlatform` in the main portable library project. This follows the [Xamarin.Forms DependencyService] pattern to load the right platform-specific class at runtime. You will later add platform specific implementations in each of the client projects.\n\n1. Add the following using statements:\n\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Metadata;\n        using Microsoft.WindowsAzure.MobileServices.Sync;\n\n2. Replace the implementation with the following:\n\n        public interface IPlatform\n        {\n            Task <string> GetTodoFilesPathAsync();\n\n            Task<IMobileServiceFileDataSource> GetFileDataSource(MobileServiceFileMetadata metadata);\n\n            Task<string> TakePhotoAsync(object context);\n\n            Task DownloadFileAsync<T>(IMobileServiceSyncTable<T> table, MobileServiceFile file, string filename);\n        }\n\n###Add FileHelper class\n\n1. Create a new class `FileHelper` in the main portable library project. Add the following using statements:\n\n        using System.IO;\n        using PCLStorage;\n        using System.Threading.Tasks;\n        using Xamarin.Forms;\n\n2. Add the class definition:\n\n        public class FileHelper\n        {\n            public static async Task<string> CopyTodoItemFileAsync(string itemId, string filePath)\n            {\n                IFolder localStorage = FileSystem.Current.LocalStorage;\n\n                string fileName = Path.GetFileName(filePath);\n                string targetPath = await GetLocalFilePathAsync(itemId, fileName);\n\n                var sourceFile = await localStorage.GetFileAsync(filePath);\n                var sourceStream = await sourceFile.OpenAsync(FileAccess.Read);\n\n                var targetFile = await localStorage.CreateFileAsync(targetPath, CreationCollisionOption.ReplaceExisting);\n\n                using (var targetStream = await targetFile.OpenAsync(FileAccess.ReadAndWrite)) {\n                    await sourceStream.CopyToAsync(targetStream);\n                }\n\n                return targetPath;\n            }\n\n            public static async Task<string> GetLocalFilePathAsync(string itemId, string fileName)\n            {\n                IPlatform platform = DependencyService.Get<IPlatform>();\n\n                string recordFilesPath = Path.Combine(await platform.GetTodoFilesPathAsync(), itemId);\n\n                    var checkExists = await FileSystem.Current.LocalStorage.CheckExistsAsync(recordFilesPath);\n                    if (checkExists == ExistenceCheckResult.NotFound) {\n                        await FileSystem.Current.LocalStorage.CreateFolderAsync(recordFilesPath, CreationCollisionOption.ReplaceExisting);\n                    }\n\n                return Path.Combine(recordFilesPath, fileName);\n            }\n\n            public static async Task DeleteLocalFileAsync(Microsoft.WindowsAzure.MobileServices.Files.MobileServiceFile fileName)\n            {\n                string localPath = await GetLocalFilePathAsync(fileName.ParentId, fileName.Name);\n                var checkExists = await FileSystem.Current.LocalStorage.CheckExistsAsync(localPath);\n\n                if (checkExists == ExistenceCheckResult.FileExists) {\n                    var file = await FileSystem.Current.LocalStorage.GetFileAsync(localPath);\n                    await file.DeleteAsync();\n                }\n            }\n        }\n\n### Add a file sync handler\n\nCreate a new class `TodoItemFileSyncHandler` in the main portable library project. This class contains callbacks from the Azure SDK to notify your code when a file is added or removed.\n\nThe Azure Mobile Client SDK does not store actually store any file data: the client SDK invokes your implementation of `IFileSyncHandler` which in turn determines whether and how files are stored on the local device.\n\n1. Add the following using statements:\n\n        using System.Threading.Tasks;\n        using Microsoft.WindowsAzure.MobileServices.Files.Sync;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Metadata;\n        using Xamarin.Forms;\n\n2. Replace the class definition with the following: \n\n        public class TodoItemFileSyncHandler : IFileSyncHandler\n        {\n            private readonly TodoItemManager todoItemManager;\n\n            public TodoItemFileSyncHandler(TodoItemManager itemManager)\n            {\n                this.todoItemManager = itemManager;\n            }\n\n            public Task<IMobileServiceFileDataSource> GetDataSource(MobileServiceFileMetadata metadata)\n            {\n                IPlatform platform = DependencyService.Get<IPlatform>();\n                return platform.GetFileDataSource(metadata);\n            }\n\n            public async Task ProcessFileSynchronizationAction(MobileServiceFile file, FileSynchronizationAction action)\n            {\n                if (action == FileSynchronizationAction.Delete) {\n                    await FileHelper.DeleteLocalFileAsync(file);\n                }\n                else { // Create or update. We're aggressively downloading all files.\n                    await this.todoItemManager.DownloadFileAsync(file);\n                }\n            }\n        }\n\n###Update TodoItemManager\n\n1. In **TodoItemManager.cs**, uncomment the line `#define OFFLINE_SYNC_ENABLED`.\n\n2. In **TodoItemManager.cs**, add the following using statements:\n\n        using System.IO;\n        using Xamarin.Forms;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Sync;\n        using Microsoft.WindowsAzure.MobileServices.Eventing;\n\n3. In the constructor of `TodoItemManager`, add the following after the call to `DefineTable()`:\n\n        // Initialize file sync\n        this.client.InitializeFileSyncContext(new TodoItemFileSyncHandler(this), store);\n\n4. In the constructor, replace the call to `InitializeAsync` with the following. This will ensure that there are callbacks when records are modified in the local store. The file sync feature uses these callbacks to trigger your file sync handler.\n\n        this.client.SyncContext.InitializeAsync(store, StoreTrackingOptions.NotifyLocalAndServerOperations);\n\n5. In `SyncAsync()`, add the following after the call to `PushAsync()`:\n\n        await this.todoTable.PushFileChangesAsync();\n\n6. Add the following methods to `TodoItemManager`:\n\n        internal async Task DownloadFileAsync(MobileServiceFile file)\n        {\n            var todoItem = await todoTable.LookupAsync(file.ParentId);\n            IPlatform platform = DependencyService.Get<IPlatform>();\n\n            string filePath = await FileHelper.GetLocalFilePathAsync(file.ParentId, file.Name); \n            await platform.DownloadFileAsync(this.todoTable, file, filePath);\n        }\n\n        internal async Task<MobileServiceFile> AddImage(TodoItem todoItem, string imagePath)\n        {\n            string targetPath = await FileHelper.CopyTodoItemFileAsync(todoItem.Id, imagePath);\n            return await this.todoTable.AddFileAsync(todoItem, Path.GetFileName(targetPath));\n        }\n\n        internal async Task DeleteImage(TodoItem todoItem, MobileServiceFile file)\n        {\n            await this.todoTable.DeleteFileAsync(file);\n        }\n\n        internal async Task<IEnumerable<MobileServiceFile>> GetImageFilesAsync(TodoItem todoItem)\n        {\n            return await this.todoTable.GetFilesAsync(todoItem);\n        }\n\n###Add a details view\n\nIn this section, you will add a new details view for a todo item. The view is created when the user selects a todo item and it allows new images to be added to an item.\n\n1. Add a new class **TodoItemImage** to the portable library project with the following implementation:\n\n        public class TodoItemImage : INotifyPropertyChanged\n        {\n            private string name;\n            private string uri;\n\n            public MobileServiceFile File { get; private set; }\n\n            public string Name\n            {\n                get { return name; }\n                set\n                {\n                    name = value;\n                    OnPropertyChanged(nameof(Name));\n                }\n            }\n\n            public string Uri\n            {\n                get { return uri; }      \n                set\n                {\n                    uri = value;\n                    OnPropertyChanged(nameof(Uri));\n                }\n            }\n\n            public TodoItemImage(MobileServiceFile file, TodoItem todoItem)\n            {\n                Name = file.Name;\n                File = file;\n\n                FileHelper.GetLocalFilePathAsync(todoItem.Id, file.Name).ContinueWith(x => this.Uri = x.Result);\n            }\n\n            public event PropertyChangedEventHandler PropertyChanged;\n\n            private void OnPropertyChanged(string propertyName)\n            {\n                PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));\n            }\n        }\n\n2. Edit **App.cs**. Replace the initialization of `MainPage` with the following:\n    \n        MainPage = new NavigationPage(new TodoList());\n\n3. In **App.cs**, add the following property:\n\n        public static object UIContext { get; set; }\n\n4. Right-click the portable library project and select **Add** -> **New Item** -> **Cross-platform** -> **Forms Xaml Page**. Name the view `TodoItemDetailsView`.\n\n5. Open **TodoItemDetailsView.xaml** and replace the body of the ContentPage with the following:\n\n          <Grid>\n            <Grid.RowDefinitions>\n              <RowDefinition Height=\"Auto\"/>\n              <RowDefinition Height=\"Auto\"/>\n              <RowDefinition Height=\"*\"/>\n            </Grid.RowDefinitions>\n            <Button Clicked=\"OnAdd\" Text=\"Add image\"></Button>\n            <ListView x:Name=\"imagesList\"\n                      ItemsSource=\"{Binding Images}\"\n                      IsPullToRefreshEnabled=\"false\"\n                      Grid.Row=\"2\">\n              <ListView.ItemTemplate>\n                <DataTemplate>\n                  <ImageCell ImageSource=\"{Binding Uri}\"\n                             Text=\"{Binding Name}\">\n                  </ImageCell>\n                </DataTemplate>\n              </ListView.ItemTemplate>\n            </ListView>\n          </Grid>\n\n6. Edit **TodoItemDetailsView.xaml.cs** and add the following using statements:\n\n        using System.Collections.ObjectModel;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n\n7. Replace the implementation of `TodoItemDetailsView` with the following:\n\n        public partial class TodoItemDetailsView : ContentPage\n        {\n            private TodoItemManager manager;\n\n            public TodoItem TodoItem { get; set; }        \n            public ObservableCollection<TodoItemImage> Images { get; set; }\n\n            public TodoItemDetailsView(TodoItem todoItem, TodoItemManager manager)\n            {\n                InitializeComponent();\n                this.Title = todoItem.Name;\n\n                this.TodoItem = todoItem;\n                this.manager = manager;\n\n                this.Images = new ObservableCollection<TodoItemImage>();\n                this.BindingContext = this;\n            }\n\n            public async Task LoadImagesAsync()\n            {\n                IEnumerable<MobileServiceFile> files = await this.manager.GetImageFilesAsync(TodoItem);\n                this.Images.Clear();\n\n                foreach (var f in files) {\n                    var todoImage = new TodoItemImage(f, this.TodoItem);\n                    this.Images.Add(todoImage);\n                }\n            }\n\n            public async void OnAdd(object sender, EventArgs e)\n            {\n                IPlatform mediaProvider = DependencyService.Get<IPlatform>();\n                string sourceImagePath = await mediaProvider.TakePhotoAsync(App.UIContext);\n\n                if (sourceImagePath != null) {\n                    MobileServiceFile file = await this.manager.AddImage(this.TodoItem, sourceImagePath);\n\n                    var image = new TodoItemImage(file, this.TodoItem);\n                    this.Images.Add(image);\n                }\n            }\n        }\n\n###Update the main view \n\nUpdate the main view to open the details view when a todo item is selected.\n\nIn **TodoList.xaml.cs**, replace the implementation of `OnSelected` with the following:\n\n    public async void OnSelected(object sender, SelectedItemChangedEventArgs e)\n    {\n        var todo = e.SelectedItem as TodoItem;\n\n        if (todo != null) {\n            var detailsView = new TodoItemDetailsView(todo, manager);\n            await detailsView.LoadImagesAsync();\n            await Navigation.PushAsync(detailsView);\n        }\n\n        todoList.SelectedItem = null;\n    }\n\n###Update the Android project\n\nAdd platform-specific code to the Android project, including code for downloading a file and using the camera to capture a new image. \n\nThis code uses the Xamarin.Forms [DependencyService](https://developer.xamarin.com/guides/xamarin-forms/dependency-service/) to load the right platform-specific class at runtime.\n\n1. Add the component **Xamarin.Mobile** to the Android project.\n\n2. Add a new class `DroidPlatform` with the following implementation. Replace \"YourNamespace\" with the main namespace of your project.\n\n        using System;\n        using System.IO;\n        using System.Threading.Tasks;\n        using Android.Content;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Metadata;\n        using Microsoft.WindowsAzure.MobileServices.Files.Sync;\n        using Microsoft.WindowsAzure.MobileServices.Sync;\n        using Xamarin.Media;\n\n        [assembly: Xamarin.Forms.Dependency(typeof(YourNamespace.Droid.DroidPlatform))]\n        namespace YourNamespace.Droid\n        {\n            public class DroidPlatform : IPlatform\n            {\n                public async Task DownloadFileAsync<T>(IMobileServiceSyncTable<T> table, MobileServiceFile file, string filename)\n                {\n                    var path = await FileHelper.GetLocalFilePathAsync(file.ParentId, file.Name);\n                    await table.DownloadFileAsync(file, path);\n                }\n\n                public async Task<IMobileServiceFileDataSource> GetFileDataSource(MobileServiceFileMetadata metadata)\n                {\n                    var filePath = await FileHelper.GetLocalFilePathAsync(metadata.ParentDataItemId, metadata.FileName);\n                    return new PathMobileServiceFileDataSource(filePath);\n                }\n\n                public async Task<string> TakePhotoAsync(object context)\n                {\n                    try {\n                        var uiContext = context as Context;\n                        if (uiContext != null) {\n                            var mediaPicker = new MediaPicker(uiContext);\n                            var photo = await mediaPicker.TakePhotoAsync(new StoreCameraMediaOptions());\n\n                            return photo.Path;\n                        }\n                    }\n                    catch (TaskCanceledException) {\n                    }\n\n                    return null;\n                }\n\n                public Task<string> GetTodoFilesPathAsync()\n                {\n                    string appData = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);\n                    string filesPath = Path.Combine(appData, \"TodoItemFiles\");\n\n                    if (!Directory.Exists(filesPath)) {\n                        Directory.CreateDirectory(filesPath);\n                    }\n\n                    return Task.FromResult(filesPath);\n                }\n            }\n        }\n\n3. Edit **MainActivity.cs**. In `OnCreate`, add the following before the call to `LoadApplication()`:\n\n        App.UIContext = this;\n\n###Update the iOS project\n\nAdd platform-specific code to the iOS project.\n\n1. Add the component **Xamarin.Mobile** to the iOS project.\n\n2. Add a new class `TouchPlatform` with the following implementation. Replace \"YourNamespace\" with the main namespace of your project.\n\n        using System;\n        using System.Collections.Generic;\n        using System.IO;\n        using System.Text;\n        using System.Threading.Tasks;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Metadata;\n        using Microsoft.WindowsAzure.MobileServices.Files.Sync;\n        using Microsoft.WindowsAzure.MobileServices.Sync;\n        using Xamarin.Media;\n\n        [assembly: Xamarin.Forms.Dependency(typeof(YourNamespace.iOS.TouchPlatform))]\n        namespace YourNamespace.iOS\n        {\n            class TouchPlatform : IPlatform\n            {\n                public async Task DownloadFileAsync<T>(IMobileServiceSyncTable<T> table, MobileServiceFile file, string filename)\n                {\n                    var path = await FileHelper.GetLocalFilePathAsync(file.ParentId, file.Name);\n                    await table.DownloadFileAsync(file, path);\n                }\n\n                public async Task<IMobileServiceFileDataSource> GetFileDataSource(MobileServiceFileMetadata metadata)\n                {\n                    var filePath = await FileHelper.GetLocalFilePathAsync(metadata.ParentDataItemId, metadata.FileName);\n                    return new PathMobileServiceFileDataSource(filePath);\n                }\n\n                public async Task<string> TakePhotoAsync(object context)\n                {\n                    try {\n                        var mediaPicker = new MediaPicker();\n                        var mediaFile = await mediaPicker.PickPhotoAsync();\n                        return mediaFile.Path;\n                    }\n                    catch (TaskCanceledException) {\n                        return null;\n                    }\n                }\n\n                public Task<string> GetTodoFilesPathAsync()\n                {\n                    string filesPath = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), \"TodoItemFiles\");\n\n                    if (!Directory.Exists(filesPath)) {\n                        Directory.CreateDirectory(filesPath);\n                    }\n\n                    return Task.FromResult(filesPath);\n                }\n            }\n        }\n\n3. Edit **AppDelegate.cs** and uncomment the call to `SQLitePCL.CurrentPlatform.Init()`.\n\n###Update the Windows project\n\n1. Install the Visual Studio extension [SQLite for Windows 8.1](http://go.microsoft.com/fwlink/?LinkID=716919). \nFor more information, see the tutorial [Enable offline sync for your Windows app](app-service-mobile-windows-store-dotnet-get-started-offline-data.md). \n\n2. Edit **Package.appxmanifest** and check the **Webcam** capability.\n\n3. Add a new class `WindowsStorePlatform` with the following implementation. Replace \"YourNamespace\" with the main namespace of your project.\n\n        using System;\n        using System.Threading.Tasks;\n        using Microsoft.WindowsAzure.MobileServices.Files;\n        using Microsoft.WindowsAzure.MobileServices.Files.Metadata;\n        using Microsoft.WindowsAzure.MobileServices.Files.Sync;\n        using Microsoft.WindowsAzure.MobileServices.Sync;\n        using Windows.Foundation;\n        using Windows.Media.Capture;\n        using Windows.Storage;\n        using YourNamespace;\n\n        [assembly: Xamarin.Forms.Dependency(typeof(WinApp.WindowsStorePlatform))]\n        namespace WinApp\n        {\n            public class WindowsStorePlatform : IPlatform\n            {\n                public async Task DownloadFileAsync<T>(IMobileServiceSyncTable<T> table, MobileServiceFile file, string filename)\n                {\n                    var path = await FileHelper.GetLocalFilePathAsync(file.ParentId, file.Name);\n                    await table.DownloadFileAsync(file, path);\n                }\n\n                public async Task<IMobileServiceFileDataSource> GetFileDataSource(MobileServiceFileMetadata metadata)\n                {\n                    var filePath = await FileHelper.GetLocalFilePathAsync(metadata.ParentDataItemId, metadata.FileName);\n                    return new PathMobileServiceFileDataSource(filePath);\n                }\n\n                public async Task<string> GetTodoFilesPathAsync()\n                {\n                    var storageFolder = ApplicationData.Current.LocalFolder;\n                    var filePath = \"TodoItemFiles\";\n\n                    var result = await storageFolder.TryGetItemAsync(filePath);\n\n                    if (result == null) {\n                        result = await storageFolder.CreateFolderAsync(filePath);\n                    }\n\n                    return result.Name; // later operations will use relative paths\n                }\n\n                public async Task<string> TakePhotoAsync(object context)\n                {\n                    try {\n                        CameraCaptureUI dialog = new CameraCaptureUI();\n                        Size aspectRatio = new Size(16, 9);\n                        dialog.PhotoSettings.CroppedAspectRatio = aspectRatio;\n\n                        StorageFile file = await dialog.CaptureFileAsync(CameraCaptureUIMode.Photo);\n                        return file.Path;\n                    }\n                    catch (TaskCanceledException) {\n                        return null;\n                    }\n                }\n            }\n        }\n\n##Summary\n\nThis article described how to use the new file support in the Azure Mobile client and server SDK to work with Azure Storage. \n\n- Create a storage account and add the connection string to your mobile app backend. Only the backend has the key to Azure Storage: the mobile client requests a SAS token (Shared Access Signature) whenever it needs to access Azure Storage. To learn more about SAS tokens in Azure Storage, see [Understanding Shared Access Signatures].\n\n- Create a controller that subclasses `StorageController` in order to handle the SAS token requests and to get the files that are associated with a record. By default, files are associated with a record by using the record ID as part of the container name; the behavior can be customized by specifying an implementation of `IContainerNameResolver`. The SAS token policy can also be customized.\n\n- The Azure Mobile Client SDK does not store actually store any file data. Rather, the client SDK invokes your `IFileSyncHandler`, which then decides how (and if) files are stored on the local device. The sync handler is registered as follows:\n\n        client.InitializeFileSync(new MyFileSyncHandler(), store);\n\n      + `IFileSyncHandler.GetDataSource` is called when the Azure Mobile Client SDK needs the file data (e.g., as part of the upload process). This gives you the ability manage how (and if) files are stored on the local device and return that information when needed.\n\n      + `IFileSyncHandler.ProcessFileSynchronizationAction` is invoked as part of the file synchronization flow. A file reference and a FileSynchronizationAction enumeration value are provided so you can decide how your application should handle that event (e.g. automatically downloading a file when it is created or updated, deleting a file from the local device when that file is deleted on the server).\n\n- A `MobileServiceFile` can be used either in online or offline mode, by using a `IMobileServiceTable` or `IMobileServiceSyncTable`, respectively. In the offline scenario, the upload will occur when the app calls `PushFileChangesAsync`. This causes the offline operation queue to be processed; for each file operation, the Azure Mobile client SDK will invoke the `GetDataSource` method on the `IFileSyncHandler` instance to retrieve the file contents for the upload.\n\n- In order to retrieve an item's files, call the ``GetFilesAsync` method on the  `IMobileServiceTable<T>` or IMobileServiceSyncTable<T>` instance. This method returns a list of files associated with the data item provided. (Note: this is a *local* operation and will return the files based on the state of the object when it was last synchronized. To get an updated list of files from the server, you should initiate a sync operation first.)\n\n        IEnumerable<MobileServiceFile> files = await myTable.GetFilesAsync(myItem);\n\n- The file sync feature uses record change notifications on the local store in order to retrieve the records that the client received as part of a push or pull operation. This is achieved by turning on local and server notifications for the sync context using the `StoreTrackingOptions` parameter. \n\n        this.client.SyncContext.InitializeAsync(store, StoreTrackingOptions.NotifyLocalAndServerOperations);\n\n      + Other store tracking options are available, such as local-only or server-only notifications. You can add or own custom callback using the `EventManager` property of `IMobileServiceClient`:\n\n            jobService.MobileService.EventManager.Subscribe<StoreOperationCompletedEvent>(StoreOperationEventHandler);\n\n- It is possible to add or remove files from a record by modifying blob storage directly, since the association is achieved through a naming convention. However, in this case you should always **update the record timestamp when the associated blobs are modified**. The Azure Mobile client SDK always updates a record when adding or removing a file. \n\n    The reason for this requirement is that some mobile clients will already have the record in local storage. When these clients perform an incremental pull, this record will not be returned and the client will not query for the new associated files. To avoid this problem, it is recommended that you update the record timestamp when performing any blob storage change that does not use the Azure Mobile client SDK.\n\n- The client project uses the [Xamarin.Forms DependencyService] pattern to load the right platform-specific class at runtime. In this sample, we defined an interface `IPlatform` with implementations in each of the platform-specific projects.\n\n<!-- URLs. -->\n\n[Visual Studio Community 2013]: https://go.microsoft.com/fwLink/p/?LinkID=534203\n[Create a Xamarin.Forms app]: ../app-service-mobile-xamarin-forms-get-started.md\n[Xamarin.Forms DependencyService]: https://developer.xamarin.com/guides/xamarin-forms/dependency-service/\n[Microsoft.Azure.Mobile.Client.Files]: https://www.nuget.org/packages/Microsoft.Azure.Mobile.Client.Files/\n[Microsoft.Azure.Mobile.Client.SQLiteStore]: https://www.nuget.org/packages/Microsoft.Azure.Mobile.Client.SQLiteStore/\n[Microsoft.Azure.Mobile.Server.Files]: https://www.nuget.org/packages/Microsoft.Azure.Mobile.Server.Files/\n[Understanding Shared Access Signatures]: ../storage/storage-dotnet-shared-access-signature-part-1.md\n[Create an Azure Storage Account]:  ../storage/storage-create-storage-account.md#create-a-storage-account\n"
}