{
  "nodes": [
    {
      "content": "Preparing your environment to back up Azure virtual machines | Microsoft Azure",
      "pos": [
        27,
        105
      ]
    },
    {
      "content": "Make sure your environment is prepared for backing up virtual machines in Azure",
      "pos": [
        124,
        203
      ]
    },
    {
      "content": "Prepare your environment to back up Azure virtual machines",
      "pos": [
        566,
        624
      ]
    },
    {
      "content": "Before you can back up an Azure virtual machine (VM), there are three conditions that must exist.",
      "pos": [
        626,
        723
      ]
    },
    {
      "pos": [
        727,
        830
      ],
      "content": "You need to create a backup vault or identify an existing backup vault <bpt id=\"p1\">*</bpt>in the same region as your VM<ept id=\"p1\">*</ept>."
    },
    {
      "content": "Establish network connectivity between the Azure public Internet addresses and the Azure storage endpoints.",
      "pos": [
        833,
        940
      ]
    },
    {
      "content": "Install the VM agent on the VM.",
      "pos": [
        943,
        974
      ]
    },
    {
      "content": "If you know these conditions already exist in your environment then proceed to the <bpt id=\"p1\">[</bpt>Back up your VMs article<ept id=\"p1\">](backup-azure-vms.md)</ept>.",
      "pos": [
        976,
        1107
      ]
    },
    {
      "content": "Otherwise, read on, this article will lead you through the steps to prepare your environment to back up an Azure VM.",
      "pos": [
        1108,
        1224
      ]
    },
    {
      "content": "Limitations when backing up and restoring a VM",
      "pos": [
        1230,
        1276
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> Azure has two deployment models for creating and working with resources: <bpt id=\"p1\">[</bpt>Resource Manager and classic<ept id=\"p1\">](../resource-manager-deployment-model.md)</ept>.",
      "pos": [
        1279,
        1437
      ]
    },
    {
      "content": "The following list provides the limitations when deploying in the classic model.",
      "pos": [
        1438,
        1518
      ]
    },
    {
      "content": "Backing up Azure Resource Manager (ARM)-based (aka IaaS V2) virtual machines is not currently supported.",
      "pos": [
        1522,
        1626
      ]
    },
    {
      "content": "Backing up virtual machines with more than 16 data disks is not supported.",
      "pos": [
        1629,
        1703
      ]
    },
    {
      "content": "Backing up virtual machines using Premium storage is not supported.",
      "pos": [
        1706,
        1773
      ]
    },
    {
      "content": "Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.",
      "pos": [
        1776,
        1872
      ]
    },
    {
      "content": "Replacing an existing virtual machine during restore is not supported.",
      "pos": [
        1875,
        1945
      ]
    },
    {
      "content": "First delete the existing virtual machine and any associated disks, and then restore the data from backup.",
      "pos": [
        1946,
        2052
      ]
    },
    {
      "content": "Cross-region backup and restore is not supported.",
      "pos": [
        2055,
        2104
      ]
    },
    {
      "content": "Backing up virtual machines by using the Azure Backup service is supported in all public regions of Azure (see the <bpt id=\"p1\">[</bpt>checklist<ept id=\"p1\">](https://azure.microsoft.com/regions/#services)</ept> of supported regions).",
      "pos": [
        2107,
        2303
      ]
    },
    {
      "content": "If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.",
      "pos": [
        2304,
        2427
      ]
    },
    {
      "content": "Backing up virtual machines by using the Azure Backup service is supported only for select operating system versions:",
      "pos": [
        2430,
        2547
      ]
    },
    {
      "content": "<bpt id=\"p1\">**</bpt>Linux<ept id=\"p1\">**</ept>: See <bpt id=\"p2\">[</bpt>the list of distributions that are endorsed by Azure<ept id=\"p2\">](../virtual-machines/virtual-machines-linux-endorsed-distros.md)</ept>.",
      "pos": [
        2552,
        2686
      ]
    },
    {
      "content": "Other Bring-Your-Own-Linux distributions also should work as long as the VM agent is available on the virtual machine.",
      "pos": [
        2687,
        2805
      ]
    },
    {
      "pos": [
        2810,
        2892
      ],
      "content": "<bpt id=\"p1\">**</bpt>Windows Server<ept id=\"p1\">**</ept>:  Versions older than Windows Server 2008 R2 are not supported."
    },
    {
      "content": "Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell.",
      "pos": [
        2899,
        3015
      ]
    },
    {
      "content": "Read more about <bpt id=\"p1\">[</bpt>restoring a multi-DC domain controller<ept id=\"p1\">](backup-azure-restore-vms.md#restoring-domain-controller-vms)</ept>.",
      "pos": [
        3016,
        3134
      ]
    },
    {
      "content": "Restoring virtual machines that have the following special network configurations is supported only through PowerShell.",
      "pos": [
        3141,
        3260
      ]
    },
    {
      "content": "VMs that you create by using the restore workflow in the UI will not have these network configurations after the restore operation is complete.",
      "pos": [
        3261,
        3404
      ]
    },
    {
      "content": "To learn more, see <bpt id=\"p1\">[</bpt>Restoring VMs with special network configurations<ept id=\"p1\">](backup-azure-restore-vms.md#restoring-vms-with-special-netwrok-configurations)</ept>.",
      "pos": [
        3405,
        3555
      ]
    },
    {
      "content": "Virtual machines under load balancer configuration (internal and external)",
      "pos": [
        3566,
        3640
      ]
    },
    {
      "content": "Virtual machines with multiple reserved IP addresses",
      "pos": [
        3651,
        3703
      ]
    },
    {
      "content": "Virtual machines with multiple network adapters",
      "pos": [
        3714,
        3761
      ]
    },
    {
      "content": "Create a backup vault for a VM",
      "pos": [
        3766,
        3796
      ]
    },
    {
      "content": "A backup vault is an entity that stores all the backups and recovery points that have been created over time.",
      "pos": [
        3798,
        3907
      ]
    },
    {
      "content": "The backup vault also contains the backup policies that will be applied to the virtual machines being backed up.",
      "pos": [
        3908,
        4020
      ]
    },
    {
      "content": "This image shows the relationships between the various Azure Backup entities:",
      "pos": [
        4022,
        4099
      ]
    },
    {
      "content": "Azure Backup entities and relationships",
      "pos": [
        4106,
        4145
      ]
    },
    {
      "content": "To create a backup vault:",
      "pos": [
        4202,
        4227
      ]
    },
    {
      "pos": [
        4232,
        4295
      ],
      "content": "Sign in to the <bpt id=\"p1\">[</bpt>Azure portal<ept id=\"p1\">](http://manage.windowsazure.com/)</ept>."
    },
    {
      "content": "In the Azure portal click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Hybrid Integration<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Backup<ept id=\"p3\">**</ept>.",
      "pos": [
        4300,
        4372
      ]
    },
    {
      "content": "When you click <bpt id=\"p1\">**</bpt>Backup<ept id=\"p1\">**</ept>, you will automatically switch to the classic portal (shown after the Note).",
      "pos": [
        4373,
        4475
      ]
    },
    {
      "content": "Ibiza portal",
      "pos": [
        4483,
        4495
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> If your subscription was last used in the classic portal, then your subscription may open in the classic portal.",
      "pos": [
        4563,
        4688
      ]
    },
    {
      "content": "In this event, to create a backup vault, click <bpt id=\"p1\">**</bpt>New<ept id=\"p1\">**</ept> &gt; <bpt id=\"p2\">**</bpt>Data Services<ept id=\"p2\">**</ept> &gt; <bpt id=\"p3\">**</bpt>Recovery Services<ept id=\"p3\">**</ept> &gt; <bpt id=\"p4\">**</bpt>Backup Vault<ept id=\"p4\">**</ept> &gt; <bpt id=\"p5\">**</bpt>Quick Create<ept id=\"p5\">**</ept> (see the image below).",
      "pos": [
        4689,
        4848
      ]
    },
    {
      "content": "Create backup vault",
      "pos": [
        4856,
        4875
      ]
    },
    {
      "content": "For <bpt id=\"p1\">**</bpt>Name<ept id=\"p1\">**</ept>, enter a friendly name to identify the vault.",
      "pos": [
        4938,
        4996
      ]
    },
    {
      "content": "The name needs to be unique for the Azure subscription.",
      "pos": [
        4997,
        5052
      ]
    },
    {
      "content": "Type a name that contains between 2 and 50 characters.",
      "pos": [
        5053,
        5107
      ]
    },
    {
      "content": "It must start with a letter, and can contain only letters, numbers, and hyphens.",
      "pos": [
        5108,
        5188
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Region<ept id=\"p1\">**</ept>, select the geographic region for the vault.",
      "pos": [
        5193,
        5251
      ]
    },
    {
      "content": "The vault must be in the same region as the virtual machines that you want to protect.",
      "pos": [
        5252,
        5338
      ]
    },
    {
      "content": "If you have virtual machines in multiple regions, you must create a backup vault in each region.",
      "pos": [
        5339,
        5435
      ]
    },
    {
      "content": "There is no need to specify storage accounts to store the backup data--the backup vault and the Azure Backup service handle this automatically.",
      "pos": [
        5436,
        5579
      ]
    },
    {
      "content": "In <bpt id=\"p1\">**</bpt>Subscription<ept id=\"p1\">**</ept> select the subscription you want to associate with the backup vault.",
      "pos": [
        5584,
        5672
      ]
    },
    {
      "content": "There will be multiple choices only if your organizational account is associated with multiple Azure subscriptions.",
      "pos": [
        5673,
        5788
      ]
    },
    {
      "content": "Click <bpt id=\"p1\">**</bpt>Create Vault<ept id=\"p1\">**</ept>.",
      "pos": [
        5793,
        5816
      ]
    },
    {
      "content": "It can take a while for the backup vault to be created.",
      "pos": [
        5817,
        5872
      ]
    },
    {
      "content": "Monitor the status notifications at the bottom of the portal.",
      "pos": [
        5873,
        5934
      ]
    },
    {
      "content": "Create vault toast notification",
      "pos": [
        5942,
        5973
      ]
    },
    {
      "content": "A message will confirm that the vault has been successfully created.",
      "pos": [
        6032,
        6100
      ]
    },
    {
      "content": "It will be listed on the <bpt id=\"p1\">**</bpt>recovery services<ept id=\"p1\">**</ept> page as <bpt id=\"p2\">**</bpt>Active<ept id=\"p2\">**</ept>.",
      "pos": [
        6101,
        6167
      ]
    },
    {
      "content": "Make sure to choose the appropriate storage redundancy option right after the vault has been created.",
      "pos": [
        6168,
        6269
      ]
    },
    {
      "content": "Read more about <bpt id=\"p1\">[</bpt>setting the storage redundancy option in the backup vault<ept id=\"p1\">](backup-configure-vault.md#azure-backup---storage-redundancy-options)</ept>.",
      "pos": [
        6270,
        6415
      ]
    },
    {
      "content": "List of backup vaults",
      "pos": [
        6423,
        6444
      ]
    },
    {
      "pos": [
        6506,
        6635
      ],
      "content": "Click the backup vault to go to the <bpt id=\"p1\">**</bpt>Quick Start<ept id=\"p1\">**</ept> page, where the instructions for backing up Azure virtual machines are shown."
    },
    {
      "content": "Virtual machine backup instructions on the Dashboard page",
      "pos": [
        6643,
        6700
      ]
    },
    {
      "content": "Network connectivity",
      "pos": [
        6767,
        6787
      ]
    },
    {
      "content": "The backup extension needs connectivity to the Azure public IP addresses to function correctly because it sends commands to an Azure Storage endpoint (HTTP URL) to manage the snapshots of the VM.",
      "pos": [
        6789,
        6984
      ]
    },
    {
      "content": "Without the right Internet connectivity, these HTTP requests from the VM will time out and the backup operation will fail.",
      "pos": [
        6985,
        7107
      ]
    },
    {
      "content": "Network restrictions with NSGs",
      "pos": [
        7113,
        7143
      ]
    },
    {
      "content": "If your deployment has access restrictions in place (through a network security group (NSG), for example), then you need to take additional steps to ensure that backup traffic to the backup vault remains unaffected.",
      "pos": [
        7145,
        7360
      ]
    },
    {
      "content": "There are two ways to provide a path for the backup traffic:",
      "pos": [
        7362,
        7422
      ]
    },
    {
      "pos": [
        7427,
        7533
      ],
      "content": "Whitelist the <bpt id=\"p1\">[</bpt>Azure datacenter IP ranges<ept id=\"p1\">](http://www.microsoft.com/en-us/download/details.aspx?id=41653)</ept>."
    },
    {
      "content": "Deploy an HTTP proxy to route the traffic.",
      "pos": [
        7537,
        7579
      ]
    },
    {
      "content": "The trade-off is between manageability, granular control, and cost.",
      "pos": [
        7581,
        7648
      ]
    },
    {
      "content": "Option",
      "pos": [
        7651,
        7657
      ]
    },
    {
      "content": "Advantages",
      "pos": [
        7658,
        7668
      ]
    },
    {
      "content": "Disadvantages",
      "pos": [
        7669,
        7682
      ]
    },
    {
      "content": "OPTION 1: Whitelist IP ranges",
      "pos": [
        7719,
        7748
      ]
    },
    {
      "content": "No additional costs.",
      "pos": [
        7750,
        7770
      ]
    },
    {
      "content": "For opening access in an NSG, use the <ph id=\"ph1\">&lt;i&gt;</ph>Set-AzureNetworkSecurityRule<ph id=\"ph2\">&lt;/i&gt;</ph> cmdlet.",
      "pos": [
        7778,
        7859
      ]
    },
    {
      "content": "Complex to manage as the impacted IP ranges change over time.",
      "pos": [
        7862,
        7923
      ]
    },
    {
      "content": "Provides access to the whole of Azure, and not just Storage.",
      "pos": [
        7927,
        7987
      ]
    },
    {
      "content": "OPTION 2: HTTP proxy",
      "pos": [
        7990,
        8010
      ]
    },
    {
      "content": "Granular control in the proxy over the storage URLs allowed.",
      "pos": [
        8012,
        8072
      ]
    },
    {
      "content": "Single point of Internet access to VMs.",
      "pos": [
        8076,
        8115
      ]
    },
    {
      "content": "Not subject to Azure IP address changes.",
      "pos": [
        8119,
        8159
      ]
    },
    {
      "content": "Additional costs for running a VM with the proxy software.",
      "pos": [
        8161,
        8219
      ]
    },
    {
      "content": "Using an HTTP proxy for VM backups",
      "pos": [
        8226,
        8260
      ]
    },
    {
      "content": "When backing up a VM, the snapshot management commands are sent from the backup extension to Azure Storage using an HTTPS API.",
      "pos": [
        8261,
        8387
      ]
    },
    {
      "content": "This traffic must be routed from the extension through the proxy, since only the proxy will be configured to have access to the public Internet.",
      "pos": [
        8388,
        8532
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> There is no recommendation for the proxy software that should be used.",
      "pos": [
        8535,
        8618
      ]
    },
    {
      "content": "Ensure that you pick a proxy that is compatible with the configuration steps below.",
      "pos": [
        8619,
        8702
      ]
    },
    {
      "content": "In the example below, the App VM needs to be configured to use the Proxy VM for all HTTP traffic bound for the public Internet.",
      "pos": [
        8704,
        8831
      ]
    },
    {
      "content": "The Proxy VM needs to be configured to allow incoming traffic from VMs in the virtual network.",
      "pos": [
        8832,
        8926
      ]
    },
    {
      "content": "And finally, the NSG (named <bpt id=\"p1\">*</bpt>NSG-lockdown<ept id=\"p1\">*</ept>) needs a new security rule that allows outbound Internet traffic from the Proxy VM.",
      "pos": [
        8927,
        9053
      ]
    },
    {
      "content": "NSG with HTTP proxy deployment diagram",
      "pos": [
        9057,
        9095
      ]
    },
    {
      "content": "A) Allow outgoing network connections:",
      "pos": [
        9158,
        9196
      ]
    },
    {
      "content": "For Windows machines, run the following command in an elevated command prompt:",
      "pos": [
        9203,
        9281
      ]
    },
    {
      "content": "This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.",
      "pos": [
        9362,
        9468
      ]
    },
    {
      "pos": [
        9473,
        9551
      ],
      "content": "For Linux machines, add the following line to the <ph id=\"ph1\">```/etc/environment```</ph> file:"
    },
    {
      "pos": [
        9618,
        9678
      ],
      "content": "Add the following lines to the <ph id=\"ph1\">```/etc/waagent.conf```</ph> file:"
    },
    {
      "content": "B) Allow incoming connections on the proxy server:",
      "pos": [
        9761,
        9811
      ]
    },
    {
      "content": "On the proxy server, open Windows Firewall.",
      "pos": [
        9818,
        9861
      ]
    },
    {
      "content": "The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.",
      "pos": [
        9862,
        9958
      ]
    },
    {
      "content": "Open the Firewall",
      "pos": [
        9966,
        9983
      ]
    },
    {
      "pos": [
        10039,
        10128
      ],
      "content": "In the Windows Firewall dialog, right-click  <bpt id=\"p1\">**</bpt>Inbound Rules<ept id=\"p1\">**</ept> and click <bpt id=\"p2\">**</bpt>New Rule...<ept id=\"p2\">**</ept>."
    },
    {
      "content": "Create a new rule",
      "pos": [
        10136,
        10153
      ]
    },
    {
      "pos": [
        10209,
        10315
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>New Inbound Rule Wizard<ept id=\"p1\">**</ept>, choose the <bpt id=\"p2\">**</bpt>Custom<ept id=\"p2\">**</ept> option for the <bpt id=\"p3\">**</bpt>Rule Type<ept id=\"p3\">**</ept> and click <bpt id=\"p4\">**</bpt>Next<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        10319,
        10401
      ],
      "content": "On the page to select the <bpt id=\"p1\">**</bpt>Program<ept id=\"p1\">**</ept>, choose <bpt id=\"p2\">**</bpt>All Programs<ept id=\"p2\">**</ept> and click <bpt id=\"p3\">**</bpt>Next<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        10406,
        10493
      ],
      "content": "On the <bpt id=\"p1\">**</bpt>Protocol and Ports<ept id=\"p1\">**</ept> page, enter the following information and click <bpt id=\"p2\">**</bpt>Next<ept id=\"p2\">**</ept>:"
    },
    {
      "content": "Create a new rule",
      "pos": [
        10501,
        10518
      ]
    },
    {
      "pos": [
        10577,
        10609
      ],
      "content": "for <bpt id=\"p1\">*</bpt>Protocol type<ept id=\"p1\">*</ept> choose <bpt id=\"p2\">*</bpt>TCP<ept id=\"p2\">*</ept>"
    },
    {
      "pos": [
        10616,
        10733
      ],
      "content": "for <bpt id=\"p1\">*</bpt>Local port<ept id=\"p1\">*</ept> choose <bpt id=\"p2\">*</bpt>Specific Ports<ept id=\"p2\">*</ept>, in the field below specify the <ph id=\"ph1\">```&lt;Proxy Port&gt;```</ph> that has been configured."
    },
    {
      "pos": [
        10740,
        10776
      ],
      "content": "for <bpt id=\"p1\">*</bpt>Remote port<ept id=\"p1\">*</ept> select <bpt id=\"p2\">*</bpt>All Ports<ept id=\"p2\">*</ept>"
    },
    {
      "content": "For the rest of the wizard, click all the way to the end and give this rule a name.",
      "pos": [
        10782,
        10865
      ]
    },
    {
      "content": "C) Add an exception rule to the NSG:",
      "pos": [
        10869,
        10905
      ]
    },
    {
      "content": "In an Azure PowerShell command prompt, type out the following command:",
      "pos": [
        10909,
        10979
      ]
    },
    {
      "content": "This command adds an exception to the NSG, which allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS).",
      "pos": [
        11272,
        11423
      ]
    },
    {
      "content": "If you need to hit a specific port in the public Internet, make sure that you add that to the <ph id=\"ph1\">```-DestinationPortRange```</ph> as well.",
      "pos": [
        11424,
        11554
      ]
    },
    {
      "content": "Ensure that you replace the names in the example with the details appropriate to your deployment.",
      "pos": [
        11557,
        11654
      ]
    },
    {
      "content": "VM agent",
      "pos": [
        11661,
        11669
      ]
    },
    {
      "content": "Before you can back up the Azure virtual machine, you should ensure that the Azure VM agent is correctly installed on the virtual machine.",
      "pos": [
        11671,
        11809
      ]
    },
    {
      "content": "Since the VM agent is an optional component at the time that the virtual machine is created, ensure that the check box for the VM agent is selected before the virtual machine is provisioned.",
      "pos": [
        11810,
        12000
      ]
    },
    {
      "content": "Manual installation and update",
      "pos": [
        12006,
        12036
      ]
    },
    {
      "content": "The VM agent is already present in VMs that are created from the Azure gallery.",
      "pos": [
        12038,
        12117
      ]
    },
    {
      "content": "However, virtual machines that are migrated from on-premises datacenters would not have the VM agent installed.",
      "pos": [
        12118,
        12229
      ]
    },
    {
      "content": "For such VMs, the VM agent needs to be installed explicitly.",
      "pos": [
        12230,
        12290
      ]
    },
    {
      "content": "Read more about <bpt id=\"p1\">[</bpt>installing the VM agent on an existing VM<ept id=\"p1\">](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)</ept>.",
      "pos": [
        12291,
        12450
      ]
    },
    {
      "content": "Operation",
      "pos": [
        12456,
        12465
      ]
    },
    {
      "content": "Windows",
      "pos": [
        12472,
        12479
      ]
    },
    {
      "content": "Linux",
      "pos": [
        12486,
        12491
      ]
    },
    {
      "content": "Installing the VM agent",
      "pos": [
        12518,
        12541
      ]
    },
    {
      "content": "Download and install the <bpt id=\"p1\">[</bpt>agent MSI<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=394789&amp;clcid=0x409)</ept>.",
      "pos": [
        12548,
        12644
      ]
    },
    {
      "content": "You will need Administrator privileges to complete the installation.",
      "pos": [
        12645,
        12713
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Update the VM property<ept id=\"p1\">](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)</ept> to indicate that the agent is installed.",
      "pos": [
        12718,
        12882
      ]
    },
    {
      "content": "Install the latest <bpt id=\"p1\">[</bpt>Linux agent<ept id=\"p1\">](https://github.com/Azure/WALinuxAgent)</ept> from GitHub.",
      "pos": [
        12890,
        12974
      ]
    },
    {
      "content": "You will need Administrator privileges to complete the installation.",
      "pos": [
        12975,
        13043
      ]
    },
    {
      "content": "<bpt id=\"p1\">[</bpt>Update the VM property<ept id=\"p1\">](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)</ept> to indicate that the agent is installed.",
      "pos": [
        13049,
        13213
      ]
    },
    {
      "content": "Updating the VM agent",
      "pos": [
        13218,
        13239
      ]
    },
    {
      "content": "Updating the VM agent is as simple as reinstalling the <bpt id=\"p1\">[</bpt>VM agent binaries<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=394789&amp;clcid=0x409)</ept>.",
      "pos": [
        13242,
        13376
      ]
    },
    {
      "content": "Ensure that no backup operation is running while the VM agent is being updated.",
      "pos": [
        13385,
        13464
      ]
    },
    {
      "content": "Follow the instructions on <bpt id=\"p1\">[</bpt>updating the Linux VM agent <ept id=\"p1\">](../virtual-machines-linux-update-agent.md)</ept>.",
      "pos": [
        13467,
        13568
      ]
    },
    {
      "content": "Ensure that no backup operation is running while the VM agent is being updated.",
      "pos": [
        13577,
        13656
      ]
    },
    {
      "content": "Validating the VM agent installation",
      "pos": [
        13661,
        13697
      ]
    },
    {
      "content": "Navigate to the <bpt id=\"p1\">*</bpt>C:\\WindowsAzure\\Packages<ept id=\"p1\">*</ept> folder in the Azure VM.",
      "pos": [
        13704,
        13770
      ]
    },
    {
      "content": "You should find the WaAppAgent.exe file present.",
      "pos": [
        13775,
        13823
      ]
    },
    {
      "content": "Right-click the file, go to <bpt id=\"p1\">**</bpt>Properties<ept id=\"p1\">**</ept>, and then select the <bpt id=\"p2\">**</bpt>Details<ept id=\"p2\">**</ept> tab.",
      "pos": [
        13828,
        13908
      ]
    },
    {
      "content": "The Product Version field should be 2.6.1198.718 or higher.",
      "pos": [
        13909,
        13968
      ]
    },
    {
      "content": "N/A",
      "pos": [
        13971,
        13974
      ]
    },
    {
      "pos": [
        13979,
        14167
      ],
      "content": "Learn about the <bpt id=\"p1\">[</bpt>VM agent<ept id=\"p1\">](https://go.microsoft.com/fwLink/?LinkID=390493&amp;clcid=0x409)</ept> and <bpt id=\"p2\">[</bpt>how to install it<ept id=\"p2\">](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/)</ept>."
    },
    {
      "content": "Backup extension",
      "pos": [
        14173,
        14189
      ]
    },
    {
      "content": "To back up the virtual machine, the Azure Backup service installs an extension to the VM agent.",
      "pos": [
        14191,
        14286
      ]
    },
    {
      "content": "The Azure Backup service seamlessly upgrades and patches the backup extension without additional user intervention.",
      "pos": [
        14287,
        14402
      ]
    },
    {
      "content": "The backup extension is installed if the VM is running.",
      "pos": [
        14404,
        14459
      ]
    },
    {
      "content": "A running VM also provides the greatest chance of getting an application-consistent recovery point.",
      "pos": [
        14460,
        14559
      ]
    },
    {
      "content": "However, the Azure Backup service will continue to back up the VM--even if it is turned off, and the extension could not be installed (aka Offline VM).",
      "pos": [
        14560,
        14711
      ]
    },
    {
      "content": "In this case, the recovery point will be <bpt id=\"p1\">*</bpt>crash consistent<ept id=\"p1\">*</ept> as discussed above.",
      "pos": [
        14712,
        14791
      ]
    },
    {
      "content": "Questions?",
      "pos": [
        14797,
        14807
      ]
    },
    {
      "pos": [
        14808,
        14950
      ],
      "content": "If you have questions, or if there is any feature that you would like to see included, <bpt id=\"p1\">[</bpt>send us feedback<ept id=\"p1\">](http://aka.ms/azurebackup_feedback)</ept>."
    },
    {
      "content": "Next steps",
      "pos": [
        14955,
        14965
      ]
    },
    {
      "content": "Now that you have prepared your environment for backing up your VM, your next logical step is to create a backup.",
      "pos": [
        14966,
        15079
      ]
    },
    {
      "content": "The planning article provides more detailed information about backing up VMs.",
      "pos": [
        15080,
        15157
      ]
    },
    {
      "content": "Back up virtual machines",
      "pos": [
        15162,
        15186
      ]
    },
    {
      "content": "Plan your VM backup infrastructure",
      "pos": [
        15212,
        15246
      ]
    },
    {
      "content": "Manage virtual machine backups",
      "pos": [
        15285,
        15315
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Preparing your environment to back up Azure virtual machines | Microsoft Azure\"\n    description=\"Make sure your environment is prepared for backing up virtual machines in Azure\"\n    services=\"backup\"\n    documentationCenter=\"\"\n    authors=\"markgalioto\"\n    manager=\"jwhit\"\n    editor=\"\"\n    keywords=\"backups; backing up;\"/>\n\n<tags\n    ms.service=\"backup\"\n    ms.workload=\"storage-backup-recovery\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"03/01/2016\"\n    ms.author=\"trinadhk; jimpark; markgal;\"/>\n\n\n# Prepare your environment to back up Azure virtual machines\n\nBefore you can back up an Azure virtual machine (VM), there are three conditions that must exist.\n\n- You need to create a backup vault or identify an existing backup vault *in the same region as your VM*.\n- Establish network connectivity between the Azure public Internet addresses and the Azure storage endpoints.\n- Install the VM agent on the VM.\n\nIf you know these conditions already exist in your environment then proceed to the [Back up your VMs article](backup-azure-vms.md). Otherwise, read on, this article will lead you through the steps to prepare your environment to back up an Azure VM.\n\n\n## Limitations when backing up and restoring a VM\n\n>[AZURE.NOTE] Azure has two deployment models for creating and working with resources: [Resource Manager and classic](../resource-manager-deployment-model.md). The following list provides the limitations when deploying in the classic model.\n\n- Backing up Azure Resource Manager (ARM)-based (aka IaaS V2) virtual machines is not currently supported.\n- Backing up virtual machines with more than 16 data disks is not supported.\n- Backing up virtual machines using Premium storage is not supported.\n- Backing up virtual machines with a reserved IP address and no defined endpoint is not supported.\n- Replacing an existing virtual machine during restore is not supported. First delete the existing virtual machine and any associated disks, and then restore the data from backup.\n- Cross-region backup and restore is not supported.\n- Backing up virtual machines by using the Azure Backup service is supported in all public regions of Azure (see the [checklist](https://azure.microsoft.com/regions/#services) of supported regions). If the region that you are looking for is unsupported today, it will not appear in the dropdown list during vault creation.\n- Backing up virtual machines by using the Azure Backup service is supported only for select operating system versions:\n  - **Linux**: See [the list of distributions that are endorsed by Azure](../virtual-machines/virtual-machines-linux-endorsed-distros.md). Other Bring-Your-Own-Linux distributions also should work as long as the VM agent is available on the virtual machine.\n  - **Windows Server**:  Versions older than Windows Server 2008 R2 are not supported.\n    - Restoring a domain controller (DC) VM that is part of a multi-DC configuration is supported only through PowerShell. Read more about [restoring a multi-DC domain controller](backup-azure-restore-vms.md#restoring-domain-controller-vms).\n    - Restoring virtual machines that have the following special network configurations is supported only through PowerShell. VMs that you create by using the restore workflow in the UI will not have these network configurations after the restore operation is complete. To learn more, see [Restoring VMs with special network configurations](backup-azure-restore-vms.md#restoring-vms-with-special-netwrok-configurations).\n        - Virtual machines under load balancer configuration (internal and external)\n        - Virtual machines with multiple reserved IP addresses\n        - Virtual machines with multiple network adapters\n\n## Create a backup vault for a VM\n\nA backup vault is an entity that stores all the backups and recovery points that have been created over time. The backup vault also contains the backup policies that will be applied to the virtual machines being backed up.\n\nThis image shows the relationships between the various Azure Backup entities:\n    ![Azure Backup entities and relationships](./media/backup-azure-vms-prepare/vault-policy-vm.png)\n\nTo create a backup vault:\n\n1. Sign in to the [Azure portal](http://manage.windowsazure.com/).\n\n2. In the Azure portal click **New** > **Hybrid Integration** > **Backup**. When you click **Backup**, you will automatically switch to the classic portal (shown after the Note).\n\n    ![Ibiza portal](./media/backup-azure-vms-prepare/Ibiza-portal-backup01.png)\n\n    >[AZURE.NOTE] If your subscription was last used in the classic portal, then your subscription may open in the classic portal. In this event, to create a backup vault, click **New** > **Data Services** > **Recovery Services** > **Backup Vault** > **Quick Create** (see the image below).\n\n    ![Create backup vault](./media/backup-azure-vms-prepare/backup_vaultcreate.png)\n\n3. For **Name**, enter a friendly name to identify the vault. The name needs to be unique for the Azure subscription. Type a name that contains between 2 and 50 characters. It must start with a letter, and can contain only letters, numbers, and hyphens.\n\n4. In **Region**, select the geographic region for the vault. The vault must be in the same region as the virtual machines that you want to protect. If you have virtual machines in multiple regions, you must create a backup vault in each region. There is no need to specify storage accounts to store the backup data--the backup vault and the Azure Backup service handle this automatically.\n\n5. In **Subscription** select the subscription you want to associate with the backup vault. There will be multiple choices only if your organizational account is associated with multiple Azure subscriptions.\n\n6. Click **Create Vault**. It can take a while for the backup vault to be created. Monitor the status notifications at the bottom of the portal.\n\n    ![Create vault toast notification](./media/backup-azure-vms-prepare/creating-vault.png)\n\n7. A message will confirm that the vault has been successfully created. It will be listed on the **recovery services** page as **Active**. Make sure to choose the appropriate storage redundancy option right after the vault has been created. Read more about [setting the storage redundancy option in the backup vault](backup-configure-vault.md#azure-backup---storage-redundancy-options).\n\n    ![List of backup vaults](./media/backup-azure-vms-prepare/backup_vaultslist.png)\n\n8. Click the backup vault to go to the **Quick Start** page, where the instructions for backing up Azure virtual machines are shown.\n\n    ![Virtual machine backup instructions on the Dashboard page](./media/backup-azure-vms-prepare/vmbackup-instructions.png)\n\n\n## Network connectivity\n\nThe backup extension needs connectivity to the Azure public IP addresses to function correctly because it sends commands to an Azure Storage endpoint (HTTP URL) to manage the snapshots of the VM. Without the right Internet connectivity, these HTTP requests from the VM will time out and the backup operation will fail.\n\n### Network restrictions with NSGs\n\nIf your deployment has access restrictions in place (through a network security group (NSG), for example), then you need to take additional steps to ensure that backup traffic to the backup vault remains unaffected.\n\nThere are two ways to provide a path for the backup traffic:\n\n1. Whitelist the [Azure datacenter IP ranges](http://www.microsoft.com/en-us/download/details.aspx?id=41653).\n2. Deploy an HTTP proxy to route the traffic.\n\nThe trade-off is between manageability, granular control, and cost.\n\n|Option|Advantages|Disadvantages|\n|------|----------|-------------|\n|OPTION 1: Whitelist IP ranges| No additional costs.<br><br>For opening access in an NSG, use the <i>Set-AzureNetworkSecurityRule</i> cmdlet. | Complex to manage as the impacted IP ranges change over time.<br>Provides access to the whole of Azure, and not just Storage.|\n|OPTION 2: HTTP proxy| Granular control in the proxy over the storage URLs allowed.<br>Single point of Internet access to VMs.<br>Not subject to Azure IP address changes.| Additional costs for running a VM with the proxy software.|\n\n### Using an HTTP proxy for VM backups\nWhen backing up a VM, the snapshot management commands are sent from the backup extension to Azure Storage using an HTTPS API. This traffic must be routed from the extension through the proxy, since only the proxy will be configured to have access to the public Internet.\n\n>[AZURE.NOTE] There is no recommendation for the proxy software that should be used. Ensure that you pick a proxy that is compatible with the configuration steps below.\n\nIn the example below, the App VM needs to be configured to use the Proxy VM for all HTTP traffic bound for the public Internet. The Proxy VM needs to be configured to allow incoming traffic from VMs in the virtual network. And finally, the NSG (named *NSG-lockdown*) needs a new security rule that allows outbound Internet traffic from the Proxy VM.\n\n![NSG with HTTP proxy deployment diagram](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)\n\n**A) Allow outgoing network connections:**\n\n1. For Windows machines, run the following command in an elevated command prompt:\n\n    ```\n    netsh winhttp set proxy http://<proxy IP>:<proxy port>\n    ```\n    This will set up a machine-wide proxy configuration, and will be used for any outgoing HTTP/HTTPS traffic.\n\n2. For Linux machines, add the following line to the ```/etc/environment``` file:\n\n    ```\n    http_proxy=http://<proxy IP>:<proxy port>\n    ```\n\n  Add the following lines to the ```/etc/waagent.conf``` file:\n\n    ```\n    HttpProxy.Host=<proxy IP>\n    HttpProxy.Port=<proxy port>\n    ```\n\n**B) Allow incoming connections on the proxy server:**\n\n1. On the proxy server, open Windows Firewall. The easiest way to access the firewall is to search for Windows Firewall with Advanced Security.\n\n    ![Open the Firewall](./media/backup-azure-vms-prepare/firewall-01.png)\n\n2. In the Windows Firewall dialog, right-click  **Inbound Rules** and click **New Rule...**.\n\n    ![Create a new rule](./media/backup-azure-vms-prepare/firewall-02.png)\n\n3. In the **New Inbound Rule Wizard**, choose the **Custom** option for the **Rule Type** and click **Next**.\n4. On the page to select the **Program**, choose **All Programs** and click **Next**.\n\n5. On the **Protocol and Ports** page, enter the following information and click **Next**:\n\n    ![Create a new rule](./media/backup-azure-vms-prepare/firewall-03.png)\n\n    - for *Protocol type* choose *TCP*\n    - for *Local port* choose *Specific Ports*, in the field below specify the ```<Proxy Port>``` that has been configured.\n    - for *Remote port* select *All Ports*\n\n    For the rest of the wizard, click all the way to the end and give this rule a name.\n\n**C) Add an exception rule to the NSG:**\n\nIn an Azure PowerShell command prompt, type out the following command:\n\n```\nGet-AzureNetworkSecurityGroup -Name \"NSG-lockdown\" |\nSet-AzureNetworkSecurityRule -Name \"allow-proxy \" -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix \"10.0.0.5/32\" -SourcePortRange \"*\" -DestinationAddressPrefix Internet -DestinationPortRange \"80-443\"\n```\n\nThis command adds an exception to the NSG, which allows TCP traffic from any port on 10.0.0.5 to any Internet address on port 80 (HTTP) or 443 (HTTPS). If you need to hit a specific port in the public Internet, make sure that you add that to the ```-DestinationPortRange``` as well.\n\n*Ensure that you replace the names in the example with the details appropriate to your deployment.*\n\n\n## VM agent\n\nBefore you can back up the Azure virtual machine, you should ensure that the Azure VM agent is correctly installed on the virtual machine. Since the VM agent is an optional component at the time that the virtual machine is created, ensure that the check box for the VM agent is selected before the virtual machine is provisioned.\n\n### Manual installation and update\n\nThe VM agent is already present in VMs that are created from the Azure gallery. However, virtual machines that are migrated from on-premises datacenters would not have the VM agent installed. For such VMs, the VM agent needs to be installed explicitly. Read more about [installing the VM agent on an existing VM](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx).\n\n| **Operation** | **Windows** | **Linux** |\n| --- | --- | --- |\n| Installing the VM agent | <li>Download and install the [agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). You will need Administrator privileges to complete the installation. <li>[Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed. | <li> Install the latest [Linux agent](https://github.com/Azure/WALinuxAgent) from GitHub. You will need Administrator privileges to complete the installation. <li> [Update the VM property](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) to indicate that the agent is installed. |\n| Updating the VM agent | Updating the VM agent is as simple as reinstalling the [VM agent binaries](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br><br>Ensure that no backup operation is running while the VM agent is being updated. | Follow the instructions on [updating the Linux VM agent ](../virtual-machines-linux-update-agent.md). <br><br>Ensure that no backup operation is running while the VM agent is being updated. |\n| Validating the VM agent installation | <li>Navigate to the *C:\\WindowsAzure\\Packages* folder in the Azure VM. <li>You should find the WaAppAgent.exe file present.<li> Right-click the file, go to **Properties**, and then select the **Details** tab. The Product Version field should be 2.6.1198.718 or higher. | N/A |\n\n\nLearn about the [VM agent](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) and [how to install it](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).\n\n### Backup extension\n\nTo back up the virtual machine, the Azure Backup service installs an extension to the VM agent. The Azure Backup service seamlessly upgrades and patches the backup extension without additional user intervention.\n\nThe backup extension is installed if the VM is running. A running VM also provides the greatest chance of getting an application-consistent recovery point. However, the Azure Backup service will continue to back up the VM--even if it is turned off, and the extension could not be installed (aka Offline VM). In this case, the recovery point will be *crash consistent* as discussed above.\n\n\n## Questions?\nIf you have questions, or if there is any feature that you would like to see included, [send us feedback](http://aka.ms/azurebackup_feedback).\n\n## Next steps\nNow that you have prepared your environment for backing up your VM, your next logical step is to create a backup. The planning article provides more detailed information about backing up VMs.\n\n- [Back up virtual machines](backup-azure-vms.md)\n- [Plan your VM backup infrastructure](backup-azure-vms-introduction.md)\n- [Manage virtual machine backups](backup-azure-manage-vms.md)\n\n"
}