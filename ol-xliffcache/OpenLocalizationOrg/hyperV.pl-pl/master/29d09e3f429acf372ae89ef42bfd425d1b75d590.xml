{
  "nodes": [
    {
      "content": "Azure App Service API app triggers",
      "pos": [
        28,
        62
      ]
    },
    {
      "content": "This article demonstrates how to implement triggers in an API App",
      "pos": [
        82,
        147
      ]
    },
    {
      "content": "Azure App Service API app triggers",
      "pos": [
        478,
        512
      ]
    },
    {
      "content": "Overview",
      "pos": [
        517,
        525
      ]
    },
    {
      "content": "This article explains how to implement API app triggers and consume them from a Logic app.",
      "pos": [
        527,
        617
      ]
    },
    {
      "pos": [
        619,
        868
      ],
      "content": "If you are new to <bpt id=\"p1\">[</bpt>API apps<ept id=\"p1\">](app-service-api-apps-why-best-platform.md)</ept> in <bpt id=\"p2\">[</bpt>Azure App Service<ept id=\"p2\">](../app-service/app-service-value-prop-what-is.md)</ept>, we recommend reading the multi-part series on <bpt id=\"p3\">[</bpt>creating API apps<ept id=\"p3\">](app-service-dotnet-create-api-app.md)</ept>"
    },
    {
      "pos": [
        870,
        1023
      ],
      "content": "In addition, all of the code snippets in this topic are copied from the <bpt id=\"p1\">[</bpt>FileWatcher API App code sample<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkId=534802)</ept>."
    },
    {
      "pos": [
        1026,
        1286
      ],
      "content": "Note that you'll need to download the following nuget package for the code in this article to build and run: <bpt id=\"p1\">[</bpt>http://www.nuget.org/packages/Microsoft.Azure.AppService.ApiApps.Service/<ept id=\"p1\">](http://www.nuget.org/packages/Microsoft.Azure.AppService.ApiApps.Service/)</ept>."
    },
    {
      "content": "What are API app triggers?",
      "pos": [
        1291,
        1317
      ]
    },
    {
      "content": "It's a common scenario for an API app to fire an event so that clients of the API app can take the appropriate action in response to the event.",
      "pos": [
        1319,
        1462
      ]
    },
    {
      "content": "The REST API based mechanism that supports this scenario is called an API app trigger.",
      "pos": [
        1463,
        1549
      ]
    },
    {
      "content": "For example, let's say your client code is using the <bpt id=\"p1\">[</bpt>Twitter Connector API app<ept id=\"p1\">](../app-service-logic/app-service-logic-connector-twitter.md)</ept> and your code needs to perform an action based on new tweets that contain specific words.",
      "pos": [
        1552,
        1783
      ]
    },
    {
      "content": "In this case, you might set up a poll or push trigger to facilitate this need.",
      "pos": [
        1784,
        1862
      ]
    },
    {
      "content": "Poll trigger versus push trigger",
      "pos": [
        1867,
        1899
      ]
    },
    {
      "content": "Currently, two types of triggers are supported:",
      "pos": [
        1901,
        1948
      ]
    },
    {
      "content": "Poll trigger - Client polls the API app for notification of an event having been fired",
      "pos": [
        1952,
        2038
      ]
    },
    {
      "content": "Push trigger - Client is notified by the API app when an event fires",
      "pos": [
        2042,
        2110
      ]
    },
    {
      "content": "Poll trigger",
      "pos": [
        2117,
        2129
      ]
    },
    {
      "content": "A poll trigger is implemented as a regular REST API and expects its clients (such as a Logic app) to poll it in order to get notification.",
      "pos": [
        2131,
        2269
      ]
    },
    {
      "content": "While the client may maintain state, the poll trigger itself is stateless.",
      "pos": [
        2270,
        2344
      ]
    },
    {
      "content": "The following information regarding the request and response packets illustrate some key aspects of the poll trigger contract:",
      "pos": [
        2347,
        2473
      ]
    },
    {
      "content": "Request",
      "pos": [
        2477,
        2484
      ]
    },
    {
      "content": "HTTP method: GET",
      "pos": [
        2491,
        2507
      ]
    },
    {
      "content": "Parameters",
      "pos": [
        2514,
        2524
      ]
    },
    {
      "content": "triggerState - This optional parameter allows clients to specify their state so that the poll trigger can properly decide whether to return notification or not based on the specified state.",
      "pos": [
        2535,
        2724
      ]
    },
    {
      "content": "API-specific parameters",
      "pos": [
        2735,
        2758
      ]
    },
    {
      "content": "Response",
      "pos": [
        2761,
        2769
      ]
    },
    {
      "content": "Status code <bpt id=\"p1\">**</bpt>200<ept id=\"p1\">**</ept> - Request is valid and there is a notification from the trigger.",
      "pos": [
        2776,
        2860
      ]
    },
    {
      "content": "The content of the notification will be the response body.",
      "pos": [
        2861,
        2919
      ]
    },
    {
      "content": "A \"Retry-After\" header in the response indicates that additional notification data must be retrieved with a subsequent request call.",
      "pos": [
        2920,
        3052
      ]
    },
    {
      "pos": [
        3059,
        3149
      ],
      "content": "Status code <bpt id=\"p1\">**</bpt>202<ept id=\"p1\">**</ept> - Request is valid, but there is no new notification from the trigger."
    },
    {
      "content": "Status code <bpt id=\"p1\">**</bpt>4xx<ept id=\"p1\">**</ept> - Request is not valid.",
      "pos": [
        3156,
        3199
      ]
    },
    {
      "content": "The client should not retry the request.",
      "pos": [
        3200,
        3240
      ]
    },
    {
      "content": "Status code <bpt id=\"p1\">**</bpt>5xx<ept id=\"p1\">**</ept> - Request has resulted in an internal server error and/or temporary issue.",
      "pos": [
        3247,
        3341
      ]
    },
    {
      "content": "The client should retry the request.",
      "pos": [
        3342,
        3378
      ]
    },
    {
      "content": "The following code snippet is an example of how to implement a poll trigger.",
      "pos": [
        3380,
        3456
      ]
    },
    {
      "content": "To test this poll trigger, follow these steps:",
      "pos": [
        4767,
        4813
      ]
    },
    {
      "pos": [
        4818,
        4892
      ],
      "content": "Deploy the API App with an authentication setting of <bpt id=\"p1\">**</bpt>public anonymous<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        4896,
        5106
      ],
      "content": "Call the **touch** operation to touch a file. The following image shows a sample request via Postman.\n![Call Touch Operation via Postman](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Call the **touch** operation to touch a file. The following image shows a sample request via Postman.",
          "pos": [
            0,
            101
          ],
          "nodes": [
            {
              "content": "Call the <bpt id=\"p1\">**</bpt>touch<ept id=\"p1\">**</ept> operation to touch a file.",
              "pos": [
                0,
                45
              ]
            },
            {
              "content": "The following image shows a sample request via Postman.",
              "pos": [
                46,
                101
              ]
            }
          ]
        },
        {
          "content": "<ph id=\"ph1\">![</ph>Call Touch Operation via Postman<ph id=\"ph2\">](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)</ph>",
          "pos": [
            102,
            207
          ]
        }
      ]
    },
    {
      "pos": [
        5110,
        5371
      ],
      "content": "Call the poll trigger with the **triggerState** parameter set to a time stamp prior to Step #2. The following image shows the sample request via Postman.\n![Call Poll Trigger via Postman](./media/app-service-api-dotnet-triggers/callpolltriggerfrompostman.PNG)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Call the poll trigger with the **triggerState** parameter set to a time stamp prior to Step #2. The following image shows the sample request via Postman.",
          "pos": [
            0,
            153
          ],
          "nodes": [
            {
              "content": "Call the poll trigger with the <bpt id=\"p1\">**</bpt>triggerState<ept id=\"p1\">**</ept> parameter set to a time stamp prior to Step #2.",
              "pos": [
                0,
                95
              ]
            },
            {
              "content": "The following image shows the sample request via Postman.",
              "pos": [
                96,
                153
              ]
            }
          ]
        },
        {
          "content": "<ph id=\"ph1\">![</ph>Call Poll Trigger via Postman<ph id=\"ph2\">](./media/app-service-api-dotnet-triggers/callpolltriggerfrompostman.PNG)</ph>",
          "pos": [
            154,
            258
          ]
        }
      ]
    },
    {
      "content": "Push trigger",
      "pos": [
        5377,
        5389
      ]
    },
    {
      "content": "A push trigger is implemented as a regular REST API that pushes notifications to clients who have registered to be notified when specific events fire.",
      "pos": [
        5391,
        5541
      ]
    },
    {
      "content": "The following information regarding the request and response packets illustrate some key aspects of the push trigger contract.",
      "pos": [
        5543,
        5669
      ]
    },
    {
      "content": "Request",
      "pos": [
        5673,
        5680
      ]
    },
    {
      "content": "HTTP method: PUT",
      "pos": [
        5687,
        5703
      ]
    },
    {
      "content": "Parameters",
      "pos": [
        5710,
        5720
      ]
    },
    {
      "content": "triggerId: required - Opaque string (such as a GUID) that represents the registration of a push trigger.",
      "pos": [
        5731,
        5835
      ]
    },
    {
      "content": "callbackUrl: required - URL of the callback to invoke when the event fires.",
      "pos": [
        5846,
        5921
      ]
    },
    {
      "content": "The invocation is a simple POST HTTP call.",
      "pos": [
        5922,
        5964
      ]
    },
    {
      "content": "API-specific parameters",
      "pos": [
        5975,
        5998
      ]
    },
    {
      "content": "Response",
      "pos": [
        6001,
        6009
      ]
    },
    {
      "pos": [
        6016,
        6076
      ],
      "content": "Status code <bpt id=\"p1\">**</bpt>200<ept id=\"p1\">**</ept> - Request to register client successful."
    },
    {
      "content": "Status code <bpt id=\"p1\">**</bpt>4xx<ept id=\"p1\">**</ept> - Request is not valid.",
      "pos": [
        6083,
        6126
      ]
    },
    {
      "content": "The client should not retry the request.",
      "pos": [
        6127,
        6167
      ]
    },
    {
      "content": "Status code <bpt id=\"p1\">**</bpt>5xx<ept id=\"p1\">**</ept> - Request has resulted in an internal server error and/or temporary issue.",
      "pos": [
        6174,
        6268
      ]
    },
    {
      "content": "The client should retry the request.",
      "pos": [
        6269,
        6305
      ]
    },
    {
      "content": "Callback",
      "pos": [
        6308,
        6316
      ]
    },
    {
      "content": "HTTP method: POST",
      "pos": [
        6323,
        6340
      ]
    },
    {
      "content": "Request body: Notification content.",
      "pos": [
        6347,
        6382
      ]
    },
    {
      "content": "The following code snippet is an example of how to implement a push trigger:",
      "pos": [
        6384,
        6460
      ]
    },
    {
      "content": "To test this poll trigger, follow these steps:",
      "pos": [
        9411,
        9457
      ]
    },
    {
      "pos": [
        9462,
        9536
      ],
      "content": "Deploy the API App with an authentication setting of <bpt id=\"p1\">**</bpt>public anonymous<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        9540,
        9654
      ],
      "content": "Browse to <bpt id=\"p1\">[</bpt>http://requestb.in/<ept id=\"p1\">](http://requestb.in/)</ept> to create a RequestBin which will serve as your callback URL."
    },
    {
      "pos": [
        9658,
        9859
      ],
      "content": "Call the push trigger with a GUID as **triggerId** and the RequestBin URL as **callbackUrl**.\n![Call Push Trigger via Postman](./media/app-service-api-dotnet-triggers/callpushtriggerfrompostman.PNG)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Call the push trigger with a GUID as <bpt id=\"p1\">**</bpt>triggerId<ept id=\"p1\">**</ept> and the RequestBin URL as <bpt id=\"p2\">**</bpt>callbackUrl<ept id=\"p2\">**</ept>.",
          "pos": [
            0,
            93
          ]
        },
        {
          "content": "<ph id=\"ph1\">![</ph>Call Push Trigger via Postman<ph id=\"ph2\">](./media/app-service-api-dotnet-triggers/callpushtriggerfrompostman.PNG)</ph>",
          "pos": [
            94,
            198
          ]
        }
      ]
    },
    {
      "pos": [
        9863,
        10073
      ],
      "content": "Call the **touch** operation to touch a file. The following image shows a sample request via Postman.\n![Call Touch Operation via Postman](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Call the **touch** operation to touch a file. The following image shows a sample request via Postman.",
          "pos": [
            0,
            101
          ],
          "nodes": [
            {
              "content": "Call the <bpt id=\"p1\">**</bpt>touch<ept id=\"p1\">**</ept> operation to touch a file.",
              "pos": [
                0,
                45
              ]
            },
            {
              "content": "The following image shows a sample request via Postman.",
              "pos": [
                46,
                101
              ]
            }
          ]
        },
        {
          "content": "<ph id=\"ph1\">![</ph>Call Touch Operation via Postman<ph id=\"ph2\">](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)</ph>",
          "pos": [
            102,
            207
          ]
        }
      ]
    },
    {
      "pos": [
        10077,
        10285
      ],
      "content": "Check the RequestBin to confirm that the push trigger callback is invoked with property output.\n![Call Poll Trigger via Postman](./media/app-service-api-dotnet-triggers/pushtriggercallbackinrequestbin.PNG)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "Check the RequestBin to confirm that the push trigger callback is invoked with property output.",
          "pos": [
            0,
            95
          ]
        },
        {
          "content": "Call Poll Trigger via Postman",
          "pos": [
            98,
            127
          ]
        }
      ]
    },
    {
      "content": "Describe triggers in API definition",
      "pos": [
        10291,
        10326
      ]
    },
    {
      "pos": [
        10328,
        10600
      ],
      "content": "After implementing the triggers and deploying your API app to Azure, navigate to the <bpt id=\"p1\">**</bpt>API Definition<ept id=\"p1\">**</ept> blade in the Azure preview portal and you'll see that triggers are automatically recognized in the UI, which is driven by the Swagger 2.0 API definition of the API app."
    },
    {
      "content": "API Definition Blade",
      "pos": [
        10604,
        10624
      ]
    },
    {
      "pos": [
        10691,
        10804
      ],
      "content": "If you click the <bpt id=\"p1\">**</bpt>Download Swagger<ept id=\"p1\">**</ept> button and open the JSON file, you'll see results similar to the following:"
    },
    {
      "content": "The extension property <bpt id=\"p1\">**</bpt>x-ms-schedular-trigger<ept id=\"p1\">**</ept> is how triggers are described in API definition, and is automatically added by the API app gateway when you request the API definition via the gateway if the request to one of the following criteria.",
      "pos": [
        11172,
        11421
      ]
    },
    {
      "content": "(You can also add this property manually.)",
      "pos": [
        11422,
        11464
      ]
    },
    {
      "content": "Poll trigger",
      "pos": [
        11468,
        11480
      ]
    },
    {
      "pos": [
        11487,
        11517
      ],
      "content": "If the HTTP method is <bpt id=\"p1\">**</bpt>GET<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11524,
        11588
      ],
      "content": "If the <bpt id=\"p1\">**</bpt>operationId<ept id=\"p1\">**</ept> property contains the string <bpt id=\"p2\">**</bpt>trigger<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        11595,
        11696
      ],
      "content": "If the <bpt id=\"p1\">**</bpt>parameters<ept id=\"p1\">**</ept> property includes a parameter with a <bpt id=\"p2\">**</bpt>name<ept id=\"p2\">**</ept> property set to <bpt id=\"p3\">**</bpt>triggerState<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Push trigger",
      "pos": [
        11699,
        11711
      ]
    },
    {
      "pos": [
        11718,
        11748
      ],
      "content": "If the HTTP method is <bpt id=\"p1\">**</bpt>PUT<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        11755,
        11819
      ],
      "content": "If the <bpt id=\"p1\">**</bpt>operationId<ept id=\"p1\">**</ept> property contains the string <bpt id=\"p2\">**</bpt>trigger<ept id=\"p2\">**</ept>."
    },
    {
      "pos": [
        11826,
        11924
      ],
      "content": "If the <bpt id=\"p1\">**</bpt>parameters<ept id=\"p1\">**</ept> property includes a parameter with a <bpt id=\"p2\">**</bpt>name<ept id=\"p2\">**</ept> property set to <bpt id=\"p3\">**</bpt>triggerId<ept id=\"p3\">**</ept>."
    },
    {
      "content": "Use API app triggers in Logic apps",
      "pos": [
        11929,
        11963
      ]
    },
    {
      "content": "List and configure API app triggers in the Logic apps designer",
      "pos": [
        11969,
        12031
      ]
    },
    {
      "content": "If you create a Logic app in the same resource group as the API app, you will be able to add it to the designer canvas simply by clicking it.",
      "pos": [
        12033,
        12174
      ]
    },
    {
      "content": "The following images illustrate this:",
      "pos": [
        12175,
        12212
      ]
    },
    {
      "content": "Triggers in Logic App Designer",
      "pos": [
        12216,
        12246
      ]
    },
    {
      "content": "Configure Poll Trigger in Logic App Designer",
      "pos": [
        12323,
        12367
      ]
    },
    {
      "content": "Configure Push Trigger in Logic App Designer",
      "pos": [
        12456,
        12500
      ]
    },
    {
      "content": "Optimize API app triggers for Logic apps",
      "pos": [
        12590,
        12630
      ]
    },
    {
      "content": "After you add triggers to an API app, there are a few things you can do to improve the experience when using the API app in a Logic app.",
      "pos": [
        12632,
        12768
      ]
    },
    {
      "content": "For instance, the <bpt id=\"p1\">**</bpt>triggerState<ept id=\"p1\">**</ept> parameter for poll triggers should be set to the following expression in the Logic app.",
      "pos": [
        12770,
        12892
      ]
    },
    {
      "content": "This expression should evaluate the last invocation of the trigger from the Logic app, and return that value.",
      "pos": [
        12893,
        13002
      ]
    },
    {
      "pos": [
        13069,
        13268
      ],
      "content": "NOTE: For an explanation of the functions used in the expression above, refer to the documentation on <bpt id=\"p1\">[</bpt>Logic App Workflow Definition Language<ept id=\"p1\">](https://msdn.microsoft.com/library/azure/dn948512.aspx)</ept>."
    },
    {
      "content": "Logic app users would need to provide the expression above for the <bpt id=\"p1\">**</bpt>triggerState<ept id=\"p1\">**</ept> parameter while using the trigger.",
      "pos": [
        13270,
        13388
      ]
    },
    {
      "content": "It is possible to have this value preset by the Logic app designer through the extension property <bpt id=\"p1\">**</bpt>x-ms-scheduler-recommendation<ept id=\"p1\">**</ept>.",
      "pos": [
        13389,
        13521
      ]
    },
    {
      "content": "The <bpt id=\"p1\">**</bpt>x-ms-visibility<ept id=\"p1\">**</ept> extension property can be set to a value of <bpt id=\"p2\">*</bpt>internal<ept id=\"p2\">*</ept> so that the parameter itself is not shown on the designer.",
      "pos": [
        13523,
        13660
      ]
    },
    {
      "content": "The following snippet illustrates that.",
      "pos": [
        13662,
        13701
      ]
    },
    {
      "content": "For push triggers, the <bpt id=\"p1\">**</bpt>triggerId<ept id=\"p1\">**</ept> parameter must uniquely identify the Logic app.",
      "pos": [
        14196,
        14280
      ]
    },
    {
      "content": "A recommended best practice is to set this property to the name of the workflow by using the following expression:",
      "pos": [
        14281,
        14395
      ]
    },
    {
      "pos": [
        14419,
        14629
      ],
      "content": "Using the <bpt id=\"p1\">**</bpt>x-ms-scheduler-recommendation<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>x-ms-visibility<ept id=\"p2\">**</ept> extension properties in its API definiton, the API app can convey to the Logic app designer to automatically set this expression for the user."
    },
    {
      "content": "Add extension properties in API defintion",
      "pos": [
        14909,
        14950
      ]
    },
    {
      "pos": [
        14952,
        15151
      ],
      "content": "Additional metadata information - such as the extension properties <bpt id=\"p1\">**</bpt>x-ms-scheduler-recommendation<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>x-ms-visibility<ept id=\"p2\">**</ept> - can be added in the API defintion in one of two ways: static or dynamic."
    },
    {
      "pos": [
        15153,
        15292
      ],
      "content": "For static metadata, you can directly edit the <bpt id=\"p1\">*</bpt>/metadata/apiDefinition.swagger.json<ept id=\"p1\">*</ept> file in your project and add the properties manually."
    },
    {
      "content": "For API apps using dynamic metadata, you can edit the SwaggerConfig.cs file to add an operation filter which can add these extensions.",
      "pos": [
        15294,
        15428
      ]
    },
    {
      "content": "The following is an example of how this class can be implemented to facilitate the dynamic metadata scenario.",
      "pos": [
        15624,
        15733
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Azure App Service API app triggers\" \n    description=\"This article demonstrates how to implement triggers in an API App\" \n    services=\"app-service\\logic\" \n    documentationCenter=\".net\" \n    authors=\"guangyang\"\n    manager=\"wpickett\" \n    editor=\"jimbe\"/>\n\n<tags \n    ms.service=\"app-service-logic\" \n    ms.workload=\"na\" \n    ms.tgt_pltfrm=\"dotnet\" \n    ms.devlang=\"na\" \n    ms.topic=\"article\" \n    ms.date=\"10/15/2015\" \n    ms.author=\"guayan\"/>\n\n# Azure App Service API app triggers\n\n## Overview\n\nThis article explains how to implement API app triggers and consume them from a Logic app.\n\nIf you are new to [API apps](app-service-api-apps-why-best-platform.md) in [Azure App Service](../app-service/app-service-value-prop-what-is.md), we recommend reading the multi-part series on [creating API apps](app-service-dotnet-create-api-app.md)\n\nIn addition, all of the code snippets in this topic are copied from the [FileWatcher API App code sample](http://go.microsoft.com/fwlink/?LinkId=534802). \n\nNote that you'll need to download the following nuget package for the code in this article to build and run: [http://www.nuget.org/packages/Microsoft.Azure.AppService.ApiApps.Service/](http://www.nuget.org/packages/Microsoft.Azure.AppService.ApiApps.Service/).\n\n## What are API app triggers?\n\nIt's a common scenario for an API app to fire an event so that clients of the API app can take the appropriate action in response to the event. The REST API based mechanism that supports this scenario is called an API app trigger. \n\nFor example, let's say your client code is using the [Twitter Connector API app](../app-service-logic/app-service-logic-connector-twitter.md) and your code needs to perform an action based on new tweets that contain specific words. In this case, you might set up a poll or push trigger to facilitate this need.\n\n## Poll trigger versus push trigger\n\nCurrently, two types of triggers are supported:\n\n- Poll trigger - Client polls the API app for notification of an event having been fired \n- Push trigger - Client is notified by the API app when an event fires \n\n### Poll trigger\n\nA poll trigger is implemented as a regular REST API and expects its clients (such as a Logic app) to poll it in order to get notification. While the client may maintain state, the poll trigger itself is stateless. \n\nThe following information regarding the request and response packets illustrate some key aspects of the poll trigger contract:\n\n- Request\n    - HTTP method: GET\n    - Parameters\n        - triggerState - This optional parameter allows clients to specify their state so that the poll trigger can properly decide whether to return notification or not based on the specified state.\n        - API-specific parameters\n- Response\n    - Status code **200** - Request is valid and there is a notification from the trigger. The content of the notification will be the response body. A \"Retry-After\" header in the response indicates that additional notification data must be retrieved with a subsequent request call.\n    - Status code **202** - Request is valid, but there is no new notification from the trigger.\n    - Status code **4xx** - Request is not valid. The client should not retry the request.\n    - Status code **5xx** - Request has resulted in an internal server error and/or temporary issue. The client should retry the request.\n\nThe following code snippet is an example of how to implement a poll trigger.\n\n    // Implement a poll trigger.\n    [HttpGet]\n    [Route(\"api/files/poll/TouchedFiles\")]\n    public HttpResponseMessage TouchedFilesPollTrigger(\n        // triggerState is a UTC timestamp\n        string triggerState,\n        // Additional parameters\n        string searchPattern = \"*\")\n    {\n        // Check to see whether there is any file touched after the timestamp.\n        var lastTriggerTimeUtc = DateTime.Parse(triggerState).ToUniversalTime();\n        var touchedFiles = Directory.EnumerateFiles(rootPath, searchPattern, SearchOption.AllDirectories)\n            .Select(f => FileInfoWrapper.FromFileInfo(new FileInfo(f)))\n            .Where(fi => fi.LastAccessTimeUtc > lastTriggerTimeUtc);\n\n        // If there are files touched after the timestamp, return their information.\n        if (touchedFiles != null && touchedFiles.Count() != 0)\n        {\n            // Extension method provided by the AppService service SDK.\n            return this.Request.EventTriggered(new { files = touchedFiles });\n        }\n        // If there are no files touched after the timestamp, tell the caller to poll again after 1 mintue.\n        else\n        {\n            // Extension method provided by the AppService service SDK.\n            return this.Request.EventWaitPoll(new TimeSpan(0, 1, 0));\n        }\n    }\n\nTo test this poll trigger, follow these steps:\n\n1. Deploy the API App with an authentication setting of **public anonymous**.\n2. Call the **touch** operation to touch a file. The following image shows a sample request via Postman.\n   ![Call Touch Operation via Postman](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)\n3. Call the poll trigger with the **triggerState** parameter set to a time stamp prior to Step #2. The following image shows the sample request via Postman.\n   ![Call Poll Trigger via Postman](./media/app-service-api-dotnet-triggers/callpolltriggerfrompostman.PNG)\n\n### Push trigger\n\nA push trigger is implemented as a regular REST API that pushes notifications to clients who have registered to be notified when specific events fire.\n\nThe following information regarding the request and response packets illustrate some key aspects of the push trigger contract.\n\n- Request\n    - HTTP method: PUT\n    - Parameters\n        - triggerId: required - Opaque string (such as a GUID) that represents the registration of a push trigger.\n        - callbackUrl: required - URL of the callback to invoke when the event fires. The invocation is a simple POST HTTP call.\n        - API-specific parameters\n- Response\n    - Status code **200** - Request to register client successful.\n    - Status code **4xx** - Request is not valid. The client should not retry the request.\n    - Status code **5xx** - Request has resulted in an internal server error and/or temporary issue. The client should retry the request.\n- Callback\n    - HTTP method: POST\n    - Request body: Notification content.\n\nThe following code snippet is an example of how to implement a push trigger:\n\n    // Implement a push trigger.\n    [HttpPut]\n    [Route(\"api/files/push/TouchedFiles/{triggerId}\")]\n    public HttpResponseMessage TouchedFilesPushTrigger(\n        // triggerId is an opaque string.\n        string triggerId,\n        // A helper class provided by the AppService service SDK.\n        // Here it defines the input of the push trigger is a string and the output to the callback is a FileInfoWrapper object.\n        [FromBody]TriggerInput<string, FileInfoWrapper> triggerInput)\n    {\n        // Register the trigger to some trigger store.\n        triggerStore.RegisterTrigger(triggerId, rootPath, triggerInput);\n\n        // Extension method provided by the AppService service SDK indicating the registration is completed.\n        return this.Request.PushTriggerRegistered(triggerInput.GetCallback());\n    }\n\n    // A simple in-memory trigger store.\n    public class InMemoryTriggerStore\n    {\n        private static InMemoryTriggerStore instance;\n\n        private IDictionary<string, FileSystemWatcher> _store;\n\n        private InMemoryTriggerStore()\n        {\n            _store = new Dictionary<string, FileSystemWatcher>();\n        }\n\n        public static InMemoryTriggerStore Instance\n        {\n            get\n            {\n                if (instance == null)\n                {\n                    instance = new InMemoryTriggerStore();\n                }\n                return instance;\n            }\n        }\n\n        // Register a push trigger.\n        public void RegisterTrigger(string triggerId, string rootPath,\n            TriggerInput<string, FileInfoWrapper> triggerInput)\n        {\n            // Use FileSystemWatcher to listen to file change event.\n            var filter = string.IsNullOrEmpty(triggerInput.inputs) ? \"*\" : triggerInput.inputs;\n            var watcher = new FileSystemWatcher(rootPath, filter);\n            watcher.IncludeSubdirectories = true;\n            watcher.EnableRaisingEvents = true;\n            watcher.NotifyFilter = NotifyFilters.LastAccess;\n\n            // When some file is changed, fire the push trigger.\n            watcher.Changed +=\n                (sender, e) => watcher_Changed(sender, e,\n                    Runtime.FromAppSettings(),\n                    triggerInput.GetCallback());\n\n            // Assoicate the FileSystemWatcher object with the triggerId.\n            _store[triggerId] = watcher;\n\n        }\n\n        // Fire the assoicated push trigger when some file is changed.\n        void watcher_Changed(object sender, FileSystemEventArgs e,\n            // AppService runtime object needed to invoke the callback.\n            Runtime runtime,\n            // The callback to invoke.\n            ClientTriggerCallback<FileInfoWrapper> callback)\n        {\n            // Helper method provided by AppService service SDK to invoke a push trigger callback.\n            callback.InvokeAsync(runtime, FileInfoWrapper.FromFileInfo(new FileInfo(e.FullPath)));\n        }\n    }\n\nTo test this poll trigger, follow these steps:\n\n1. Deploy the API App with an authentication setting of **public anonymous**.\n2. Browse to [http://requestb.in/](http://requestb.in/) to create a RequestBin which will serve as your callback URL.\n3. Call the push trigger with a GUID as **triggerId** and the RequestBin URL as **callbackUrl**.\n   ![Call Push Trigger via Postman](./media/app-service-api-dotnet-triggers/callpushtriggerfrompostman.PNG)\n4. Call the **touch** operation to touch a file. The following image shows a sample request via Postman.\n   ![Call Touch Operation via Postman](./media/app-service-api-dotnet-triggers/calltouchfilefrompostman.PNG)\n5. Check the RequestBin to confirm that the push trigger callback is invoked with property output.\n   ![Call Poll Trigger via Postman](./media/app-service-api-dotnet-triggers/pushtriggercallbackinrequestbin.PNG)\n\n### Describe triggers in API definition\n\nAfter implementing the triggers and deploying your API app to Azure, navigate to the **API Definition** blade in the Azure preview portal and you'll see that triggers are automatically recognized in the UI, which is driven by the Swagger 2.0 API definition of the API app.\n\n![API Definition Blade](./media/app-service-api-dotnet-triggers/apidefinitionblade.PNG)\n\nIf you click the **Download Swagger** button and open the JSON file, you'll see results similar to the following:\n\n    \"/api/files/poll/TouchedFiles\": {\n      \"get\": {\n        \"operationId\": \"Files_TouchedFilesPollTrigger\",\n        ...\n        \"x-ms-scheduler-trigger\": \"poll\"\n      }\n    },\n    \"/api/files/push/TouchedFiles/{triggerId}\": {\n      \"put\": {\n        \"operationId\": \"Files_TouchedFilesPushTrigger\",\n        ...\n        \"x-ms-scheduler-trigger\": \"push\"\n      }\n    }\n\nThe extension property **x-ms-schedular-trigger** is how triggers are described in API definition, and is automatically added by the API app gateway when you request the API definition via the gateway if the request to one of the following criteria. (You can also add this property manually.)\n\n- Poll trigger\n    - If the HTTP method is **GET**.\n    - If the **operationId** property contains the string **trigger**.\n    - If the **parameters** property includes a parameter with a **name** property set to **triggerState**.\n- Push trigger\n    - If the HTTP method is **PUT**.\n    - If the **operationId** property contains the string **trigger**.\n    - If the **parameters** property includes a parameter with a **name** property set to **triggerId**.\n\n## Use API app triggers in Logic apps\n\n### List and configure API app triggers in the Logic apps designer\n\nIf you create a Logic app in the same resource group as the API app, you will be able to add it to the designer canvas simply by clicking it. The following images illustrate this:\n\n![Triggers in Logic App Designer](./media/app-service-api-dotnet-triggers/triggersinlogicappdesigner.PNG)\n\n![Configure Poll Trigger in Logic App Designer](./media/app-service-api-dotnet-triggers/configurepolltriggerinlogicappdesigner.PNG)\n\n![Configure Push Trigger in Logic App Designer](./media/app-service-api-dotnet-triggers/configurepushtriggerinlogicappdesigner.PNG)\n\n## Optimize API app triggers for Logic apps\n\nAfter you add triggers to an API app, there are a few things you can do to improve the experience when using the API app in a Logic app.\n\nFor instance, the **triggerState** parameter for poll triggers should be set to the following expression in the Logic app. This expression should evaluate the last invocation of the trigger from the Logic app, and return that value.  \n\n    @coalesce(triggers()?.outputs?.body?['triggerState'], '')\n\nNOTE: For an explanation of the functions used in the expression above, refer to the documentation on [Logic App Workflow Definition Language](https://msdn.microsoft.com/library/azure/dn948512.aspx).\n\nLogic app users would need to provide the expression above for the **triggerState** parameter while using the trigger. It is possible to have this value preset by the Logic app designer through the extension property **x-ms-scheduler-recommendation**.  The **x-ms-visibility** extension property can be set to a value of *internal* so that the parameter itself is not shown on the designer.  The following snippet illustrates that.\n\n    \"/api/Messages/poll\": {\n      \"get\": {\n        \"operationId\": \"Messages_NewMessageTrigger\",\n        \"parameters\": [\n          {\n            \"name\": \"triggerState\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"x-ms-visibility\": \"internal\",\n            \"x-ms-scheduler-recommendation\": \"@coalesce(triggers()?.outputs?.body?['triggerState'], '')\",\n            \"type\": \"string\"\n          }\n        ]\n        ...\n        \"x-ms-scheduler-trigger\": \"poll\"\n      }\n    }\n\nFor push triggers, the **triggerId** parameter must uniquely identify the Logic app. A recommended best practice is to set this property to the name of the workflow by using the following expression:\n\n    @workflow().name\n\nUsing the **x-ms-scheduler-recommendation** and **x-ms-visibility** extension properties in its API definiton, the API app can convey to the Logic app designer to automatically set this expression for the user.\n\n        \"parameters\":[  \n          {  \n            \"name\":\"triggerId\",\n            \"in\":\"path\",\n            \"required\":true,\n            \"x-ms-visibility\":\"internal\",\n            \"x-ms-scheduler-recommendation\":\"@workflow().name\",\n            \"type\":\"string\"\n          },\n\n\n### Add extension properties in API defintion\n\nAdditional metadata information - such as the extension properties **x-ms-scheduler-recommendation** and **x-ms-visibility** - can be added in the API defintion in one of two ways: static or dynamic.\n\nFor static metadata, you can directly edit the */metadata/apiDefinition.swagger.json* file in your project and add the properties manually.\n\nFor API apps using dynamic metadata, you can edit the SwaggerConfig.cs file to add an operation filter which can add these extensions.\n\n    GlobalConfiguration.Configuration \n        .EnableSwagger(c =>\n            {\n                ...\n                c.OperationFilter<TriggerStateFilter>();\n                ...\n            }\n\n\nThe following is an example of how this class can be implemented to facilitate the dynamic metadata scenario.\n\n    // Add extension properties on the triggerState parameter\n    public class TriggerStateFilter : IOperationFilter\n    {\n\n        public void Apply(Operation operation, SchemaRegistry schemaRegistry, System.Web.Http.Description.ApiDescription apiDescription)\n        {\n            if (operation.operationId.IndexOf(\"Trigger\", StringComparison.InvariantCultureIgnoreCase) >= 0)\n            {\n                // this is a possible trigger\n                var triggerStateParam = operation.parameters.FirstOrDefault(x => x.name.Equals(\"triggerState\"));\n                if (triggerStateParam != null)\n                {\n                    if (triggerStateParam.vendorExtensions == null)\n                    {\n                        triggerStateParam.vendorExtensions = new Dictionary<string, object>();\n                    }\n\n                    // add 2 vendor extensions\n                    // x-ms-visibility: set to 'internal' to signify this is an internal field\n                    // x-ms-scheduler-recommendation: set to a value that logic app can use\n                    triggerStateParam.vendorExtensions.Add(\"x-ms-visibility\", \"internal\");\n                    triggerStateParam.vendorExtensions.Add(\"x-ms-scheduler-recommendation\",\n                                                           \"@coalesce(triggers()?.outputs?.body?['triggerState'], '')\");\n                }\n            }\n        }\n    }\n \n\n\n"
}