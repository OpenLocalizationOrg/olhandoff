{"nodes":[{"content":"Writing a custom DSC resource with PowerShell classes","pos":[2,55]},{"content":"Applies To: Windows Windows PowerShell 5.0","pos":[59,101]},{"content":"With the introduction of PowerShell classes in Windows PowerShell 5.0, you can now define a DSC resource by creating a class.","pos":[103,228]},{"content":"The class defines both the schema and the implementation of the resource, so there is no need to create a separate MOF file.","pos":[229,353]},{"content":"The folder structure for a class-based resource is also simpler, because a <bpt id=\"p1\">**</bpt>DSCResources<ept id=\"p1\">**</ept> folder is not necessary.","pos":[354,470]},{"content":"In a class-based DSC resource, the schema is defined as properties of the class which can be modified with attributes to specify the property type..","pos":[472,620]},{"content":"The resource is implemented by <bpt id=\"p1\">**</bpt>Get()<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Set()<ept id=\"p2\">**</ept>, and <bpt id=\"p3\">**</bpt>Test()<ept id=\"p3\">**</ept> methods (equivalent to the <bpt id=\"p4\">**</bpt>Get-TargetResource<ept id=\"p4\">**</ept>, <bpt id=\"p5\">**</bpt>Set-TargetResource<ept id=\"p5\">**</ept>, and <bpt id=\"p6\">**</bpt>Test-TargetResource<ept id=\"p6\">**</ept> functions in a script resource.","pos":[621,823]},{"pos":[825,936],"content":"In this topic, we will create a simple resource named <bpt id=\"p1\">**</bpt>FileResource<ept id=\"p1\">**</ept> that manages a file in a specified path."},{"pos":[938,1077],"content":"For more information about DSC resources, see <bpt id=\"p1\">[</bpt>Build Custom Windows PowerShell Desired State Configuration Resources<ept id=\"p1\">](authoringResource.md)</ept>"},{"content":"Folder structure for a class resource","pos":[1082,1119]},{"content":"To implement a DSC custom resource with a PowerShell class, create the following folder structure.","pos":[1121,1219]},{"content":"The class is defined in <bpt id=\"p1\">**</bpt>MyDscResource.psm1<ept id=\"p1\">**</ept> and the module manifest is defined in <bpt id=\"p2\">**</bpt>MyDscResource.psd1<ept id=\"p2\">**</ept>","pos":[1220,1327]},{"content":"Create the class","pos":[1463,1479]},{"content":"You use the class keyword to create a PowerShell class.","pos":[1481,1536]},{"content":"To specify that a class is a DSC resource, use the <bpt id=\"p1\">**</bpt>DscResource()<ept id=\"p1\">**</ept> attribute.","pos":[1537,1616]},{"content":"The name of the class is the name of the DSC resource.","pos":[1617,1671]},{"content":"Declare properties","pos":[1735,1753]},{"content":"The DSC resource schema is defined as properties of the class.","pos":[1755,1817]},{"content":"We declare three properties as follows.","pos":[1818,1857]},{"content":"Notice that the properties are modified by attributes.","pos":[2068,2122]},{"content":"The meaning of the attributes is as follows:","pos":[2123,2167]},{"content":"<bpt id=\"p1\">**</bpt>DscProperty(Key)<ept id=\"p1\">**</ept>: The property is required.","pos":[2171,2218]},{"content":"The property is a key.","pos":[2219,2241]},{"content":"The values of all properties marked as keys must combine to uniquely identify a resource instance within a configuration.","pos":[2242,2363]},{"pos":[2366,2419],"content":"<bpt id=\"p1\">**</bpt>DscProperty(Mandatory)<ept id=\"p1\">**</ept>: The property is required."},{"content":"<bpt id=\"p1\">**</bpt>DscProperty(NotConfigurable)<ept id=\"p1\">**</ept>: The property is read-only.","pos":[2422,2482]},{"content":"Properties marked with this attribute cannot be set by a configuration, but are populated by the <bpt id=\"p1\">**</bpt>Get()<ept id=\"p1\">**</ept> method when present.","pos":[2483,2610]},{"pos":[2613,2685],"content":"<bpt id=\"p1\">**</bpt>DscProperty()<ept id=\"p1\">**</ept>: The property is configurable, but it is not required."},{"content":"The <bpt id=\"p1\">**</bpt>$Path<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>$SourcePath<ept id=\"p2\">**</ept> properties are both strings.","pos":[2687,2749]},{"content":"The <bpt id=\"p1\">**</bpt>$CreationTime<ept id=\"p1\">**</ept> is a <bpt id=\"p2\">[</bpt>DateTime<ept id=\"p2\">](https://technet.microsoft.com/en-us/library/system.datetime.aspx)</ept> property.","pos":[2750,2863]},{"content":"The <bpt id=\"p1\">**</bpt>$Ensure<ept id=\"p1\">**</ept> property is an enumeration type, defined as follows.","pos":[2864,2932]},{"content":"Implementing the methods","pos":[3000,3024]},{"pos":[3026,3203],"content":"The <bpt id=\"p1\">**</bpt>Get()<ept id=\"p1\">**</ept>, <bpt id=\"p2\">**</bpt>Set()<ept id=\"p2\">**</ept>, and <bpt id=\"p3\">**</bpt>Test()<ept id=\"p3\">**</ept> methods are analogous to the <bpt id=\"p4\">**</bpt>Get-TargetResource<ept id=\"p4\">**</ept>, <bpt id=\"p5\">**</bpt>Set-TargetResource<ept id=\"p5\">**</ept>, and <bpt id=\"p6\">**</bpt>Test-TargetResource<ept id=\"p6\">**</ept> functions in a script resource."},{"pos":[3205,3326],"content":"This code also includes the CopyFile() function, a helper function that copies the file from <bpt id=\"p1\">**</bpt>$SourcePath<ept id=\"p1\">**</ept> to <bpt id=\"p2\">**</bpt>$Path<ept id=\"p2\">**</ept>"},{"content":"The complete file","pos":[6789,6806]},{"content":"The complete class file follows.","pos":[6807,6839]},{"content":"Create a manifest","pos":[12424,12441]},{"content":"To make a class-based resource available to the DSC engine, you must include a <bpt id=\"p1\">**</bpt>DscResourcesToExport<ept id=\"p1\">**</ept> statement in the manifest file that instructs the module to export the resource.","pos":[12443,12627]},{"content":"Our manifest looks like this:","pos":[12628,12657]},{"content":"Test the resource","pos":[13472,13489]},{"content":"After saving the class and manifest files in the folder structure as described earlier, you can create a configuration that uses the new resource.","pos":[13491,13637]},{"content":"For information about how to run a DSC configuration, see <bpt id=\"p1\">[</bpt>Enacting configurations<ept id=\"p1\">](enactingConfigurations.md)</ept>.","pos":[13638,13749]},{"content":"The following configuration will check to see whether the file at <ph id=\"ph1\">`c:\\test\\test.txt`</ph> exists, and, if not, copies the file from <ph id=\"ph2\">`c:\\test.txt`</ph> (you should create <ph id=\"ph3\">`c:\\test.txt`</ph> before you run the configuration).","pos":[13750,13958]},{"content":"See Also","pos":[14227,14235]},{"content":"Concepts","pos":[14240,14248]},{"content":"Build Custom Windows PowerShell Desired State Configuration Resources","pos":[14250,14319]}],"content":"# Writing a custom DSC resource with PowerShell classes\n\n> Applies To: Windows Windows PowerShell 5.0\n\nWith the introduction of PowerShell classes in Windows PowerShell 5.0, you can now define a DSC resource by creating a class. The class defines both the schema and the implementation of the resource, so there is no need to create a separate MOF file. The folder structure for a class-based resource is also simpler, because a **DSCResources** folder is not necessary.\n\nIn a class-based DSC resource, the schema is defined as properties of the class which can be modified with attributes to specify the property type.. The resource is implemented by **Get()**, **Set()**, and **Test()** methods (equivalent to the **Get-TargetResource**, **Set-TargetResource**, and **Test-TargetResource** functions in a script resource.\n\nIn this topic, we will create a simple resource named **FileResource** that manages a file in a specified path.\n\nFor more information about DSC resources, see [Build Custom Windows PowerShell Desired State Configuration Resources](authoringResource.md)\n\n## Folder structure for a class resource\n\nTo implement a DSC custom resource with a PowerShell class, create the following folder structure. The class is defined in **MyDscResource.psm1** and the module manifest is defined in **MyDscResource.psd1**.\n\n```\n$env: psmodulepath (folder)\n    |- MyDscResources (folder)\n        |- MyDscResource.psm1 \n           MyDscResource.psd1 \n```\n\n## Create the class\n\nYou use the class keyword to create a PowerShell class. To specify that a class is a DSC resource, use the **DscResource()** attribute. The name of the class is the name of the DSC resource.\n\n```powershell\n[DscResource()]\nclass FileResource {\n}\n```\n\n### Declare properties\n\nThe DSC resource schema is defined as properties of the class. We declare three properties as follows.\n\n```powershell\n[DscProperty(Key)]\n[string]$Path\n\n[DscProperty(Mandatory)]\n[Ensure] $Ensure\n\n[DscProperty(Mandatory)]\n[string] $SourcePath\n\n[DscProperty(NotConfigurable)]\n[Nullable[datetime]] $CreationTime\n```\n\nNotice that the properties are modified by attributes. The meaning of the attributes is as follows:\n\n- **DscProperty(Key)**: The property is required. The property is a key. The values of all properties marked as keys must combine to uniquely identify a resource instance within a configuration.\n- **DscProperty(Mandatory)**: The property is required.\n- **DscProperty(NotConfigurable)**: The property is read-only. Properties marked with this attribute cannot be set by a configuration, but are populated by the **Get()** method when present.\n- **DscProperty()**: The property is configurable, but it is not required.\n\nThe **$Path** and **$SourcePath** properties are both strings. The **$CreationTime** is a [DateTime](https://technet.microsoft.com/en-us/library/system.datetime.aspx) property. The **$Ensure** property is an enumeration type, defined as follows.\n\n```powershell\nenum Ensure \n{ \n    Absent \n    Present \n}\n```\n\n### Implementing the methods\n\nThe **Get()**, **Set()**, and **Test()** methods are analogous to the **Get-TargetResource**, **Set-TargetResource**, and **Test-TargetResource** functions in a script resource.\n\nThis code also includes the CopyFile() function, a helper function that copies the file from **$SourcePath** to **$Path**. \n\n```powershell\n\n    <#\n        This method is equivalent of the Set-TargetResource script function.\n        It sets the resource to the desired state.\n    #>\n    [void] Set()\n    {\n        $fileExists = $this.TestFilePath($this.Path)\n\n        if ($this.ensure -eq [Ensure]::Present)\n        {\n            if(-not $fileExists)\n            {\n                $this.CopyFile()\n            }\n        }\n        else\n        {\n            if ($fileExists)\n            {\n                Write-Verbose -Message \"Deleting the file $($this.Path)\"\n                Remove-Item -LiteralPath $this.Path -Force\n            }\n        }\n    }\n\n    <#\n        This method is equivalent of the Test-TargetResource script function.\n        It should return True or False, showing whether the resource\n        is in a desired state.\n    #>\n    [bool] Test()\n    {\n        $present = $this.TestFilePath($this.Path)\n\n        if ($this.Ensure -eq [Ensure]::Present)\n        {\n            return $present\n        }\n        else\n        {\n            return -not $present\n        }\n    }\n\n    <#\n        This method is equivalent of the Get-TargetResource script function.\n        The implementation should use the keys to find appropriate resources.\n        This method returns an instance of this class with the updated key\n         properties.\n    #>\n    [FileResource] Get()\n    {\n        $present = $this.TestFilePath($this.Path)\n\n        if ($present)\n        {\n            $file = Get-ChildItem -LiteralPath $this.Path\n            $this.CreationTime = $file.CreationTime\n            $this.Ensure = [Ensure]::Present\n        }\n        else\n        {\n            $this.CreationTime = $null\n            $this.Ensure = [Ensure]::Absent\n        }\n\n        return $this\n    }\n\n    <#\n        Helper method to check if the file exists and it is file\n    #>\n    [bool] TestFilePath([string] $location)\n    {\n        $present = $true\n\n        $item = Get-ChildItem -LiteralPath $location -ErrorAction Ignore\n\n        if ($item -eq $null)\n        {\n            $present = $false\n        }\n        elseif ($item.PSProvider.Name -ne \"FileSystem\")\n        {\n            throw \"Path $($location) is not a file path.\"\n        }\n        elseif ($item.PSIsContainer)\n        {\n            throw \"Path $($location) is a directory path.\"\n        }\n\n        return $present\n    }\n\n    <#\n        Helper method to copy file from source to path\n    #>\n    [void] CopyFile()\n    {\n        if (-not $this.TestFilePath($this.SourcePath))\n        {\n            throw \"SourcePath $($this.SourcePath) is not found.\"\n        }\n\n        [System.IO.FileInfo] $destFileInfo = New-Object -TypeName System.IO.FileInfo($this.Path)\n\n        if (-not $destFileInfo.Directory.Exists)\n        {\n            Write-Verbose -Message \"Creating directory $($destFileInfo.Directory.FullName)\"\n\n            <#\n                Use CreateDirectory instead of New-Item to avoid code\n                to handle the non-terminating error\n            #>\n            [System.IO.Directory]::CreateDirectory($destFileInfo.Directory.FullName)\n        }\n\n        if (Test-Path -LiteralPath $this.Path -PathType Container)\n        {\n            throw \"Path $($this.Path) is a directory path\"\n        }\n\n        Write-Verbose -Message \"Copying $($this.SourcePath) to $($this.Path)\"\n\n        # DSC engine catches and reports any error that occurs\n        Copy-Item -LiteralPath $this.SourcePath -Destination $this.Path -Force\n    }\n```\n\n### The complete file\nThe complete class file follows.\n\n```powershell\nenum Ensure\n{\n    Absent\n    Present\n}\n\n<#\n   This resource manages the file in a specific path.\n   [DscResource()] indicates the class is a DSC resource\n#>\n\n[DscResource()]\nclass FileResource\n{\n    <#\n       This property is the fully qualified path to the file that is\n       expected to be present or absent.\n\n       The [DscProperty(Key)] attribute indicates the property is a\n       key and its value uniquely identifies a resource instance.\n       Defining this attribute also means the property is required\n       and DSC will ensure a value is set before calling the resource.\n\n       A DSC resource must define at least one key property.\n    #>\n    [DscProperty(Key)]\n    [string]$Path\n\n    <#\n        This property indicates if the settings should be present or absent\n        on the system. For present, the resource ensures the file pointed\n        to by $Path exists. For absent, it ensures the file point to by\n        $Path does not exist.\n\n        The [DscProperty(Mandatory)] attribute indicates the property is\n        required and DSC will guarantee it is set.\n\n        If Mandatory is not specified or if it is defined as\n        Mandatory=$false, the value is not guaranteed to be set when DSC\n        calls the resource.  This is appropriate for optional properties.\n    #>\n    [DscProperty(Mandatory)]\n    [Ensure] $Ensure\n\n    <#\n       This property defines the fully qualified path to a file that will\n       be placed on the system if $Ensure = Present and $Path does not\n        exist.\n\n       NOTE: This property is required because [DscProperty(Mandatory)] is\n        set.\n    #>\n    [DscProperty(Mandatory)]\n    [string] $SourcePath\n\n    <#\n       This property reports the file's create timestamp.\n\n       [DscProperty(NotConfigurable)] attribute indicates the property is\n       not configurable in DSC configuration.  Properties marked this way\n       are populated by the Get() method to report additional details\n       about the resource when it is present.\n\n    #>\n    [DscProperty(NotConfigurable)]\n    [Nullable[datetime]] $CreationTime\n\n    <#\n        This method is equivalent of the Set-TargetResource script function.\n        It sets the resource to the desired state.\n    #>\n    [void] Set()\n    {\n        $fileExists = $this.TestFilePath($this.Path)\n        if ($this.ensure -eq [Ensure]::Present)\n        {\n            if (-not $fileExists)\n            {\n                $this.CopyFile()\n            }\n        }\n        else\n        {\n            if ($fileExists)\n            {\n                Write-Verbose -Message \"Deleting the file $($this.Path)\"\n                Remove-Item -LiteralPath $this.Path -Force\n            }\n        }\n    }\n\n    <#\n        This method is equivalent of the Test-TargetResource script function.\n        It should return True or False, showing whether the resource\n        is in a desired state.\n    #>\n    [bool] Test()\n    {\n        $present = $this.TestFilePath($this.Path)\n\n        if ($this.Ensure -eq [Ensure]::Present)\n        {\n            return $present\n        }\n        else\n        {\n            return -not $present\n        }\n    }\n\n    <#\n        This method is equivalent of the Get-TargetResource script function.\n        The implementation should use the keys to find appropriate resources.\n        This method returns an instance of this class with the updated key\n         properties.\n    #>\n    [FileResource] Get()\n    {\n        $present = $this.TestFilePath($this.Path)\n\n        if ($present)\n        {\n            $file = Get-ChildItem -LiteralPath $this.Path\n            $this.CreationTime = $file.CreationTime\n            $this.Ensure = [Ensure]::Present\n        }\n        else\n        {\n            $this.CreationTime = $null\n            $this.Ensure = [Ensure]::Absent\n        }\n\n        return $this\n    }\n\n    <#\n        Helper method to check if the file exists and it is file\n    #>\n    [bool] TestFilePath([string] $location)\n    {\n        $present = $true\n\n        $item = Get-ChildItem -LiteralPath $location -ea Ignore\n        if ($item -eq $null)\n        {\n            $present = $false\n        }\n        elseif ($item.PSProvider.Name -ne \"FileSystem\")\n        {\n            throw \"Path $($location) is not a file path.\"\n        }\n        elseif ($item.PSIsContainer)\n        {\n            throw \"Path $($location) is a directory path.\"\n        }\n\n        return $present\n    }\n\n    <#\n        Helper method to copy file from source to path\n    #>\n    [void] CopyFile()\n    {\n        if (-not $this.TestFilePath($this.SourcePath))\n        {\n            throw \"SourcePath $($this.SourcePath) is not found.\"\n        }\n\n        [System.IO.FileInfo] $destFileInfo = new-object System.IO.FileInfo($this.Path)\n        if (-not $destFileInfo.Directory.Exists)\n        {\n            Write-Verbose -Message \"Creating directory $($destFileInfo.Directory.FullName)\"\n\n            <#\n                Use CreateDirectory instead of New-Item to avoid code\n                 to handle the non-terminating error\n            #>\n            [System.IO.Directory]::CreateDirectory($destFileInfo.Directory.FullName)\n        }\n\n        if (Test-Path -LiteralPath $this.Path -PathType Container)\n        {\n            throw \"Path $($this.Path) is a directory path\"\n        }\n\n        Write-Verbose -Message \"Copying $($this.SourcePath) to $($this.Path)\"\n\n        # DSC engine catches and reports any error that occurs\n        Copy-Item -LiteralPath $this.SourcePath -Destination $this.Path -Force\n    }\n} # This module defines a class for a DSC \"FileResource\" provider.\n```\n\n\n## Create a manifest\n\nTo make a class-based resource available to the DSC engine, you must include a **DscResourcesToExport** statement in the manifest file that instructs the module to export the resource. Our manifest looks like this:\n\n```powershell\n@{\n\n# Script module or binary module file associated with this manifest.\nRootModule = 'MyDscResource.psm1'\n\nDscResourcesToExport = 'FileResource'\n\n# Version number of this module.\nModuleVersion = '1.0'\n\n# ID used to uniquely identify this module\nGUID = '81624038-5e71-40f8-8905-b1a87afe22d7'\n\n# Author of this module\nAuthor = 'Microsoft Corporation'\n\n# Company or vendor of this module\nCompanyName = 'Microsoft Corporation'\n\n# Copyright statement for this module\nCopyright = '(c) 2014 Microsoft. All rights reserved.'\n\n# Description of the functionality provided by this module\n# Description = ''\n\n# Minimum version of the Windows PowerShell engine required by this module\nPowerShellVersion = '5.0'\n\n# Name of the Windows PowerShell host required by this module\n# PowerShellHostName = ''\n} \n```\n\n## Test the resource\n\nAfter saving the class and manifest files in the folder structure as described earlier, you can create a configuration that uses the new resource. For information about how to run a DSC configuration, see [Enacting configurations](enactingConfigurations.md). The following configuration will check to see whether the file at `c:\\test\\test.txt` exists, and, if not, copies the file from `c:\\test.txt` (you should create `c:\\test.txt` before you run the configuration).\n\n```powershell\nConfiguration Test\n{\n    Import-DSCResource -module MyDscResource\n    FileResource file\n    {\n        Path = \"C:\\test\\test.txt\"\n        SourcePath = \"c:\\test.txt\"\n        Ensure = \"Present\"\n    } \n}\nTest\nStart-DscConfiguration -Wait -Force Test\n```\n\n## See Also\n### Concepts\n[Build Custom Windows PowerShell Desired State Configuration Resources](authoringResource.md)\n"}