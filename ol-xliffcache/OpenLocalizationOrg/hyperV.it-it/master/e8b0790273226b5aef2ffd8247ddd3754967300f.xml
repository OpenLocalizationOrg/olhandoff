{"nodes":[{"content":"Deploy and manage backup for Windows Server/Client using PowerShell | Microsoft Azure","pos":[27,112]},{"content":"Learn how to deploy and manage Azure Backup using PowerShell","pos":[131,191]},{"content":"Deploy and manage backup to Azure for Windows Server/Windows Client using PowerShell","pos":[511,595]},{"content":"This article shows you how to use PowerShell for setting up Azure Backup on Windows Server or a Windows client, and managing backup and recovery.","pos":[597,742]},{"content":"Install Azure PowerShell","pos":[747,771]},{"content":"In October 2015, Azure PowerShell 1.0 was released.","pos":[879,930]},{"content":"This release succeeded the 0.9.8 release and brought about some significant changes, especially in the naming pattern of the cmdlets.","pos":[931,1064]},{"content":"1.0 cmdlets follow the naming pattern {verb}-AzureRm{noun}; whereas, the 0.9.8 names do not include <bpt id=\"p1\">**</bpt>Rm<ept id=\"p1\">**</ept> (for example, New-AzureRmResourceGroup instead of New-AzureResourceGroup).","pos":[1065,1246]},{"content":"When using Azure PowerShell 0.9.8, you must first enable the Resource Manager mode by running the <bpt id=\"p1\">**</bpt>Switch-AzureMode AzureResourceManager<ept id=\"p1\">**</ept> command.","pos":[1247,1395]},{"content":"This command is not necessary in 1.0 or later.","pos":[1396,1442]},{"content":"If you want to use your scripts written for the 0.9.8 environment, in the 1.0 or later environment, you should carefully test the scripts in a pre-production environment before using them in production to avoid unexpected impact.","pos":[1444,1673]},{"pos":[1675,1805],"content":"<bpt id=\"p1\">[</bpt>Download the latest PowerShell release<ept id=\"p1\">](https://github.com/Azure/azure-powershell/releases)</ept> (minimum version required is : 1.0.0)"},{"content":"Create a backup vault","pos":[1908,1929]},{"content":"For customers using Azure Backup for the first time, you need to register the Azure Backup provider to be used with your subscription.","pos":[1949,2083]},{"content":"This can be done by running the following command: Register-AzureProvider -ProviderNamespace \"Microsoft.Backup\"","pos":[2084,2195]},{"content":"You can create a new backup vault using the <bpt id=\"p1\">**</bpt>New-AzureRMBackupVault<ept id=\"p1\">**</ept> cmdlet.","pos":[2197,2275]},{"content":"The backup vault is an ARM resource, so you need to place it within a Resource Group.","pos":[2276,2361]},{"content":"In an elevated Azure PowerShell console, run the following commands:","pos":[2362,2430]},{"pos":[2640,2726],"content":"Use the <bpt id=\"p1\">**</bpt>Get-AzureRMBackupVault<ept id=\"p1\">**</ept> cmdlet to list the backup vaults in a subscription."},{"content":"Installing the Azure Backup agent","pos":[2732,2765]},{"content":"Before you install the Azure Backup agent, you need to have the installer downloaded and present on the Windows Server.","pos":[2766,2885]},{"content":"You can get the latest version of the installer from the <bpt id=\"p1\">[</bpt>Microsoft Download Center<ept id=\"p1\">](http://aka.ms/azurebackup_agent)</ept> or from the backup vault's Dashboard page.","pos":[2886,3046]},{"content":"Save the installer to an easily accessible location like *C:\\Downloads\\*.","pos":[3047,3120]},{"content":"To install the agent, run the following command in an elevated PowerShell console:","pos":[3122,3204]},{"content":"This installs the agent with all the default options.","pos":[3249,3302]},{"content":"The installation takes a few minutes in the background.","pos":[3303,3358]},{"content":"If you do not specify the <bpt id=\"p1\">*</bpt>/nu<ept id=\"p1\">*</ept> option then the <bpt id=\"p2\">**</bpt>Windows Update<ept id=\"p2\">**</ept> window will open at the end of the installation to check for any updates.","pos":[3359,3499]},{"content":"Once installed, the agent will show in the list of installed programs.","pos":[3500,3570]},{"pos":[3572,3677],"content":"To see the list of installed programs, go to <bpt id=\"p1\">**</bpt>Control Panel<ept id=\"p1\">**</ept><ph id=\"ph1\"> &gt; </ph><bpt id=\"p2\">**</bpt>Programs<ept id=\"p2\">**</ept><ph id=\"ph2\"> &gt; </ph><bpt id=\"p3\">**</bpt>Programs and Features<ept id=\"p3\">**</ept>"},{"content":"Agent installed","pos":[3682,3697]},{"content":"Installation options","pos":[3766,3786]},{"content":"To see all the options available via the command-line, use the following command:","pos":[3788,3869]},{"content":"The available options include:","pos":[3914,3944]},{"content":"Option","pos":[3948,3954]},{"content":"Details","pos":[3957,3964]},{"content":"Default","pos":[3967,3974]},{"content":"/q","pos":[4004,4006]},{"content":"Quiet installation","pos":[4009,4027]},{"content":"/p:\"location\"","pos":[4036,4049]},{"content":"Path to the installation folder for the Azure Backup agent.","pos":[4052,4111]},{"content":"C:\\Program Files\\Microsoft Azure Recovery Services Agent","pos":[4114,4170]},{"content":"/s:\"location\"","pos":[4175,4188]},{"content":"Path to the cache folder for the Azure Backup agent.","pos":[4191,4243]},{"content":"C:\\Program Files\\Microsoft Azure Recovery Services Agent\\Scratch","pos":[4246,4310]},{"content":"/m","pos":[4315,4317]},{"content":"Opt-in to Microsoft Update","pos":[4320,4346]},{"content":"/nu","pos":[4355,4358]},{"content":"Do not Check for updates after installation is complete","pos":[4361,4416]},{"content":"/d","pos":[4425,4427]},{"content":"Uninstalls Microsoft Azure Recovery Services Agent","pos":[4430,4480]},{"content":"/ph","pos":[4489,4492]},{"content":"Proxy Host Address","pos":[4495,4513]},{"content":"/po","pos":[4522,4525]},{"content":"Proxy Host Port Number","pos":[4528,4550]},{"content":"/pu","pos":[4559,4562]},{"content":"Proxy Host UserName","pos":[4565,4584]},{"content":"/pw","pos":[4593,4596]},{"content":"Proxy Password","pos":[4599,4613]},{"content":"Registering with the Azure Backup service","pos":[4625,4666]},{"content":"Before you can register with the Azure Backup service, you need to ensure that the <bpt id=\"p1\">[</bpt>prerequisites<ept id=\"p1\">](backup-configure-vault.md)</ept> are met.","pos":[4667,4801]},{"content":"You must:","pos":[4802,4811]},{"content":"Have a valid Azure subscription","pos":[4815,4846]},{"content":"Have a backup vault","pos":[4849,4868]},{"pos":[4870,5048],"content":"To download the vault credentials, run the <bpt id=\"p1\">**</bpt>Get-AzureRMBackupVaultCredentials<ept id=\"p1\">**</ept> cmdlet in an Azure PowerShell console and store it in a convenient location like *C:\\Downloads\\*."},{"pos":[5308,5463],"content":"Registering the machine with the vault is done using the <bpt id=\"p1\">[</bpt>Start-OBRegistration<ept id=\"p1\">](https://technet.microsoft.com/library/hh770398%28v=wps.630%29.aspx)</ept> cmdlet:"},{"content":"Do not use relative paths to specify the vault credentials file.","pos":[5825,5889]},{"content":"You must provide an absolute path as an input to the cmdlet.","pos":[5890,5950]},{"content":"Networking settings","pos":[5955,5974]},{"content":"When the connectivity of the Windows machine to the internet is through a proxy server, the proxy settings can also be provided to the agent.","pos":[5975,6116]},{"content":"In this example, there is no proxy server, so we are explicitly clearing any proxy-related information.","pos":[6117,6220]},{"pos":[6222,6377],"content":"Bandwidth usage can also be controlled with the options of <ph id=\"ph1\">```work hour bandwidth```</ph> and <ph id=\"ph2\">```non-work hour bandwidth```</ph> for a given set of days of the week."},{"pos":[6379,6535],"content":"Setting the proxy and bandwidth details is done using the <bpt id=\"p1\">[</bpt>Set-OBMachineSetting<ept id=\"p1\">](https://technet.microsoft.com/library/hh770409%28v=wps.630%29.aspx)</ept> cmdlet:"},{"content":"Encryption settings","pos":[6709,6728]},{"content":"The backup data sent to Azure Backup is encrypted to protect the confidentiality of the data.","pos":[6729,6822]},{"content":"The encryption passphrase is the \"password\" to decrypt the data at the time of restore.","pos":[6823,6910]},{"content":"Keep the passphrase information safe and secure once it is set.","pos":[7083,7146]},{"content":"You will not be able to restore data from Azure without this passphrase.","pos":[7147,7219]},{"content":"Back up files and folders","pos":[7224,7249]},{"content":"All your backups from Windows Servers and clients to Azure Backup are governed by a policy.","pos":[7250,7341]},{"content":"The policy comprises three parts:","pos":[7342,7375]},{"pos":[7380,7481],"content":"A <bpt id=\"p1\">**</bpt>backup schedule<ept id=\"p1\">**</ept> that specifies when backups need to be taken and synchronized with the service."},{"pos":[7485,7573],"content":"A <bpt id=\"p1\">**</bpt>retention schedule<ept id=\"p1\">**</ept> that specifies how long to retain the recovery points in Azure."},{"pos":[7577,7661],"content":"A <bpt id=\"p1\">**</bpt>file inclusion/exclusion specification<ept id=\"p1\">**</ept> that dictates what should be backed up."},{"content":"In this document, since we're automating backup, we'll assume nothing has been configured.","pos":[7663,7753]},{"content":"We begin by creating a new backup policy using the <bpt id=\"p1\">[</bpt>New-OBPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770416.aspx)</ept> cmdlet and using it.","pos":[7754,7893]},{"content":"At this time the policy is empty and other cmdlets are needed to define what items will be included or excluded, when backups will run, and where the backups will be stored.","pos":[7938,8111]},{"content":"Configuring the backup schedule","pos":[8117,8148]},{"content":"The first of the 3 parts of a policy is the backup schedule, which is created using the <bpt id=\"p1\">[</bpt>New-OBSchedule<ept id=\"p1\">](https://technet.microsoft.com/library/hh770401)</ept> cmdlet.","pos":[8149,8309]},{"content":"The backup schedule defines when backups need to be taken.","pos":[8310,8368]},{"content":"When creating a schedule you need to specify 2 input parameters:","pos":[8369,8433]},{"content":"<bpt id=\"p1\">**</bpt>Days of the week<ept id=\"p1\">**</ept> that the backup should run.","pos":[8437,8485]},{"content":"You can run the backup job on just one day, or every day of the week, or any combination in between.","pos":[8486,8586]},{"content":"<bpt id=\"p1\">**</bpt>Times of the day<ept id=\"p1\">**</ept> when the backup should run.","pos":[8589,8637]},{"content":"You can define up to 3 different times of the day when the backup will be triggered.","pos":[8638,8722]},{"content":"For instance, you could configure a backup policy that runs at 4PM every Saturday and Sunday.","pos":[8724,8817]},{"pos":[8907,9075],"content":"The backup schedule needs to be associated with a policy, and this can be achieved by using the <bpt id=\"p1\">[</bpt>Set-OBSchedule<ept id=\"p1\">](https://technet.microsoft.com/library/hh770407)</ept> cmdlet."},{"content":"Configuring a retention policy","pos":[9278,9308]},{"content":"The retention policy defines how long recovery points created from backup jobs are retained.","pos":[9309,9401]},{"content":"When creating a new retention policy using the <bpt id=\"p1\">[</bpt>New-OBRetentionPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770425)</ept> cmdlet, you can specify the number of days that the backup recovery points need to be retained with Azure Backup.","pos":[9402,9634]},{"content":"The example below sets a retention policy of 7 days.","pos":[9635,9687]},{"pos":[9764,9914],"content":"The retention policy must be associated with the main policy using the cmdlet <bpt id=\"p1\">[</bpt>Set-OBRetentionPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770405)</ept>:"},{"content":"Including and excluding files to be backed up","pos":[10482,10527]},{"content":"An <ph id=\"ph1\">```OBFileSpec```</ph> object defines the files to be included and excluded in a backup.","pos":[10528,10613]},{"content":"This is a set of rules that scope out the protected files and folders on a machine.","pos":[10614,10697]},{"content":"You can have as many file inclusion or exclusion rules as required, and associate them with a policy.","pos":[10698,10799]},{"content":"When creating a new OBFileSpec object, you can:","pos":[10800,10847]},{"content":"Specify the files and folders to be included","pos":[10851,10895]},{"content":"Specify the files and folders to be excluded","pos":[10898,10942]},{"content":"Specify recursive backup of data in a folder (or) whether only the top-level files in the specified folder should be backed up.","pos":[10945,11072]},{"content":"The latter is achieved by using the -NonRecursive flag in the New-OBFileSpec command.","pos":[11074,11159]},{"content":"In the example below, we'll back up volume C: and D: and exclude the OS binaries in the Windows folder and any temporary folders.","pos":[11161,11290]},{"content":"To do so we'll create two file specifications using the <bpt id=\"p1\">[</bpt>New-OBFileSpec<ept id=\"p1\">](https://technet.microsoft.com/library/hh770408)</ept> cmdlet - one for inclusion and one for exclusion.","pos":[11291,11461]},{"content":"Once the file specifications have been created, they're associated with the policy using the <bpt id=\"p1\">[</bpt>Add-OBFileSpec<ept id=\"p1\">](https://technet.microsoft.com/library/hh770424)</ept> cmdlet.","pos":[11462,11627]},{"content":"Applying the policy","pos":[14041,14060]},{"content":"Now the policy object is complete and has an associated backup schedule, retention policy, and an inclusion/exclusion list of files.","pos":[14061,14193]},{"content":"This policy can now be committed for Azure Backup to use.","pos":[14194,14251]},{"content":"Before you apply the newly created policy ensure that there are no existing backup policies associated with the server by using the <bpt id=\"p1\">[</bpt>Remove-OBPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770415)</ept> cmdlet.","pos":[14252,14457]},{"content":"Removing the policy will prompt for confirmation.","pos":[14458,14507]},{"content":"To skip the confirmation use the <ph id=\"ph1\">```-Confirm:$false```</ph> flag with the cmdlet.","pos":[14508,14584]},{"content":"Committing the policy object is done using the <bpt id=\"p1\">[</bpt>Set-OBPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770421)</ept> cmdlet.","pos":[14832,14949]},{"content":"This will also ask for confirmation.","pos":[14950,14986]},{"content":"To skip the confirmation use the <ph id=\"ph1\">```-Confirm:$false```</ph> flag with the cmdlet.","pos":[14987,15063]},{"content":"You can view the details of the existing backup policy using the <bpt id=\"p1\">[</bpt>Get-OBPolicy<ept id=\"p1\">](https://technet.microsoft.com/library/hh770406)</ept> cmdlet.","pos":[16236,16371]},{"content":"You can drill-down further using the <bpt id=\"p1\">[</bpt>Get-OBSchedule<ept id=\"p1\">](https://technet.microsoft.com/library/hh770423)</ept> cmdlet for the backup schedule and the <bpt id=\"p2\">[</bpt>Get-OBRetentionPolicy<ept id=\"p2\">](https://technet.microsoft.com/library/hh770427)</ept> cmdlet for the retention policies","pos":[16372,16618]},{"content":"Performing an ad-hoc backup","pos":[17512,17539]},{"content":"Once a backup policy has been set the backups will occur per the schedule.","pos":[17540,17614]},{"content":"Triggering an ad-hoc backup is also possible using the <bpt id=\"p1\">[</bpt>Start-OBBackup<ept id=\"p1\">](https://technet.microsoft.com/library/hh770426)</ept> cmdlet:","pos":[17615,17742]},{"content":"Restore data from Azure Backup","pos":[18015,18045]},{"content":"This section will guide you through the steps for automating recovery of data from Azure Backup.","pos":[18046,18142]},{"content":"Doing so involves the following steps:","pos":[18143,18181]},{"content":"Pick the source volume","pos":[18186,18208]},{"content":"Choose a backup point to restore","pos":[18212,18244]},{"content":"Choose an item to restore","pos":[18248,18273]},{"content":"Trigger the restore process","pos":[18277,18304]},{"content":"Picking the source volume","pos":[18310,18335]},{"content":"In order to restore an item from Azure Backup, you first need to identify the source of the item.","pos":[18336,18433]},{"content":"Since we're executing the commands in the context of a Windows Server or a Windows client, the machine is already identified.","pos":[18434,18559]},{"content":"The next step in identifying the source is to identify the volume containing it.","pos":[18560,18640]},{"content":"A list of volumes or sources being backed up from this machine can be retrieved by executing the <bpt id=\"p1\">[</bpt>Get-OBRecoverableSource<ept id=\"p1\">](https://technet.microsoft.com/library/hh770410)</ept> cmdlet.","pos":[18641,18819]},{"content":"This command returns an array of all the sources backed up from this server/client.","pos":[18820,18903]},{"content":"Choosing a backup point to restore","pos":[19135,19169]},{"content":"The list of backup points can be retrieved by executing the <bpt id=\"p1\">[</bpt>Get-OBRecoverableItem<ept id=\"p1\">](https://technet.microsoft.com/library/hh770399.aspx)</ept> cmdlet with appropriate parameters.","pos":[19170,19342]},{"content":"In our example, we’ll choose the latest backup point for the source volume <bpt id=\"p1\">*</bpt>D:<ept id=\"p1\">*</ept> and use it to recover a specific file.","pos":[19343,19461]},{"content":"The object <ph id=\"ph1\">```$rps```</ph> is an array of backup points.","pos":[20047,20098]},{"content":"The first element is the latest point and the Nth element is the oldest point.","pos":[20099,20177]},{"content":"To choose the latest point, we will use","pos":[20178,20217]},{"content":"Choosing an item to restore","pos":[20238,20265]},{"content":"To identify the exact file or folder to restore, recursively use the <bpt id=\"p1\">[</bpt>Get-OBRecoverableItem<ept id=\"p1\">](https://technet.microsoft.com/library/hh770399.aspx)</ept> cmdlet.","pos":[20266,20419]},{"content":"That way the folder hierarchy can be browsed solely using the","pos":[20420,20481]},{"pos":[20512,20613],"content":"In this example, if we want to restore the file <bpt id=\"p1\">*</bpt>finances.xls<ept id=\"p1\">*</ept> we can reference that using the object"},{"content":"You can also search for items to restore using the <ph id=\"ph1\">```Get-OBRecoverableItem```</ph> cmdlet.","pos":[21782,21868]},{"content":"In our example, to search for <bpt id=\"p1\">*</bpt>finances.xls<ept id=\"p1\">*</ept> we could get a handle on the file by running this command:","pos":[21869,21972]},{"content":"Triggering the restore process","pos":[22095,22125]},{"content":"To trigger the restore process, we first need to specify the recovery options.","pos":[22126,22204]},{"content":"This can be done by using the <bpt id=\"p1\">[</bpt>New-OBRecoveryOption<ept id=\"p1\">](https://technet.microsoft.com/library/hh770417.aspx)</ept> cmdlet.","pos":[22205,22318]},{"content":"For this example, let's assume that we want to restore the files to <bpt id=\"p1\">*</bpt>C:\\temp<ept id=\"p1\">*</ept>.","pos":[22319,22397]},{"content":"Let's also assume that we want to skip files that already exist on the destination folder <bpt id=\"p1\">*</bpt>C:\\temp<ept id=\"p1\">*</ept>.","pos":[22398,22498]},{"content":"To create such a recovery option, use the following command:","pos":[22499,22559]},{"pos":[22665,22864],"content":"Now trigger restore by using the <bpt id=\"p1\">[</bpt>Start-OBRecovery<ept id=\"p1\">](https://technet.microsoft.com/library/hh770402.aspx)</ept> command on the selected <ph id=\"ph1\">```$item```</ph> from the output of the <ph id=\"ph2\">```Get-OBRecoverableItem```</ph> cmdlet:"},{"content":"Uninstalling the Azure Backup agent","pos":[23161,23196]},{"content":"Uninstalling the Azure Backup agent can be done by using the following command:","pos":[23197,23276]},{"content":"Uninstalling the agent binaries from the machine has some consequences to consider:","pos":[23326,23409]},{"content":"It removes the file-filter from the machine, and tracking of changes is stopped.","pos":[23413,23493]},{"content":"All policy information is removed from the machine, but the policy information continues to be stored in the service.","pos":[23496,23613]},{"content":"All backup schedules are removed, and no further backups are taken.","pos":[23616,23683]},{"content":"However, the data stored in Azure remains and is retained as per the retention policy setup by you.","pos":[23685,23784]},{"content":"Older points are automatically aged out.","pos":[23785,23825]},{"content":"Remote management","pos":[23830,23847]},{"content":"All the management around the Azure Backup agent, policies, and data sources can be done remotely through PowerShell.","pos":[23848,23965]},{"content":"The machine that will be managed remotely needs to be prepared correctly.","pos":[23966,24039]},{"content":"By default, the WinRM service is configured for manual startup.","pos":[24041,24104]},{"content":"The startup type must be set to <bpt id=\"p1\">*</bpt>Automatic<ept id=\"p1\">*</ept> and the service should be started.","pos":[24105,24183]},{"content":"To verify that the WinRM service is running, the value of the Status property should be <bpt id=\"p1\">*</bpt>Running<ept id=\"p1\">*</ept>","pos":[24184,24281]},{"content":"PowerShell should be configured for remoting.","pos":[24467,24512]},{"content":"The machine can now be managed remotely - starting from the installation of the agent.","pos":[24747,24833]},{"content":"For example, the following script copies the agent to the remote machine and installs it.","pos":[24834,24923]},{"content":"Next steps","pos":[25348,25358]},{"content":"For more information about Azure Backup for Windows Server/Client see","pos":[25359,25428]},{"content":"Introduction to Azure Backup","pos":[25433,25461]},{"content":"Back up Windows Servers","pos":[25493,25516]}],"content":"<properties\n    pageTitle=\"Deploy and manage backup for Windows Server/Client using PowerShell | Microsoft Azure\"\n    description=\"Learn how to deploy and manage Azure Backup using PowerShell\"\n    services=\"backup\"\n    documentationCenter=\"\"\n    authors=\"nkolli1\"\n    manager=\"shivamg\"\n    editor=\"\"/>\n\n<tags\n    ms.service=\"backup\"\n    ms.workload=\"storage-backup-recovery\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"01/22/2016\"\n    ms.author=\"markgal;jimpark;nkolli\"/>\n\n\n# Deploy and manage backup to Azure for Windows Server/Windows Client using PowerShell\n\nThis article shows you how to use PowerShell for setting up Azure Backup on Windows Server or a Windows client, and managing backup and recovery.\n\n## Install Azure PowerShell\n\n[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-include.md)]\n\nIn October 2015, Azure PowerShell 1.0 was released. This release succeeded the 0.9.8 release and brought about some significant changes, especially in the naming pattern of the cmdlets. 1.0 cmdlets follow the naming pattern {verb}-AzureRm{noun}; whereas, the 0.9.8 names do not include **Rm** (for example, New-AzureRmResourceGroup instead of New-AzureResourceGroup). When using Azure PowerShell 0.9.8, you must first enable the Resource Manager mode by running the **Switch-AzureMode AzureResourceManager** command. This command is not necessary in 1.0 or later.\n\nIf you want to use your scripts written for the 0.9.8 environment, in the 1.0 or later environment, you should carefully test the scripts in a pre-production environment before using them in production to avoid unexpected impact.\n\n[Download the latest PowerShell release](https://github.com/Azure/azure-powershell/releases) (minimum version required is : 1.0.0)\n\n\n[AZURE.INCLUDE [arm-getting-setup-powershell](../../includes/arm-getting-setup-powershell.md)]\n\n\n## Create a backup vault\n\n> [AZURE.WARNING] For customers using Azure Backup for the first time, you need to register the Azure Backup provider to be used with your subscription. This can be done by running the following command: Register-AzureProvider -ProviderNamespace \"Microsoft.Backup\"\n\nYou can create a new backup vault using the **New-AzureRMBackupVault** cmdlet. The backup vault is an ARM resource, so you need to place it within a Resource Group. In an elevated Azure PowerShell console, run the following commands:\n\n```\nPS C:\\> New-AzureResourceGroup –Name “test-rg” -Region “West US”\nPS C:\\> $backupvault = New-AzureRMBackupVault –ResourceGroupName “test-rg” –Name “test-vault” –Region “West US” –Storage GeoRedundant\n```\n\nUse the **Get-AzureRMBackupVault** cmdlet to list the backup vaults in a subscription.\n\n\n## Installing the Azure Backup agent\nBefore you install the Azure Backup agent, you need to have the installer downloaded and present on the Windows Server. You can get the latest version of the installer from the [Microsoft Download Center](http://aka.ms/azurebackup_agent) or from the backup vault's Dashboard page. Save the installer to an easily accessible location like *C:\\Downloads\\*.\n\nTo install the agent, run the following command in an elevated PowerShell console:\n\n```\nPS C:\\> MARSAgentInstaller.exe /q\n```\n\nThis installs the agent with all the default options. The installation takes a few minutes in the background. If you do not specify the */nu* option then the **Windows Update** window will open at the end of the installation to check for any updates. Once installed, the agent will show in the list of installed programs.\n\nTo see the list of installed programs, go to **Control Panel** > **Programs** > **Programs and Features**.\n\n![Agent installed](./media/backup-client-automation/installed-agent-listing.png)\n\n### Installation options\n\nTo see all the options available via the command-line, use the following command:\n\n```\nPS C:\\> MARSAgentInstaller.exe /?\n```\n\nThe available options include:\n\n| Option | Details | Default |\n| ---- | ----- | ----- |\n| /q | Quiet installation | - |\n| /p:\"location\" | Path to the installation folder for the Azure Backup agent. | C:\\Program Files\\Microsoft Azure Recovery Services Agent |\n| /s:\"location\" | Path to the cache folder for the Azure Backup agent. | C:\\Program Files\\Microsoft Azure Recovery Services Agent\\Scratch |\n| /m | Opt-in to Microsoft Update | - |\n| /nu | Do not Check for updates after installation is complete | - |\n| /d | Uninstalls Microsoft Azure Recovery Services Agent | - |\n| /ph | Proxy Host Address | - |\n| /po | Proxy Host Port Number | - |\n| /pu | Proxy Host UserName | - |\n| /pw | Proxy Password | - |\n\n\n## Registering with the Azure Backup service\nBefore you can register with the Azure Backup service, you need to ensure that the [prerequisites](backup-configure-vault.md) are met. You must:\n\n- Have a valid Azure subscription\n- Have a backup vault\n\nTo download the vault credentials, run the **Get-AzureRMBackupVaultCredentials** cmdlet in an Azure PowerShell console and store it in a convenient location like *C:\\Downloads\\*.\n\n```\nPS C:\\> $credspath = \"C:\\\"\nPS C:\\> $credsfilename = Get-AzureRMBackupVaultCredentials -Vault $backupvault -TargetLocation $credspath\nPS C:\\> $credsfilename\nf5303a0b-fae4-4cdb-b44d-0e4c032dde26_backuprg_backuprn_2015-08-11--06-22-35.VaultCredentials\n```\n\nRegistering the machine with the vault is done using the [Start-OBRegistration](https://technet.microsoft.com/library/hh770398%28v=wps.630%29.aspx) cmdlet:\n\n```\nPS C:\\> $cred = $credspath + $credsfilename\nPS C:\\> Start-OBRegistration -VaultCredentials $cred -Confirm:$false\n\nCertThumbprint      : 7a2ef2caa2e74b6ed1222a5e89288ddad438df2\nSubscriptionID      : ef4ab577-c2c0-43e4-af80-af49f485f3d1\nServiceResourceName : test-vault\nRegion              : West US\n\nMachine registration succeeded.\n```\n\n> [AZURE.IMPORTANT] Do not use relative paths to specify the vault credentials file. You must provide an absolute path as an input to the cmdlet.\n\n## Networking settings\nWhen the connectivity of the Windows machine to the internet is through a proxy server, the proxy settings can also be provided to the agent. In this example, there is no proxy server, so we are explicitly clearing any proxy-related information.\n\nBandwidth usage can also be controlled with the options of ```work hour bandwidth``` and ```non-work hour bandwidth``` for a given set of days of the week.\n\nSetting the proxy and bandwidth details is done using the [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409%28v=wps.630%29.aspx) cmdlet:\n\n```\nPS C:\\> Set-OBMachineSetting -NoProxy\nServer properties updated successfully.\n\nPS C:\\> Set-OBMachineSetting -NoThrottle\nServer properties updated successfully.\n```\n\n## Encryption settings\nThe backup data sent to Azure Backup is encrypted to protect the confidentiality of the data. The encryption passphrase is the \"password\" to decrypt the data at the time of restore.\n\n```\nPS C:\\> ConvertTo-SecureString -String \"Complex!123_STRING\" -AsPlainText -Force | Set-OBMachineSetting\nServer properties updated successfully\n```\n\n> [AZURE.IMPORTANT] Keep the passphrase information safe and secure once it is set. You will not be able to restore data from Azure without this passphrase.\n\n## Back up files and folders\nAll your backups from Windows Servers and clients to Azure Backup are governed by a policy. The policy comprises three parts:\n\n1. A **backup schedule** that specifies when backups need to be taken and synchronized with the service.\n2. A **retention schedule** that specifies how long to retain the recovery points in Azure.\n3. A **file inclusion/exclusion specification** that dictates what should be backed up.\n\nIn this document, since we're automating backup, we'll assume nothing has been configured. We begin by creating a new backup policy using the [New-OBPolicy](https://technet.microsoft.com/library/hh770416.aspx) cmdlet and using it.\n\n```\nPS C:\\> $newpolicy = New-OBPolicy\n```\n\nAt this time the policy is empty and other cmdlets are needed to define what items will be included or excluded, when backups will run, and where the backups will be stored.\n\n### Configuring the backup schedule\nThe first of the 3 parts of a policy is the backup schedule, which is created using the [New-OBSchedule](https://technet.microsoft.com/library/hh770401) cmdlet. The backup schedule defines when backups need to be taken. When creating a schedule you need to specify 2 input parameters:\n\n- **Days of the week** that the backup should run. You can run the backup job on just one day, or every day of the week, or any combination in between.\n- **Times of the day** when the backup should run. You can define up to 3 different times of the day when the backup will be triggered.\n\nFor instance, you could configure a backup policy that runs at 4PM every Saturday and Sunday.\n\n```\nPS C:\\> $sched = New-OBSchedule -DaysofWeek Saturday, Sunday -TimesofDay 16:00\n```\n\nThe backup schedule needs to be associated with a policy, and this can be achieved by using the [Set-OBSchedule](https://technet.microsoft.com/library/hh770407) cmdlet.\n\n```\nPS C:> Set-OBSchedule -Policy $newpolicy -Schedule $sched\nBackupSchedule : 4:00 PM Saturday, Sunday, Every 1 week(s) DsList : PolicyName : RetentionPolicy : State : New PolicyState : Valid\n```\n### Configuring a retention policy\nThe retention policy defines how long recovery points created from backup jobs are retained. When creating a new retention policy using the [New-OBRetentionPolicy](https://technet.microsoft.com/library/hh770425) cmdlet, you can specify the number of days that the backup recovery points need to be retained with Azure Backup. The example below sets a retention policy of 7 days.\n\n```\nPS C:\\> $retentionpolicy = New-OBRetentionPolicy -RetentionDays 7\n```\n\nThe retention policy must be associated with the main policy using the cmdlet [Set-OBRetentionPolicy](https://technet.microsoft.com/library/hh770405):\n\n```\nPS C:\\> Set-OBRetentionPolicy -Policy $newpolicy -RetentionPolicy $retentionpolicy\n\nBackupSchedule  : 4:00 PM\n                  Saturday, Sunday,\n                  Every 1 week(s)\nDsList          :\nPolicyName      :\nRetentionPolicy : Retention Days : 7\n\n                  WeeklyLTRSchedule :\n                  Weekly schedule is not set\n\n                  MonthlyLTRSchedule :\n                  Monthly schedule is not set\n\n                  YearlyLTRSchedule :\n                  Yearly schedule is not set\n\nState           : New\nPolicyState     : Valid\n```\n### Including and excluding files to be backed up\nAn ```OBFileSpec``` object defines the files to be included and excluded in a backup. This is a set of rules that scope out the protected files and folders on a machine. You can have as many file inclusion or exclusion rules as required, and associate them with a policy. When creating a new OBFileSpec object, you can:\n\n- Specify the files and folders to be included\n- Specify the files and folders to be excluded\n- Specify recursive backup of data in a folder (or) whether only the top-level files in the specified folder should be backed up.\n\nThe latter is achieved by using the -NonRecursive flag in the New-OBFileSpec command.\n\nIn the example below, we'll back up volume C: and D: and exclude the OS binaries in the Windows folder and any temporary folders. To do so we'll create two file specifications using the [New-OBFileSpec](https://technet.microsoft.com/library/hh770408) cmdlet - one for inclusion and one for exclusion. Once the file specifications have been created, they're associated with the policy using the [Add-OBFileSpec](https://technet.microsoft.com/library/hh770424) cmdlet.\n\n```\nPS C:\\> $inclusions = New-OBFileSpec -FileSpec @(\"C:\\\", \"D:\\\")\n\nPS C:\\> $exclusions = New-OBFileSpec -FileSpec @(\"C:\\windows\", \"C:\\temp\") -Exclude\n\nPS C:\\> Add-OBFileSpec -Policy $newpolicy -FileSpec $inclusions\n\nBackupSchedule  : 4:00 PM\n                  Saturday, Sunday,\n                  Every 1 week(s)\nDsList          : {DataSource\n                  DatasourceId:0\n                  Name:C:\\\n                  FileSpec:FileSpec\n                  FileSpec:C:\\\n                  IsExclude:False\n                  IsRecursive:True\n\n                  , DataSource\n                  DatasourceId:0\n                  Name:D:\\\n                  FileSpec:FileSpec\n                  FileSpec:D:\\\n                  IsExclude:False\n                  IsRecursive:True\n\n                  }\nPolicyName      :\nRetentionPolicy : Retention Days : 7\n\n                  WeeklyLTRSchedule :\n                  Weekly schedule is not set\n\n                  MonthlyLTRSchedule :\n                  Monthly schedule is not set\n\n                  YearlyLTRSchedule :\n                  Yearly schedule is not set\n\nState           : New\nPolicyState     : Valid\n\n\nPS C:\\> Add-OBFileSpec -Policy $newpolicy -FileSpec $exclusions\n\nBackupSchedule  : 4:00 PM\n                  Saturday, Sunday,\n                  Every 1 week(s)\nDsList          : {DataSource\n                  DatasourceId:0\n                  Name:C:\\\n                  FileSpec:FileSpec\n                  FileSpec:C:\\\n                  IsExclude:False\n                  IsRecursive:True\n                  ,FileSpec\n                  FileSpec:C:\\windows\n                  IsExclude:True\n                  IsRecursive:True\n                  ,FileSpec\n                  FileSpec:C:\\temp\n                  IsExclude:True\n                  IsRecursive:True\n\n                  , DataSource\n                  DatasourceId:0\n                  Name:D:\\\n                  FileSpec:FileSpec\n                  FileSpec:D:\\\n                  IsExclude:False\n                  IsRecursive:True\n\n                  }\nPolicyName      :\nRetentionPolicy : Retention Days : 7\n\n                  WeeklyLTRSchedule :\n                  Weekly schedule is not set\n\n                  MonthlyLTRSchedule :\n                  Monthly schedule is not set\n\n                  YearlyLTRSchedule :\n                  Yearly schedule is not set\n\nState           : New\nPolicyState     : Valid\n```\n\n### Applying the policy\nNow the policy object is complete and has an associated backup schedule, retention policy, and an inclusion/exclusion list of files. This policy can now be committed for Azure Backup to use. Before you apply the newly created policy ensure that there are no existing backup policies associated with the server by using the [Remove-OBPolicy](https://technet.microsoft.com/library/hh770415) cmdlet. Removing the policy will prompt for confirmation. To skip the confirmation use the ```-Confirm:$false``` flag with the cmdlet.\n\n```\nPS C:> Get-OBPolicy | Remove-OBPolicy\nMicrosoft Azure Backup Are you sure you want to remove this backup policy? This will delete all the backed up data. [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is \"Y\"):\n```\n\nCommitting the policy object is done using the [Set-OBPolicy](https://technet.microsoft.com/library/hh770421) cmdlet. This will also ask for confirmation. To skip the confirmation use the ```-Confirm:$false``` flag with the cmdlet.\n\n```\nPS C:> Set-OBPolicy -Policy $newpolicy\nMicrosoft Azure Backup Do you want to save this backup policy ? [Y] Yes [A] Yes to All [N] No [L] No to All [S] Suspend [?] Help (default is \"Y\"):\nBackupSchedule : 4:00 PM Saturday, Sunday, Every 1 week(s)\nDsList : {DataSource\n         DatasourceId:4508156004108672185\n         Name:C:\\\n         FileSpec:FileSpec\n         FileSpec:C:\\\n         IsExclude:False\n         IsRecursive:True,\n\n         FileSpec\n         FileSpec:C:\\windows\n         IsExclude:True\n         IsRecursive:True,\n\n         FileSpec\n         FileSpec:C:\\temp\n         IsExclude:True\n         IsRecursive:True,\n\n         DataSource\n         DatasourceId:4508156005178868542\n         Name:D:\\\n         FileSpec:FileSpec\n         FileSpec:D:\\\n         IsExclude:False\n         IsRecursive:True\n    }\nPolicyName : c2eb6568-8a06-49f4-a20e-3019ae411bac\nRetentionPolicy : Retention Days : 7\n              WeeklyLTRSchedule :\n              Weekly schedule is not set\n\n              MonthlyLTRSchedule :\n              Monthly schedule is not set\n\n              YearlyLTRSchedule :\n              Yearly schedule is not set\nState : Existing PolicyState : Valid\n```\n\nYou can view the details of the existing backup policy using the [Get-OBPolicy](https://technet.microsoft.com/library/hh770406) cmdlet. You can drill-down further using the [Get-OBSchedule](https://technet.microsoft.com/library/hh770423) cmdlet for the backup schedule and the [Get-OBRetentionPolicy](https://technet.microsoft.com/library/hh770427) cmdlet for the retention policies\n\n```\nPS C:> Get-OBPolicy | Get-OBSchedule\nSchedulePolicyName : 71944081-9950-4f7e-841d-32f0a0a1359a\nScheduleRunDays : {Saturday, Sunday}\nScheduleRunTimes : {16:00:00}\nState : Existing\n\nPS C:> Get-OBPolicy | Get-OBRetentionPolicy\nRetentionDays : 7\nRetentionPolicyName : ca3574ec-8331-46fd-a605-c01743a5265e\nState : Existing\n\nPS C:> Get-OBPolicy | Get-OBFileSpec\nFileName : *\nFilePath : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\nFileSpec : D:\\\nIsExclude : False\nIsRecursive : True\n\nFileName : *\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\\nFileSpec : C:\\\nIsExclude : False\nIsRecursive : True\n\nFileName : *\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\windows\nFileSpec : C:\\windows\nIsExclude : True\nIsRecursive : True\n\nFileName : *\nFilePath : \\?\\Volume{cdd41007-a22f-11e2-be6c-806e6f6e6963}\\temp\nFileSpec : C:\\temp\nIsExclude : True\nIsRecursive : True\n```\n\n### Performing an ad-hoc backup\nOnce a backup policy has been set the backups will occur per the schedule. Triggering an ad-hoc backup is also possible using the [Start-OBBackup](https://technet.microsoft.com/library/hh770426) cmdlet:\n\n```\nPS C:> Get-OBPolicy | Start-OBBackup\nTaking snapshot of volumes...\nPreparing storage...\nEstimating size of backup items...\nEstimating size of backup items...\nTransferring data...\nVerifying backup...\nJob completed.\nThe backup operation completed successfully.\n```\n\n## Restore data from Azure Backup\nThis section will guide you through the steps for automating recovery of data from Azure Backup. Doing so involves the following steps:\n\n1. Pick the source volume\n2. Choose a backup point to restore\n3. Choose an item to restore\n4. Trigger the restore process\n\n### Picking the source volume\nIn order to restore an item from Azure Backup, you first need to identify the source of the item. Since we're executing the commands in the context of a Windows Server or a Windows client, the machine is already identified. The next step in identifying the source is to identify the volume containing it. A list of volumes or sources being backed up from this machine can be retrieved by executing the [Get-OBRecoverableSource](https://technet.microsoft.com/library/hh770410) cmdlet. This command returns an array of all the sources backed up from this server/client.\n\n```\nPS C:> $source = Get-OBRecoverableSource\nPS C:> $source\nFriendlyName : C:\\\nRecoverySourceName : C:\\\nServerName : myserver.microsoft.com\n\nFriendlyName : D:\\\nRecoverySourceName : D:\\\nServerName : myserver.microsoft.com\n```\n\n### Choosing a backup point to restore\nThe list of backup points can be retrieved by executing the [Get-OBRecoverableItem](https://technet.microsoft.com/library/hh770399.aspx) cmdlet with appropriate parameters. In our example, we’ll choose the latest backup point for the source volume *D:* and use it to recover a specific file.\n\n```\nPS C:> $rps = Get-OBRecoverableItem -Source $source[1]\nIsDir : False\nItemNameFriendly : D:\\\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\nLocalMountPoint : D:\\\nMountPointName : D:\\\nName : D:\\\nPointInTime : 18-Jun-15 6:41:52 AM\nServerName : myserver.microsoft.com\nItemSize :\nItemLastModifiedTime :\n\nIsDir : False\nItemNameFriendly : D:\\\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\\nLocalMountPoint : D:\\\nMountPointName : D:\\\nName : D:\\\nPointInTime : 17-Jun-15 6:31:31 AM\nServerName : myserver.microsoft.com\nItemSize :\nItemLastModifiedTime :\n```\nThe object ```$rps``` is an array of backup points. The first element is the latest point and the Nth element is the oldest point. To choose the latest point, we will use ```$rps[0]```.\n\n### Choosing an item to restore\nTo identify the exact file or folder to restore, recursively use the [Get-OBRecoverableItem](https://technet.microsoft.com/library/hh770399.aspx) cmdlet. That way the folder hierarchy can be browsed solely using the ```Get-OBRecoverableItem```.\n\nIn this example, if we want to restore the file *finances.xls* we can reference that using the object ```$filesFolders[1]```.\n\n```\nPS C:> $filesFolders = Get-OBRecoverableItem $rps[0]\nPS C:> $filesFolders\nIsDir : True\nItemNameFriendly : D:\\MyData\\\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\\nLocalMountPoint : D:\\\nMountPointName : D:\\\nName : MyData\nPointInTime : 18-Jun-15 6:41:52 AM\nServerName : myserver.microsoft.com\nItemSize :\nItemLastModifiedTime : 15-Jun-15 8:49:29 AM\n\nPS C:> $filesFolders = Get-OBRecoverableItem $filesFolders[0]\nPS C:> $filesFolders\nIsDir : False\nItemNameFriendly : D:\\MyData\\screenshot.oxps\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\screenshot.oxps\nLocalMountPoint : D:\\\nMountPointName : D:\\\nName : screenshot.oxps\nPointInTime : 18-Jun-15 6:41:52 AM\nServerName : myserver.microsoft.com\nItemSize : 228313\nItemLastModifiedTime : 21-Jun-14 6:45:09 AM\n\nIsDir : False\nItemNameFriendly : D:\\MyData\\finances.xls\nItemNameGuid : \\?\\Volume{b835d359-a1dd-11e2-be72-2016d8d89f0f}\\MyData\\finances.xls\nLocalMountPoint : D:\\\nMountPointName : D:\\\nName : finances.xls\nPointInTime : 18-Jun-15 6:41:52 AM\nServerName : myserver.microsoft.com\nItemSize : 96256\nItemLastModifiedTime : 21-Jun-14 6:43:02 AM\n```\n\nYou can also search for items to restore using the ```Get-OBRecoverableItem``` cmdlet. In our example, to search for *finances.xls* we could get a handle on the file by running this command:\n\n```\nPS C:\\> $item = Get-OBRecoverableItem -RecoveryPoint $rps[0] -Location \"D:\\MyData\" -SearchString \"finance*\"\n```\n\n### Triggering the restore process\nTo trigger the restore process, we first need to specify the recovery options. This can be done by using the [New-OBRecoveryOption](https://technet.microsoft.com/library/hh770417.aspx) cmdlet. For this example, let's assume that we want to restore the files to *C:\\temp*. Let's also assume that we want to skip files that already exist on the destination folder *C:\\temp*. To create such a recovery option, use the following command:\n\n```\nPS C:\\> $recovery_option = New-OBRecoveryOption -DestinationPath \"C:\\temp\" -OverwriteType Skip\n```\n\nNow trigger restore by using the [Start-OBRecovery](https://technet.microsoft.com/library/hh770402.aspx) command on the selected ```$item``` from the output of the ```Get-OBRecoverableItem``` cmdlet:\n\n```\nPS C:\\> Start-OBRecovery -RecoverableItem $item -RecoveryOption $recover_option\nEstimating size of backup items...\nEstimating size of backup items...\nEstimating size of backup items...\nEstimating size of backup items...\nJob completed.\nThe recovery operation completed successfully.\n```\n\n\n## Uninstalling the Azure Backup agent\nUninstalling the Azure Backup agent can be done by using the following command:\n\n```\nPS C:\\> .\\MARSAgentInstaller.exe /d /q\n```\n\nUninstalling the agent binaries from the machine has some consequences to consider:\n\n- It removes the file-filter from the machine, and tracking of changes is stopped.\n- All policy information is removed from the machine, but the policy information continues to be stored in the service.\n- All backup schedules are removed, and no further backups are taken.\n\nHowever, the data stored in Azure remains and is retained as per the retention policy setup by you. Older points are automatically aged out.\n\n## Remote management\nAll the management around the Azure Backup agent, policies, and data sources can be done remotely through PowerShell. The machine that will be managed remotely needs to be prepared correctly.\n\nBy default, the WinRM service is configured for manual startup. The startup type must be set to *Automatic* and the service should be started. To verify that the WinRM service is running, the value of the Status property should be *Running*.\n\n```\nPS C:\\> Get-Service WinRM\n\nStatus   Name               DisplayName\n------   ----               -----------\nRunning  winrm              Windows Remote Management (WS-Manag...\n```\n\nPowerShell should be configured for remoting.\n\n```\nPS C:\\> Enable-PSRemoting -force\nWinRM is already set up to receive requests on this computer.\nWinRM has been updated for remote management.\nWinRM firewall exception enabled.\n\nPS C:\\> Set-ExecutionPolicy unrestricted -force\n```\n\nThe machine can now be managed remotely - starting from the installation of the agent. For example, the following script copies the agent to the remote machine and installs it.\n\n```\nPS C:\\> $dloc = \"\\\\REMOTESERVER01\\c$\\Windows\\Temp\"\nPS C:\\> $agent = \"\\\\REMOTESERVER01\\c$\\Windows\\Temp\\MARSAgentInstaller.exe\"\nPS C:\\> $args = \"/q\"\nPS C:\\> Copy-Item \"C:\\Downloads\\MARSAgentInstaller.exe\" -Destination $dloc - force\n\nPS C:\\> $s = New-PSSession -ComputerName REMOTESERVER01\nPS C:\\> Invoke-Command -Session $s -Script { param($d, $a) Start-Process -FilePath $d $a -Wait } -ArgumentList $agent $args\n```\n\n## Next steps\nFor more information about Azure Backup for Windows Server/Client see\n\n- [Introduction to Azure Backup](backup-configure-vault.md)\n- [Back up Windows Servers](backup-azure-backup-windows-server.md)\n"}