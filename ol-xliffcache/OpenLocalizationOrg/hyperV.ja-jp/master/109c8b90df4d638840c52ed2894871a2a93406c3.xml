{
  "nodes": [
    {
      "content": "Azure AD Connect Health Agent installation | Microsoft Azure",
      "pos": [
        27,
        87
      ]
    },
    {
      "content": "This is the Azure AD Connect Health page that describes the agent installation for AD FS and Sync.",
      "pos": [
        106,
        204
      ]
    },
    {
      "content": "Azure AD Connect Health Agent Installation",
      "pos": [
        528,
        570
      ]
    },
    {
      "content": "This document will walk you through installing and configuring the Azure AD Connect Health Agent for AD FS and sync.",
      "pos": [
        573,
        689
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph>Remember that before you see any AD FS data in your instance of Azure AD Connect Health, you will need to install the Azure AD Connect Health Agent on your targeted servers.",
      "pos": [
        692,
        877
      ]
    },
    {
      "content": "Be sure to complete the requirements <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](active-directory-aadconnect-health.md#requirements)</ept> prior to installing the agent.",
      "pos": [
        879,
        1005
      ]
    },
    {
      "content": "You can download the agent <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://go.microsoft.com/fwlink/?LinkID=518973)</ept>.",
      "pos": [
        1007,
        1088
      ]
    },
    {
      "content": "Installing the  Azure AD Connect Health Agent for AD FS",
      "pos": [
        1094,
        1149
      ]
    },
    {
      "content": "To start the agent installation, double-click on the .exe file that you downloaded.",
      "pos": [
        1150,
        1233
      ]
    },
    {
      "content": "On the first screen, click Install.",
      "pos": [
        1234,
        1269
      ]
    },
    {
      "content": "Verify Azure AD Connect Health",
      "pos": [
        1273,
        1303
      ]
    },
    {
      "content": "Once the installation is finished, click Configure Now.",
      "pos": [
        1376,
        1431
      ]
    },
    {
      "content": "Verify Azure AD Connect Health",
      "pos": [
        1435,
        1465
      ]
    },
    {
      "content": "This will launch a command prompt followed by some PowerShell that will execute Register-AzureADConnectHealthADFSAgent.",
      "pos": [
        1538,
        1657
      ]
    },
    {
      "content": "You will be prompted to sign in to Azure.",
      "pos": [
        1658,
        1699
      ]
    },
    {
      "content": "Go ahead and sign in.",
      "pos": [
        1700,
        1721
      ]
    },
    {
      "content": "Verify Azure AD Connect Health",
      "pos": [
        1725,
        1755
      ]
    },
    {
      "content": "After signing in, PowerShell will continue.",
      "pos": [
        1829,
        1872
      ]
    },
    {
      "content": "Once it completes you can close PowerShell and the configuration is complete.",
      "pos": [
        1873,
        1950
      ]
    },
    {
      "content": "At this point, the services should be started automatically and the agent will be now monitoring and gathering data.",
      "pos": [
        1952,
        2068
      ]
    },
    {
      "content": "Be aware that you will see warnings in the PowerShell window if you have not met all of the pre-requisites that were outlined in the previous sections.",
      "pos": [
        2070,
        2221
      ]
    },
    {
      "content": "Be sure to complete the requirements <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](active-directory-aadconnect-health.md#requirements)</ept> prior to installing the agent.",
      "pos": [
        2222,
        2348
      ]
    },
    {
      "content": "The following screenshot below is an example of these errors.",
      "pos": [
        2349,
        2410
      ]
    },
    {
      "content": "Verify Azure AD Connect Health",
      "pos": [
        2414,
        2444
      ]
    },
    {
      "content": "To verify the agent has been installed, open services and look for the following.",
      "pos": [
        2517,
        2598
      ]
    },
    {
      "content": "These services should be running if you completed the configuration.",
      "pos": [
        2599,
        2667
      ]
    },
    {
      "content": "Otherwise, they will not start until the configuration is complete.",
      "pos": [
        2668,
        2735
      ]
    },
    {
      "content": "Azure AD Connect Health AD FS Diagnostics Service",
      "pos": [
        2739,
        2788
      ]
    },
    {
      "content": "Azure AD Connect Health AD FS Insights Service",
      "pos": [
        2791,
        2837
      ]
    },
    {
      "content": "Azure AD Connect Health AD FS Monitoring Service",
      "pos": [
        2840,
        2888
      ]
    },
    {
      "content": "Verify Azure AD Connect Health",
      "pos": [
        2892,
        2922
      ]
    },
    {
      "content": "Agent installation on Windows Server 2008 R2 Servers",
      "pos": [
        3000,
        3052
      ]
    },
    {
      "content": "For Windows Server 2008 R2 servers do the following:",
      "pos": [
        3054,
        3106
      ]
    },
    {
      "content": "Ensure that the server is running at Service Pack 1 or higher.",
      "pos": [
        3111,
        3173
      ]
    },
    {
      "content": "Turn off IE ESC for agent installation:",
      "pos": [
        3177,
        3216
      ]
    },
    {
      "content": "Install Windows PowerShell 4.0 on each of the servers prior to installing the AD Health agent.",
      "pos": [
        3220,
        3314
      ]
    },
    {
      "content": "To install Windows PowerShell 4.0:",
      "pos": [
        3316,
        3350
      ]
    },
    {
      "pos": [
        3354,
        3510
      ],
      "content": "Install <bpt id=\"p1\">[</bpt>Microsoft .NET Framework 4.5<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=40779)</ept> using the following link to download the offline installer."
    },
    {
      "content": "Install PowerShell ISE (From Windows Features)",
      "pos": [
        3514,
        3560
      ]
    },
    {
      "pos": [
        3564,
        3669
      ],
      "content": "Install the <bpt id=\"p1\">[</bpt>Windows Management Framework 4.0.<ept id=\"p1\">](https://www.microsoft.com/download/details.aspx?id=40855)</ept>"
    },
    {
      "content": "Install Internet Explorer version 10 or above on the server.",
      "pos": [
        3673,
        3733
      ]
    },
    {
      "content": "This is required by the Health Service to authenticate you using your Azure Admin credentials.",
      "pos": [
        3734,
        3828
      ]
    },
    {
      "pos": [
        3832,
        4080
      ],
      "content": "For additional information on installing Windows PowerShell 4.0 on Windows Server 2008 R2 see the wiki article <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://social.technet.microsoft.com/wiki/contents/articles/20623.step-by-step-upgrading-the-powershell-version-4-on-2008-r2.aspx)</ept>."
    },
    {
      "content": "Enable Auditing for AD FS",
      "pos": [
        4086,
        4111
      ]
    },
    {
      "content": "In order for the Usage Analytics feature to gather and analyze data, the Azure AD Connect Health agent needs the information in the AD FS Audit Logs.",
      "pos": [
        4113,
        4262
      ]
    },
    {
      "content": "These logs are not enabled by default.",
      "pos": [
        4263,
        4301
      ]
    },
    {
      "content": "This only applies to AD FS federation servers.",
      "pos": [
        4302,
        4348
      ]
    },
    {
      "content": "You do not need to enable auditing on AD FS Proxy servers or Web Application Proxy servers.",
      "pos": [
        4349,
        4440
      ]
    },
    {
      "content": "Use the following procedures to enable AD FS auditing and to locate the AD FS audit logs.",
      "pos": [
        4441,
        4530
      ]
    },
    {
      "content": "To enable auditing for AD FS 2.0",
      "pos": [
        4537,
        4569
      ]
    },
    {
      "pos": [
        4574,
        4690
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept>, point to <bpt id=\"p2\">**</bpt>Programs<ept id=\"p2\">**</ept>, point to <bpt id=\"p3\">**</bpt>Administrative Tools<ept id=\"p3\">**</ept>, and then click <bpt id=\"p4\">**</bpt>Local Security Policy<ept id=\"p4\">**</ept>."
    },
    {
      "pos": [
        4694,
        4825
      ],
      "content": "Navigate to the <bpt id=\"p1\">**</bpt>Security Settings\\Local Policies\\User Rights Management<ept id=\"p1\">**</ept> folder, and then double-click Generate security audits."
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Local Security Setting<ept id=\"p1\">**</ept> tab, verify that the AD FS 2.0 service account is listed.",
      "pos": [
        4829,
        4920
      ]
    },
    {
      "content": "If it is not present, click <bpt id=\"p1\">**</bpt>Add User or Group<ept id=\"p1\">**</ept> and add it to the list, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.",
      "pos": [
        4921,
        5017
      ]
    },
    {
      "pos": [
        5021,
        5216
      ],
      "content": "Open a command prompt with elevated privileges and run the following command to enable auditing.<ph id=\"ph1\">&lt;code&gt;</ph><ph id=\"ph2\">auditpol.exe /set /subcategory:\"Application Generated\" /failure:enable /success:enable</ph><ph id=\"ph3\">&lt;/code&gt;</ph>"
    },
    {
      "content": "Close Local Security Policy, and then open the Management snap-in.",
      "pos": [
        5220,
        5286
      ]
    },
    {
      "content": "To open the Management snap-in, click <bpt id=\"p1\">**</bpt>Start<ept id=\"p1\">**</ept>, point to <bpt id=\"p2\">**</bpt>Programs<ept id=\"p2\">**</ept>, point to <bpt id=\"p3\">**</bpt>Administrative Tools<ept id=\"p3\">**</ept>, and then click AD FS 2.0 Management.",
      "pos": [
        5288,
        5431
      ]
    },
    {
      "content": "In the Actions pane, click Edit Federation Service Properties.",
      "pos": [
        5435,
        5497
      ]
    },
    {
      "pos": [
        5501,
        5579
      ],
      "content": "In the <bpt id=\"p1\">**</bpt>Federation Service Properties<ept id=\"p1\">**</ept> dialog box, click the <bpt id=\"p2\">**</bpt>Events<ept id=\"p2\">**</ept> tab."
    },
    {
      "pos": [
        5583,
        5648
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Success audits<ept id=\"p1\">**</ept> and <bpt id=\"p2\">**</bpt>Failure audits<ept id=\"p2\">**</ept> check boxes."
    },
    {
      "pos": [
        5652,
        5665
      ],
      "content": "Click <bpt id=\"p1\">**</bpt>OK<ept id=\"p1\">**</ept>."
    },
    {
      "content": "To enable auditing for AD FS on Windows Server 2012 R2",
      "pos": [
        5672,
        5726
      ]
    },
    {
      "pos": [
        5731,
        5905
      ],
      "content": "Open <bpt id=\"p1\">**</bpt>Local Security Policy<ept id=\"p1\">**</ept> by opening <bpt id=\"p2\">**</bpt>Server Manager<ept id=\"p2\">**</ept> on the Start screen, or Server Manager in the taskbar on the desktop, then click <bpt id=\"p3\">**</bpt>Tools/Local Security Policy<ept id=\"p3\">**</ept>."
    },
    {
      "pos": [
        5909,
        6044
      ],
      "content": "Navigate to the <bpt id=\"p1\">**</bpt>Security Settings\\Local Policies\\User Rights Assignment<ept id=\"p1\">**</ept> folder, and then double-click <bpt id=\"p2\">**</bpt>Generate security audits<ept id=\"p2\">**</ept>."
    },
    {
      "content": "On the <bpt id=\"p1\">**</bpt>Local Security Setting<ept id=\"p1\">**</ept> tab, verify that the AD FS service account is listed.",
      "pos": [
        6048,
        6135
      ]
    },
    {
      "content": "If it is not present, click <bpt id=\"p1\">**</bpt>Add User or Group<ept id=\"p1\">**</ept> and add it to the list, and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>.",
      "pos": [
        6136,
        6232
      ]
    },
    {
      "pos": [
        6236,
        6433
      ],
      "content": "Open a command prompt with elevated privileges and run the following command to enable auditing: <ph id=\"ph1\">&lt;code&gt;</ph><ph id=\"ph2\">auditpol.exe /set /subcategory:\"Application Generated\" /failure:enable /success:enable.</ph><ph id=\"ph3\">&lt;/code&gt;</ph>"
    },
    {
      "pos": [
        6437,
        6584
      ],
      "content": "Close <bpt id=\"p1\">**</bpt>Local Security Policy<ept id=\"p1\">**</ept>, and then open the <bpt id=\"p2\">**</bpt>AD FS Management<ept id=\"p2\">**</ept> snap-in (in Server Manager, click Tools, and then select AD FS Management)."
    },
    {
      "pos": [
        6588,
        6654
      ],
      "content": "In the Actions pane, click <bpt id=\"p1\">**</bpt>Edit Federation Service Properties<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6658,
        6732
      ],
      "content": "In the Federation Service Properties dialog box, click the <bpt id=\"p1\">**</bpt>Events<ept id=\"p1\">**</ept> tab."
    },
    {
      "pos": [
        6736,
        6819
      ],
      "content": "Select the <bpt id=\"p1\">**</bpt>Success audits and Failure audits<ept id=\"p1\">**</ept> check boxes and then click <bpt id=\"p2\">**</bpt>OK<ept id=\"p2\">**</ept>."
    },
    {
      "content": "To locate the AD FS audit logs",
      "pos": [
        6831,
        6861
      ]
    },
    {
      "pos": [
        6867,
        6889
      ],
      "content": "Open <bpt id=\"p1\">**</bpt>Event Viewer<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6893,
        6936
      ],
      "content": "Go to Windows Logs and select <bpt id=\"p1\">**</bpt>Security<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6940,
        6984
      ],
      "content": "On the right, click <bpt id=\"p1\">**</bpt>Filter Current Logs<ept id=\"p1\">**</ept>."
    },
    {
      "pos": [
        6988,
        7034
      ],
      "content": "Under Event Source, select <bpt id=\"p1\">**</bpt>AD FS Auditing<ept id=\"p1\">**</ept>."
    },
    {
      "content": "AD FS audit logs",
      "pos": [
        7038,
        7054
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.WARNING]</ph> If you have a group policy that is disabling AD FS auditing then the Azure AD Connect Health Agent will not be able to collect information.",
      "pos": [
        7130,
        7285
      ]
    },
    {
      "content": "Ensure that you don’t have a group policy that may be disabling auditing.",
      "pos": [
        7286,
        7359
      ]
    },
    {
      "content": "Installing the Azure AD Connect Health agent for sync",
      "pos": [
        7418,
        7471
      ]
    },
    {
      "content": "The Azure AD Connect Health agent for sync is installed automatically in the latest build of Azure AD Connect.",
      "pos": [
        7472,
        7582
      ]
    },
    {
      "content": "To use Azure AD Connect for sync you will need to download the latest version of Azure AD Connect and install it.",
      "pos": [
        7584,
        7697
      ]
    },
    {
      "content": "You can download the latest version <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](http://www.microsoft.com/download/details.aspx?id=47594)</ept>.",
      "pos": [
        7699,
        7799
      ]
    },
    {
      "content": "To verify the agent has been installed, open services and look for the following.",
      "pos": [
        7801,
        7882
      ]
    },
    {
      "content": "These services should be running if you completed the configuration.",
      "pos": [
        7883,
        7951
      ]
    },
    {
      "content": "Otherwise, they will not start until the configuration is complete.",
      "pos": [
        7952,
        8019
      ]
    },
    {
      "content": "Azure AD Connect Health AadSync Insights Service",
      "pos": [
        8023,
        8071
      ]
    },
    {
      "content": "Azure AD Connect Health AadSync Monitoring Service",
      "pos": [
        8074,
        8124
      ]
    },
    {
      "content": "Verify Azure AD Connect Health for Sync",
      "pos": [
        8129,
        8168
      ]
    },
    {
      "content": "[Azure.NOTE] Remember that using Azure AD Connect Health requires Azure AD Premium.",
      "pos": [
        8234,
        8317
      ]
    },
    {
      "content": "If you do not have Azure AD Premium you will not be able to complete the configuration in the Azure portal.",
      "pos": [
        8319,
        8426
      ]
    },
    {
      "content": "For more information see the requirements <bpt id=\"p1\">[</bpt>here<ept id=\"p1\">](active-directory-aadconnect-health.md#requirements)</ept>.",
      "pos": [
        8428,
        8529
      ]
    },
    {
      "content": "Configure Azure AD Connect Health Agents to use HTTP Proxy",
      "pos": [
        8538,
        8596
      ]
    },
    {
      "content": "You can configure Azure AD Connect Health Agents to work with an HTTP Proxy.",
      "pos": [
        8597,
        8673
      ]
    },
    {
      "content": "Using “Netsh WinHttp set ProxyServerAddress” will not work as the agent uses System.Net to make web requests instead of Microsoft Windows HTTP Services.",
      "pos": [
        8691,
        8843
      ]
    },
    {
      "content": "The configured Http Proxy address will be used to pass-through encrypted Https messages.",
      "pos": [
        8846,
        8934
      ]
    },
    {
      "content": "Authenticated proxies (using HTTPBasic) are not supported.",
      "pos": [
        8937,
        8995
      ]
    },
    {
      "content": "Change Health Agent Proxy Configuration",
      "pos": [
        9001,
        9040
      ]
    },
    {
      "content": "You have the following options to configure Azure AD Connect Health Agent to use an HTTP Proxy.",
      "pos": [
        9041,
        9136
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> You must restart all Azure AD Connect Health Agent services for the proxy settings to be updated.",
      "pos": [
        9139,
        9249
      ]
    },
    {
      "content": "Run the following command:",
      "pos": [
        9250,
        9276
      ]
    },
    {
      "content": "Restart-Service AdHealth*",
      "pos": [
        9285,
        9310
      ]
    },
    {
      "content": "Import existing proxy Settings",
      "pos": [
        9317,
        9347
      ]
    },
    {
      "content": "Import from Internet Explorer",
      "pos": [
        9355,
        9384
      ]
    },
    {
      "content": "You can import your Internet Explorer HTTP proxy settings and use them for Azure AD Connect Health Agents by executing the following PowerShell command on each server running the Health Agent.",
      "pos": [
        9385,
        9577
      ]
    },
    {
      "content": "Import from WinHTTP",
      "pos": [
        9656,
        9675
      ]
    },
    {
      "content": "You can import you WinHTTP proxy settings by executing the following PowerShell command on each server running the Health Agent.",
      "pos": [
        9676,
        9804
      ]
    },
    {
      "content": "Specify Proxy addresses manually",
      "pos": [
        9873,
        9905
      ]
    },
    {
      "content": "You can specify a proxy server manually by executing the following PowerShell command on each server running the Health Agent.",
      "pos": [
        9906,
        10032
      ]
    },
    {
      "pos": [
        10109,
        10194
      ],
      "content": "Example: <bpt id=\"p1\">*</bpt>Set-AzureAdConnectHealthProxySettings -HttpsProxyAddress myproxyserver:443<ept id=\"p1\">*</ept>"
    },
    {
      "content": "\"address\" can be a DNS resolvable server name or an IPv4 address",
      "pos": [
        10198,
        10262
      ]
    },
    {
      "content": "\"port\" can be omitted.",
      "pos": [
        10265,
        10287
      ]
    },
    {
      "content": "If omitted then 443 is chosen as default port.",
      "pos": [
        10288,
        10334
      ]
    },
    {
      "content": "Clear existing proxy configuration",
      "pos": [
        10341,
        10375
      ]
    },
    {
      "content": "You can clear the existing proxy configuration by running the following command.",
      "pos": [
        10376,
        10456
      ]
    },
    {
      "content": "Read current proxy settings",
      "pos": [
        10515,
        10542
      ]
    },
    {
      "content": "You can use the following command to read the currently configured proxy settings.",
      "pos": [
        10543,
        10625
      ]
    },
    {
      "content": "Related links",
      "pos": [
        10727,
        10740
      ]
    },
    {
      "content": "Azure AD Connect Health",
      "pos": [
        10745,
        10768
      ]
    },
    {
      "content": "Azure AD Connect Health Operations",
      "pos": [
        10812,
        10846
      ]
    },
    {
      "content": "Using Azure AD Connect Health with AD FS",
      "pos": [
        10901,
        10941
      ]
    },
    {
      "content": "Using Azure AD Connect Health for sync",
      "pos": [
        10990,
        11028
      ]
    },
    {
      "content": "Azure AD Connect Health FAQ",
      "pos": [
        11077,
        11104
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Azure AD Connect Health Agent installation | Microsoft Azure\"\n    description=\"This is the Azure AD Connect Health page that describes the agent installation for AD FS and Sync.\"\n    services=\"active-directory\"\n    documentationCenter=\"\"\n    authors=\"billmath\"\n    manager=\"stevenpo\"\n    editor=\"curtand\"/>\n\n<tags\n    ms.service=\"active-directory\"\n    ms.workload=\"identity\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"na\"\n    ms.topic=\"article\"\n    ms.date=\"10/15/2015\"\n    ms.author=\"billmath\"/>\n\n\n\n\n\n\n# Azure AD Connect Health Agent Installation \n\nThis document will walk you through installing and configuring the Azure AD Connect Health Agent for AD FS and sync.\n\n>[AZURE.NOTE]Remember that before you see any AD FS data in your instance of Azure AD Connect Health, you will need to install the Azure AD Connect Health Agent on your targeted servers.  Be sure to complete the requirements [here](active-directory-aadconnect-health.md#requirements) prior to installing the agent.  You can download the agent [here](http://go.microsoft.com/fwlink/?LinkID=518973).\n\n\n## Installing the  Azure AD Connect Health Agent for AD FS\nTo start the agent installation, double-click on the .exe file that you downloaded. On the first screen, click Install.\n\n![Verify Azure AD Connect Health](./media/active-directory-aadconnect-health-requirements/install1.png)\n\nOnce the installation is finished, click Configure Now.\n\n![Verify Azure AD Connect Health](./media/active-directory-aadconnect-health-requirements/install2.png)\n\nThis will launch a command prompt followed by some PowerShell that will execute Register-AzureADConnectHealthADFSAgent. You will be prompted to sign in to Azure. Go ahead and sign in.\n\n![Verify Azure AD Connect Health](./media/active-directory-aadconnect-health-requirements/install3.png)\n\n\nAfter signing in, PowerShell will continue. Once it completes you can close PowerShell and the configuration is complete.\n\nAt this point, the services should be started automatically and the agent will be now monitoring and gathering data.  Be aware that you will see warnings in the PowerShell window if you have not met all of the pre-requisites that were outlined in the previous sections. Be sure to complete the requirements [here](active-directory-aadconnect-health.md#requirements) prior to installing the agent. The following screenshot below is an example of these errors.\n\n![Verify Azure AD Connect Health](./media/active-directory-aadconnect-health-requirements/install4.png)\n\nTo verify the agent has been installed, open services and look for the following. These services should be running if you completed the configuration. Otherwise, they will not start until the configuration is complete.\n\n- Azure AD Connect Health AD FS Diagnostics Service\n- Azure AD Connect Health AD FS Insights Service\n- Azure AD Connect Health AD FS Monitoring Service\n\n![Verify Azure AD Connect Health](./media/active-directory-aadconnect-health-requirements/install5.png)\n\n\n### Agent installation on Windows Server 2008 R2 Servers\n\nFor Windows Server 2008 R2 servers do the following:\n\n1. Ensure that the server is running at Service Pack 1 or higher.\n1. Turn off IE ESC for agent installation:\n1. Install Windows PowerShell 4.0 on each of the servers prior to installing the AD Health agent.  To install Windows PowerShell 4.0:\n - Install [Microsoft .NET Framework 4.5](https://www.microsoft.com/download/details.aspx?id=40779) using the following link to download the offline installer.\n - Install PowerShell ISE (From Windows Features)\n - Install the [Windows Management Framework 4.0.](https://www.microsoft.com/download/details.aspx?id=40855)\n - Install Internet Explorer version 10 or above on the server. This is required by the Health Service to authenticate you using your Azure Admin credentials.\n1. For additional information on installing Windows PowerShell 4.0 on Windows Server 2008 R2 see the wiki article [here](http://social.technet.microsoft.com/wiki/contents/articles/20623.step-by-step-upgrading-the-powershell-version-4-on-2008-r2.aspx).\n\n### Enable Auditing for AD FS\n\nIn order for the Usage Analytics feature to gather and analyze data, the Azure AD Connect Health agent needs the information in the AD FS Audit Logs. These logs are not enabled by default. This only applies to AD FS federation servers. You do not need to enable auditing on AD FS Proxy servers or Web Application Proxy servers. Use the following procedures to enable AD FS auditing and to locate the AD FS audit logs.\n\n#### To enable auditing for AD FS 2.0\n\n1. Click **Start**, point to **Programs**, point to **Administrative Tools**, and then click **Local Security Policy**.\n2. Navigate to the **Security Settings\\Local Policies\\User Rights Management** folder, and then double-click Generate security audits.\n3. On the **Local Security Setting** tab, verify that the AD FS 2.0 service account is listed. If it is not present, click **Add User or Group** and add it to the list, and then click **OK**.\n4. Open a command prompt with elevated privileges and run the following command to enable auditing.<code>auditpol.exe /set /subcategory:\"Application Generated\" /failure:enable /success:enable</code>\n5. Close Local Security Policy, and then open the Management snap-in.  To open the Management snap-in, click **Start**, point to **Programs**, point to **Administrative Tools**, and then click AD FS 2.0 Management.\n6. In the Actions pane, click Edit Federation Service Properties.\n7. In the **Federation Service Properties** dialog box, click the **Events** tab.\n8. Select the **Success audits** and **Failure audits** check boxes.\n9. Click **OK**.\n\n#### To enable auditing for AD FS on Windows Server 2012 R2\n\n1. Open **Local Security Policy** by opening **Server Manager** on the Start screen, or Server Manager in the taskbar on the desktop, then click **Tools/Local Security Policy**.\n2. Navigate to the **Security Settings\\Local Policies\\User Rights Assignment** folder, and then double-click **Generate security audits**.\n3. On the **Local Security Setting** tab, verify that the AD FS service account is listed. If it is not present, click **Add User or Group** and add it to the list, and then click **OK**.\n4. Open a command prompt with elevated privileges and run the following command to enable auditing: <code>auditpol.exe /set /subcategory:\"Application Generated\" /failure:enable /success:enable.</code>\n5. Close **Local Security Policy**, and then open the **AD FS Management** snap-in (in Server Manager, click Tools, and then select AD FS Management).\n6. In the Actions pane, click **Edit Federation Service Properties**.\n7. In the Federation Service Properties dialog box, click the **Events** tab.\n8. Select the **Success audits and Failure audits** check boxes and then click **OK**.\n\n\n\n\n\n\n#### To locate the AD FS audit logs\n\n\n1. Open **Event Viewer**.\n2. Go to Windows Logs and select **Security**.\n3. On the right, click **Filter Current Logs**.\n4. Under Event Source, select **AD FS Auditing**.\n\n![AD FS audit logs](./media/active-directory-aadconnect-health-requirements/adfsaudit.png)\n\n> [AZURE.WARNING] If you have a group policy that is disabling AD FS auditing then the Azure AD Connect Health Agent will not be able to collect information. Ensure that you don’t have a group policy that may be disabling auditing.\n\n[//]: # (Start of Agent Proxy Configuration Section)\n\n## Installing the Azure AD Connect Health agent for sync\nThe Azure AD Connect Health agent for sync is installed automatically in the latest build of Azure AD Connect.  To use Azure AD Connect for sync you will need to download the latest version of Azure AD Connect and install it.  You can download the latest version [here](http://www.microsoft.com/download/details.aspx?id=47594).\n\nTo verify the agent has been installed, open services and look for the following. These services should be running if you completed the configuration. Otherwise, they will not start until the configuration is complete.\n\n- Azure AD Connect Health AadSync Insights Service\n- Azure AD Connect Health AadSync Monitoring Service\n \n![Verify Azure AD Connect Health for Sync](./media/active-directory-aadconnect-health-sync/services.png)\n\n>[Azure.NOTE] Remember that using Azure AD Connect Health requires Azure AD Premium.  If you do not have Azure AD Premium you will not be able to complete the configuration in the Azure portal.  For more information see the requirements [here](active-directory-aadconnect-health.md#requirements). \n\n\n\n\n## Configure Azure AD Connect Health Agents to use HTTP Proxy\nYou can configure Azure AD Connect Health Agents to work with an HTTP Proxy.\n\n>[AZURE.NOTE]\n- Using “Netsh WinHttp set ProxyServerAddress” will not work as the agent uses System.Net to make web requests instead of Microsoft Windows HTTP Services.\n- The configured Http Proxy address will be used to pass-through encrypted Https messages.\n- Authenticated proxies (using HTTPBasic) are not supported.\n\n### Change Health Agent Proxy Configuration\nYou have the following options to configure Azure AD Connect Health Agent to use an HTTP Proxy.\n\n>[AZURE.NOTE] You must restart all Azure AD Connect Health Agent services for the proxy settings to be updated. Run the following command:<br>\n    Restart-Service AdHealth*\n\n#### Import existing proxy Settings\n\n##### Import from Internet Explorer\nYou can import your Internet Explorer HTTP proxy settings and use them for Azure AD Connect Health Agents by executing the following PowerShell command on each server running the Health Agent.\n\n    Set-AzureAdConnectHealthProxySettings -ImportFromInternetSettings\n\n##### Import from WinHTTP\nYou can import you WinHTTP proxy settings by executing the following PowerShell command on each server running the Health Agent.\n\n    Set-AzureAdConnectHealthProxySettings -ImportFromWinHttp\n\n#### Specify Proxy addresses manually\nYou can specify a proxy server manually by executing the following PowerShell command on each server running the Health Agent.\n\n    Set-AzureAdConnectHealthProxySettings -HttpsProxyAddress address:port\n\nExample: *Set-AzureAdConnectHealthProxySettings -HttpsProxyAddress myproxyserver:443*\n\n- \"address\" can be a DNS resolvable server name or an IPv4 address\n- \"port\" can be omitted. If omitted then 443 is chosen as default port.\n\n#### Clear existing proxy configuration\nYou can clear the existing proxy configuration by running the following command.\n\n    Set-AzureAdConnectHealthProxySettings -NoProxy\n\n\n### Read current proxy settings\nYou can use the following command to read the currently configured proxy settings.\n\n    Get-AzureAdConnectHealthProxySettings\n\n\n[//]: # (End of Agent Proxy Configuration Section)\n\n\n## Related links\n\n* [Azure AD Connect Health](active-directory-aadconnect-health.md)\n* [Azure AD Connect Health Operations](active-directory-aadconnect-health-operations.md)\n* [Using Azure AD Connect Health with AD FS](active-directory-aadconnect-health-adfs.md)\n* [Using Azure AD Connect Health for sync](active-directory-aadconnect-health-sync.md)\n* [Azure AD Connect Health FAQ](active-directory-aadconnect-health-faq.md)\n\n\n"
}