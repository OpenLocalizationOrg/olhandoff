{"nodes":[{"content":"This is a hub topic covering the full developer picture of how enterprise data protection (EDP) relates to files, buffers, clipboard, networking, background tasks, and data protection under lock.","pos":[36,231]},{"content":"Enterprise data protection (EDP)","pos":[360,392]},{"content":"Enterprise data protection (EDP)","pos":[401,433]},{"pos":[435,555],"content":"<bpt id=\"p1\">__</bpt>Note<ept id=\"p1\">__</ept> Enterprise data protection (EDP) policy cannot be applied on Windows 10, Version 1511 (build 10586) or earlier."},{"content":"This is a hub topic covering the full developer picture of how enterprise data protection (EDP) relates to files, buffers, clipboard, networking, background tasks, and data protection under lock.","pos":[557,752]},{"pos":[754,944],"content":"For more info about EDP from the point of view of end-users and administrators, see <bpt id=\"p1\">[</bpt>Enterprise data protection (EDP) overview<ept id=\"p1\">](https://technet.microsoft.com/library/dn985838(v=vs.85).aspx)</ept>."},{"content":"What is EDP?","pos":[949,961]},{"content":"EDP is a set of features on desktops, laptops, tablets, and phones for Mobile Device Management (MDM).","pos":[963,1065]},{"content":"EDP gives an enterprise greater control over how its data (enterprise files and data blobs) is handled on devices that the enterprise manages.","pos":[1066,1208]},{"content":"Enterprise data is tagged with encryption.","pos":[1214,1256]},{"content":"This is \"enterprise-protected data\", or just \"protected data\" for short.","pos":[1257,1329]},{"content":"Only apps that the managing enterprise explicitly allows via EDP policy can access enterprise-protected data, for example, in files.","pos":[1334,1466]},{"content":"Only apps explicitly allowed via EDP policy have enterprise Virtual Private Network (VPN) access.","pos":[1471,1568]},{"content":"App-restriction policy also determines how allowed apps should handle enterprise data.","pos":[1573,1659]},{"content":"Policy-based restrictions apply even to enterprise content exchanged via the Windows clipboard or via the Share contract.","pos":[1664,1785]},{"content":"On demand, the managing enterprise can revoke the device's access to protected content, essentially wiping the device of enterprise data while leaving personal data intact.","pos":[1790,1962]},{"content":"A channel app is an app that downloads protected data.","pos":[1967,2021]},{"content":"Examples include mail and file-synchronization apps.","pos":[2022,2074]},{"content":"EDP enhances the <bpt id=\"p1\">[</bpt>Encrypting File System (EFS)<ept id=\"p1\">](http://technet.microsoft.com/library/cc700811.aspx)</ept> and <bpt id=\"p2\">[</bpt>Windows Selective Wipe<ept id=\"p2\">](https://technet.microsoft.com/library/dn486874.aspx)</ept> to provide more security and flexibility options.","pos":[2076,2307]},{"content":"New EDP APIs let you create apps that protect and revoke access to enterprise content, work with protected file properties, and access encrypted data in its raw form.","pos":[2308,2474]},{"content":"In addition to introducing new APIs for protecting files and folders, it introduces APIs for protecting buffers and streams.","pos":[2475,2599]},{"content":"It also introduces a set of APIs that allow apps to identify and indicate the enterprise that must enforce data protection policy.","pos":[2600,2730]},{"content":"So that the managing enterprise can control access to its protected data, the app-restriction policy defines a list of apps, and restrictions on those apps.","pos":[2732,2888]},{"content":"By default, an app is unable to autonomously access protected data.","pos":[2889,2956]},{"content":"To gain access, the app must be added to a list called the allowed list, and apps on the allowed list are called allowed apps.","pos":[2957,3083]},{"content":"On a managed device, Windows can restrict and/or audit access to protected data on the clipboard or via the share contract, so that access by an app not on the allowed list is audited and/or requires user consent, or else is completely blocked.","pos":[3084,3328]},{"content":"Policy for EDP is provided to a device by the managing enterprise (this makes the device a \"managed device\").","pos":[3330,3439]},{"content":"Provisioning of policy can happen through enrollment by the user in mobile device management (MDM), through manual configuration by IT, or through another management and policy delivery mechanism such as System Center Configuration Manager (SCCM).","pos":[3440,3687]},{"content":"EDP file protection leverages Rights Management Service (RMS) keys, if provisioned, since these keys can roam across devices and therefore allow protected data to roam.","pos":[3689,3857]},{"content":"In the absence of RMS keys, these APIs will fall back to local Selective Wipe keys and limit roaming functionality.","pos":[3858,3973]},{"content":"Data that roams encrypted will be accessible on down-level Windows and on third-party devices via platform-specific RMS apps provided by Microsoft, as well as with RMS-enlightened third party apps.","pos":[3974,4171]},{"content":"In summary—data protected with the EDP APIs can be managed by the enterprise, so you can build your app in a way that helps the enterprise protect and manage its data.","pos":[4173,4340]},{"content":"In other words, you can build an enterprise-ready app.","pos":[4341,4395]},{"content":"And, helping you do just that is what the rest of this guide is about.","pos":[4396,4466]},{"content":"Set up your computer for EDP","pos":[4471,4499]},{"content":"In order to properly develop your app, and test how it will behave in the enterprise, you'll want to set up your computer or device with the right conditions.","pos":[4502,4660]},{"content":"That involves a few tasks ordinarily in the domain of IT administrators.","pos":[4661,4733]},{"content":"Have your development machine enrolled into mobile device management (MDM).","pos":[4739,4814]},{"pos":[4819,4972],"content":"Have your app added to the allowed list via the <bpt id=\"p1\">[</bpt>AppLocker configuration service provider<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/hardware/dn920019)</ept>."},{"content":"The next task is to build an app that's aware of, and can respond dynamically to, the managed identity of the enterprise it's running inside, and the protection policy in effect.","pos":[4974,5152]},{"content":"That means \"enlightening\" your app.","pos":[5153,5188]},{"content":"Apps that enlighten to follow policy are much more likely to be on the list allowed to access enterprise data.","pos":[5189,5299]},{"content":"Enterprise-enlightened apps","pos":[5304,5331]},{"content":"Once your app is on the allowed list, it can read protected data.","pos":[5334,5399]},{"content":"And, by default, any data output by your app is automatically protected by the system.","pos":[5400,5486]},{"content":"That automatic protection is because the managing enterprise must, one way or another, ensure that enterprise data stays under its own control.","pos":[5487,5630]},{"content":"But, keeping your app on such a short leash is only the default way to achieve that.","pos":[5631,5715]},{"content":"A better way is to ask the system to trust you enough to give you more power and flexibility.","pos":[5716,5809]},{"content":"And, the price of admission for that is to make your app smarter.","pos":[5810,5875]},{"content":"That means going a step further than getting on the allowed list; it means making your app—and declaring it to be—enterprise-enlightened.","pos":[5876,6013]},{"content":"Your app is enlightened if it uses the techniques we'll describe to autonomously keep enterprise data protected whether the data is at rest, in use, or in flight.","pos":[6015,6177]},{"content":"Your enlightened app recognizes enterprise data sources and enterprise data, and protects it when it arrives in your app.","pos":[6178,6299]},{"content":"Being enlightened also means being aware of, and abiding by, EDP policy whenever enterprise data leaves your app.","pos":[6300,6413]},{"content":"This includes disallowing content from going to a non-enterprise network end-point, wrapping the data in a portable encrypted form before allowing it to roam, and potentially (depending on policy settings), prompting the user before pasting enterprise data into an app not on the allowed list.","pos":[6414,6707]},{"content":"Once you've made your app enlightened, your app announces to the system that it is enlightened by declaring the restricted <bpt id=\"p1\">**</bpt>enterpriseDataPolicy<ept id=\"p1\">**</ept> capability.","pos":[6708,6867]},{"content":"For more info about working with restricted capabilities, see <bpt id=\"p1\">[</bpt>Special and restricted capabilities<ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/mt270968#special_and_restricted_capabilities)</ept>.","pos":[6868,7062]},{"content":"Ideally, all enterprise data is protected data, both at rest and in flight.","pos":[7064,7139]},{"content":"But, inevitably, there must be some brief period between enterprise data being initially generated and it being protected.","pos":[7140,7262]},{"content":"And, sometimes enterprise data can exist on an enterprise network endpoint without being encrypted.","pos":[7263,7362]},{"content":"An enlightened app is capable of autonomously protecting such data; allowed-but-not-enlightened apps will need to have protection imposed by the system.","pos":[7363,7515]},{"content":"This is because an unenlightened app always runs in enterprise mode.","pos":[7517,7585]},{"content":"The system makes sure of that.","pos":[7586,7616]},{"content":"But, an enlightened app is free to move between enterprise mode and personal mode at will and as appropriate for the kind of data the app is working with at any given time.","pos":[7617,7789]},{"content":"It's also important for an enlightened app to respect personal data, and not to tag personal data as enterprise data.","pos":[7790,7907]},{"content":"An enlightened app may concurrently handle both enterprise data and personal data, so long as these promises are kept.","pos":[7908,8026]},{"content":"The next section shows how to switch modes in code.","pos":[8027,8078]},{"content":"Confirming an identity is managed, and determining protection policy enforcement level","pos":[8083,8169]},{"content":"Your app generally gets an enterprise identity from an external resource such as a mailbox email address, or a domain that is managed, or a uri hostname.","pos":[8171,8324]},{"content":"You can call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.GetPrimaryManagedIdentityForNetworkEndpointAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn706027)</ept> to obtain the managed identity, if any, for a network endpoint hostname.","pos":[8325,8547]},{"content":"This code example illustrates the general structure for enlightened behavior, including how to determine whether an enterprise identity actually is managed, and what policy is currently in effect.","pos":[8549,8745]},{"content":"As shown, you first determine whether EDP policy is set for the enterprise's identity.","pos":[9490,9576]},{"content":"The term \"managed\" is short for \"managed by an EDP policy\".","pos":[9577,9636]},{"content":"When EDP policy is set for a specific identity, <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.IsIdentityManaged<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705171)</ept> returns true for that identity.","pos":[9637,9822]},{"content":"This is your cue to use EDP APIs with that identity.","pos":[9823,9875]},{"content":"Although the file and buffer APIs are somewhat exceptional in that they will function as expected even for an unmanaged identity, that scenario doesn't make sense.","pos":[9876,10039]},{"content":"If a device is managed, then it is managed for a enterprise identity.","pos":[10040,10109]},{"content":"If an identity is not managed, then protecting data to that identity is meaningless.","pos":[10110,10194]},{"content":"The next step is to determine and implement the enforcement level for the policy.","pos":[10196,10277]},{"content":"To determine the enforcement level for the policy, call the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>GetEnforcementLevel<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/mt608406)</ept> method.","pos":[10278,10429]},{"content":"When an enterprise policy is enforced on the identity, your enlightened app must help the system with policy enforcement by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705170)</ept> APIs during UI activities or network accesses to ensure that the system tags data transfers with this identity when necessary.","pos":[10430,10776]},{"content":"More info about how to interpret the enforcement level and put it into practice is contained in this guide.","pos":[10777,10884]},{"content":"The code example also shows how to enter enterprise mode, and return to personal mode, by setting the value of <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.Identity<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705785)</ept> to the enterprise identity, or the empty string, respectively.","pos":[10885,11155]},{"content":"Again, note that entering and exiting enterprise mode only makes sense with a managed identity.","pos":[11156,11251]},{"content":"EDP features at a glance","pos":[11256,11280]},{"content":"File and buffer protection.","pos":[11285,11312]},{"content":"Your app can protect, containerize and wipe data associated with an enterprise identity.","pos":[11320,11408]},{"content":"Key-management is handled by Windows.","pos":[11413,11450]},{"content":"Windows uses the enterprise’s RMS keys when they are available to the device; otherwise, Windows falls back to local Selective Wipe protection.","pos":[11451,11594]},{"content":"Device policy management.","pos":[11598,11623]},{"content":"Your app can query the identity (enterprise or organization) that is managing the device.","pos":[11631,11720]},{"content":"Your app can protect users from inadvertent data disclosure by associating an identity with the data in question.","pos":[11725,11838]},{"content":"Your app can protect enterprise resources over the network by checking for enterprise-owned network endpoint connections (servers, IP ranges), and associating the data to a managed (that is, MDM-enrolled) identity.","pos":[11843,12057]},{"content":"The EDP APIs only work with managed identities that have an EDP policy defined on the device.","pos":[12062,12155]},{"content":"If an identity is not managed, then, the APIs indicate that to the application, when necessary.","pos":[12156,12251]},{"content":"Here's a list of links to topics that drill into EDP APIs and scenarios specific to these particular feature areas.","pos":[12253,12368]},{"content":"Files","pos":[12373,12378]},{"pos":[12380,12462],"content":"See <bpt id=\"p1\">[</bpt>Use EDP to protect files<ept id=\"p1\">](../files/protect-your-enterprise-data-with-edp.md)</ept>."},{"content":"Streams and buffers","pos":[12467,12486]},{"pos":[12488,12585],"content":"See <bpt id=\"p1\">[</bpt>Use EDP to protect streams and buffers<ept id=\"p1\">](../files/use-edp-to-protect-streams-and-buffers.md)</ept>."},{"content":"Clipboard, share, and exchanging data between apps","pos":[12590,12640]},{"pos":[12642,12786],"content":"See <bpt id=\"p1\">[</bpt>Use EDP to protect enterprise data transferred between apps<ept id=\"p1\">](../app-to-app/use-edp-to-protect-enterprise-data-transferred-between-apps.md)</ept>."},{"content":"Networking","pos":[12791,12801]},{"pos":[12803,12919],"content":"See <bpt id=\"p1\">[</bpt>Tagging network connections with EDP identity<ept id=\"p1\">](../networking/tagging_network_connections_with_edp_identity.md)</ept>."},{"content":"Data protection under lock (DPL), and background tasks","pos":[12924,12978]},{"content":"An organization can choose to administer a secure \"data protection under lock\" (DPL) policy, where encryption keys required to access protected resources are temporarily removed from device memory when the device is locked.","pos":[12980,13203]},{"content":"To prepare your app for this eventuality, see the <bpt id=\"p1\">[</bpt>Handle device lock events and avoid leaving unprotected content in memory<ept id=\"p1\">](#handle_lock_events)</ept> section in this topic.","pos":[13204,13373]},{"content":"Also, if your app has a background task that needs to protect files, see <bpt id=\"p1\">[</bpt>Protect enterprise data in a new file (for a background task)<ept id=\"p1\">](../files/protect-your-enterprise-data-with-edp.md#protect_data_new_file_bg)</ept>.","pos":[13374,13587]},{"content":"UI-policy enforcement","pos":[13592,13613]},{"content":"In this section, we'll take the example of an enlightened mail app, which is currently displaying an enterprise mailbox among a set of mailboxes that include both enterprise and personal mailboxes belonging to the user.","pos":[13616,13835]},{"content":"To ensure that there are no data leaks from the enterprise data in the enterprise mailbox, the app calls <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.TryApplyProcessUIPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705791)</ept> to make sure that the operating system knows about the current context of the app, whether enterprise or personal.","pos":[13836,14167]},{"content":"The API returns false if the identity is not being managed by an enterprise policy.","pos":[14168,14251]},{"content":"Handle device lock events and avoid leaving unprotected content in memory","pos":[15107,15180]},{"content":"In this scenario, we'll take the example of an enlightened mail app that's designed to handle both enterprise mail and personal mail.","pos":[15183,15316]},{"content":"When the app is running in an organization that has chosen to administer a secure \"data protection under lock\" (DPL) policy, the app must be sure to remove all sensitive data from memory while the device is locked.","pos":[15317,15531]},{"content":"To do this, it registers for the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.ProtectedAccessSuspending<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705787)</ept> and <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>ProtectionPolicyManager.ProtectedAccessResumed<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn705786)</ept> events so that it's notified whenever the device is locked and unlocked (in case DPL is in effect).","pos":[15532,15893]},{"content":"<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectedAccessSuspending<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705787)</ept> is raised before data protection keys provisioned on the device are temporarily removed.","pos":[15895,16073]},{"content":"The reason these keys are removed when the device is locked is to ensure that there can't be unauthorized access to encrypted data while the device is locked and also possibly not in possession of its owner.","pos":[16074,16281]},{"content":"<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectedAccessResumed<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705786)</ept> is raised once the keys are available again upon device unlock.","pos":[16282,16432]},{"content":"By handing these two events, the app can ensure that it protects any sensitive content in memory with <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DataProtectionManager<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn706017)</ept>.","pos":[16434,16622]},{"content":"It should also close any file streams open on its protected files to ensure that the system does not cache any sensitive data in memory.","pos":[16623,16759]},{"content":"You can do this in one of several ways.","pos":[16760,16799]},{"content":"To close a file stream returned from an Open method of a <bpt id=\"p1\">**</bpt>StorageFile<ept id=\"p1\">**</ept>, you can call the <bpt id=\"p2\">**</bpt>Dispose<ept id=\"p2\">**</ept> method on the stream.","pos":[16800,16924]},{"content":"You can scope the use of stream with a using statement (C<ph id=\"ph1\">\\#</ph> or VB).","pos":[16925,16992]},{"content":"Or, you can wrap a <bpt id=\"p1\">**</bpt>DataReader<ept id=\"p1\">**</ept> or a <bpt id=\"p2\">**</bpt>DataWriter<ept id=\"p2\">**</ept> object around the stream and use the <bpt id=\"p3\">**</bpt>Dispose<ept id=\"p3\">**</ept> method or using statement with that object.","pos":[16993,17139]},{"content":"Note","pos":[17143,17147]},{"content":"In an environment without a DPL policy configured, the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectedAccessResumed<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705786)</ept> event is raised, but not the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>ProtectedAccessSuspending<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn705787)</ept> event.","pos":[17152,17419]},{"content":"Be aware of this in your code, and be careful not to assume that the events always come in pairs on every system, nor that you can always use the events to determine the locked/unlocked state of the device.","pos":[17420,17626]},{"content":"You can see that in the code example here that we are careful not to assume anything about the protected state of the currently displayed email nor about the open state of the database file stream.","pos":[17627,17824]},{"pos":[17826,18045],"content":"Also, be aware that when resuming from lock on a device without a DPL policy configured, <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectedAccessResumedEventArgs.Identities<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705772)</ept> is an empty collection."},{"content":"In the interest of brevity, this code example is slightly simplified, and it focuses on dealing with enterprise mail.","pos":[18047,18164]},{"content":"In a real app, personal mails would be written to a different, unprotected, mail database file, and you wouldn't protect personal emails under lock.","pos":[18165,18313]},{"content":"Register to be notified when protected content is revoked","pos":[23376,23433]},{"content":"Picture the scenario where a mail app has set up an enterprise mailbox on a user’s device.","pos":[23436,23526]},{"content":"At some point—and for one of several possible reasons—the enterprise wishes to revoke access to the enterprise-protected emails and other resources on that device.","pos":[23527,23690]},{"content":"There are several possible reasons for the revocation.","pos":[23691,23745]},{"content":"It's more likely than not that the particular enterprise policy will trigger a revocation on un-enroll, so one scenario is that the user has un-enrolled their device from the enterprise (perhaps they're gifting or selling the device, they just want to use a different one, they're moving to another job, or they're retiring).","pos":[23746,24071]},{"content":"Another scenario is that an un-enroll notification is sent by an IT administrator remotely via Mobile Device Management (MDM), perhaps if a device is reported as lost.","pos":[24072,24239]},{"content":"Whatever the specifics of the case, the enterprise sends a request to wipe all mail from the user’s device, since it's no longer needed on there.","pos":[24241,24386]},{"content":"A remote management client on a device receives the request from the enterprise’s remote management server, and calls <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.RevokeContent<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705790)</ept> to revoke the keys that are required to access content protected on that device to that enterprise identity.","pos":[24387,24715]},{"content":"If your app needs to be notified when a revoke happens, then you can register with the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.ProtectedContentRevoked<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705788)</ept> event.","pos":[24717,24922]},{"content":"When your app receives the event, it can delete any metadata associated with the enterprise mailbox, which will no longer be required.","pos":[24923,25057]},{"content":"Remote management client initiates a wipe of enterprise-protected data","pos":[25731,25801]},{"content":"A user has several enterprise files on their personal device that are protected to the enterprise identity.","pos":[25804,25911]},{"content":"The user loses their device.","pos":[25912,25940]},{"content":"When the enterprise is notified that the user has lost their device, the enterprise sends a request to wipe all sensitive data from the user’s device to prevent that data from leaking.","pos":[25941,26125]},{"content":"The remote management client on the device receives this request from the enterprise’s remote management server, and it calls <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>ProtectionPolicyManager.RevokeContent<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn705790)</ept> to revoke the keys required to access content protected to the enterprise identity.","pos":[26126,26437]}],"content":"---\nauthor: mcleblanc\nDescription: 'This is a hub topic covering the full developer picture of how enterprise data protection (EDP) relates to files, buffers, clipboard, networking, background tasks, and data protection under lock.'\nMS-HAID: 'dev\\_enterprise.edp\\_hub'\nMSHAttr: 'PreferredLib:/library/windows/apps'\nSearch.Product: eADQiWindows 10XVcnh\ntitle: 'Enterprise data protection (EDP)'\n---\n\n# Enterprise data protection (EDP)\n\n__Note__ Enterprise data protection (EDP) policy cannot be applied on Windows 10, Version 1511 (build 10586) or earlier.\n\nThis is a hub topic covering the full developer picture of how enterprise data protection (EDP) relates to files, buffers, clipboard, networking, background tasks, and data protection under lock.\n\nFor more info about EDP from the point of view of end-users and administrators, see [Enterprise data protection (EDP) overview](https://technet.microsoft.com/library/dn985838(v=vs.85).aspx).\n\n## What is EDP?\n\nEDP is a set of features on desktops, laptops, tablets, and phones for Mobile Device Management (MDM). EDP gives an enterprise greater control over how its data (enterprise files and data blobs) is handled on devices that the enterprise manages.\n\n-   Enterprise data is tagged with encryption. This is \"enterprise-protected data\", or just \"protected data\" for short.\n-   Only apps that the managing enterprise explicitly allows via EDP policy can access enterprise-protected data, for example, in files.\n-   Only apps explicitly allowed via EDP policy have enterprise Virtual Private Network (VPN) access.\n-   App-restriction policy also determines how allowed apps should handle enterprise data.\n-   Policy-based restrictions apply even to enterprise content exchanged via the Windows clipboard or via the Share contract.\n-   On demand, the managing enterprise can revoke the device's access to protected content, essentially wiping the device of enterprise data while leaving personal data intact.\n-   A channel app is an app that downloads protected data. Examples include mail and file-synchronization apps.\n\nEDP enhances the [Encrypting File System (EFS)](http://technet.microsoft.com/library/cc700811.aspx) and [Windows Selective Wipe](https://technet.microsoft.com/library/dn486874.aspx) to provide more security and flexibility options. New EDP APIs let you create apps that protect and revoke access to enterprise content, work with protected file properties, and access encrypted data in its raw form. In addition to introducing new APIs for protecting files and folders, it introduces APIs for protecting buffers and streams. It also introduces a set of APIs that allow apps to identify and indicate the enterprise that must enforce data protection policy.\n\nSo that the managing enterprise can control access to its protected data, the app-restriction policy defines a list of apps, and restrictions on those apps. By default, an app is unable to autonomously access protected data. To gain access, the app must be added to a list called the allowed list, and apps on the allowed list are called allowed apps. On a managed device, Windows can restrict and/or audit access to protected data on the clipboard or via the share contract, so that access by an app not on the allowed list is audited and/or requires user consent, or else is completely blocked.\n\nPolicy for EDP is provided to a device by the managing enterprise (this makes the device a \"managed device\"). Provisioning of policy can happen through enrollment by the user in mobile device management (MDM), through manual configuration by IT, or through another management and policy delivery mechanism such as System Center Configuration Manager (SCCM).\n\nEDP file protection leverages Rights Management Service (RMS) keys, if provisioned, since these keys can roam across devices and therefore allow protected data to roam. In the absence of RMS keys, these APIs will fall back to local Selective Wipe keys and limit roaming functionality. Data that roams encrypted will be accessible on down-level Windows and on third-party devices via platform-specific RMS apps provided by Microsoft, as well as with RMS-enlightened third party apps.\n\nIn summary—data protected with the EDP APIs can be managed by the enterprise, so you can build your app in a way that helps the enterprise protect and manage its data. In other words, you can build an enterprise-ready app. And, helping you do just that is what the rest of this guide is about.\n\n## Set up your computer for EDP\n\n\nIn order to properly develop your app, and test how it will behave in the enterprise, you'll want to set up your computer or device with the right conditions. That involves a few tasks ordinarily in the domain of IT administrators.\n\n-   Have your development machine enrolled into mobile device management (MDM).\n-   Have your app added to the allowed list via the [AppLocker configuration service provider](https://msdn.microsoft.com/library/windows/hardware/dn920019).\n\nThe next task is to build an app that's aware of, and can respond dynamically to, the managed identity of the enterprise it's running inside, and the protection policy in effect. That means \"enlightening\" your app. Apps that enlighten to follow policy are much more likely to be on the list allowed to access enterprise data.\n\n## Enterprise-enlightened apps\n\n\nOnce your app is on the allowed list, it can read protected data. And, by default, any data output by your app is automatically protected by the system. That automatic protection is because the managing enterprise must, one way or another, ensure that enterprise data stays under its own control. But, keeping your app on such a short leash is only the default way to achieve that. A better way is to ask the system to trust you enough to give you more power and flexibility. And, the price of admission for that is to make your app smarter. That means going a step further than getting on the allowed list; it means making your app—and declaring it to be—enterprise-enlightened.\n\nYour app is enlightened if it uses the techniques we'll describe to autonomously keep enterprise data protected whether the data is at rest, in use, or in flight. Your enlightened app recognizes enterprise data sources and enterprise data, and protects it when it arrives in your app. Being enlightened also means being aware of, and abiding by, EDP policy whenever enterprise data leaves your app. This includes disallowing content from going to a non-enterprise network end-point, wrapping the data in a portable encrypted form before allowing it to roam, and potentially (depending on policy settings), prompting the user before pasting enterprise data into an app not on the allowed list. Once you've made your app enlightened, your app announces to the system that it is enlightened by declaring the restricted **enterpriseDataPolicy** capability. For more info about working with restricted capabilities, see [Special and restricted capabilities](https://msdn.microsoft.com/library/windows/apps/mt270968#special_and_restricted_capabilities).\n\nIdeally, all enterprise data is protected data, both at rest and in flight. But, inevitably, there must be some brief period between enterprise data being initially generated and it being protected. And, sometimes enterprise data can exist on an enterprise network endpoint without being encrypted. An enlightened app is capable of autonomously protecting such data; allowed-but-not-enlightened apps will need to have protection imposed by the system.\n\nThis is because an unenlightened app always runs in enterprise mode. The system makes sure of that. But, an enlightened app is free to move between enterprise mode and personal mode at will and as appropriate for the kind of data the app is working with at any given time. It's also important for an enlightened app to respect personal data, and not to tag personal data as enterprise data. An enlightened app may concurrently handle both enterprise data and personal data, so long as these promises are kept. The next section shows how to switch modes in code.\n\n## Confirming an identity is managed, and determining protection policy enforcement level\n\nYour app generally gets an enterprise identity from an external resource such as a mailbox email address, or a domain that is managed, or a uri hostname. You can call [**ProtectionPolicyManager.GetPrimaryManagedIdentityForNetworkEndpointAsync**](https://msdn.microsoft.com/library/windows/apps/dn706027) to obtain the managed identity, if any, for a network endpoint hostname.\n\nThis code example illustrates the general structure for enlightened behavior, including how to determine whether an enterprise identity actually is managed, and what policy is currently in effect.\n\n```CSharp\nusing Windows.Security.EnterpriseData;\n\n...\n\nstring identity = \"contoso.com\";\n\nif (ProtectionPolicyManager.IsIdentityManaged(identity))\n{\n    EnforcementLevel enforcementLevel = ProtectionPolicyManager.GetEnforcementLevel();\n\n    // During UI activities or network access, call ProtectionPolicyManager APIs\n    // (taking the enforcement level into account) to ensure that the system\n    // tags data with the identity as appropriate.\n\n    ProtectionPolicyManager.GetForCurrentView().Identity = identity;\n    // The app is now in enterprise mode.\n\n    ProtectionPolicyManager.GetForCurrentView().Identity = string.Empty;\n    // The app is back in personal mode.\n}\nelse\n{\n    // No policy enforcement is done on this identity.\n}\n```\n\nAs shown, you first determine whether EDP policy is set for the enterprise's identity. The term \"managed\" is short for \"managed by an EDP policy\". When EDP policy is set for a specific identity, [**ProtectionPolicyManager.IsIdentityManaged**](https://msdn.microsoft.com/library/windows/apps/dn705171) returns true for that identity. This is your cue to use EDP APIs with that identity. Although the file and buffer APIs are somewhat exceptional in that they will function as expected even for an unmanaged identity, that scenario doesn't make sense. If a device is managed, then it is managed for a enterprise identity. If an identity is not managed, then protecting data to that identity is meaningless.\n\nThe next step is to determine and implement the enforcement level for the policy. To determine the enforcement level for the policy, call the [**GetEnforcementLevel**](https://msdn.microsoft.com/library/windows/apps/mt608406) method. When an enterprise policy is enforced on the identity, your enlightened app must help the system with policy enforcement by calling [**ProtectionPolicyManager**](https://msdn.microsoft.com/library/windows/apps/dn705170) APIs during UI activities or network accesses to ensure that the system tags data transfers with this identity when necessary. More info about how to interpret the enforcement level and put it into practice is contained in this guide. The code example also shows how to enter enterprise mode, and return to personal mode, by setting the value of [**ProtectionPolicyManager.Identity**](https://msdn.microsoft.com/library/windows/apps/dn705785) to the enterprise identity, or the empty string, respectively. Again, note that entering and exiting enterprise mode only makes sense with a managed identity.\n\n## EDP features at a glance\n\n\n**File and buffer protection.**\n\n-   Your app can protect, containerize and wipe data associated with an enterprise identity.\n-   Key-management is handled by Windows. Windows uses the enterprise’s RMS keys when they are available to the device; otherwise, Windows falls back to local Selective Wipe protection.\n\n**Device policy management.**\n\n-   Your app can query the identity (enterprise or organization) that is managing the device.\n-   Your app can protect users from inadvertent data disclosure by associating an identity with the data in question.\n-   Your app can protect enterprise resources over the network by checking for enterprise-owned network endpoint connections (servers, IP ranges), and associating the data to a managed (that is, MDM-enrolled) identity.\n-   The EDP APIs only work with managed identities that have an EDP policy defined on the device. If an identity is not managed, then, the APIs indicate that to the application, when necessary.\n\nHere's a list of links to topics that drill into EDP APIs and scenarios specific to these particular feature areas.\n\n## Files\n\nSee [Use EDP to protect files](../files/protect-your-enterprise-data-with-edp.md).\n\n## Streams and buffers\n\nSee [Use EDP to protect streams and buffers](../files/use-edp-to-protect-streams-and-buffers.md).\n\n## Clipboard, share, and exchanging data between apps\n\nSee [Use EDP to protect enterprise data transferred between apps](../app-to-app/use-edp-to-protect-enterprise-data-transferred-between-apps.md).\n\n## Networking\n\nSee [Tagging network connections with EDP identity](../networking/tagging_network_connections_with_edp_identity.md).\n\n## Data protection under lock (DPL), and background tasks\n\nAn organization can choose to administer a secure \"data protection under lock\" (DPL) policy, where encryption keys required to access protected resources are temporarily removed from device memory when the device is locked. To prepare your app for this eventuality, see the [Handle device lock events and avoid leaving unprotected content in memory](#handle_lock_events) section in this topic. Also, if your app has a background task that needs to protect files, see [Protect enterprise data in a new file (for a background task)](../files/protect-your-enterprise-data-with-edp.md#protect_data_new_file_bg).\n\n## UI-policy enforcement\n\n\nIn this section, we'll take the example of an enlightened mail app, which is currently displaying an enterprise mailbox among a set of mailboxes that include both enterprise and personal mailboxes belonging to the user. To ensure that there are no data leaks from the enterprise data in the enterprise mailbox, the app calls [**ProtectionPolicyManager.TryApplyProcessUIPolicy**](https://msdn.microsoft.com/library/windows/apps/dn705791) to make sure that the operating system knows about the current context of the app, whether enterprise or personal. The API returns false if the identity is not being managed by an enterprise policy.\n\n```CSharp\nusing Windows.Security.EnterpriseData;\n\n...\n\npublic class Mailbox\n{\n    public bool HasEnterpriseMail { get { /* implementation */ } }\n    public string Identity { get { /* implementation */ } }\n}\n\nprivate void SwitchMailbox(Mailbox targetMailbox)\n{\n    // Code goes here to perform setup for \"targetMailbox\".\n\n    if (targetMailbox.HasEnterpriseMail)\n    {\n        bool result = \n            ProtectionPolicyManager.TryApplyProcessUIPolicy(targetMailbox.Identity);\n\n        // Code goes here to process \"result\", which indicates whether\n        // or not policy enforcement is in place for the identity.\n    }\n    else\n    {\n        // For personal mailboxes, we clear policy enforcement (in case\n        // it is still set from when we processed an enterprise mailbox).\n        ProtectionPolicyManager.ClearProcessUIPolicy();\n    }\n}\n```\n\n## Handle device lock events and avoid leaving unprotected content in memory\n\n\nIn this scenario, we'll take the example of an enlightened mail app that's designed to handle both enterprise mail and personal mail. When the app is running in an organization that has chosen to administer a secure \"data protection under lock\" (DPL) policy, the app must be sure to remove all sensitive data from memory while the device is locked. To do this, it registers for the [**ProtectionPolicyManager.ProtectedAccessSuspending**](https://msdn.microsoft.com/library/windows/apps/dn705787) and [**ProtectionPolicyManager.ProtectedAccessResumed**](https://msdn.microsoft.com/library/windows/apps/dn705786) events so that it's notified whenever the device is locked and unlocked (in case DPL is in effect).\n\n[**ProtectedAccessSuspending**](https://msdn.microsoft.com/library/windows/apps/dn705787) is raised before data protection keys provisioned on the device are temporarily removed. The reason these keys are removed when the device is locked is to ensure that there can't be unauthorized access to encrypted data while the device is locked and also possibly not in possession of its owner. [**ProtectedAccessResumed**](https://msdn.microsoft.com/library/windows/apps/dn705786) is raised once the keys are available again upon device unlock.\n\nBy handing these two events, the app can ensure that it protects any sensitive content in memory with [**DataProtectionManager**](https://msdn.microsoft.com/library/windows/apps/dn706017). It should also close any file streams open on its protected files to ensure that the system does not cache any sensitive data in memory. You can do this in one of several ways. To close a file stream returned from an Open method of a **StorageFile**, you can call the **Dispose** method on the stream. You can scope the use of stream with a using statement (C\\# or VB). Or, you can wrap a **DataReader** or a **DataWriter** object around the stream and use the **Dispose** method or using statement with that object.\n\n**Note**  \nIn an environment without a DPL policy configured, the [**ProtectedAccessResumed**](https://msdn.microsoft.com/library/windows/apps/dn705786) event is raised, but not the [**ProtectedAccessSuspending**](https://msdn.microsoft.com/library/windows/apps/dn705787) event. Be aware of this in your code, and be careful not to assume that the events always come in pairs on every system, nor that you can always use the events to determine the locked/unlocked state of the device. You can see that in the code example here that we are careful not to assume anything about the protected state of the currently displayed email nor about the open state of the database file stream.\n\nAlso, be aware that when resuming from lock on a device without a DPL policy configured, [**ProtectedAccessResumedEventArgs.Identities**](https://msdn.microsoft.com/library/windows/apps/dn705772) is an empty collection.\n\nIn the interest of brevity, this code example is slightly simplified, and it focuses on dealing with enterprise mail. In a real app, personal mails would be written to a different, unprotected, mail database file, and you wouldn't protect personal emails under lock.\n\n```CSharp\nusing Windows.Security.Cryptography;\nusing Windows.Security.EnterpriseData;\nusing Windows.Storage;\nusing Windows.Storage.Streams;\n\n...\n\npublic class DisplayedMail\n{\n    public string Body { get; set; }\n    public IBuffer ProtectedBody { get; set; }\n    public bool IsProtected { get; set; }\n}\n\nprivate IOutputStream mailDatabaseStream = null;\nprivate string currentlyDisplayedMailIdentity = \"contoso.com\";\nprivate DisplayedMail currentlyDisplayedMail = new DisplayedMail()\n    { Body = \"Lorem ipsum dolor...\", ProtectedBody = null, IsProtected = false };\n\n// Gets the app's protected mail database file, then opens and stores a stream on it.\nprivate async void OpenMailDatabase()\n{\n    // Only attempt to open the database file stream if we know it's closed.\n    if (this.mailDatabaseStream == null)\n    {\n        StorageFolder appDataStorageFolder = ApplicationData.Current.LocalFolder;\n        StorageFile storageFile = await appDataStorageFolder.GetFileAsync(\"maildb.dat\");\n        using (IRandomAccessStream randomAccessStream =\n            await storageFile.OpenAsync(FileAccessMode.ReadWrite))\n        {\n            this.mailDatabaseStream = randomAccessStream.GetOutputStreamAt(0);\n        }\n    }\n}\n\n// Called once by the app when starting up.\nprivate void AppSetup()\n{\n    ProtectionPolicyManager.ProtectedAccessSuspending +=\n        this.ProtectionPolicyManager_ProtectedAccessSuspending;\n    ProtectionPolicyManager.ProtectedAccessResumed +=\n        this.ProtectionPolicyManager_ProtectedAccessResumed;\n    this.OpenMailDatabase();\n}\n\n// Background work called when the app receives an email.\nprivate async void AppMailReceived(string fauxEmail)\n{\n    // Only attempt to write to the database file stream if we know it's open.\n    if (this.mailDatabaseStream != null)\n    {\n        IBuffer emailAsBuffer = CryptographicBuffer.ConvertStringToBinary\n            (fauxEmail, BinaryStringEncoding.Utf8);\n        await this.mailDatabaseStream.WriteAsync(emailAsBuffer);\n        await this.mailDatabaseStream.FlushAsync();\n    }\n    else\n    {\n        // Code goes here to handle the case where the device is\n        // locked and we can't access the protected mail database.\n    }\n}\n\n// Called by ProtectionPolicyManager when the device is locked if under DPL.\nprivate async void ProtectionPolicyManager_ProtectedAccessSuspending\n    (object sender, ProtectedAccessSuspendingEventArgs e)\n{\n    if (!new System.Collections.Generic.List<string>(e.Identities).Contains\n        (this.currentlyDisplayedMailIdentity))\n    {\n        // This event is not for our identity. Another will be sent for our identity.\n        return;\n    }\n\n    // Get suspension deferral.\n    Windows.Foundation.Deferral deferral = e.GetDeferral();\n\n    // Protect the displayed mail content.\n    if (!this.currentlyDisplayedMail.IsProtected)\n    {\n        IBuffer mailBodyBuffer = CryptographicBuffer.ConvertStringToBinary\n            (this.currentlyDisplayedMail.Body, BinaryStringEncoding.Utf8);\n        BufferProtectUnprotectResult result = await DataProtectionManager.ProtectAsync\n            (mailBodyBuffer, this.currentlyDisplayedMailIdentity);\n        if (result.ProtectionInfo.Status == DataProtectionStatus.Protected)\n        {\n            // Save the protected version and clear the unprotected version.\n            this.currentlyDisplayedMail.ProtectedBody = result.Buffer;\n            this.currentlyDisplayedMail.Body = null;\n        }\n    }\n\n    // Close the mail database file stream to make sure that we have no unprotected\n    // content in memory.\n    this.mailDatabaseStream.Dispose();\n    this.mailDatabaseStream = null;\n\n    // Optionally, code goes here to use e.Deadline to determine whether we have more\n    // than 15 seconds left before the suspension deadline. If we do then process any\n    // messages queued up for sending while we are still able to access them.\n\n    // All done. Complete deferral.\n    deferral.Complete();\n}\n\n// Called by ProtectionPolicyManager when the device is unlocked.\nprivate async void ProtectionPolicyManager_ProtectedAccessResumed\n    (object sender, ProtectedAccessResumedEventArgs e)\n{\n    if (!new System.Collections.Generic.List<string>(e.Identities).Contains\n        (this.currentlyDisplayedMailIdentity))\n    {\n        // This event is not for our identity. Another will be sent for our identity.\n        return;\n    }\n\n    // Unprotect the displayed mail content.\n    if (this.currentlyDisplayedMail.IsProtected)\n    {\n        BufferProtectUnprotectResult result = await DataProtectionManager.UnprotectAsync\n            (this.currentlyDisplayedMail.ProtectedBody);\n        if (result.ProtectionInfo.Status == DataProtectionStatus.Unprotected)\n        {\n            // Restore the unprotected version.\n            this.currentlyDisplayedMail.Body = CryptographicBuffer.ConvertBinaryToString\n                (BinaryStringEncoding.Utf8, result.Buffer);\n            this.currentlyDisplayedMail.ProtectedBody = null;\n        }\n    }\n\n    // Reopen the closed mail database.\n    this.OpenMailDatabase();\n}\n```\n\n## Register to be notified when protected content is revoked\n\n\nPicture the scenario where a mail app has set up an enterprise mailbox on a user’s device. At some point—and for one of several possible reasons—the enterprise wishes to revoke access to the enterprise-protected emails and other resources on that device. There are several possible reasons for the revocation. It's more likely than not that the particular enterprise policy will trigger a revocation on un-enroll, so one scenario is that the user has un-enrolled their device from the enterprise (perhaps they're gifting or selling the device, they just want to use a different one, they're moving to another job, or they're retiring). Another scenario is that an un-enroll notification is sent by an IT administrator remotely via Mobile Device Management (MDM), perhaps if a device is reported as lost.\n\nWhatever the specifics of the case, the enterprise sends a request to wipe all mail from the user’s device, since it's no longer needed on there. A remote management client on a device receives the request from the enterprise’s remote management server, and calls [**ProtectionPolicyManager.RevokeContent**](https://msdn.microsoft.com/library/windows/apps/dn705790) to revoke the keys that are required to access content protected on that device to that enterprise identity.\n\nIf your app needs to be notified when a revoke happens, then you can register with the [**ProtectionPolicyManager.ProtectedContentRevoked**](https://msdn.microsoft.com/library/windows/apps/dn705788) event. When your app receives the event, it can delete any metadata associated with the enterprise mailbox, which will no longer be required.\n\n```CSharp\nusing Windows.Security.EnterpriseData;\n\n...\n\nprivate string mailIdentity = \"contoso.com\";\n\nvoid MailAppSetup()\n{\n    ProtectionPolicyManager.ProtectedContentRevoked += ProtectionPolicyManager_ProtectedContentRevoked;\n    // Code goes here to set up mailbox for 'mailIdentity'.\n}\n\nprivate void ProtectionPolicyManager_ProtectedContentRevoked(object sender, ProtectedContentRevokedEventArgs e)\n{\n    if (!new System.Collections.Generic.List<string>(e.Identities).Contains\n        (this.mailIdentity))\n    {\n        // This event is not for our identity.\n        return;\n    }\n\n    // Code goes here to delete any metadata associated with 'mailIdentity'.\n}\n```\n\n## Remote management client initiates a wipe of enterprise-protected data\n\n\nA user has several enterprise files on their personal device that are protected to the enterprise identity. The user loses their device. When the enterprise is notified that the user has lost their device, the enterprise sends a request to wipe all sensitive data from the user’s device to prevent that data from leaking. The remote management client on the device receives this request from the enterprise’s remote management server, and it calls [**ProtectionPolicyManager.RevokeContent**](https://msdn.microsoft.com/library/windows/apps/dn705790) to revoke the keys required to access content protected to the enterprise identity.\n\n```CSharp\nWindows.Security.EnterpriseData.ProtectionPolicyManager.RevokeContent(\"contoso.com\");\n```\n\n \n\n \n\n\n\n"}