{"nodes":[{"content":"Web authentication broker","pos":[11,36]},{"content":"This article explains how to connect your Universal Windows Platform (UWP) app to an online identity provider that uses authentication protocols like OpenID or OAuth, such as Facebook, Twitter, Flickr, Instagram, and so on.","pos":[50,273]},{"content":"Web authentication broker","pos":[346,371]},{"content":"Updated for UWP apps on Windows 10.","pos":[377,412]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept>","pos":[413,505]},{"content":"This article explains how to connect your Universal Windows Platform (UWP) app to an online identity provider that uses authentication protocols like OpenID or OAuth, such as Facebook, Twitter, Flickr, Instagram, and so on.","pos":[511,734]},{"content":"The <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AuthenticateAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br212066)</ept> method sends a request to the online identity provider and gets back an access token that describes the provider resources to which the app has access.","pos":[735,972]},{"pos":[974,1121],"content":"<bpt id=\"p1\">**</bpt>Note<ept id=\"p1\">**</ept>  For a complete, working code sample, clone the <bpt id=\"p2\">[</bpt>WebAuthenticationBroker repo on GitHub<ept id=\"p2\">](http://go.microsoft.com/fwlink/p/?LinkId=620622)</ept>."},{"content":"Register your app with your online provider","pos":[1129,1172]},{"content":"You must register your app with the online identity provider to which you want to connect.","pos":[1175,1265]},{"content":"You can find out how to register your app from the identity provider.","pos":[1266,1335]},{"content":"After registering, the online provider typically gives you an Id or secret key for your app.","pos":[1336,1428]},{"content":"Build the authentication request URI","pos":[1433,1469]},{"content":"The request URI consists of the address where you send the authentication request to your online provider appended with other required information, such as an app ID or secret, a redirect URI where the user is sent after completing authentication, and the expected response type.","pos":[1472,1751]},{"content":"You can find out from your provider what parameters are required.","pos":[1752,1817]},{"content":"The request URI is sent as the <bpt id=\"p1\">*</bpt>requestUri<ept id=\"p1\">*</ept> parameter of the <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>AuthenticateAsync<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/br212066)</ept> method.","pos":[1819,1969]},{"content":"It must be a secure address (it must start with https://)","pos":[1970,2027]},{"content":"The following example shows how to build the request URI.","pos":[2029,2086]},{"content":"Connect to the online provider","pos":[2339,2369]},{"content":"You call the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AuthenticateAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br212066)</ept> method to connect to the online identity provider and get an access token.","pos":[2372,2541]},{"content":"The method takes the URI constructed in the previous step as the <bpt id=\"p1\">*</bpt>requestUri<ept id=\"p1\">*</ept> parameter, and a URI to which you want the user to be redirected as the <bpt id=\"p2\">*</bpt>callbackUri<ept id=\"p2\">*</ept> parameter.","pos":[2542,2716]},{"content":"In addition to <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AuthenticateAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br212066)</ept>, the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>Windows.Security.Authentication.Web<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/br227044)</ept> namespace contains an <bpt id=\"p5\">[</bpt><bpt id=\"p6\">**</bpt>AuthenticateAndContinue<ept id=\"p6\">**</ept><ept id=\"p5\">](https://msdn.microsoft.com/library/windows/apps/dn632425)</ept> method.","pos":[3764,4083]},{"content":"Do not call this method.","pos":[4084,4108]},{"content":"It is designed for apps targeting Windows Phone 8.1 only and is deprecated starting with Windows 10.","pos":[4109,4209]},{"content":"Connecting with single sign-on (SSO).","pos":[4214,4251]},{"content":"By default, Web authentication broker does not allow cookies to persist.","pos":[4254,4326]},{"content":"Because of this, even if the app user indicates that they want to stay logged in (for example, by selecting a check box in the provider's login dialog), they will have to login each time they want to access resources for that provider.","pos":[4327,4562]},{"content":"To login with SSO, your online identity provider must have enabled SSO for Web authentication broker, and your app must call the overload of <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>AuthenticateAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br212068)</ept> that does not take a <bpt id=\"p3\">*</bpt>callbackUri<ept id=\"p3\">*</ept> parameter.","pos":[4563,4831]},{"content":"To support SSO, the online provider must allow you to register a redirect URI in the form <ph id=\"ph1\">`ms-app://`</ph><bpt id=\"p1\">*</bpt>appSID<ept id=\"p1\">*</ept>, where <bpt id=\"p2\">*</bpt>appSID<ept id=\"p2\">*</ept> is the SID for your app.","pos":[4833,4983]},{"content":"You can find your app's SID from the app developer page for your app, or by calling the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>GetCurrentApplicationCallbackUri<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br212069)</ept> method.","pos":[4984,5176]},{"content":"Debugging","pos":[6210,6219]},{"content":"There are several ways to troubleshoot the web authentication broker APIs, including reviewing operational logs and reviewing web requests and responses using Fiddler.","pos":[6222,6389]},{"content":"Operational logs","pos":[6395,6411]},{"content":"Often you can determine what is not working by using the operational logs.","pos":[6413,6487]},{"content":"There is a dedicated event log channel Microsoft-Windows-WebAuth<ph id=\"ph1\">\\\\</ph>Operational that allows website developers to understand how their web pages are being processed by the Web authentication broker.","pos":[6488,6684]},{"content":"To enable it, launch eventvwr.exe and enable Operational log under the Application and Services<ph id=\"ph1\">\\\\</ph>Microsoft<ph id=\"ph2\">\\\\</ph>Windows<ph id=\"ph3\">\\\\</ph>WebAuth.","pos":[6685,6810]},{"content":"Also, the Web authentication broker appends a unique string to the user agent string to identify itself on the web server.","pos":[6811,6933]},{"content":"The string is \"MSAuthHost/1.0\".","pos":[6934,6965]},{"content":"Note that the version number may change in the future, so you should not to depend on that version number in your code.","pos":[6966,7085]},{"content":"An example of the full user agent string, followed by full debugging steps, is as follows.","pos":[7086,7176]},{"content":"Enable operational logs.","pos":[7290,7314]},{"content":"Run Contoso social application.","pos":[7319,7350]},{"content":"event viewer displaying the webauth operational logs","pos":[7353,7405]},{"content":"The generated logs entries can be used to understand the behavior of Web authentication broker in greater detail.","pos":[7442,7555]},{"content":"In this case, these can include:","pos":[7556,7588]},{"content":"Navigation Start: Logs when the AuthHost is started and contains information about the start and termination URLs.","pos":[7597,7711]},{"content":"illustrates the details of navigation start","pos":[7722,7765]},{"content":"Navigation Complete: Logs the completion of loading a web page.","pos":[7806,7869]},{"content":"Meta Tag: Logs when a meta-tag is encountered including the details.","pos":[7878,7946]},{"content":"Navigation Terminate: Navigation terminated by the user.","pos":[7955,8011]},{"content":"Navigation Error: AuthHost encounters a navigation error at a URL including HttpStatusCode.","pos":[8020,8111]},{"content":"Navigation End: Terminating URL is encountered.","pos":[8120,8167]},{"content":"Fiddler","pos":[8173,8180]},{"content":"The Fiddler web debugger can be used with apps.","pos":[8182,8229]},{"content":"Since the AuthHost runs in its own app container to give it the private network capability, you must set a registry key: Windows Registry Editor Version 5.00","pos":[8235,8392]},{"pos":[8398,8576],"content":"<bpt id=\"p1\">**</bpt>HKEY<ph id=\"ph1\">\\_</ph>LOCAL<ph id=\"ph2\">\\_</ph>MACHINE<ept id=\"p1\">**</ept><ph id=\"ph3\">\\\\</ph><bpt id=\"p2\">**</bpt>SOFTWARE<ept id=\"p2\">**</ept><ph id=\"ph4\">\\\\</ph><bpt id=\"p3\">**</bpt>Microsoft<ept id=\"p3\">**</ept><ph id=\"ph5\">\\\\</ph><bpt id=\"p4\">**</bpt>Windows NT<ept id=\"p4\">**</ept><ph id=\"ph6\">\\\\</ph><bpt id=\"p5\">**</bpt>CurrentVersion<ept id=\"p5\">**</ept><ph id=\"ph7\">\\\\</ph><bpt id=\"p6\">**</bpt>Image File Execution Options<ept id=\"p6\">**</ept><ph id=\"ph8\">\\\\</ph><bpt id=\"p7\">**</bpt>authhost.exe<ept id=\"p7\">**</ept><ph id=\"ph9\">\\\\</ph><bpt id=\"p8\">**</bpt>EnablePrivateNetwork<ept id=\"p8\">**</ept> = 00000001"},{"content":"Add a rule for the AuthHost as this is what is generating the outbound traffic.","pos":[8651,8730]},{"content":"Add a firewall rule for incoming traffic to Fiddler.","pos":[9839,9891]}],"content":"---\ntitle: Web authentication broker\ndescription: This article explains how to connect your Universal Windows Platform (UWP) app to an online identity provider that uses authentication protocols like OpenID or OAuth, such as Facebook, Twitter, Flickr, Instagram, and so on.\nms.assetid: 05F06961-1768-44A7-B185-BCDB74488F85\nauthor: awkoren\n---\n\n# Web authentication broker\n\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n\nThis article explains how to connect your Universal Windows Platform (UWP) app to an online identity provider that uses authentication protocols like OpenID or OAuth, such as Facebook, Twitter, Flickr, Instagram, and so on. The [**AuthenticateAsync**](https://msdn.microsoft.com/library/windows/apps/br212066) method sends a request to the online identity provider and gets back an access token that describes the provider resources to which the app has access.\n\n**Note**  For a complete, working code sample, clone the [WebAuthenticationBroker repo on GitHub](http://go.microsoft.com/fwlink/p/?LinkId=620622).\n\n \n\n## Register your app with your online provider\n\n\nYou must register your app with the online identity provider to which you want to connect. You can find out how to register your app from the identity provider. After registering, the online provider typically gives you an Id or secret key for your app.\n\n## Build the authentication request URI\n\n\nThe request URI consists of the address where you send the authentication request to your online provider appended with other required information, such as an app ID or secret, a redirect URI where the user is sent after completing authentication, and the expected response type. You can find out from your provider what parameters are required.\n\nThe request URI is sent as the *requestUri* parameter of the [**AuthenticateAsync**](https://msdn.microsoft.com/library/windows/apps/br212066) method. It must be a secure address (it must start with https://)\n\nThe following example shows how to build the request URI.\n\n```cs\nstring startURL = \"https://<providerendpoint>?client_id=<clientid>&scope=<scopes>&response_type=token\";\nstring endURL = \"http://<appendpoint>\";\n\nSystem.Uri startURI = new System.Uri(startURL);\nSystem.Uri endURI = new System.Uri(endURL);\n```\n\n## Connect to the online provider\n\n\nYou call the [**AuthenticateAsync**](https://msdn.microsoft.com/library/windows/apps/br212066) method to connect to the online identity provider and get an access token. The method takes the URI constructed in the previous step as the *requestUri* parameter, and a URI to which you want the user to be redirected as the *callbackUri* parameter.\n\n```cs\nstring result;\n\ntry\n{\n    var webAuthenticationResult = \n        await Windows.Security.Authentication.Web.WebAuthenticationBroker.AuthenticateAsync( \n        Windows.Security.Authentication.Web.WebAuthenticationOptions.None, \n        startURI, \n        endURI);\n\n    switch (webAuthenticationResult.ResponseStatus)\n    {\n        case Windows.Security.Authentication.Web.WebAuthenticationStatus.Success:\n            // Successful authentication. \n            result = webAuthenticationResult.ResponseData.ToString(); \n            break;\n        case Windows.Security.Authentication.Web.WebAuthenticationStatus.ErrorHttp:\n            // HTTP error. \n            result = webAuthenticationResult.ResponseErrorDetail.ToString(); \n            break;\n        default:\n            // Other error.\n            result = webAuthenticationResult.ResponseData.ToString(); \n            break;\n    } \n}\ncatch (Exception ex)\n{\n    // Authentication failed. Handle parameter, SSL/TLS, and Network Unavailable errors here. \n    result = ex.Message;\n}\n```\n\nIn addition to [**AuthenticateAsync**](https://msdn.microsoft.com/library/windows/apps/br212066), the [**Windows.Security.Authentication.Web**](https://msdn.microsoft.com/library/windows/apps/br227044) namespace contains an [**AuthenticateAndContinue**](https://msdn.microsoft.com/library/windows/apps/dn632425) method. Do not call this method. It is designed for apps targeting Windows Phone 8.1 only and is deprecated starting with Windows 10.\n\n## Connecting with single sign-on (SSO).\n\n\nBy default, Web authentication broker does not allow cookies to persist. Because of this, even if the app user indicates that they want to stay logged in (for example, by selecting a check box in the provider's login dialog), they will have to login each time they want to access resources for that provider. To login with SSO, your online identity provider must have enabled SSO for Web authentication broker, and your app must call the overload of [**AuthenticateAsync**](https://msdn.microsoft.com/library/windows/apps/br212068) that does not take a *callbackUri* parameter.\n\nTo support SSO, the online provider must allow you to register a redirect URI in the form `ms-app://`*appSID*, where *appSID* is the SID for your app. You can find your app's SID from the app developer page for your app, or by calling the [**GetCurrentApplicationCallbackUri**](https://msdn.microsoft.com/library/windows/apps/br212069) method.\n\n```cs\nstring result;\n\ntry\n{\n    var webAuthenticationResult = \n        await Windows.Security.Authentication.Web.WebAuthenticationBroker.AuthenticateAsync( \n        Windows.Security.Authentication.Web.WebAuthenticationOptions.None, \n        startURI);\n\n    switch (webAuthenticationResult.ResponseStatus)\n    {\n        case Windows.Security.Authentication.Web.WebAuthenticationStatus.Success:\n            // Successful authentication. \n            result = webAuthenticationResult.ResponseData.ToString(); \n            break;\n        case Windows.Security.Authentication.Web.WebAuthenticationStatus.ErrorHttp:\n            // HTTP error. \n            result = webAuthenticationResult.ResponseErrorDetail.ToString(); \n            break;\n        default:\n            // Other error.\n            result = webAuthenticationResult.ResponseData.ToString(); \n            break;\n    } \n}\ncatch (Exception ex)\n{\n    // Authentication failed. Handle parameter, SSL/TLS, and Network Unavailable errors here. \n    result = ex.Message;\n}\n```\n\n## Debugging\n\n\nThere are several ways to troubleshoot the web authentication broker APIs, including reviewing operational logs and reviewing web requests and responses using Fiddler.\n\n### Operational logs\n\nOften you can determine what is not working by using the operational logs. There is a dedicated event log channel Microsoft-Windows-WebAuth\\\\Operational that allows website developers to understand how their web pages are being processed by the Web authentication broker. To enable it, launch eventvwr.exe and enable Operational log under the Application and Services\\\\Microsoft\\\\Windows\\\\WebAuth. Also, the Web authentication broker appends a unique string to the user agent string to identify itself on the web server. The string is \"MSAuthHost/1.0\". Note that the version number may change in the future, so you should not to depend on that version number in your code. An example of the full user agent string, followed by full debugging steps, is as follows.\n\n`User-Agent: Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Win64; x64; Trident/6.0; MSAuthHost/1.0)`\n\n1.  Enable operational logs.\n2.  Run Contoso social application. ![event viewer displaying the webauth operational logs](images/wab-event-viewer-1.png)\n3.  The generated logs entries can be used to understand the behavior of Web authentication broker in greater detail. In this case, these can include:\n    -   Navigation Start: Logs when the AuthHost is started and contains information about the start and termination URLs.\n    -   ![illustrates the details of navigation start](images/wab-event-viewer-2.png)\n    -   Navigation Complete: Logs the completion of loading a web page.\n    -   Meta Tag: Logs when a meta-tag is encountered including the details.\n    -   Navigation Terminate: Navigation terminated by the user.\n    -   Navigation Error: AuthHost encounters a navigation error at a URL including HttpStatusCode.\n    -   Navigation End: Terminating URL is encountered.\n\n### Fiddler\n\nThe Fiddler web debugger can be used with apps.\n\n1.  Since the AuthHost runs in its own app container to give it the private network capability, you must set a registry key: Windows Registry Editor Version 5.00\n\n    **HKEY\\_LOCAL\\_MACHINE**\\\\**SOFTWARE**\\\\**Microsoft**\\\\**Windows NT**\\\\**CurrentVersion**\\\\**Image File Execution Options**\\\\**authhost.exe**\\\\**EnablePrivateNetwork** = 00000001\n\n                         Data type  \n                         DWORD\n\n2.  Add a rule for the AuthHost as this is what is generating the outbound traffic.\n    ```syntax\n    CheckNetIsolation.exe LoopbackExempt -a -n=microsoft.windows.authhost.a.p_8wekyb3d8bbwe\n    CheckNetIsolation.exe LoopbackExempt -a -n=microsoft.windows.authhost.sso.p_8wekyb3d8bbwe\n    CheckNetIsolation.exe LoopbackExempt -a -n=microsoft.windows.authhost.sso.c_8wekyb3d8bbwe\n    D:\\Windows\\System32>CheckNetIsolation.exe LoopbackExempt -s\n    List Loopback Exempted AppContainers\n    [1] -----------------------------------------------------------------\n        Name: microsoft.windows.authhost.sso.c_8wekyb3d8bbwe\n        SID:  S-1-15-2-1973105767-3975693666-32999980-3747492175-1074076486-3102532000-500629349\n    [2] -----------------------------------------------------------------\n        Name: microsoft.windows.authhost.sso.p_8wekyb3d8bbwe\n        SID:  S-1-15-2-166260-4150837609-3669066492-3071230600-3743290616-3683681078-2492089544\n    [3] -----------------------------------------------------------------\n        Name: microsoft.windows.authhost.a.p_8wekyb3d8bbwe\n        SID:  S-1-15-2-3506084497-1208594716-3384433646-2514033508-1838198150-1980605558-3480344935\n    ```\n\n3.  Add a firewall rule for incoming traffic to Fiddler."}