{"nodes":[{"content":"Smart cards","pos":[11,22]},{"content":"This topic explains how Universal Windows Platform (UWP) apps can use smart cards to connect users to secure network services, including how to access physical smart card readers, create virtual smart cards, communicate with smart cards, authenticate users, reset user PINs, and remove or disconnect smart cards.","pos":[36,348]},{"content":"Smart cards","pos":[421,432]},{"content":"Updated for UWP apps on Windows 10.","pos":[438,473]},{"content":"For Windows 8.x articles, see the <bpt id=\"p1\">[</bpt>archive<ept id=\"p1\">](http://go.microsoft.com/fwlink/p/?linkid=619132)</ept>","pos":[474,566]},{"content":"This topic explains how Universal Windows Platform (UWP) apps can use smart cards to connect users to secure network services, including how to access physical smart card readers, create virtual smart cards, communicate with smart cards, authenticate users, reset user PINs, and remove or disconnect smart cards.","pos":[572,884]},{"content":"Configure the app manifest","pos":[889,915]},{"pos":[918,1097],"content":"Before your app can authenticate users using smart cards or virtual smart cards, you must set the <bpt id=\"p1\">**</bpt>Shared User Certificates<ept id=\"p1\">**</ept> capability in the project Package.appxmanifest file."},{"content":"Access connected card readers and smart cards","pos":[1102,1147]},{"content":"You can query for readers and attached smart cards by passing the device ID (specified in <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>DeviceInformation<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br225393)</ept>) to the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardReader.FromIdAsync<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn263890)</ept> method.","pos":[1150,1429]},{"content":"To access the smart cards currently attached to the returned reader device, call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardReader.FindAllCardsAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263887)</ept>.","pos":[1430,1609]},{"pos":[2140,2334],"content":"You should also enable your app to observe for <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>CardAdded<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263866)</ept> events by implementing a method to handle app behavior on card insertion."},{"pos":[2493,2779],"content":"You can then pass each returned <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCard<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297565)</ept> object to <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardProvisioning<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept> to access the methods that allow your app to access and customize its configuration."},{"content":"Create a virtual smart card","pos":[2784,2811]},{"content":"To create a virtual smart card using <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardProvisioning<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept>, your app will first need to provide a friendly name, an admin key, and a <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardPinPolicy<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn297642)</ept>.","pos":[2814,3094]},{"content":"The friendly name is generally something provided to the app, but your app will still need to provide an admin key and generate an instance of the current <bpt id=\"p1\">**</bpt>SmartCardPinPolicy<ept id=\"p1\">**</ept> before passing all three values to <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>RequestVirtualSmartCardCreationAsync<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/dn263830)</ept>.","pos":[3095,3409]},{"pos":[3415,3524],"content":"Create a new instance of a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardPinPolicy<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297642)</ept>"},{"pos":[3529,3734],"content":"Generate the admin key value by calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>CryptographicBuffer.GenerateRandom<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/br241392)</ept> on the admin key value provided by the service or management tool."},{"pos":[3739,3902],"content":"Pass these values along with the <bpt id=\"p1\">*</bpt>FriendlyNameText<ept id=\"p1\">*</ept> string to <bpt id=\"p2\">[</bpt><bpt id=\"p3\">**</bpt>RequestVirtualSmartCardCreationAsync<ept id=\"p3\">**</ept><ept id=\"p2\">](https://msdn.microsoft.com/library/windows/apps/dn263830)</ept>."},{"pos":[4240,4524],"content":"Once <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestVirtualSmartCardCreationAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263830)</ept> has returned the associated <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardProvisioning<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept> object, the virtual smart card is provisioned and ready for use."},{"content":"Handle authentication challenges","pos":[4529,4561]},{"content":"To authenticate with smart cards or virtual smart cards, your app must provide the behavior to complete challenges between the admin key data stored on the card, and the admin key data maintained by the authentication server or management tool.","pos":[4564,4808]},{"content":"The following code shows how to support smart card authentication for services or modification of physical or virtual card details.","pos":[4810,4941]},{"content":"If the data generated using the admin key on the card (\"challenge\") is the same as the admin key data provided by the server or management tool (\"adminkey\"), authentication is successful.","pos":[4942,5129]},{"content":"You will see this code referenced throughout the remainder of this topic was we review how to complete an authentication action, and how to apply changes to smart card and virtual smart card information.","pos":[5768,5971]},{"content":"Verify smart card or virtual smart card authentication response","pos":[5976,6039]},{"content":"Now that we have the logic for authentication challenges defined, we can communicate with the reader to access the smart card, or alternatively, access a virtual smart card for authentication.","pos":[6042,6234]},{"content":"To begin the challenge, call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>GetChallengeContextAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263811)</ept> from the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardProvisioning<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept> object associated with the smart card.","pos":[6240,6491]},{"content":"This will generate an instance of <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardChallengeContext<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297570)</ept>, which contains the card's <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>Challenge<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn297578)</ept> value.","pos":[6492,6723]},{"pos":[6729,6906],"content":"Next, pass the card's challenge value and the admin key provided by the service or management tool to the <bpt id=\"p1\">**</bpt>ChallengeResponseAlgorithm<ept id=\"p1\">**</ept> that we defined in the previous example."},{"pos":[6912,7049],"content":"<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>VerifyResponseAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297627)</ept> will return <bpt id=\"p3\">**</bpt>true<ept id=\"p3\">**</ept> if authentication is successful."},{"content":"Change or reset a user PIN","pos":[7526,7552]},{"content":"To change the PIN associated with a smart card:","pos":[7555,7602]},{"pos":[7608,7745],"content":"Access the card and generate the associated <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardProvisioning<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept> object."},{"pos":[7750,7896],"content":"Call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestPinChangeAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263823)</ept> to display a UI to the user to complete this operation."},{"pos":[7901,7967],"content":"If the PIN was successfully changed the call will return <bpt id=\"p1\">**</bpt>true<ept id=\"p1\">**</ept>."},{"content":"To request a PIN reset:","pos":[8134,8157]},{"content":"Call <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestPinResetAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263825)</ept> to initiate the operation.","pos":[8163,8279]},{"content":"This call includes a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardPinResetHandler<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297701)</ept> method that represents the smart card and the pin reset request.","pos":[8280,8454]},{"pos":[8459,8851],"content":"<bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>SmartCardPinResetHandler<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn297701)</ept> provides information that our <bpt id=\"p3\">**</bpt>ChallengeResponseAlgorithm<ept id=\"p3\">**</ept>, wrapped in a <bpt id=\"p4\">[</bpt><bpt id=\"p5\">**</bpt>SmartCardPinResetDeferral<ept id=\"p5\">**</ept><ept id=\"p4\">](https://msdn.microsoft.com/library/windows/apps/dn297693)</ept> call, uses to compare the card's challenge value and the admin key provided by the service or management tool to authenticate the request."},{"pos":[8857,9050],"content":"If the challenge is successful, the <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestPinResetAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263825)</ept> call is completed; returning <bpt id=\"p3\">**</bpt>true<ept id=\"p3\">**</ept> if the PIN was successfully reset."},{"content":"Remove a smart card or virtual smart card","pos":[9663,9704]},{"pos":[9707,9864],"content":"When a physical smart card is removed a <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>CardRemoved<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263875)</ept> event will fire when the card is deleted."},{"content":"Associate the firing of this event with the card reader with the method that defines your app's behavior on card or reader removal as an event handler.","pos":[9866,10017]},{"content":"This behavior can be something as simply as providing notification to the user that the card was removed.","pos":[10018,10123]},{"pos":[10199,10521],"content":"The removal of a virtual smart card is handled programmatically by first retrieving the card and then calling <bpt id=\"p1\">[</bpt><bpt id=\"p2\">**</bpt>RequestVirtualSmartCardDeletionAsync<ept id=\"p2\">**</ept><ept id=\"p1\">](https://msdn.microsoft.com/library/windows/apps/dn263850)</ept> from the <bpt id=\"p3\">[</bpt><bpt id=\"p4\">**</bpt>SmartCardProvisioning<ept id=\"p4\">**</ept><ept id=\"p3\">](https://msdn.microsoft.com/library/windows/apps/dn263801)</ept> returned object."}],"content":"---\ntitle: Smart cards\ndescription: This topic explains how Universal Windows Platform (UWP) apps can use smart cards to connect users to secure network services, including how to access physical smart card readers, create virtual smart cards, communicate with smart cards, authenticate users, reset user PINs, and remove or disconnect smart cards.\nms.assetid: 86524267-50A0-4567-AE17-35C4B6D24745\nauthor: awkoren\n---\n\n# Smart cards\n\n\n\\[ Updated for UWP apps on Windows 10. For Windows 8.x articles, see the [archive](http://go.microsoft.com/fwlink/p/?linkid=619132) \\]\n\n\nThis topic explains how Universal Windows Platform (UWP) apps can use smart cards to connect users to secure network services, including how to access physical smart card readers, create virtual smart cards, communicate with smart cards, authenticate users, reset user PINs, and remove or disconnect smart cards.\n\n## Configure the app manifest\n\n\nBefore your app can authenticate users using smart cards or virtual smart cards, you must set the **Shared User Certificates** capability in the project Package.appxmanifest file.\n\n## Access connected card readers and smart cards\n\n\nYou can query for readers and attached smart cards by passing the device ID (specified in [**DeviceInformation**](https://msdn.microsoft.com/library/windows/apps/br225393)) to the [**SmartCardReader.FromIdAsync**](https://msdn.microsoft.com/library/windows/apps/dn263890) method. To access the smart cards currently attached to the returned reader device, call [**SmartCardReader.FindAllCardsAsync**](https://msdn.microsoft.com/library/windows/apps/dn263887).\n\n```cs\nstring selector = SmartCardReader.GetDeviceSelector();\nDeviceInformationCollection devices =\n    await DeviceInformation.FindAllAsync(selector);\n\nforeach (DeviceInformation device in devices)\n{\n    SmartCardReader reader =\n        await SmartCardReader.FromIdAsync(device.Id);\n\n    // For each reader, we want to find all the cards associated\n    // with it.  Then we will create a SmartCardListItem for\n    // each (reader, card) pair.\n    IReadOnlyList<SmartCard> cards =\n        await reader.FindAllCardsAsync();\n}\n```\n\nYou should also enable your app to observe for [**CardAdded**](https://msdn.microsoft.com/library/windows/apps/dn263866) events by implementing a method to handle app behavior on card insertion.\n\n```cs\nprivate void reader_CardAdded(SmartCardReader sender, CardAddedEventArgs args)\n{\n  // A card has been inserted into the sender SmartCardReader.\n}\n```\n\nYou can then pass each returned [**SmartCard**](https://msdn.microsoft.com/library/windows/apps/dn297565) object to [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801) to access the methods that allow your app to access and customize its configuration.\n\n## Create a virtual smart card\n\n\nTo create a virtual smart card using [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801), your app will first need to provide a friendly name, an admin key, and a [**SmartCardPinPolicy**](https://msdn.microsoft.com/library/windows/apps/dn297642). The friendly name is generally something provided to the app, but your app will still need to provide an admin key and generate an instance of the current **SmartCardPinPolicy** before passing all three values to [**RequestVirtualSmartCardCreationAsync**](https://msdn.microsoft.com/library/windows/apps/dn263830).\n\n1.  Create a new instance of a [**SmartCardPinPolicy**](https://msdn.microsoft.com/library/windows/apps/dn297642)\n2.  Generate the admin key value by calling [**CryptographicBuffer.GenerateRandom**](https://msdn.microsoft.com/library/windows/apps/br241392) on the admin key value provided by the service or management tool.\n3.  Pass these values along with the *FriendlyNameText* string to [**RequestVirtualSmartCardCreationAsync**](https://msdn.microsoft.com/library/windows/apps/dn263830).\n\n```cs\nSmartCardPinPolicy pinPolicy = new SmartCardPinPolicy();\npinPolicy.MinLength = 6;\n\nIBuffer adminkey = CryptographicBuffer.GenerateRandom(24);\n\nSmartCardProvisioning provisioning = await\n     SmartCardProvisioning.RequestVirtualSmartCardCreationAsync(\n          \"Card friendly name\",\n          adminkey,\n          pinPolicy);\n```\n\nOnce [**RequestVirtualSmartCardCreationAsync**](https://msdn.microsoft.com/library/windows/apps/dn263830) has returned the associated [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801) object, the virtual smart card is provisioned and ready for use.\n\n## Handle authentication challenges\n\n\nTo authenticate with smart cards or virtual smart cards, your app must provide the behavior to complete challenges between the admin key data stored on the card, and the admin key data maintained by the authentication server or management tool.\n\nThe following code shows how to support smart card authentication for services or modification of physical or virtual card details. If the data generated using the admin key on the card (\"challenge\") is the same as the admin key data provided by the server or management tool (\"adminkey\"), authentication is successful.\n\n```cs\nstatic class ChallengeResponseAlgorithm\n{\n    public static IBuffer CalculateResponse(IBuffer challenge, IBuffer adminkey)\n    {\n        if (challenge == null)\n            throw new ArgumentNullException(\"challenge\");\n        if (adminkey == null)\n            throw new ArgumentNullException(\"adminkey\");\n\n        SymmetricKeyAlgorithmProvider objAlg = SymmetricKeyAlgorithmProvider.OpenAlgorithm(SymmetricAlgorithmNames.TripleDesCbc);\n        var symmetricKey = objAlg.CreateSymmetricKey(adminkey);\n        var buffEncrypted = CryptographicEngine.Encrypt(symmetricKey, challenge, null);\n        return buffEncrypted;\n    }\n}\n```\n\nYou will see this code referenced throughout the remainder of this topic was we review how to complete an authentication action, and how to apply changes to smart card and virtual smart card information.\n\n## Verify smart card or virtual smart card authentication response\n\n\nNow that we have the logic for authentication challenges defined, we can communicate with the reader to access the smart card, or alternatively, access a virtual smart card for authentication.\n\n1.  To begin the challenge, call [**GetChallengeContextAsync**](https://msdn.microsoft.com/library/windows/apps/dn263811) from the [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801) object associated with the smart card. This will generate an instance of [**SmartCardChallengeContext**](https://msdn.microsoft.com/library/windows/apps/dn297570), which contains the card's [**Challenge**](https://msdn.microsoft.com/library/windows/apps/dn297578) value.\n\n2.  Next, pass the card's challenge value and the admin key provided by the service or management tool to the **ChallengeResponseAlgorithm** that we defined in the previous example.\n\n3.  [**VerifyResponseAsync**](https://msdn.microsoft.com/library/windows/apps/dn297627) will return **true** if authentication is successful.\n\n```cs\nbool verifyResult = false;\nSmartCard card = await rootPage.GetSmartCard();\nSmartCardProvisioning provisioning =\n    await SmartCardProvisioning.FromSmartCardAsync(card);\n\nusing (SmartCardChallengeContext context =\n       await provisioning.GetChallengeContextAsync())\n{\n    IBuffer response = ChallengeResponseAlgorithm.CalculateResponse(\n        context.Challenge,\n        rootPage.AdminKey);\n\n    verifyResult = await context.VerifyResponseAsync(response);\n}\n```\n\n## Change or reset a user PIN\n\n\nTo change the PIN associated with a smart card:\n\n1.  Access the card and generate the associated [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801) object.\n2.  Call [**RequestPinChangeAsync**](https://msdn.microsoft.com/library/windows/apps/dn263823) to display a UI to the user to complete this operation.\n3.  If the PIN was successfully changed the call will return **true**.\n\n```cs\nSmartCardProvisioning provisioning =\n    await SmartCardProvisioning.FromSmartCardAsync(card);\n\nbool result = await provisioning.RequestPinChangeAsync();\n```\n\nTo request a PIN reset:\n\n1.  Call [**RequestPinResetAsync**](https://msdn.microsoft.com/library/windows/apps/dn263825) to initiate the operation. This call includes a [**SmartCardPinResetHandler**](https://msdn.microsoft.com/library/windows/apps/dn297701) method that represents the smart card and the pin reset request.\n2.  [**SmartCardPinResetHandler**](https://msdn.microsoft.com/library/windows/apps/dn297701) provides information that our **ChallengeResponseAlgorithm**, wrapped in a [**SmartCardPinResetDeferral**](https://msdn.microsoft.com/library/windows/apps/dn297693) call, uses to compare the card's challenge value and the admin key provided by the service or management tool to authenticate the request.\n\n3.  If the challenge is successful, the [**RequestPinResetAsync**](https://msdn.microsoft.com/library/windows/apps/dn263825) call is completed; returning **true** if the PIN was successfully reset.\n\n```cs\nSmartCardProvisioning provisioning =\n    await SmartCardProvisioning.FromSmartCardAsync(card);\n\nbool result = await provisioning.RequestPinResetAsync(\n    (pinResetSender, request) =>\n    {\n        SmartCardPinResetDeferral deferral =\n            request.GetDeferral();\n\n        try\n        {\n            IBuffer response =\n                ChallengeResponseAlgorithm.CalculateResponse(\n                    request.Challenge,\n                    rootPage.AdminKey);\n            request.SetResponse(response);\n        }\n        finally\n        {\n            deferral.Complete();\n        }\n    });\n}\n```\n\n## Remove a smart card or virtual smart card\n\n\nWhen a physical smart card is removed a [**CardRemoved**](https://msdn.microsoft.com/library/windows/apps/dn263875) event will fire when the card is deleted.\n\nAssociate the firing of this event with the card reader with the method that defines your app's behavior on card or reader removal as an event handler. This behavior can be something as simply as providing notification to the user that the card was removed.\n\n```cs\nreader = card.Reader;\nreader.CardRemoved += HandleCardRemoved;\n```\n\nThe removal of a virtual smart card is handled programmatically by first retrieving the card and then calling [**RequestVirtualSmartCardDeletionAsync**](https://msdn.microsoft.com/library/windows/apps/dn263850) from the [**SmartCardProvisioning**](https://msdn.microsoft.com/library/windows/apps/dn263801) returned object.\n\n```cs\nbool result = await SmartCardProvisioning\n    .RequestVirtualSmartCardDeletionAsync(card);\n```"}